<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的旅遊行程</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
        <h1 class="text-2xl font-bold mb-4 text-gray-800 text-center">✈️ 旅遊行程同步筆記</h1>
        
        <p class="text-sm text-gray-500 mb-2">在這邊輸入，所有裝置都會同步更新：</p>
        
        <textarea id="travelInput" 
            class="w-full h-48 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none mb-4"
            placeholder="正在載入資料..."></textarea>

        <div id="statusMsg" class="text-center text-sm text-gray-400 h-6">準備就緒</div>
    </div>

    <script type="module">
        // 1. 引入 Firebase 必要工具
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyAImFK704mHo2HYsnt-VnmeVveZaZSkCLI",
  authDomain: "triptokyoapp.firebaseapp.com",
  projectId: "triptokyoapp",
  storageBucket: "triptokyoapp.firebasestorage.app",
  messagingSenderId: "875138652318",
  appId: "1:875138652318:web:1eb712afb49e24a059038f",
  measurementId: "G-FEG9FJLRX5" };
        // ==========================================

        // 2. 啟動 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 定義我們要存取的位置 (集合: trips, 文件: myPlan)
        const docRef = doc(db, "trips", "myPlan");
        const inputField = document.getElementById('travelInput');
        const statusMsg = document.getElementById('statusMsg');

        let typingTimer; // 用來偵測打字停止

        // 3. 【監聽雲端】當雲端資料改變時，更新畫面
        onSnapshot(docRef, (doc) => {
            if (doc.exists()) {
                const cloudContent = doc.data().content;
                // 只有當輸入框內容跟雲端不一樣時才更新 (避免打字被打斷)
                if (inputField.value !== cloudContent && document.activeElement !== inputField) {
                    inputField.value = cloudContent;
                    statusMsg.innerText = "已從雲端同步最新內容 ☁️";
                    setTimeout(() => statusMsg.innerText = "", 2000);
                } else if (inputField.placeholder === "正在載入資料...") {
                    // 第一次載入
                    inputField.value = cloudContent;
                    inputField.placeholder = "開始輸入行程...";
                }
            } else {
                inputField.placeholder = "開始輸入行程...";
            }
        });

        // 4. 【寫入雲端】當使用者打字時，自動儲存
        inputField.addEventListener('input', () => {
            statusMsg.innerText = "輸入中...";
            
            // 防抖動設計：停止打字 0.5 秒後才上傳，節省流量
            clearTimeout(typingTimer);
            typingTimer = setTimeout(saveToCloud, 500);
        });

        async function saveToCloud() {
            const text = inputField.value;
            statusMsg.innerText = "正在儲存...";
            try {
                await setDoc(docRef, { content: text }, { merge: true });
                statusMsg.innerText = "已儲存 ✅";
                setTimeout(() => statusMsg.innerText = "", 2000);
            } catch (error) {
                console.error("儲存失敗", error);
                statusMsg.innerText = "❌ 儲存失敗，請檢查網路或設定";
            }
        }
    </script>
</body>
</html>

