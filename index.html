<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f9f7f2">
    <title>æ—…ã®è¨˜ V17 (åŒæ­¥ä¿®å¾©/å…¬è²»ç¨ç«‹ç‰ˆ)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@400;500;700;900&family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'paper': '#f9f7f2', 
                        'sakura': '#f8c3cd', 
                        'matcha': '#bccc9a', 
                        'fuji': '#7b90d2', 
                        'fuji-light': '#eff6ff', 
                        'pencil': '#595857', 
                        'ink': '#2c2c2c',
                        'expense-bg': '#fffdf9'
                    },
                    fontFamily: { 
                        'maru': ['"Zen Maru Gothic"', 'sans-serif'], 
                        'hand': ['"Yomogi"', '"Zen Maru Gothic"', 'cursive'],
                        'serif': ['"Noto Serif TC"', 'serif']
                    },
                    boxShadow: { 
                        'soft': '0 4px 20px rgba(0,0,0,0.03)',
                        'float': '0 8px 30px rgba(0,0,0,0.08)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body {
            font-family: 'Zen Maru Gothic', 'Noto Serif TC', sans-serif; 
            background-color: #f9f7f2; 
            color: #595857;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 24px 24px; 
            background-position: center top;
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
            min-height: 100vh; 
            padding-bottom: calc(90px + var(--sab));
        }
        .handwritten { font-family: 'Yomogi', cursive; }
        
        /* Modal Transitions */
        .modal { transition: opacity 0.2s ease-in-out; } 
        .modal.hidden { opacity: 0; pointer-events: none; } 
        .modal.visible { opacity: 1; pointer-events: auto; }
        
        /* Card Styles */
        .hand-card { 
            background: #fff; 
            border-radius: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); 
            position: relative; 
            border: 1px solid rgba(0,0,0,0.02); 
        }
        
        /* Navigation */
        .nav-item.active i, .nav-item.active span { color: #7b90d2; font-weight: 900; } 
        
        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .drag-handle { cursor: grab; display: flex; align-items: center; justify-content: center; width: 40px; height: 100%; background-color: rgba(0,0,0,0.02); position: absolute; left: 0; top: 0; z-index: 10; border-right: 1px solid rgba(0,0,0,0.03); }
        
        /* Links */
        .smart-link { color: #7b90d2; text-decoration: underline; text-decoration-style: dotted; font-weight: bold; }
        .guide-link { color: #bccc9a; text-decoration: underline; font-weight: bold; cursor: pointer; padding: 0 4px; border-radius: 4px; transition: background 0.2s; }
        .guide-link:hover { background-color: #f0fdf4; color: #166534; }
        
        /* Shopping Categories */
        .cat-tab { transition: all 0.2s; border: 1px solid transparent; }
        .cat-tab.active { background-color: #fca5a5; color: white; border-color: #fca5a5; box-shadow: 0 2px 5px rgba(252, 165, 165, 0.4); }
        
        /* Public Fund Bar Animation */
        .fund-bar { transition: width 1s ease-in-out, background-color 0.5s; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="pb-2 px-4 text-center sticky top-0 bg-[#f9f7f2]/95 z-40 backdrop-blur-sm border-b border-gray-100/50" style="padding-top: max(1.5rem, var(--sat));">
        <h1 class="text-4xl font-black tracking-widest text-ink handwritten relative inline-block mt-2">
            <span class="absolute -top-5 -left-8 text-3xl rotate-[-15deg] opacity-80">âœˆï¸</span> æ—…ã®è¨˜
        </h1>
        <div class="flex justify-center items-center gap-3 mt-2">
            <div id="cloud-status" class="text-[10px] bg-gray-200/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 cursor-pointer" onclick="forceDownload()"><i class="fa-solid fa-code-branch"></i> <span>æª¢æŸ¥åŒæ­¥</span></div>
            <button onclick="forceDownload()" class="text-[10px] bg-white text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 border border-gray-200 shadow-sm active:scale-95"><i class="fa-solid fa-rotate-right"></i> <span>æ‰‹å‹•ä¸‹è¼‰</span></button>
            <button onclick="forceUpload()" class="text-[10px] bg-ink text-white px-2 py-0.5 rounded-full flex items-center gap-1 shadow-sm active:scale-95"><i class="fa-solid fa-cloud-arrow-up"></i> <span>ä¸Šå‚³</span></button>
        </div>
    </header>

    <main id="app" class="px-4 w-full mx-auto min-h-screen max-w-5xl relative pb-24">
        
        <!-- ================= PLAN SECTION ================= -->
        <section id="view-plan" class="view-section animate-fade relative z-10">
            <div class="flex justify-between items-center mb-6 mt-6">
                <h3 class="text-pencil font-bold handwritten text-xl flex items-center"><i class="fa-solid fa-plane-departure mr-2 text-xl text-fuji"></i>èˆªç­è³‡è¨Š</h3>
                <button onclick="openFlightModal()" class="text-xs bg-white border border-fuji/30 text-fuji px-4 py-2 rounded-xl shadow-sm font-bold hover:bg-fuji hover:text-white transition"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
            </div>
            
            <div id="flight-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10"></div>
            
            <div class="flex justify-between items-center mb-4 border-t-2 border-dashed border-gray-200 pt-8 mt-6">
                 <h3 class="text-pencil font-bold handwritten text-xl flex items-center"><i class="fa-solid fa-map-location-dot mr-2 text-xl text-matcha"></i>æ¯æ—¥è¡Œç¨‹</h3>
            </div>
            
            <p class="text-center text-xs text-gray-400 mb-6 bg-white/60 py-2 rounded-full shadow-sm max-w-xs mx-auto">
                <i class="fa-solid fa-circle-info text-fuji"></i> é»æ“Šé¤å…·åœ–ç¤ºè¨˜å¸³ï¼Œé»æ“Šæ–‡å­—é–‹å•Ÿé€£çµ
            </p>

            <div id="itinerary-container" class="space-y-6 md:grid md:grid-cols-2 md:space-y-0 md:gap-6 items-start"></div>
            
            <button onclick="addNewDay()" class="w-full mt-8 mb-8 border-2 border-dashed border-gray-300 text-gray-400 rounded-2xl py-4 hover:bg-white hover:border-matcha font-bold text-sm bg-white/50 handwritten flex items-center justify-center gap-2 transition">
                <i class="fa-solid fa-plus-circle"></i> å¯«ä¸‹ä¸€é å›æ†¶
            </button>
        </section>

        <!-- ================= GUIDE SECTION ================= -->
        <section id="view-guide" class="view-section hidden relative z-10">
            <div class="flex justify-between items-end mb-6 mt-6">
                <h2 class="text-2xl font-bold text-pencil handwritten flex items-center gap-2"><span class="text-3xl">ğŸ</span> æ·±åº¦å°è¦½</h2>
                <button onclick="openGuideModal()" class="text-sm bg-matcha/20 text-green-800 px-4 py-1.5 rounded-full border border-matcha/50 font-bold shadow-sm"><i class="fa-solid fa-plus mr-1"></i>æ–°å¢æ™¯é»</button>
            </div>
            <div id="guide-list" class="space-y-6 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-6"></div>
        </section>

        <!-- ================= WALLET SECTION ================= -->
        <section id="view-wallet" class="view-section hidden relative z-10">
            
            <!-- å…¬è²»éŒ¢åŒ…å¡ç‰‡ (ç¨ç«‹è¨ˆç®—é‚è¼¯) -->
            <div class="mt-6 mb-6 p-5 bg-white rounded-[24px] shadow-sm border border-gray-100 relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-32 h-32 bg-fuji/5 rounded-full -mr-10 -mt-10 group-hover:bg-fuji/10 transition"></div>
                
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="font-bold text-pencil flex items-center gap-2 text-lg"><i class="fa-solid fa-sack-dollar text-fuji text-xl"></i> å…¬è²»éŒ¢åŒ…</h3>
                    <button onclick="editPublicFund()" class="text-xs text-fuji bg-fuji/10 px-3 py-1.5 rounded-full font-bold hover:bg-fuji hover:text-white transition">è¨­å®šç¸½é¡</button>
                </div>
                
                <div class="flex items-end justify-between relative z-10 mb-3">
                    <div>
                        <div class="text-xs text-gray-400 mb-1 font-bold">å‰©é¤˜å…¬è²» (JPY)</div>
                        <div class="text-4xl font-black text-fuji font-mono tracking-tight" id="public-fund-remaining">0</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400 mb-1">å…¬è²»ç¸½é ç®—</div>
                        <div class="text-sm font-bold text-gray-600 font-mono" id="public-fund-total">0</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-100 rounded-full h-3 relative z-10 overflow-hidden shadow-inner">
                    <div id="public-fund-bar" class="fund-bar h-full rounded-full bg-fuji w-0"></div>
                </div>
                <div class="text-[10px] text-gray-400 mt-2 text-right relative z-10">* è‹¥æ”¯å‡ºç‚ºå°å¹£ï¼Œå°‡ä¾åŒ¯ç‡è‡ªå‹•æ›ç®—æ‰£é™¤</div>
            </div>

            <div class="flex justify-between items-center mt-6 mb-6">
                <h2 class="text-2xl font-bold text-pencil handwritten flex items-center gap-2"><span class="text-3xl">ğŸ‘›</span> æ—…è²»æ˜ç´°</h2>
                <div class="flex items-center gap-1 bg-white px-2 py-1.5 rounded-xl shadow-sm border border-gray-100">
                    <span class="text-[10px] text-gray-400 font-mono font-bold mr-1">åŒ¯ç‡</span>
                    <input type="number" id="exchange-rate" value="0.215" step="0.001" onchange="renderExpenses(); renderPublicFund();" class="w-16 text-center rounded text-sm outline-none border-b border-gray-200 py-1 text-fuji font-bold bg-transparent">
                </div>
            </div>
            
            <div class="flex overflow-x-auto gap-4 pb-4 no-scrollbar mb-4" id="wallet-dashboard-container"></div>
            
            <div class="flex justify-between items-center mb-4 mt-4 px-1">
                <h4 class="text-sm font-bold text-gray-400 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> æœ€è¿‘æ”¯å‡º</h4>
                <div class="flex gap-2">
                    <button onclick="openMemberModal()" class="text-xs text-gray-500 bg-white border border-gray-200 rounded-lg px-3 py-1.5 shadow-sm">æˆå“¡ç®¡ç†</button>
                    <button onclick="openIOUModal()" class="text-xs text-fuji bg-fuji/5 border border-fuji/20 rounded-lg px-3 py-1.5 shadow-sm">å€Ÿæ¬¾</button>
                </div>
            </div>
            
            <div id="expense-list" class="space-y-3 pb-24 md:grid md:grid-cols-2 md:gap-3 md:space-y-0"></div>
            
            <div class="fixed bottom-24 right-6 md:right-10 z-30">
                <button onclick="openExpenseModal()" class="bg-ink text-white rounded-full h-14 px-6 shadow-float flex items-center gap-2 hover:scale-105 transition active:scale-95 border-2 border-white/20">
                    <i class="fa-solid fa-pen-nib text-xl"></i> <span class="font-bold handwritten tracking-widest text-lg">è¨˜ä¸€ç­†</span>
                </button>
            </div>
        </section>

        <!-- ================= LISTS SECTION ================= -->
        <section id="view-lists" class="view-section hidden relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- Shopping -->
                <div class="hand-card p-0 bg-white border-l-8 border-white overflow-hidden flex flex-col" id="shopping-card">
                     <div class="p-4 pb-2 border-b border-gray-50 bg-white z-10 sticky top-0">
                         <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold text-pencil handwritten flex items-center gap-2"><i class="fa-solid fa-bag-shopping text-red-400"></i> è³¼ç‰©æ¸…å–®</h3>
                            <button onclick="openShoppingModal()" class="text-xs bg-red-50 text-red-500 px-3 py-1.5 rounded-lg border border-red-100 font-bold">æ–°å¢</button>
                         </div>
                         <!-- Categories -->
                         <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1" id="shop-category-tabs"></div>
                     </div>
                     <div id="shopping-swipe-area" class="flex-1 p-4 pt-4 min-h-[300px]">
                         <div id="shopping-list-pending" class="grid grid-cols-2 gap-3 mb-4"></div>
                         <div class="flex items-center gap-2 mb-2 opacity-60"><div class="h-px bg-gray-200 flex-1"></div><span class="text-[10px] text-gray-400">å·²è³¼è²·</span><div class="h-px bg-gray-200 flex-1"></div></div>
                         <div id="shopping-list-done" class="grid grid-cols-2 gap-3 opacity-60 grayscale filter"></div>
                     </div>
                </div>

                <!-- Must Eat -->
                <div class="hand-card p-6 bg-[#fffdf0] border-l-8 border-[#fffdf0]">
                     <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-300 pb-2">
                        <h3 class="text-xl font-bold text-pencil handwritten flex items-center gap-2"><i class="fa-solid fa-utensils text-matcha"></i> å¿…åƒæ¸…å–®</h3>
                        <button onclick="openMustEatModal()" class="text-xs bg-matcha/10 text-green-700 px-3 py-1.5 rounded-lg border border-matcha/30 font-bold">æ–°å¢/ç·¨è¼¯</button>
                     </div>
                     <div id="must-eat-list" class="space-y-3"></div>
                </div>
                
                 <div class="hand-card p-6 bg-[#fffff0] rotate-1 shadow-md border-t-8 border-[#e6e6d8]/30">
                    <h3 class="text-lg font-bold mb-2 handwritten text-yellow-800 flex items-center gap-2"><i class="fa-solid fa-note-sticky"></i> éš¨æ‰‹è¨˜</h3>
                    <textarea id="memo-pad" class="w-full h-48 p-3 bg-transparent border-none resize-none text-sm leading-8 outline-none text-gray-700 handwritten" style="background-image: repeating-linear-gradient(transparent, transparent 31px, #e5e5e5 32px); line-height: 32px;" placeholder="åœ¨é€™è£¡éš¨æ‰‹è¨˜ä¸‹æƒ³æ³•..."></textarea>
                </div>
            </div>
        </section>

        <!-- ================= INFO SECTION ================= -->
        <section id="view-info" class="view-section hidden relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <!-- Sync Config -->
                <div class="hand-card p-6 border-l-8 border-gray-200">
                    <h3 class="font-bold text-gray-600 handwritten text-xl flex items-center gap-2 mb-4"><i class="fa-brands fa-github"></i> é›²ç«¯å‚™ä»½è¨­å®š</h3>
                    <p class="text-xs text-gray-400 mb-3">ä½¿ç”¨ GitHub Gist ID èˆ‡ Token ä¾†åŒæ­¥æ‰€æœ‰è£ç½®ã€‚</p>
                    <div class="space-y-3">
                        <input type="text" id="gist-id-input" placeholder="Gist ID" class="w-full border p-2 rounded text-xs bg-gray-50 font-mono">
                        <input type="password" id="gist-token-input" placeholder="Token" class="w-full border p-2 rounded text-xs bg-gray-50 font-mono">
                        <button onclick="saveGistConfig()" class="w-full bg-ink text-white px-3 py-2 rounded text-sm font-bold shadow hover:bg-black transition">å„²å­˜ä¸¦é€£ç·š</button>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="hand-card p-4 flex justify-between items-center bg-blue-50/30 border border-blue-100" onclick="toggleVJW()">
                        <h3 class="font-bold text-blue-800 handwritten text-lg flex items-center gap-2"><i class="fa-solid fa-passport"></i>Visit Japan Web</h3>
                        <a href="https://www.vjw.digital.go.jp/" target="_blank" onclick="event.stopPropagation()" class="text-xs bg-white text-blue-500 px-3 py-1.5 rounded-full shadow-sm font-bold"><i class="fa-solid fa-link"></i></a>
                    </div>
                    <div id="vjw-content" class="transition-all duration-300 overflow-hidden max-h-0"><div class="p-4"><div id="vjw-container" class="flex overflow-x-auto gap-4"></div></div></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <a href="https://tenki.jp/" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-blue-50 transition"><i class="fa-solid fa-cloud-sun-rain text-3xl text-fuji mb-2"></i><span class="font-bold text-sm text-gray-600">Tenki.jp å¤©æ°£</span></a>
                        <a href="https://www.google.com/maps/search/drugstore" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-pink-50 transition"><i class="fa-solid fa-store text-3xl text-sakura mb-2"></i><span class="font-bold text-sm text-gray-600">é™„è¿‘è—¥å¦</span></a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ================= MODALS ================= -->
    
    <!-- Day Modal -->
    <div id="day-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-lg rounded-2xl p-4 shadow-2xl relative hand-card h-[85vh] overflow-y-auto border-4 border-white">
            <button onclick="closeModal('day-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-2 text-center handwritten">ç·¨è¼¯è¡Œç¨‹</h3>
            <input type="hidden" id="day-id-edit">
            <div class="flex gap-2 items-center mb-2"><input type="text" id="day-date-edit" class="flex-1 p-2 border-b-2 border-matcha bg-transparent font-bold text-xl" placeholder="æ—¥æœŸæ¨™é¡Œ"><select id="day-weather-edit" class="bg-white border rounded p-1 text-2xl h-10 w-24"><option value="">â˜</option><option value="sunny">â˜€</option><option value="cloudy">â˜</option><option value="rain">â˜‚</option><option value="snow">â›„</option></select></div>
            <label class="flex items-center space-x-2 text-sm text-gray-600 mb-4 bg-yellow-50 p-2 rounded"><input type="checkbox" id="day-highlight-edit" class="accent-red-400"><span>é‡é»å¤©æ•¸</span></label>
            
            <div class="mb-4 bg-white p-2 rounded border border-gray-200"><div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-gray-400">ç•¶æ—¥ç›¸ç‰‡é›†</h4><div class="relative overflow-hidden inline-block"><button class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs"><i class="fa-solid fa-plus"></i> æ–°å¢</button><input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addDayPhoto(this)"></div></div><div id="day-photos-preview" class="grid grid-cols-3 gap-2"></div></div>
            
            <div class="mb-4"><input type="text" id="day-accommodation-edit" class="w-full p-2 border rounded text-sm mb-2" placeholder="ä½å®¿åç¨±"><input type="url" id="day-accommodation-url-edit" class="w-full p-2 border rounded text-sm" placeholder="Google Maps é€£çµ"></div>
            
            <div class="mb-4 border-t pt-3 bg-gray-50 p-2 rounded-lg border border-gray-100"><h4 class="text-xs font-bold text-gray-400 mb-2"><i class="fa-solid fa-train"></i> äº¤é€šæ–¹å¼</h4><div class="flex gap-2 mb-2"><input type="time" id="day-trans-time" class="w-1/3 p-2 border rounded text-sm"><input type="text" id="day-trans-content" placeholder="å…§å®¹" class="flex-1 p-2 border rounded text-sm"></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative bg-white"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (b)=>{currentTransPhoto=b;document.getElementById('trans-photo-preview').src=b;document.getElementById('trans-photo-preview').classList.remove('hidden');document.getElementById('trans-photo-text').classList.add('hidden');})"><div id="trans-photo-text" class="text-xs text-gray-400">ä¸Šå‚³è»Šç¥¨</div><img id="trans-photo-preview" class="hidden h-20 mx-auto object-contain rounded"><button onclick="clearTransPhoto()" class="absolute top-1 right-1 bg-gray-200 rounded-full w-5 h-5 text-[10px] text-gray-500 z-10">x</button></div></div>
            
            <textarea id="day-content-edit" class="w-full h-32 p-3 border rounded-lg bg-white text-sm mb-4" placeholder="è¡Œç¨‹å…§å®¹..."></textarea>
            
            <div class="bg-white p-3 rounded-lg border mb-4 space-y-4 shadow-sm">
                <h4 class="text-xs font-bold text-gray-400 border-b pb-1">ä¸‰é¤å®‰æ’ (åç¨± / é€£çµ)</h4>
                <div class="border-b pb-2"><div class="flex gap-2 mb-1 items-center"><i class="fa-solid fa-mug-hot text-orange-300 w-5"></i><input type="text" id="meal-b-name" placeholder="æ—©é¤åç¨±" class="w-1/2 text-sm font-bold bg-gray-50 p-1 rounded"><input type="text" id="meal-b-url" placeholder="é€£çµ (Google Map/IG)" class="flex-1 text-xs border p-1 rounded"></div></div>
                <div class="border-b pb-2"><div class="flex gap-2 mb-1 items-center"><i class="fa-solid fa-utensils text-green-400 w-5"></i><input type="text" id="meal-l-name" placeholder="åˆé¤åç¨±" class="w-1/2 text-sm font-bold bg-gray-50 p-1 rounded"><input type="text" id="meal-l-url" placeholder="é€£çµ" class="flex-1 text-xs border p-1 rounded"></div></div>
                <div><div class="flex gap-2 mb-1 items-center"><i class="fa-solid fa-wine-glass text-purple-400 w-5"></i><input type="text" id="meal-d-name" placeholder="æ™šé¤åç¨±" class="w-1/2 text-sm font-bold bg-gray-50 p-1 rounded"><input type="text" id="meal-d-url" placeholder="é€£çµ" class="flex-1 text-xs border p-1 rounded"></div></div>
            </div>
            
            <textarea id="day-note-edit" class="w-full h-20 p-2 border border-yellow-200 bg-yellow-50 rounded text-sm mb-4" placeholder="æ¯æ—¥å‚™è¨»..."></textarea>
            <div class="flex gap-2"><button onclick="deleteDay()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm">åˆªé™¤</button><button onclick="saveDay()" class="flex-[2] bg-matcha text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expense-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-expense-bg w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative hand-card border border-white"><button onclick="closeModal('expense-modal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-xl font-bold mb-6 text-center text-gray-700">æ–°å¢ç´€éŒ„</h3><input type="hidden" id="ex-id"><div class="flex justify-between mb-6 overflow-x-auto pb-2 no-scrollbar gap-2" id="expense-categories"></div><div class="flex items-center justify-center gap-2 mb-6"><select id="ex-currency" class="bg-gray-100 font-bold rounded-lg px-2 py-1 border-none"><option value="JPY">JPY</option><option value="TWD">TWD</option></select><input type="number" id="ex-amount" placeholder="0" class="text-4xl font-bold text-center w-40 outline-none bg-transparent border-b-2 border-gray-100 text-gray-700"></div><div class="mb-6"><label class="block text-xs text-gray-400 mb-2 font-bold ml-1">ä»˜æ¬¾äºº</label><div id="ex-payer-container" class="flex flex-wrap gap-2"></div></div><div class="mb-4"><input type="text" id="ex-note" placeholder="å‚™è¨»..." class="w-full bg-gray-50 rounded-xl p-3 text-sm outline-none border border-gray-100"></div><div class="flex gap-3"><button onclick="deleteExpense()" id="btn-delete-expense" class="w-12 h-12 rounded-full bg-gray-100 text-gray-400 hidden"><i class="fa-solid fa-trash-can"></i></button><button onclick="saveExpense()" class="flex-1 bg-ink text-white py-3 rounded-full font-bold shadow-lg">ç¢ºèªå„²å­˜</button></div></div></div>

    <!-- Shopping Modal -->
    <div id="shopping-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card"><button onclick="closeModal('shopping-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-bold mb-3 text-center">è³¼ç‰©é …ç›®</h3><input type="hidden" id="shop-id"><input type="text" id="shop-name" placeholder="å•†å“åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold"><div class="mb-3"><label class="text-xs text-gray-400">åˆ†é¡</label><select id="shop-cat-select" class="w-full border rounded p-2 text-sm bg-white"></select><div class="mt-1 flex gap-2"><input type="text" id="new-shop-cat" placeholder="æ–°åˆ†é¡" class="border rounded p-1 text-xs w-20"><button onclick="addShopCat()" class="bg-gray-200 text-xs px-2 rounded hover:bg-gray-300">+</button></div></div><div class="flex gap-2 mb-3"><div class="flex-1"><label class="text-xs text-gray-400">æ•¸é‡</label><input type="number" id="shop-qty" value="1" class="w-full border rounded p-2 text-sm"></div><div class="flex-[2]"><label class="text-xs text-gray-400">å–®åƒ¹ (JPY)</label><input type="number" id="shop-price" placeholder="0" class="w-full border rounded p-2 text-sm"></div></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center relative mb-4 bg-white"><input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="processImage(this, (b)=>{currentShopPhoto=b;document.getElementById('shop-photo-preview').src=b;document.getElementById('shop-photo-preview').classList.remove('hidden');})"><img id="shop-photo-preview" class="hidden h-32 mx-auto object-contain rounded"></div><button onclick="saveShoppingItem()" class="w-full bg-red-400 text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div></div>

    <!-- Shop Check Modal -->
    <div id="shop-check-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl text-center"><h3 class="font-bold text-lg mb-2">å·²è³¼è²·ç¢ºèª</h3><p class="text-sm text-gray-500 mb-6">æ‚¨è¦å°‡æ­¤é …ç›®è¨˜å¸³å—ï¼Ÿ</p><div class="space-y-3"><button onclick="confirmShopExpense(true)" class="w-full bg-ink text-white py-3 rounded-xl font-bold shadow-lg">æ˜¯ï¼Œè¨˜å¸³ä¸¦å®Œæˆ</button><button onclick="confirmShopExpense(false)" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">å¦ï¼Œåƒ…æ¨™ç¤ºå·²è²·</button><button onclick="closeModal('shop-check-modal')" class="w-full text-gray-400 py-2 text-sm">å–æ¶ˆ</button></div></div></div>

    <!-- Flight Modal -->
    <div id="flight-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-3xl p-6 shadow-2xl relative hand-card"><button onclick="closeModal('flight-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center handwritten">ç·¨è¼¯èˆªç­</h3><input type="hidden" id="flight-id"><div class="flex gap-4 items-center mb-4"><input type="text" id="flight-dep" placeholder="TPE" class="w-1/2 p-3 text-center font-black text-3xl border-2 rounded-xl bg-white"><i class="fa-solid fa-plane text-gray-300"></i><input type="text" id="flight-arr" placeholder="NRT" class="w-1/2 p-3 text-center font-black text-3xl border-2 rounded-xl bg-white"></div><input type="text" id="flight-code" placeholder="èˆªç­ä»£è™Ÿ" class="w-full p-2 border-b bg-transparent text-center font-bold text-xl mb-2"><input type="text" id="flight-date" placeholder="æ—¥æœŸ" class="w-full p-1 bg-transparent text-center text-sm mb-1"><input type="text" id="flight-time" placeholder="æ™‚é–“" class="w-full p-1 bg-transparent text-center text-sm mb-4"><button onclick="saveFlight()" class="w-full bg-fuji text-white py-3 rounded-xl font-bold shadow-lg">å„² å­˜</button></div></div>

    <!-- Guide Modal -->
    <div id="guide-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card"><button onclick="closeModal('guide-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-bold mb-3 handwritten text-lg">ç·¨è¼¯æ™¯é»</h3><input type="hidden" id="guide-id"><input type="text" id="guide-title" placeholder="æ™¯é»åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold text-lg"><textarea id="guide-desc" placeholder="ä»‹ç´¹..." class="w-full mb-3 border bg-white p-2 rounded h-24 text-sm"></textarea><div class="flex gap-2 mb-3"><input type="text" id="guide-price" placeholder="é ç®—" class="w-1/2 border rounded p-2 text-xs bg-white"><input type="text" id="guide-time" placeholder="æ™‚é–“" class="w-1/2 border rounded p-2 text-xs bg-white"></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative mb-3 bg-white"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (b)=>{currentGuidePhoto=b;document.getElementById('guide-photo-preview').src=b;document.getElementById('guide-photo-preview').classList.remove('hidden');document.getElementById('guide-photo-text').classList.add('hidden');})"><div id="guide-photo-text" class="text-xs text-gray-400">æ›´æ–°ç…§ç‰‡</div><img id="guide-photo-preview" class="hidden h-32 mx-auto object-cover rounded"></div><button onclick="saveGuide()" class="w-full bg-matcha text-white py-2 rounded-lg font-bold">å„²å­˜</button></div></div>

    <!-- Must Eat Modal -->
    <div id="must-eat-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card"><button onclick="closeModal('must-eat-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center text-matcha">ğŸ½ï¸ ç·¨è¼¯å¿…åƒ</h3><input type="hidden" id="eat-loc-id"><input type="text" id="eat-location" placeholder="åœ°é»åç¨±" class="w-full p-2 border-b-2 border-matcha/50 bg-transparent font-bold text-lg mb-4"><div id="eat-themes-container" class="space-y-3 mb-4"></div><button onclick="addThemeRow()" class="w-full py-2 border-2 border-dashed border-matcha/30 text-matcha rounded-lg text-sm font-bold mb-4">æ–°å¢ä¸»é¡Œ</button><div class="flex gap-2"><button onclick="deleteMustEatLocation()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg">åˆªé™¤</button><button onclick="saveMustEatLocation()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div></div></div>

    <!-- Member Modal -->
    <div id="member-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg"><h4 class="font-bold mb-3 text-center">ç®¡ç†æˆå“¡</h4><div id="member-list" class="space-y-2 mb-3 max-h-60 overflow-y-auto"></div><div class="flex gap-2"><input type="text" id="new-payer-name" placeholder="æ–°æˆå“¡åç¨±" class="flex-1 border p-1 text-sm rounded"><button onclick="addPayer()" class="bg-matcha text-white px-3 rounded text-sm">æ–°å¢</button></div><button onclick="closeModal('member-modal')" class="w-full mt-3 bg-gray-200 py-1 rounded text-sm">é—œé–‰</button></div></div>
    
    <!-- IOU Modal -->
    <div id="iou-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto"><button onclick="closeModal('iou-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center text-fuji">ğŸ¤ æ‰‹å‹•æ¬ æ¬¾/å€Ÿæ¬¾</h3><input type="hidden" id="iou-id"><div class="space-y-3 p-3 border rounded-lg bg-white mb-4"><div class="text-xs text-gray-500 mb-1">èª°å€Ÿçµ¦èª°ï¼Ÿ</div><div class="flex gap-2"><div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µæ¬Šäºº</label><select id="iou-creditor" class="w-full bg-white border rounded p-1 text-sm"></select></div><div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µå‹™äºº</label><select id="iou-debtor" class="w-full bg-white border rounded p-1 text-sm"></select></div></div><div class="flex items-center gap-2 bg-gray-50 border rounded p-2"><span class="font-bold text-sm">TWD</span><input type="number" id="iou-amount" placeholder="é‡‘é¡" class="flex-1 text-lg text-right w-full bg-transparent" inputmode="numeric"></div><input type="text" id="iou-note" placeholder="å‚™è¨»" class="w-full p-2 border rounded text-sm"><div class="flex gap-2 mt-3"><button onclick="deleteIOU()" id="btn-delete-iou" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden">åˆªé™¤</button><button onclick="saveIOU()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div></div><h4 class="text-sm font-bold text-gray-600 mb-2">åˆ—è¡¨:</h4><div id="iou-list-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner"></div></div></div>

    <!-- Lightbox -->
    <div id="lightbox-modal" class="modal hidden fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('lightbox-modal')"><div class="absolute top-4 right-4 text-white/80 z-50 cursor-pointer bg-white/10 rounded-full w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-times"></i></div><div id="lightbox-container" class="zoom-container w-full h-full flex items-center justify-center" onclick="event.stopPropagation()"><img id="lightbox-image" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded" onclick="toggleZoom(this)"></div></div>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#f9f7f2]/95 border-t border-gray-200 pt-2 pb-safe px-6 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] backdrop-blur-sm" style="padding-bottom: calc(10px + var(--sab));">
        <div class="flex justify-between items-center w-full mx-auto pb-1 max-w-lg">
            <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center text-gray-400 flex-1 transition" data-target="plan"><i class="fa-solid fa-map text-lg mb-1"></i><span class="text-[10px] font-bold">è¡Œç¨‹</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center text-gray-400 flex-1 transition" data-target="guide"><i class="fa-solid fa-book-open text-lg mb-1"></i><span class="text-[10px] font-bold">å°è¦½</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-gray-400 flex-1 transition" data-target="wallet"><i class="fa-solid fa-wallet text-lg mb-1"></i><span class="text-[10px] font-bold">è¨˜å¸³</span></button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center text-gray-400 flex-1 transition" data-target="lists"><i class="fa-solid fa-list-check text-lg mb-1"></i><span class="text-[10px] font-bold">æ¸…å–®</span></button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center text-gray-400 flex-1 transition" data-target="info"><i class="fa-solid fa-circle-info text-lg mb-1"></i><span class="text-[10px] font-bold">è³‡è¨Š</span></button>
        </div>
    </nav>

    <!-- SCRIPTS -->
    <script>
        // --- 1. CONFIG & DATA ---
        const PRELOADED_GUIDES = [{id: 101, title: "ç¯„ä¾‹å°è¦½ï¼šæ±äº¬éµå¡”", price: "Â¥1200", desc: "å¿…å»çš„ç¶“å…¸åœ°æ¨™ã€‚", photo: "", time: "09:00 - 23:00"}];
        const WEATHER_MAP = {'sunny': 'â˜€', 'cloudy': 'â˜', 'rain': 'â˜‚', 'snow': 'â›„'};
        const expenseCategories = [{ id: 'é¤é£²', icon: 'fa-utensils', color: 'bg-yellow-100 text-yellow-600' }, { id: 'äº¤é€š', icon: 'fa-train-subway', color: 'bg-blue-100 text-blue-600' }, { id: 'è³¼ç‰©', icon: 'fa-bag-shopping', color: 'bg-pink-100 text-pink-600' }, { id: 'é–€ç¥¨', icon: 'fa-ticket', color: 'bg-green-100 text-green-600' }, { id: 'ä½å®¿', icon: 'fa-bed', color: 'bg-purple-100 text-purple-600' }, { id: 'å…¶ä»–', icon: 'fa-asterisk', color: 'bg-gray-100 text-gray-600' }];
        const RECOVERED_PAYERS = ["æˆ‘", "æ—…ä¼´", "å…¬è²»"];

        let flights=[], itinerary=[], mustEatList=[], expenses=[], guides=[], shoppingList=[], payers=[], payerProfiles={}, manualDebts=[], memoText="", todos=[], shoppingOwners=["æˆ‘çš„æ¸…å–®"];
        let shoppingCategories = ["All", "è—¥å¦", "é›¶é£Ÿ", "é›»å™¨", "ä¼´æ‰‹ç¦®", "è¡£ç‰©"];
        let publicFundSettings = { total: 0, currency: 'JPY' };
        let vjwData={isOpen:true,items:[]}, gistId="", gistToken="";
        let tempThemes=[], currentPhotoBase64=null, currentGuidePhoto=null, currentShopPhoto=null, currentTransPhoto=null, tempDayPhotos=[], selectedPayers=[], selectedCat='é¤é£²';
        let currentShopCat = "All", tempShopItemForCheck = null;

        // --- 2. CORE STORAGE ---
        function reloadLocalData() {
            flights = JSON.parse(localStorage.getItem('flights')) || [];
            itinerary = JSON.parse(localStorage.getItem('itinerary_v2')) || [];
            mustEatList = JSON.parse(localStorage.getItem('mustEatList')) || [];
            expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            guides = JSON.parse(localStorage.getItem('guides')) || PRELOADED_GUIDES;
            shoppingList = JSON.parse(localStorage.getItem('shoppingList_v3')) || [];
            payers = JSON.parse(localStorage.getItem('payers')) || RECOVERED_PAYERS;
            if(!payers.includes("å…¬è²»")) payers.push("å…¬è²»");
            payerProfiles = JSON.parse(localStorage.getItem('payerProfiles')) || {};
            manualDebts = JSON.parse(localStorage.getItem('manualDebts_v1')) || [];
            memoText = localStorage.getItem('memo') || "";
            publicFundSettings = JSON.parse(localStorage.getItem('publicFundSettings')) || {total: 0, currency: 'JPY'};
            shoppingCategories = JSON.parse(localStorage.getItem('shoppingCategories')) || ["All", "è—¥å¦", "é›¶é£Ÿ", "é›»å™¨", "ä¼´æ‰‹ç¦®", "è¡£ç‰©"];
            vjwData = JSON.parse(localStorage.getItem('vjwData')) || { isOpen: true, items: [] };
            gistId = localStorage.getItem('gist_id') || ""; 
            gistToken = localStorage.getItem('gist_token') || "";
            mustEatList.forEach(m => { if(!m.themes) m.themes = []; });
        }

        function saveData() {
            localStorage.setItem('flights', JSON.stringify(flights));
            localStorage.setItem('itinerary_v2', JSON.stringify(itinerary));
            localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('guides', JSON.stringify(guides));
            localStorage.setItem('shoppingList_v3', JSON.stringify(shoppingList));
            localStorage.setItem('payers', JSON.stringify(payers));
            localStorage.setItem('payerProfiles', JSON.stringify(payerProfiles));
            localStorage.setItem('manualDebts_v1', JSON.stringify(manualDebts));
            localStorage.setItem('memo', memoText); 
            localStorage.setItem('publicFundSettings', JSON.stringify(publicFundSettings));
            localStorage.setItem('shoppingCategories', JSON.stringify(shoppingCategories));
            localStorage.setItem('vjwData', JSON.stringify(vjwData));
        }

        // --- 3. UTILS ---
        function checkUrl(str) { if(!str) return null; if(str.startsWith('http') || str.startsWith('www')) return str; return null; }
        function quickExpense(note, cat, amt=0) { document.getElementById('ex-note').value = note; document.getElementById('ex-amount').value = amt || ''; selectedCat = cat; openExpenseModal(); }
        function jumpToGuide(id) { switchTab('guide'); setTimeout(() => { const el = document.getElementById(`guide-${id}`); if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 300); }
        function openModal(id){document.getElementById(id).classList.remove('hidden');setTimeout(()=>document.getElementById(id).classList.add('visible'),10);}
        function closeModal(id){const el=document.getElementById(id);el.classList.remove('visible');setTimeout(()=>el.classList.add('hidden'),200);}
        function switchTab(t){ document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); document.getElementById('view-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); document.querySelector(`[data-target="${t}"]`).classList.add('active'); window.scrollTo(0,0); }
        function processImage(input, cb) { if(input.files[0]){const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas'),x=c.getContext('2d'),max=800;let w=i.width,h=i.height;if(w>h&&w>max){h*=max/w;w=max}else if(h>max){w*=max/h;h=max}c.width=w;c.height=h;x.drawImage(i,0,0,w,h);cb(c.toDataURL('image/jpeg',0.6))};i.src=e.target.result};r.readAsDataURL(input.files[0])} }
        function viewPhoto(src) { document.getElementById('lightbox-image').src = src; openModal('lightbox-modal'); }
        function toggleZoom(img) { if(img.classList.contains('zoomed')){img.classList.remove('zoomed');}else{img.classList.add('zoomed');} }

        // --- 4. PUBLIC FUND (Separate Logic) ---
        function editPublicFund() {
            const val = prompt("è«‹è¼¸å…¥å…¬è²»ç¸½é ç®— (JPY):", publicFundSettings.total);
            if(val !== null) { publicFundSettings.total = parseInt(val) || 0; saveData(); renderPublicFund(); }
        }
        function renderPublicFund() {
            let used = 0;
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.215;
            
            expenses.forEach(e => {
                // Only subtract if payer is explicitly 'å…¬è²»'
                if(e.payer === 'å…¬è²»') {
                    // Normalize to JPY (Fund Base)
                    let amountInJpy = (e.curr === 'TWD') ? (e.amt / rate) : parseFloat(e.amt);
                    used += amountInJpy;
                }
            });
            
            const remain = publicFundSettings.total - used;
            document.getElementById('public-fund-total').innerText = 'JPY ' + publicFundSettings.total.toLocaleString();
            document.getElementById('public-fund-remaining').innerText = Math.round(remain).toLocaleString();
            
            const pct = Math.max(0, Math.min(100, (remain / publicFundSettings.total) * 100));
            document.getElementById('public-fund-bar').style.width = pct + '%';
            document.getElementById('public-fund-bar').className = `fund-bar h-full rounded-full ${pct < 20 ? 'bg-red-400' : 'bg-fuji'}`;
        }

        // --- 5. ITINERARY (Interaction Fixed) ---
        function renderItinerary() {
            const c = document.getElementById('itinerary-container'); c.innerHTML = '';
            itinerary.forEach((day) => {
                // Deep Link Logic for Guides in Content
                let contentHtml = day.content.split('\n').map(line => {
                    let processedLine = line;
                    guides.forEach(g => {
                        if(line.includes(g.title)) {
                            processedLine = line.replace(g.title, `<span class="guide-link" onclick="jumpToGuide(${g.id})"><i class="fa-solid fa-map-pin"></i> ${g.title}</span>`);
                        }
                    });
                    return `<li class="flex items-start text-base"><span class="mr-2 mt-2 w-2 h-2 bg-sakura rounded-full flex-shrink-0 border border-red-200"></span><span class="flex-1">${processedLine}</span></li>`;
                }).join('');
                
                const wIcon = WEATHER_MAP[day.weather] || '';
                const accLink = day.accommodationUrl || checkUrl(day.accommodation);
                const accHtml = day.accommodation ? `<div class="mt-3 text-sm text-gray-600 flex items-center gap-2 border-t pt-3 border-dashed border-gray-200"><i class="fa-solid fa-bed text-fuji"></i> ${accLink ? `<a href="${accLink}" target="_blank" class="smart-link">${day.accommodation}</a>` : `<span class="font-bold">${day.accommodation}</span>`}</div>` : '';

                // V17 Meal Interaction Logic
                const renderMeal = (type, label, icon, color) => {
                    const m = day.meals?.[type];
                    if(!m || !m.name) return '';
                    const url = m.url || checkUrl(m.name);
                    
                    // Icon -> Expense
                    const iconHtml = `<i class="fa-solid ${icon} ${color} cursor-pointer hover:scale-110 transition p-1" onclick="quickExpense('${m.name}','é¤é£²')" title="è¨˜ä¸€ç­†"></i>`;
                    
                    // Text -> Link
                    const textHtml = url 
                        ? `<a href="${url}" target="_blank" class="text-fuji underline decoration-dotted font-bold hover:text-fuji/80" title="é–‹å•Ÿé€£çµ">${m.name} <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a>`
                        : `<span class="font-bold text-gray-700 cursor-default">${m.name}</span>`;

                    return `<div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-gray-400 w-6">${label}</span>
                                <div class="flex-1 flex items-center gap-2 bg-gray-50 p-1.5 rounded transition hover:bg-white hover:shadow-sm">
                                    ${iconHtml}
                                    ${textHtml}
                                </div>
                            </div>`;
                };
                
                const mealsHtml = (day.meals && (day.meals.b?.name || day.meals.l?.name || day.meals.d?.name)) ? 
                    `<div class="mt-3 border-t border-dashed border-gray-200 pt-3 px-1">
                        ${renderMeal('b', 'æ—©é¤', 'fa-mug-hot', 'text-orange-300')}
                        ${renderMeal('l', 'åˆé¤', 'fa-utensils', 'text-green-400')}
                        ${renderMeal('d', 'æ™šé¤', 'fa-wine-glass', 'text-purple-400')}
                    </div>` : '';
                
                const photosHtml = day.photos?.length ? `<div class="mt-3 grid grid-cols-3 gap-1 rounded-lg overflow-hidden">${day.photos.map(p=>`<img src="${p}" class="w-full aspect-square object-cover cursor-pointer hover:opacity-90" onclick="viewPhoto('${p}')">`).join('')}</div>` : '';
                const transHtml = (day.transportation && (day.transportation.content || day.transportation.photo)) ? `<div class="mt-2 bg-gray-50 p-3 rounded-lg border border-gray-100 text-sm"><div class="font-bold text-gray-500 flex items-center gap-2 mb-1"><i class="fa-solid fa-train text-blue-400"></i> äº¤é€š ${day.transportation.time ? `<span class="text-xs font-normal bg-white px-2 py-0.5 rounded border border-gray-200 text-gray-400">${day.transportation.time}</span>` : ''}</div><div class="ml-6 text-gray-700 font-medium">${day.transportation.content||''}</div>${day.transportation.photo ? `<div class="mt-2 ml-6"><button onclick="viewPhoto('${day.transportation.photo}')" class="text-xs bg-white border border-blue-200 text-blue-500 px-2 py-1 rounded shadow-sm hover:bg-blue-50 transition flex items-center gap-1"><i class="fa-solid fa-ticket"></i> æŸ¥çœ‹è»Šç¥¨</button></div>` : ''}</div>` : '';
                const noteHtml = day.dayNote ? `<div class="mt-3 p-2 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-100 handwritten leading-relaxed"><i class="fa-solid fa-pencil mr-1"></i> ${day.dayNote}</div>` : '';

                c.innerHTML += `<div class="relative pl-8 border-l-2 ${day.highlight?'border-sakura':'border-gray-200'} pb-8"><div class="absolute -left-2.5 top-0 w-5 h-5 rounded-full ${day.highlight?'bg-sakura':'bg-gray-300'} border-4 border-paper shadow-sm"></div><div class="flex justify-between mb-2 items-center"><div class="flex items-center"><h3 class="font-black text-2xl handwritten ${day.highlight?'text-red-400':'text-pencil'}">${day.date}</h3>${wHtml}</div><button onclick="openDayEditor('${day.id}')" class="text-gray-300 hover:text-fuji p-2"><i class="fa-solid fa-pen"></i></button></div><div class="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 relative"><ul class="text-sm space-y-3 leading-relaxed text-gray-700 font-maru font-bold text-lg mb-3">${contentHtml}</ul>${photosHtml}${accHtml}${transHtml}${mealsHtml}${noteHtml}</div></div>`;
            });
        }
        
        function openDayEditor(id){ const d=itinerary.find(i=>i.id===id); document.getElementById('day-id-edit').value=d.id; document.getElementById('day-date-edit').value=d.date; document.getElementById('day-weather-edit').value=d.weather||""; document.getElementById('day-highlight-edit').checked=d.highlight; document.getElementById('day-content-edit').value=d.content; document.getElementById('day-accommodation-edit').value=d.accommodation; document.getElementById('day-accommodation-url-edit').value=d.accommodationUrl; document.getElementById('day-trans-content').value=d.transportation?.content||''; document.getElementById('day-trans-time').value=d.transportation?.time||''; currentTransPhoto=d.transportation?.photo; if(currentTransPhoto){ document.getElementById('trans-photo-preview').src = currentTransPhoto; document.getElementById('trans-photo-preview').classList.remove('hidden'); document.getElementById('trans-photo-text').classList.add('hidden'); } else { clearTransPhoto(); } document.getElementById('day-note-edit').value=d.dayNote||''; tempDayPhotos = d.photos ? [...d.photos] : []; renderDayPhotosPreview(); 
            ['b','l','d'].forEach(t=>{ 
                document.getElementById('meal-'+t+'-name').value=d.meals?.[t]?.name||'';
                document.getElementById('meal-'+t+'-url').value=d.meals?.[t]?.url||'';
            }); 
            openModal('day-modal'); 
        }
        function saveDay(){ 
            const idx=itinerary.findIndex(i=>i.id===document.getElementById('day-id-edit').value); const i=itinerary[idx]; 
            i.date=document.getElementById('day-date-edit').value; i.weather=document.getElementById('day-weather-edit').value; i.highlight=document.getElementById('day-highlight-edit').checked; i.content=document.getElementById('day-content-edit').value; i.accommodation=document.getElementById('day-accommodation-edit').value; i.accommodationUrl=document.getElementById('day-accommodation-url-edit').value; i.transportation={content:document.getElementById('day-trans-content').value, time:document.getElementById('day-trans-time').value, photo:currentTransPhoto}; i.dayNote=document.getElementById('day-note-edit').value; i.photos=[...tempDayPhotos]; 
            i.meals={
                b:{name:document.getElementById('meal-b-name').value, url:document.getElementById('meal-b-url').value},
                l:{name:document.getElementById('meal-l-name').value, url:document.getElementById('meal-l-url').value},
                d:{name:document.getElementById('meal-d-name').value, url:document.getElementById('meal-d-url').value}
            }; 
            saveData(); renderItinerary(); closeModal('day-modal'); 
        }

        // --- 6. SHOPPING ---
        function renderShoppingList() {
            const tabContainer = document.getElementById('shop-category-tabs');
            tabContainer.innerHTML = shoppingCategories.map(cat => 
                `<button onclick="currentShopCat='${cat}';renderShoppingList()" class="cat-tab px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap ${currentShopCat===cat ? 'active' : 'bg-gray-100 text-gray-500'}">${cat}</button>`
            ).join('');

            const list = shoppingList.filter(s => (currentShopCat === 'All' || s.category === currentShopCat));
            const p = document.getElementById('shopping-list-pending'), d = document.getElementById('shopping-list-done'); p.innerHTML=''; d.innerHTML='';
            list.forEach(s => {
                const h = `<div class="relative p-2 border shadow-sm rounded bg-white" onclick="openShoppingModal(${s.id})"><div class="absolute top-2 left-2 w-5 h-5 border-2 rounded ${s.done?'bg-red-400 border-red-400':''}" onclick="event.stopPropagation();handleShopItemClick(${s.id})"></div><div class="pl-8"><div class="font-bold">${s.name}</div><div class="text-[10px] text-gray-400 bg-gray-50 inline-block px-1 rounded mr-1">${s.category||'All'}</div><span class="text-xs text-gray-400">Â¥${s.price} x ${s.qty}</span></div></div>`;
                if(s.done) d.innerHTML+=h; else p.innerHTML+=h;
            });
        }
        function openShoppingModal(id=null){ 
            ['shop-id','shop-name','shop-qty','shop-price'].forEach(k=>document.getElementById(k).value=''); currentShopPhoto=null; document.getElementById('shop-photo-preview').classList.add('hidden'); 
            const sel = document.getElementById('shop-cat-select'); sel.innerHTML = shoppingCategories.filter(c=>c!=='All').map(c=>`<option value="${c}">${c}</option>`).join('');
            if(id){
                const s=shoppingList.find(i=>i.id===id);document.getElementById('shop-id').value=s.id;document.getElementById('shop-name').value=s.name;document.getElementById('shop-qty').value=s.qty;document.getElementById('shop-price').value=s.price;sel.value=s.category||shoppingCategories[1];
                if(s.photo){currentShopPhoto=s.photo;document.getElementById('shop-photo-preview').src=s.photo;document.getElementById('shop-photo-preview').classList.remove('hidden')}
            } else { if(currentShopCat!=='All') sel.value = currentShopCat; }
            openModal('shopping-modal'); 
        }
        function addShopCat() { const n=document.getElementById('new-shop-cat').value; if(n && !shoppingCategories.includes(n)) { shoppingCategories.push(n); saveData(); openShoppingModal(document.getElementById('shop-id').value || null); }}
        function saveShoppingItem(){ const id=document.getElementById('shop-id').value, name=document.getElementById('shop-name').value; if(!name)return; const item={ id:id?parseInt(id):Date.now(), name, qty:document.getElementById('shop-qty').value, price:document.getElementById('shop-price').value, photo:currentShopPhoto, done:false, category: document.getElementById('shop-cat-select').value }; if(id){const idx=shoppingList.findIndex(i=>i.id==id);item.done=shoppingList[idx].done;shoppingList[idx]=item;}else{shoppingList.push(item);} saveData(); renderShoppingList(); closeModal('shopping-modal'); }
        
        function handleShopItemClick(id) {
            const s = shoppingList.find(i => i.id === id);
            if(s.done) { s.done = false; saveData(); renderShoppingList(); } else { tempShopItemForCheck = s; openModal('shop-check-modal'); }
        }
        function confirmShopExpense(isExpense) {
            if(tempShopItemForCheck) {
                tempShopItemForCheck.done = true; 
                saveData(); 
                if(isExpense) { quickExpense(tempShopItemForCheck.name, 'è³¼ç‰©', tempShopItemForCheck.price * tempShopItemForCheck.qty); }
                renderShoppingList();
            }
            closeModal('shop-check-modal');
        }

        // --- 7. EXPENSES (Standard) ---
        function openExpenseModal(id=null) { 
            document.getElementById('expense-categories').innerHTML = expenseCategories.map(c => `<div onclick="selectedCat='${c.id}';openExpenseModal(document.getElementById('ex-id').value||null)" class="w-10 h-10 rounded-full flex items-center justify-center cursor-pointer ${selectedCat===c.id?'ring-2 ring-black '+c.color:'bg-gray-50 text-gray-400'}"><i class="fa-solid ${c.icon}"></i></div>`).join('');
            document.getElementById('ex-payer-container').innerHTML = payers.map(p => `<button onclick="togglePayer('${p}')" class="px-3 py-1.5 rounded-full text-xs border font-bold transition-all ${selectedPayers.includes(p) ? 'bg-ink text-white border-ink' : 'bg-white text-gray-500'}">${p}</button>`).join('');
            document.getElementById('btn-delete-expense').classList.add('hidden');
            if(id) { const ex = expenses.find(e => e.id == id); document.getElementById('ex-id').value = ex.id; document.getElementById('ex-amount').value = ex.amt; document.getElementById('ex-currency').value = ex.curr; document.getElementById('ex-note').value = ex.note; selectedCat = ex.cat; selectedPayers = (ex.payer || "").split(','); document.getElementById('btn-delete-expense').classList.remove('hidden'); }
            else if (!id && !document.getElementById('ex-note').value) { document.getElementById('ex-id').value = ''; document.getElementById('ex-amount').value = ''; document.getElementById('ex-note').value = ''; selectedPayers = ['æˆ‘']; }
            openModal('expense-modal');
        }
        function saveExpense() { const id=document.getElementById('ex-id').value, amt=parseFloat(document.getElementById('ex-amount').value); if(!amt) return; const ex={id:id?parseInt(id):Date.now(), cat:selectedCat, note:document.getElementById('ex-note').value, curr:document.getElementById('ex-currency').value, amt, payer:selectedPayers.join(','), photo:null}; if(id){const idx=expenses.findIndex(e=>e.id==id);expenses[idx]=ex;}else{expenses.push(ex);} saveData(); renderExpenses(); renderPublicFund(); closeModal('expense-modal'); }
        function deleteExpense(){ if(confirm("Del?")){ expenses=expenses.filter(e=>e.id!=document.getElementById('ex-id').value); saveData(); renderExpenses(); renderPublicFund(); closeModal('expense-modal'); } }
        function togglePayer(p) { if(selectedPayers.includes(p)) selectedPayers=selectedPayers.filter(x=>x!==p); else selectedPayers.push(p); if(selectedPayers.length===0)selectedPayers=[p]; openExpenseModal(document.getElementById('ex-id').value||null); }
        
        function renderExpenses() {
            const list = document.getElementById('expense-list'); list.innerHTML = '';
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            expenses.sort((a,b) => b.id - a.id).forEach(e => {
                const cat = expenseCategories.find(c => c.id === e.cat) || expenseCategories[5];
                list.innerHTML += `<div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-50 flex items-center gap-3 relative overflow-hidden" onclick="openExpenseModal(${e.id})"><div class="w-10 h-10 rounded-full ${cat.color} flex items-center justify-center flex-shrink-0 text-sm"><i class="fa-solid ${cat.icon}"></i></div><div class="flex-1"><div class="font-bold text-gray-700 text-sm truncate">${e.note || cat.id}</div><div class="text-[10px] text-gray-400">${e.payer}</div></div><div class="text-right"><div class="font-bold font-mono text-gray-800">${e.curr} ${parseFloat(e.amt).toLocaleString()}</div>${e.curr === 'JPY' ? `<div class="text-[10px] text-gray-400">â‰ˆ NT$ ${Math.round(e.amt * rate).toLocaleString()}</div>` : ''}</div></div>`;
            });
            const dash = document.getElementById('wallet-dashboard-container'); dash.innerHTML = '';
            payers.forEach(p => { let total = 0; expenses.forEach(e => { if((e.payer||"").includes(p)) { total += (e.curr==='JPY'?e.amt*rate:e.amt) / e.payer.split(',').length; } }); dash.innerHTML += `<div class="min-w-[140px] p-4 bg-white rounded-[24px] shadow-sm border border-gray-100"><div class="font-bold text-gray-700 text-sm mb-1">${p}</div><div class="text-lg font-bold font-mono text-gray-800">NT$ ${Math.round(total).toLocaleString()}</div></div>`; });
            renderPublicFund();
        }

        // --- 8. SYNC FIXED (Full Payload) ---
        function saveGistConfig() { gistId=document.getElementById('gist-id-input').value; gistToken=document.getElementById('gist-token-input').value; localStorage.setItem('gist_id',gistId); localStorage.setItem('gist_token',gistToken); alert("å·²å„²å­˜è¨­å®š"); forceDownload(); }
        
        function forceDownload() { 
            if(!gistId) { document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> æœªè¨­å®š'; return; }
            document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä¸‹è¼‰ä¸­...';
            
            fetch(`https://api.github.com/gists/${gistId}`)
            .then(r=>r.json())
            .then(d=>{ 
                const content = d.files["travel_data.json"].content;
                const c = JSON.parse(content);
                
                // Restore ALL keys
                localStorage.setItem('flights', JSON.stringify(c.flights||[]));
                localStorage.setItem('itinerary_v2', JSON.stringify(c.itinerary||[]));
                localStorage.setItem('mustEatList', JSON.stringify(c.mustEatList||[]));
                localStorage.setItem('expenses', JSON.stringify(c.expenses||[]));
                localStorage.setItem('guides', JSON.stringify(c.guides||[]));
                localStorage.setItem('shoppingList_v3', JSON.stringify(c.shoppingList||[]));
                localStorage.setItem('payers', JSON.stringify(c.payers||RECOVERED_PAYERS));
                localStorage.setItem('manualDebts_v1', JSON.stringify(c.manualDebts||[]));
                localStorage.setItem('memo', c.memoText||"");
                localStorage.setItem('publicFundSettings', JSON.stringify(c.publicFundSettings||{total:0}));
                localStorage.setItem('shoppingCategories', JSON.stringify(c.shoppingCategories||["All"]));
                localStorage.setItem('vjwData', JSON.stringify(c.vjwData||{isOpen:true,items:[]}));
                
                document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-check text-green-500"></i> å·²åŒæ­¥';
                window.location.reload(); 
            })
            .catch(err => {
                console.error(err);
                document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-xmark text-red-500"></i> å¤±æ•—';
                alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ ID/Token æˆ–ç¶²è·¯ã€‚");
            });
        }
        
        async function forceUpload() { 
            if(!gistId) return alert("è«‹å…ˆè¨­å®š Gist");
            document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';
            
            const payload = {
                flights, itinerary, mustEatList, expenses, guides, shoppingList, payers, 
                manualDebts, memoText, publicFundSettings, shoppingCategories, vjwData,
                lastUpdate: new Date().toISOString()
            };
            
            try {
                await fetch(`https://api.github.com/gists/${gistId}`, {
                    method:'PATCH', 
                    headers:{'Authorization':`token ${gistToken}`, 'Content-Type': 'application/json'}, 
                    body:JSON.stringify({files:{"travel_data.json":{content:JSON.stringify(payload)}}})
                }); 
                document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-check text-green-500"></i> å·²ä¸Šå‚³';
            } catch(e) {
                document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-xmark text-red-500"></i> ä¸Šå‚³å¤±æ•—';
            }
        }

        // --- Init ---
        // Flights, Guides, IOU, Members, VJW basics...
        function renderFlights() { document.getElementById('flight-list-container').innerHTML = flights.map(f=>`<div class="bg-white rounded-[24px] p-5 shadow-soft relative hand-card"><button onclick="editFlight(${f.id})" class="absolute top-3 right-3 text-gray-300"><i class="fa-solid fa-pen"></i></button><div class="flex justify-between items-center mb-4"><span class="text-4xl font-black handwritten text-pencil">${f.dep}</span><i class="fa-solid fa-plane text-fuji rotate-[-45deg]"></i><span class="text-4xl font-black handwritten text-pencil">${f.arr}</span></div><div class="bg-fuji-light rounded-2xl py-2 px-4 text-center"><div class="font-bold text-fuji">${f.code}</div><div class="text-xs text-gray-400">${f.date} ${f.time}</div></div></div>`).join(''); }
        function saveFlight(){ const id=document.getElementById('flight-id').value; const f={id:id?parseInt(id):Date.now(), dep:document.getElementById('flight-dep').value, arr:document.getElementById('flight-arr').value, code:document.getElementById('flight-code').value, time:document.getElementById('flight-time').value, date:document.getElementById('flight-date').value}; if(id){const idx=flights.findIndex(i=>i.id==id);if(idx>-1)flights[idx]=f;}else{flights.push(f);} saveData(); renderFlights(); closeModal('flight-modal'); }
        function editFlight(id){ const f=flights.find(i=>i.id==id); document.getElementById('flight-id').value=f.id;document.getElementById('flight-dep').value=f.dep;document.getElementById('flight-arr').value=f.arr;document.getElementById('flight-code').value=f.code;document.getElementById('flight-date').value=f.date;document.getElementById('flight-time').value=f.time;openModal('flight-modal'); }
        function openFlightModal(){ ['flight-id','flight-dep','flight-arr','flight-code','flight-date','flight-time'].forEach(k=>document.getElementById(k).value=''); openModal('flight-modal'); }
        function renderGuides(){ const l=document.getElementById('guide-list'); l.innerHTML=''; if(window.guideSortable) window.guideSortable.destroy(); guides.forEach(g=>{ l.innerHTML+=`<div id="guide-${g.id}" data-id="${g.id}" class="hand-card p-0 overflow-hidden relative group"><div class="drag-handle"><i class="fa-solid fa-grip-vertical text-gray-400"></i></div><button onclick="event.stopPropagation(); openGuideModal(${g.id})" class="absolute top-2 right-2 z-50 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center shadow"><i class="fa-solid fa-pen text-gray-500"></i></button>${g.photo?`<img src="${g.photo}" class="w-full h-40 object-cover ml-10" style="width:calc(100% - 2.5rem)" onclick="viewPhoto('${g.photo}')">`:''} <div class="p-4 pl-14"><h3 class="font-bold text-lg font-hand text-xl">${g.title}</h3><div class="flex gap-2 mb-2 mt-1">${g.price ? `<span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-0.5 rounded">${g.price}</span>` : ''}</div><p class="text-sm whitespace-pre-line text-gray-600 leading-relaxed">${g.desc}</p></div></div>`; }); window.guideSortable = new Sortable(l, { handle: '.drag-handle', animation: 150, onEnd: function (evt) { guides.splice(evt.newIndex, 0, guides.splice(evt.oldIndex, 1)[0]); saveData(); } }); }
        function openGuideModal(id=null) { currentGuidePhoto=null; document.getElementById('guide-photo-preview').classList.add('hidden'); document.getElementById('guide-photo-text').classList.remove('hidden'); if(id){const g=guides.find(i=>i.id==id); document.getElementById('guide-id').value=g.id; document.getElementById('guide-title').value=g.title; document.getElementById('guide-desc').value=g.desc; document.getElementById('guide-price').value=g.price||""; document.getElementById('guide-time').value=g.time||""; if(g.photo){currentGuidePhoto=g.photo; document.getElementById('guide-photo-preview').src=g.photo; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden');}} else { ['guide-id','guide-title','guide-desc','guide-price','guide-time'].forEach(k=>document.getElementById(k).value=''); } openModal('guide-modal'); }
        function saveGuide() { const id=document.getElementById('guide-id').value, t=document.getElementById('guide-title').value; if(!t)return; const newItem = {id:id?parseInt(id):Date.now(), title:t, desc:document.getElementById('guide-desc').value, price:document.getElementById('guide-price').value, time:document.getElementById('guide-time').value, photo:currentGuidePhoto||(id?guides.find(i=>i.id==id).photo:null)}; if(id){const idx=guides.findIndex(i=>i.id==id);if(idx>-1)guides[idx]=newItem;}else{guides.push(newItem);} saveData(); renderGuides(); closeModal('guide-modal'); }
        function addNewDay(){itinerary.push({id:'day_'+Date.now(),date:"New Day",highlight:false,content:"...",weather:"", meals:{}}); saveData(); renderItinerary();}
        function deleteDay(){if(confirm("Del?")){itinerary=itinerary.filter(d=>d.id!==document.getElementById('day-id-edit').value); saveData(); renderItinerary(); closeModal('day-modal');}}
        function addDayPhoto(input) { processImage(input, (base64) => { tempDayPhotos.push(base64); renderDayPhotosPreview(); }); }
        function renderDayPhotosPreview() { document.getElementById('day-photos-preview').innerHTML = tempDayPhotos.map((p, i) => `<div class="relative"><img src="${p}" class="w-full h-full rounded"><button onclick="tempDayPhotos.splice(${i},1);renderDayPhotosPreview()" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 text-xs">x</button></div>`).join(''); }
        function clearTransPhoto() { currentTransPhoto = null; document.getElementById('trans-photo-preview').src = ''; document.getElementById('trans-photo-preview').classList.add('hidden'); document.getElementById('trans-photo-text').classList.remove('hidden'); }
        function searchDayWeather() { const loc = document.getElementById('day-accommodation-edit').value || "Japan"; window.open(`https://www.google.com/search?q=${loc}+weather+${document.getElementById('day-date-edit').value}`, '_blank'); }
        function renderMustEatList() { document.getElementById('must-eat-list').innerHTML = mustEatList.map(l => `<div class="mb-6"><h4 class="text-lg font-black text-matcha border-b-2 border-matcha/30 inline-block px-2 mb-3">${l.location}</h4><div class="pl-2 border-l-2 border-matcha/10">${l.themes.map(t=>`<div class="bg-white p-3 rounded shadow-sm border border-gray-100 mb-2 flex justify-between"><span>${t.name}</span>${t.url?`<a href="${t.url}" target="_blank" class="text-fuji"><i class="fa-solid fa-link"></i></a>`:''}</div>`).join('')}</div></div>`).join(''); }
        function openMustEatModal(id=null) { document.getElementById('eat-location').value = ''; tempThemes = []; document.getElementById('eat-loc-id').value = ''; if(id) { const item = mustEatList.find(i => i.id === id); if(item) { document.getElementById('eat-loc-id').value = item.id; document.getElementById('eat-location').value = item.location; tempThemes = JSON.parse(JSON.stringify(item.themes)); } } else { tempThemes = [{id: Date.now(), name: '', url: '', isVeg: false}]; } renderThemeRows(); openModal('must-eat-modal'); }
        function renderThemeRows() { document.getElementById('eat-themes-container').innerHTML = tempThemes.map((t, idx) => `<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 relative group mb-2"><button onclick="tempThemes.splice(${idx},1);renderThemeRows()" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button><div class="flex items-center gap-2 mb-2"><input type="text" placeholder="é¤å»³åç¨±" class="flex-1 bg-transparent border-b border-gray-300 text-sm font-bold" value="${t.name}" oninput="tempThemes[${idx}].name=this.value"><label class="text-xs text-green-600"><input type="checkbox" ${t.isVeg ? 'checked' : ''} onchange="tempThemes[${idx}].isVeg=this.checked"> ç´ é£Ÿ</label></div><input type="url" placeholder="ç¶²å€" class="w-full bg-white border rounded text-xs p-1" value="${t.url||''}" oninput="tempThemes[${idx}].url=this.value"></div>`).join(''); }
        function addThemeRow() { tempThemes.push({id: Date.now(), name: '', url: '', isVeg: false}); renderThemeRows(); }
        function saveMustEatLocation() { const id = document.getElementById('eat-loc-id').value, location = document.getElementById('eat-location').value; if(!location) return alert("è«‹è¼¸å…¥åœ°é»"); const data = { id: id || 'loc_'+Date.now(), location, themes: tempThemes.filter(t => t.name) }; if(id) { const idx = mustEatList.findIndex(i => i.id === id); if(idx > -1) mustEatList[idx] = data; } else { mustEatList.push(data); } saveData(); renderMustEatList(); closeModal('must-eat-modal'); }
        function deleteMustEatLocation() { const id = document.getElementById('eat-loc-id').value; if(id && confirm("Del?")) { mustEatList = mustEatList.filter(i => i.id !== id); saveData(); renderMustEatList(); closeModal('must-eat-modal'); } }
        function openMemberModal(){ document.getElementById('member-list').innerHTML=payers.map((p,i)=>`<div class="flex justify-between p-2 bg-gray-50 rounded items-center"><span class="font-bold text-sm">${p}</span>${p!=='å…¬è²»'&&payers.length>2?`<button onclick="removePayer(${i})" class="text-red-400 text-xs px-2">åˆªé™¤</button>`:''}</div>`).join(''); openModal('member-modal'); }
        function addPayer(){const n=document.getElementById('new-payer-name').value;if(n&&!payers.includes(n)){payers.push(n); saveData(); openMemberModal(); renderExpenses();}}
        function removePayer(i){if(confirm("Del?")){payers.splice(i,1); saveData(); openMemberModal(); renderExpenses();}}
        function openIOUModal(){ const h=payers.filter(p=>p!=='å…¬è²»').map(p=>`<option value="${p}">${p}</option>`).join(''); document.getElementById('iou-creditor').innerHTML=h; document.getElementById('iou-debtor').innerHTML=h; document.getElementById('iou-list-container').innerHTML=manualDebts.map(i=>`<div class="flex justify-between p-2 border-b"><span class="text-sm">${i.debtor} æ¬  ${i.creditor}</span><span class="font-bold">NT$${i.amount}</span><button onclick="deleteIOU('${i.id}')" class="text-xs text-red-400">x</button></div>`).join(''); openModal('iou-modal'); }
        function saveIOU(){ const c=document.getElementById('iou-creditor').value, d=document.getElementById('iou-debtor').value, a=parseFloat(document.getElementById('iou-amount').value), n=document.getElementById('iou-note').value; if(!a||c===d)return; manualDebts.push({id:'iou'+Date.now(),creditor:c,debtor:d,amount:a,note:n}); saveData(); openIOUModal(); }
        function deleteIOU(id){ if(confirm("Del?")){manualDebts=manualDebts.filter(i=>i.id!=id);saveData();openIOUModal();} }
        function toggleVJW() { vjwData.isOpen = !vjwData.isOpen; renderVJW(); saveData(); }
        function renderVJW() { const c = document.getElementById('vjw-content'); if(vjwData.isOpen) { c.classList.remove('max-h-0'); c.classList.add('max-h-[500px]'); } else { c.classList.add('max-h-0'); c.classList.remove('max-h-[500px]'); } document.getElementById('vjw-container').innerHTML = vjwData.items.map(i => `<div class="flex-shrink-0 w-48 bg-white p-2 border rounded relative"><button onclick="deleteVJW(${i.id})" class="absolute top-1 right-1 text-red-400">x</button><div class="font-bold text-center mb-1">${i.name}</div><img src="${i.image}" class="w-full h-40 object-contain" onclick="viewPhoto('${i.image}')"></div>`).join('') + `<div class="flex-shrink-0 w-48 h-48 border-2 border-dashed flex items-center justify-center cursor-pointer relative"><span class="text-gray-400">+ Add</span><input type="file" class="absolute inset-0 opacity-0" onchange="processImage(this, b=>{vjwData.items.push({id:Date.now(),name:'New',image:b});saveData();renderVJW()})"></div>`; }
        function deleteVJW(id){ if(confirm("Del?")){vjwData.items=vjwData.items.filter(i=>i.id!==id);saveData();renderVJW()} }

        window.onload = function() { reloadLocalData(); renderFlights(); renderItinerary(); renderGuides(); renderExpenses(); renderMustEatList(); renderShoppingList(); document.getElementById('memo-pad').value = memoText; renderVJW(); if(gistId){document.getElementById('gist-id-input').value=gistId;document.getElementById('gist-token-input').value=gistToken;} switchTab('plan'); }
    </script>
</body>
    </html>
