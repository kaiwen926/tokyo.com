<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—…ã®è¨˜ AI">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f9f7f2">

    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">

    <title>ä¸€èµ·æ—…è¡Œå§</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- å¼•å…¥æ—¥ç³»æ‰‹å¯«å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@400;500;700;900&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'paper': '#f9f7f2', 
                        'sakura': '#f8c3cd', 
                        'matcha': '#bccc9a', 
                        'fuji': '#7b90d2', 
                        'fuji-light': '#eff6ff', 
                        'pencil': '#595857', 
                        'ink': '#2c2c2c',
                        'clay': '#b5651d',
                        'ai': '#8e7cc3' // AI Theme Color
                    },
                    fontFamily: { 
                        'maru': ['"Zen Maru Gothic"', 'sans-serif'], 
                        'hand': ['"Yomogi"', '"Zen Maru Gothic"', 'cursive'],
                        'serif': ['"Noto Serif TC"', 'serif']
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0,0,0,0.03)'
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body {
            font-family: 'Zen Maru Gothic', 'Noto Serif TC', sans-serif; 
            background-color: #f9f7f2; 
            color: #595857;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: center top;
            -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none;
            min-height: 100vh; padding-bottom: calc(80px + var(--sab));
        }
        .handwritten { font-family: 'Yomogi', cursive; }
        .modal { transition: opacity 0.3s ease-in-out; } .modal.hidden { opacity: 0; pointer-events: none; } .modal.visible { opacity: 1; pointer-events: auto; }
        .hand-card { background: #fff; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); position: relative; transition: transform 0.2s; }
        .btn-action { border: 2px solid #595857; border-radius: 999px; transition: all 0.2s; }
        .btn-action:active { transform: scale(0.95); }
        .nav-item.active i, .nav-item.active span { color: #7b90d2; font-weight: 900; } 
        .zoom-container { overflow: auto; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .zoom-container img { transition: transform 0.2s; cursor: zoom-in; }
        .zoom-container img.zoomed { max-width: none !important; max-height: none !important; cursor: zoom-out; cursor: grab; }
        .zoom-container.zoomed-mode { align-items: flex-start; justify-content: flex-start; }
        
        /* AI Chat Styles */
        .chat-msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; margin-bottom: 8px; position: relative; }
        .chat-user { background-color: #fuji; color: #7b90d2; background: #eff6ff; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #f3e5f5; color: #4a148c; align-self: flex-start; border-bottom-left-radius: 2px; }
        .typing-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: #aaa; animation: typing 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="pb-2 px-4 text-center sticky top-0 bg-[#f9f7f2]/95 z-40 backdrop-blur-sm transition-all duration-300 relative" style="padding-top: max(1.5rem, var(--sat));">
        <h1 class="text-4xl font-black tracking-widest text-ink handwritten relative inline-block mt-2" style="font-weight: 900;">
            <span class="absolute -top-4 -left-6 text-3xl rotate-[-15deg] opacity-60">âœˆï¸</span>
            æ—…ã®è¨˜
            <div class="absolute bottom-1 left-0 w-full h-3 bg-sakura/40 -z-10 rounded-full transform -rotate-1"></div>
        </h1>
        <div class="flex justify-center items-center gap-2 mt-2">
            <p class="text-[10px] text-fuji font-bold tracking-[0.2em] font-serif uppercase handwritten">AI Travel Assistant</p>
            <div id="cloud-status" class="text-[10px] bg-gray-200/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200">
                <i class="fa-solid fa-code-branch"></i> <span>æœªé€£ç·š</span>
            </div>
            <button onclick="forceDownload()" class="text-[10px] bg-gray-100/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 hover:bg-fuji-light hover:text-fuji" title="ç«‹å³åŒæ­¥">
                <i class="fa-solid fa-rotate-right"></i> <span>åŒæ­¥</span>
            </button>
        </div>
        <button id="quick-expense-btn" onclick="switchTab('wallet'); openExpenseModal();" 
                class="absolute top-0 right-5 text-matcha hover:text-green-700 active:scale-95 transition-all text-2xl p-1" 
                style="padding-top: max(1.8rem, calc(0.3rem + var(--sat))); display: none;" 
                title="å¿«é€Ÿè¨˜å¸³">
            <i class="fa-solid fa-circle-dollar-to-slot"></i>
        </button>
    </header>

    <!-- MAIN CONTAINER -->
    <main id="app" class="px-5 w-full mx-auto min-h-screen max-w-md relative">
        <!-- è£é£¾ç”¨å°æ’ç•« -->
        <div class="absolute top-0 left-0 -ml-4 mt-6 text-2xl opacity-50 rotate-[-10deg] pointer-events-none">ğŸŒ¸</div>
        <div class="absolute top-1/4 right-0 -mr-4 text-3xl text-fuji/30 rotate-[20deg] pointer-events-none">ğŸ—»</div>
        <div class="absolute bottom-1/3 left-0 -ml-8 text-xl text-matcha/40 pointer-events-none">ğŸµ</div>


        <!-- PLAN VIEW -->
        <section id="view-plan" class="view-section animate-fade">
            <div class="flex justify-between items-center mb-4 mt-6">
                <h3 class="text-pencil font-bold handwritten text-xl flex items-center"><i class="fa-solid fa-plane-departure mr-2 text-xl"></i>èˆªç­è³‡è¨Š</h3>
                <button onclick="openFlightModal()" class="text-xs bg-white border border-fuji/30 text-fuji px-3 py-1.5 rounded-lg shadow-sm active:scale-95 font-bold hover:bg-fuji hover:text-white transition"><i class="fa-solid fa-plus mr-1"></i>æ–°å¢</button>
            </div>
            <div id="flight-list-container" class="space-y-4 mb-10"></div>
            
            <div class="flex justify-between items-center mb-4 border-t-2 border-dashed border-gray-200 pt-8 mt-6">
                 <h3 class="text-pencil font-bold handwritten text-xl flex items-center"><i class="fa-solid fa-map-location-dot mr-2 text-xl"></i>æ¯æ—¥è¡Œç¨‹</h3>
            </div>
            <p class="text-xs text-gray-400 mb-4 text-center handwritten"><i class="fa-solid fa-circle-info mr-1"></i> é»æ“Šå‰æ–¹åœ–ç¤ºè¨˜å¸³ / é»æ“Šé¤é»åç¨±å°èˆª</p>
            <div id="itinerary-container" class="space-y-6"></div>
            <button onclick="addNewDay()" class="w-full mt-6 mb-8 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl py-3 hover:bg-white hover:border-matcha hover:text-matcha transition font-bold text-sm bg-white/50 handwritten"><i class="fa-solid fa-plus-circle mr-1"></i> å¯«ä¸‹ä¸€é å›æ†¶</button>
        </section>

        <!-- GUIDE VIEW -->
        <section id="view-guide" class="view-section hidden">
            <div class="flex justify-between items-end mb-4 mt-4">
                <h2 class="text-2xl font-bold text-pencil handwritten">æ·±åº¦å°è¦½</h2>
                <button onclick="openGuideModal()" class="text-sm bg-matcha/30 text-green-800 px-3 py-1 rounded-full border border-matcha hover:bg-matcha hover:text-white transition"><i class="fa-solid fa-plus mr-1"></i>æ–°å¢</button>
            </div>
            <div id="guide-list" class="space-y-6"></div>
        </section>

        <!-- WALLET VIEW (UPGRADED) -->
        <section id="view-wallet" class="view-section hidden">
            <div class="bg-[#2c3e50] rounded-2xl p-4 shadow-soft text-white mb-6 relative overflow-hidden mt-4">
                <div class="absolute top-0 right-0 w-20 h-20 bg-white/5 rounded-full -mr-10 -mt-10"></div>
                <h4 class="text-sm text-gray-300 font-bold mb-3 flex justify-between items-center relative z-10">
                    <span class="flex items-center font-serif tracking-wider"><i class="fa-solid fa-chart-simple mr-2"></i>è²¡å‹™ç¸½è¦½ (TWD)</span>
                    <button onclick="renderExpenses()" class="text-xs text-blue-300 hover:text-white"><i class="fa-solid fa-rotate-right"></i></button>
                </h4>
                
                <!-- å…¬è²»è³‡é‡‘æ± é¡¯ç¤º -->
                <div class="mb-4 bg-white/10 p-2 rounded-lg border border-white/20 flex justify-between items-center relative z-10">
                    <div>
                        <div class="text-[10px] text-gray-400 mb-1">å…¬è²»è³‡é‡‘æ± é¤˜é¡</div>
                        <div class="text-xl font-bold font-mono text-matcha" id="public-fund-balance">NT$ 0</div>
                    </div>
                    <button onclick="openDepositModal()" class="text-xs bg-matcha text-white px-3 py-1.5 rounded shadow hover:bg-green-600 transition"><i class="fa-solid fa-piggy-bank mr-1"></i> å…¥é‡‘</button>
                </div>

                <div id="individual-stats-dashboard" class="grid grid-cols-2 gap-3 text-xs relative z-10"></div>
                
                <div class="mt-4 flex justify-between items-end relative z-10 border-t border-gray-600 pt-2">
                    <div class="text-right">
                        <span class="text-xs text-gray-400">åŒ¯ç‡ (1 JPY â‰ˆ)</span>
                        <input type="number" id="exchange-rate" value="0.215" step="0.001" onchange="renderExpenses()" class="w-16 bg-gray-600 text-center rounded text-sm outline-none ml-1 text-white border-b border-gray-500">
                    </div>
                    <div>
                        <span class="text-xs text-gray-400 block mb-1">ç¸½æ”¯å‡º</span>
                        <div class="text-xl font-bold font-mono text-yellow-300" id="wallet-total-display">NT$ 0</div>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center mb-4">
                <button onclick="openIOUModal()" class="text-xs bg-fuji/10 text-fuji font-bold px-3 py-2 rounded border border-fuji/30 hover:bg-fuji/30 transition flex items-center gap-1"><i class="fa-solid fa-money-bill-transfer"></i> æ‰‹å‹•æ¬ æ¬¾/å€Ÿæ¬¾</button>
                 <button onclick="openPayerModal()" class="text-xs text-gray-400 border border-gray-300 rounded px-2 py-1 hover:bg-white"><i class="fa-solid fa-gear mr-1"></i>ç®¡ç†æˆå“¡</button>
            </div>
            <div id="settlement-summary-container" class="mb-6"><div class="bg-matcha/10 rounded-lg p-4 shadow-sm border border-matcha/30"><h4 class="text-sm font-bold text-green-800 mb-2 handwritten text-lg"><i class="fa-solid fa-handshake mr-1"></i> çµç®—å»ºè­° (Net)</h4><div id="settlement-summary" class="text-sm space-y-2 font-mono text-gray-600"></div></div></div>
            <div class="flex items-center gap-2 mb-3"><span class="text-xs font-bold text-gray-500">ç¯©é¸ä»˜æ¬¾äºº:</span><select id="wallet-filter" onchange="renderExpenses()" class="bg-white border border-gray-300 rounded text-sm p-1 outline-none"><option value="ALL">å…¨éƒ¨</option></select></div>
            <button onclick="openExpenseModal()" class="w-full btn-action bg-sakura/10 text-red-800 font-bold py-3 mb-6 flex items-center justify-center gap-2 border-sakura"><i class="fa-solid fa-pen-nib"></i> è¨˜ä¸€ç­†</button>
            <div id="expense-list" class="space-y-3 pb-20"></div>
        </section>

        <!-- LISTS VIEW -->
        <section id="view-lists" class="view-section hidden">
            <div class="hand-card p-5 mb-6 bg-[#fffdf0] relative mt-4">
                 <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-300 pb-2 mt-2">
                    <h3 class="text-xl font-bold text-pencil handwritten">å¿…åƒæ¸…å–®</h3>
                    <button onclick="openMustEatModal()" class="text-xs bg-matcha/20 text-green-700 px-2 py-1 rounded border border-matcha/50 shadow-sm hover:bg-matcha hover:text-white transition">+ æ–°å¢</button>
                 </div>
                 <div id="must-eat-list" class="space-y-3"></div>
            </div>
            <div class="hand-card p-5 mb-6 bg-white relative">
                 <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-200 pb-2 mt-2">
                    <h3 class="text-xl font-bold text-pencil handwritten">è³¼ç‰©æ¸…å–®</h3>
                    <button onclick="openShoppingModal()" class="text-xs bg-red-50 text-red-500 px-2 py-1 rounded border border-red-100 hover:bg-red-400 hover:text-white transition">+ æ–°å¢</button>
                 </div>
                 <div id="shopping-list-pending" class="grid grid-cols-2 gap-3 mb-4"></div>
                 <div id="shopping-list-done" class="grid grid-cols-2 gap-3 opacity-60 grayscale"></div>
            </div>
            <div class="hand-card p-5 mb-6 bg-[#f0f4f8]">
                <h3 class="text-lg font-bold text-center mb-4 text-fuji handwritten"><i class="fa-solid fa-suitcase mr-2"></i>è¡Œæç¢ºèª</h3>
                <ul id="checklist-container" class="space-y-2"></ul>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="new-todo" placeholder="æ–°å¢é …ç›®..." class="flex-1 bg-transparent border-b border-gray-300 text-sm outline-none font-hand">
                    <button onclick="addTodo()" class="text-fuji hover:scale-110 transition"><i class="fa-solid fa-circle-plus fa-lg"></i></button>
                </div>
            </div>
             <div class="hand-card p-5 bg-[#fffff0] rotate-1 shadow-md">
                <div class="absolute top-0 left-0 w-full h-2 bg-yellow-400/20"></div>
                <h3 class="text-lg font-bold mb-2 handwritten text-yellow-800"><i class="fa-solid fa-note-sticky mr-2"></i>éš¨æ‰‹è¨˜ (MEMO)</h3>
                <textarea id="memo-pad" class="w-full h-48 p-3 bg-transparent border-none resize-none text-sm leading-8 outline-none text-gray-700 handwritten" style="background-image: repeating-linear-gradient(transparent, transparent 31px, #e5e5e5 32px); line-height: 32px;" placeholder="åœ¨é€™è£¡éš¨æ‰‹è¨˜ä¸‹æƒ³æ³•..."></textarea>
            </div>
        </section>

        <!-- INFO VIEW -->
        <section id="view-info" class="view-section hidden">
            <div class="flex justify-between items-center mb-6 mt-4 px-2">
                <div class="w-8"></div> 
                <h2 class="text-2xl font-bold handwritten text-center">æ—…é€”æƒ…å ±</h2>
                <button onclick="resetToDefaults()" class="w-8 h-8 rounded-full bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100 transition shadow-sm" title="å¼·åˆ¶é‡ç½®è³‡æ–™">
                    <i class="fa-solid fa-rotate-right text-xs"></i>
                </button>
            </div>

            <div class="hand-card p-4 mb-6 border-l-4 border-matcha bg-matcha/5">
                <h3 class="font-bold text-green-800 mb-2 handwritten text-lg"><i class="fa-brands fa-github mr-2"></i>GitHub Gist é›²ç«¯åŒæ­¥</h3>
                <div class="text-xs text-gray-500 mb-4">è³‡æ–™æœ‰è®Šå‹•æœƒè‡ªå‹•ä¸Šå‚³ï¼ˆç´„ 1 ç§’å¾Œï¼‰ã€‚</div>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-600 block mb-1">1. Gist ID</label>
                        <input type="text" id="gist-id-input" placeholder="ä¾‹å¦‚: a3f1c1d8xxxx" class="w-full border p-2 rounded text-sm font-mono bg-white tracking-wider">
                    </div>
                    <div>
                         <label class="text-xs font-bold text-gray-600 block mb-1">2. å­˜å–æ¬Šæ– (Token)</label>
                         <input type="password" id="gist-token-input" placeholder="ghp_xxxx..." class="w-full border p-2 rounded text-sm font-mono bg-white tracking-wider">
                    </div>
                    <button onclick="saveGistConfig()" class="w-full bg-matcha text-white px-3 py-2 rounded text-sm font-bold shadow hover:bg-matcha/80"><i class="fa-solid fa-floppy-disk mr-1"></i> å„²å­˜é€£ç·šè¨­å®š</button>
                </div>
                
                 <div class="flex gap-2 mt-4 pt-4 border-t border-dashed border-matcha/30">
                     <button onclick="forceDownload()" class="flex-1 bg-white border border-green-200 text-green-800 px-2 py-2 rounded text-xs hover:bg-green-50 shadow-sm"><i class="fa-solid fa-cloud-arrow-down mr-1"></i> ä¸‹è¼‰ (è¦†è“‹æœ¬æ©Ÿ)</button>
                     <button onclick="forceUpload()" class="flex-1 bg-white border border-green-200 text-green-800 px-2 py-2 rounded text-xs hover:bg-green-50 shadow-sm"><i class="fa-solid fa-cloud-arrow-up mr-1"></i> ä¸Šå‚³ (è¦†è“‹é›²ç«¯)</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-blue-50 transition"><i class="fa-solid fa-cloud-sun-rain text-3xl text-fuji mb-2"></i><span class="font-bold text-sm">å¤©æ°£é å ±</span></a>
                <a href="https://www.google.com/maps/search/drugstore" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-pink-50 transition"><i class="fa-solid fa-store text-3xl text-sakura mb-2"></i><span class="font-bold text-sm">é™„è¿‘è—¥å¦</span></a>
            </div>
        </section>
    </main>

    <!-- AI CHAT FLOATING BUTTON & MODAL -->
    <div class="fixed bottom-24 right-5 z-40">
        <button onclick="toggleAIChat()" class="w-14 h-14 bg-ai text-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition animate-bounce-slow border-2 border-white">
            <i class="fa-solid fa-robot text-2xl"></i>
        </button>
    </div>

    <div id="ai-chat-modal" class="modal hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
        <div class="fixed inset-0 bg-black/30 backdrop-blur-[2px]" onclick="toggleAIChat()"></div>
        <div class="bg-white w-full max-w-sm h-[60vh] sm:h-[500px] sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col relative z-50 pointer-events-auto transition-transform duration-300 transform translate-y-0">
            <!-- Header -->
            <div class="bg-ai text-white p-4 rounded-t-2xl flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-robot"></i>
                    <span class="font-bold">AI æ—…éŠå°å¹«æ‰‹</span>
                </div>
                <button onclick="toggleAIChat()" class="text-white/80 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <!-- Chat Area -->
            <div id="ai-chat-history" class="flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col gap-2">
                <div class="chat-msg chat-ai">
                    å—¨ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ ğŸ¤– <br>
                    è©¦è‘—è¼¸å…¥ã€Œ<b>åˆ†æ</b>ã€æˆ–ã€Œ<b>æ“æ“ åº¦</b>ã€ä¾†å¹«ä½ çœ‹çœ‹è¡Œç¨‹ï¼Œæˆ–è€…è¼¸å…¥ã€Œ<b>æ‰“åŒ…</b>ã€å–å¾—æ¸…å–®ï¼
                </div>
            </div>
            <!-- Input Area -->
            <div class="p-3 border-t bg-white flex gap-2">
                <input type="text" id="ai-input" placeholder="å•æˆ‘ä¸€äº›å•é¡Œ..." class="flex-1 border rounded-full px-4 py-2 text-sm outline-none focus:border-ai" onkeypress="if(event.key==='Enter') sendAIMessage()">
                <button onclick="sendAIMessage()" class="w-10 h-10 bg-ai text-white rounded-full flex items-center justify-center hover:bg-purple-600 transition"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Flight, Day, Guide, Shopping, MustEat Modals (Unchanged structure, minimized for brevity) -->
    <div id="flight-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-3xl p-6 shadow-2xl relative hand-card"><button onclick="closeModal('flight-modal')" class="absolute top-3 right-3 text-gray-400 hover:text-red-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center handwritten">ç·¨è¼¯èˆªç­</h3><div class="space-y-4"><input type="hidden" id="flight-id"><div class="flex gap-4 items-center"><input type="text" id="flight-dep" placeholder="TPE" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white"><i class="fa-solid fa-plane text-gray-300"></i><input type="text" id="flight-arr" placeholder="NRT" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white"></div><div class="bg-fuji-light p-4 rounded-xl"><input type="text" id="flight-code" placeholder="èˆªç­ä»£è™Ÿ (ä¾‹: IT202)" class="w-full p-2 border-b border-fuji/20 bg-transparent text-center font-bold text-fuji handwritten text-xl mb-2 focus:outline-none placeholder-fuji/40"><input type="text" id="flight-date" placeholder="æ—¥æœŸ (ä¾‹: 1/10 å»ç¨‹)" class="w-full p-1 bg-transparent text-center text-sm font-hand text-gray-500 mb-1 focus:outline-none"><input type="text" id="flight-time" placeholder="æ™‚é–“ (ä¾‹: 14:00 - 18:00)" class="w-full p-1 bg-transparent text-center text-sm font-hand text-gray-500 focus:outline-none"></div><input type="url" id="flight-url" placeholder="é€£çµ (e-ticket)" class="w-full p-2 border rounded-lg bg-white text-xs text-center"><button onclick="saveFlight()" class="w-full bg-fuji text-white py-3 rounded-xl font-bold mt-2 shadow-lg shadow-fuji/30 hover:bg-fuji/90 transition handwritten tracking-widest">å„² å­˜</button></div></div></div>
    
    <!-- Day Editor Modal (Simplified) -->
    <div id="day-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-4 shadow-2xl relative hand-card h-[85vh] overflow-y-auto border-4 border-white"><button onclick="closeModal('day-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-2 text-center handwritten">ç·¨è¼¯è¡Œç¨‹</h3><input type="hidden" id="day-id-edit"><input type="text" id="day-date-edit" class="w-full p-2 border-b-2 border-matcha bg-transparent font-bold mb-4 font-hand text-xl focus:outline-none" placeholder="æ—¥æœŸæ¨™é¡Œ"><label class="flex items-center space-x-2 text-sm text-gray-600 mb-4 bg-yellow-50 p-2 rounded"><input type="checkbox" id="day-highlight-edit" class="accent-red-400"><span>æ¨™è¨˜ç‚ºé‡é»å¤©æ•¸ (Highlight)</span></label><div class="mb-4 bg-white p-2 rounded border border-gray-200 shadow-inner"><div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-gray-400">ç•¶æ—¥ç›¸ç‰‡é›†</h4><div class="relative overflow-hidden inline-block"><button class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs hover:bg-gray-200"><i class="fa-solid fa-plus"></i> æ–°å¢</button><input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addDayPhoto(this)"></div></div><div id="day-photos-preview" class="grid grid-cols-3 gap-2"></div></div><div class="mb-4"><input type="text" id="day-accommodation-edit" class="w-full p-2 border rounded text-sm mb-2" placeholder="ä½å®¿åœ°é»"><input type="url" id="day-accommodation-url-edit" class="w-full p-2 border rounded text-sm" placeholder="Google Maps é€£çµ"></div><div class="mb-4 border-t pt-3 bg-gray-50 p-2 rounded-lg border border-gray-100"><h4 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1"><i class="fa-solid fa-train"></i> äº¤é€šæ–¹å¼</h4><div class="flex gap-2 mb-2"><input type="time" id="day-trans-time" class="w-1/3 p-2 border border-gray-300 rounded text-sm"><input type="text" id="day-trans-content" placeholder="å…§å®¹ (å¦‚: æ­æ–°å¹¹ç·š)" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div><div class="flex gap-2 mb-2"><input type="text" id="day-trans-note" placeholder="å‚™è¨» (å¦‚: è²·ç¥¨)" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative hover:bg-white bg-white"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentTransPhoto = base64; document.getElementById('trans-photo-preview').src = base64; document.getElementById('trans-photo-preview').classList.remove('hidden'); document.getElementById('trans-photo-text').classList.add('hidden'); })"><div id="trans-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-ticket mb-1 block"></i> ä¸Šå‚³è»Šç¥¨/æ™‚åˆ»è¡¨</div><img id="trans-photo-preview" class="hidden h-20 mx-auto object-contain rounded"><button onclick="clearTransPhoto()" class="absolute top-1 right-1 bg-gray-200 rounded-full w-5 h-5 text-[10px] text-gray-500 z-10"><i class="fa-solid fa-times"></i></button></div></div><textarea id="day-content-edit" class="w-full h-32 p-3 border rounded-lg bg-white text-sm mb-4 font-hand leading-relaxed" placeholder="è¡Œç¨‹å…§å®¹... (è«‹ç”¨åæ–œç·š '\' åˆ†éš”æ¯é …æ´»å‹•)"></textarea><div class="bg-white p-3 rounded-lg border mb-4 space-y-4 shadow-sm"><h4 class="text-xs font-bold text-gray-400 border-b pb-1">ä¸‰é¤å®‰æ’</h4><div class="border-b pb-2"><div class="flex gap-2 mb-1"><i class="fa-solid fa-mug-hot text-orange-300 w-5"></i><input type="text" id="meal-b-name" placeholder="æ—©é¤" class="flex-1 text-sm font-bold bg-transparent"></div><div class="flex gap-2 pl-7"><input type="url" id="meal-b-url" placeholder="ç¶²å€ (ç•™ç©ºå‰‡æœå°‹åœ°é»)" class="w-1/2 text-xs border rounded px-1"><input type="text" id="meal-b-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1"></div></div><div class="border-b pb-2"><div class="flex gap-2 mb-1"><i class="fa-solid fa-utensils text-green-400 w-5"></i><input type="text" id="meal-l-name" placeholder="åˆé¤" class="flex-1 text-sm font-bold bg-transparent"></div><div class="flex gap-2 pl-7"><input type="url" id="meal-l-url" placeholder="ç¶²å€ (ç•™ç©ºå‰‡æœå°‹åœ°é»)" class="w-1/2 text-xs border rounded px-1"><input type="text" id="meal-l-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1"></div></div><div><div class="flex gap-2 mb-1"><i class="fa-solid fa-wine-glass text-purple-400 w-5"></i><input type="text" id="meal-d-name" placeholder="æ™šé¤" class="flex-1 text-sm font-bold bg-transparent"></div><div class="flex gap-2 pl-7"><input type="url" id="meal-d-url" placeholder="ç¶²å€ (ç•™ç©ºå‰‡æœå°‹åœ°é»)" class="w-1/2 text-xs border rounded px-1"><input type="text" id="meal-d-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1"></div></div></div><textarea id="day-note-edit" class="w-full h-20 p-2 border border-yellow-200 bg-yellow-50 rounded text-sm mb-4 handwritten" placeholder="æ¯æ—¥å‚™è¨»..."></textarea><div class="flex gap-2"><button onclick="deleteDay()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm">åˆªé™¤</button><button onclick="saveDay()" class="flex-[2] bg-matcha text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div></div></div>
    
    <!-- Lightbox, Guide, Shopping, MustEat, IOU, Payer Modals (Hidden but necessary) -->
    <div id="lightbox-modal" class="modal hidden fixed inset-0 bg-black/50 z-[100] flex flex-col" onclick="closeModal('lightbox-modal')"><div class="absolute top-4 right-4 text-white/80 z-50 cursor-pointer bg-black/50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-white/20 transition"><i class="fa-solid fa-times"></i></div><div id="lightbox-container" class="zoom-container p-2" onclick="event.stopPropagation()"><img id="lightbox-image" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded-sm" onclick="toggleZoom(this)"></div><div class="absolute bottom-10 left-0 w-full text-center text-white/50 text-xs pointer-events-none">é»æ“Šåœ–ç‰‡åˆ‡æ›ç¸®æ”¾</div></div>
    <div id="guide-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card"><button onclick="closeModal('guide-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-bold mb-3 handwritten text-lg">æ–°å¢/ç·¨è¼¯æ™¯é»å°è¦½</h3><input type="hidden" id="guide-id"><input type="text" id="guide-title" placeholder="æ™¯é»åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold font-hand text-lg focus:border-matcha outline-none"><textarea id="guide-desc" placeholder="ä»‹ç´¹å…§å®¹..." class="w-full mb-3 border bg-white p-2 rounded h-24 text-sm"></textarea><input type="text" id="guide-coords" placeholder="åº§æ¨™ (36.34,138.61)" class="w-full mb-3 border-b bg-transparent p-2 text-xs"><div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative mb-3 hover:bg-white bg-white/50"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentGuidePhoto = base64; document.getElementById('guide-photo-preview').src = base64; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden'); })"><div id="guide-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-image mb-1 block"></i> æ›´æ–°ç…§ç‰‡</div><img id="guide-photo-preview" class="hidden h-32 mx-auto object-cover rounded"></div><button onclick="saveGuide()" class="w-full bg-matcha text-white py-2 rounded-lg font-bold">å„²å­˜</button></div></div>
    <div id="shopping-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card"><button onclick="closeModal('shopping-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-bold mb-3 text-center">è³¼ç‰©é …ç›®</h3><input type="hidden" id="shop-id"><input type="text" id="shop-name" placeholder="å•†å“åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold"><div class="flex gap-2 mb-3"><div class="flex-1"><label class="text-xs text-gray-400">æ•¸é‡</label><input type="number" id="shop-qty" value="1" class="w-full border rounded p-2 text-sm"></div><div class="flex-[2]"><label class="text-xs text-gray-400">å–®åƒ¹ (JPY)</label><input type="number" id="shop-price" placeholder="0" class="w-full border rounded p-2 text-sm"></div></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center relative mb-4 bg-white"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentShopPhoto = base64; document.getElementById('shop-photo-preview').src = base64; document.getElementById('shop-photo-preview').classList.remove('hidden'); document.getElementById('shop-photo-text').classList.add('hidden'); })"><div id="shop-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-camera mb-1 block"></i> ç…§ç‰‡</div><img id="shop-photo-preview" class="hidden h-32 mx-auto object-contain rounded"></div><div class="flex gap-2"><button onclick="deleteShoppingItem()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg">åˆªé™¤</button><button onclick="saveShoppingItem()" class="flex-[2] bg-red-400 text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div></div></div>
    <div id="must-eat-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto"><button onclick="closeModal('must-eat-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center text-matcha">ğŸ½ï¸ ç·¨è¼¯å¿…åƒ</h3><input type="hidden" id="eat-id"><div class="space-y-3 p-3 border rounded-lg bg-white mb-4"><input type="text" id="eat-location" placeholder="åœ°é»åç¨± (ä¾‹å¦‚: è¼•äº•æ¾¤)" class="w-full p-2 border-b-2 border-matcha/50 bg-transparent text-center font-bold"><input type="text" id="eat-name" placeholder="ä¸»é¡Œåç¨± (å¯é¸)" class="w-full p-2 border rounded bg-gray-50 text-sm"><textarea id="eat-note" placeholder="å‚™è¨»/äº¤é€š" class="w-full h-16 p-2 border rounded bg-gray-50 text-sm"></textarea></div><h4 class="text-sm font-bold text-gray-600 mb-2">èœå–®/é …ç›®:</h4><div id="must-eat-items-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner"></div><div class="flex flex-col gap-2 mt-4 p-3 bg-gray-100 rounded-lg border border-gray-200"><div class="flex gap-2"><input type="text" id="new-food-name" placeholder="æ–°å¢åç¨±" class="flex-1 p-2 border rounded text-sm outline-matcha"><input type="number" id="new-food-price" placeholder="åƒ¹æ ¼" class="w-20 p-2 border rounded text-sm text-right outline-matcha"></div><div class="flex gap-2 items-center"><input type="url" id="new-food-url" placeholder="ç¶²å€ (å¯é¸)" class="flex-1 p-2 border rounded text-xs outline-matcha"><button onclick="addNewFoodItem()" class="bg-matcha text-white px-3 py-2 rounded-lg hover:bg-green-600 active:scale-95 transition text-sm"><i class="fa-solid fa-plus"></i></button></div></div><div class="flex gap-2 mt-4"><button onclick="deleteMustEatItem()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hover:bg-red-100">åˆªé™¤</button><button onclick="saveMustEatItem()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow hover:bg-fuji/80">å„²å­˜</button></div></div></div>
    <div id="iou-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto"><button onclick="closeModal('iou-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center text-fuji">ğŸ¤ æ‰‹å‹•æ¬ æ¬¾/å€Ÿæ¬¾</h3><input type="hidden" id="iou-id"><div class="space-y-3 p-3 border rounded-lg bg-white mb-4"><div class="text-xs text-gray-500 mb-1">èª°å€Ÿçµ¦èª°ï¼Ÿ</div><div class="flex gap-2"><div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µæ¬Šäºº</label><select id="iou-creditor" class="w-full bg-white border rounded p-1 text-sm"></select></div><div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µå‹™äºº</label><select id="iou-debtor" class="w-full bg-white border rounded p-1 text-sm"></select></div></div><div class="flex items-center gap-2 bg-gray-50 border rounded p-2"><span class="font-bold text-sm">TWD</span><input type="number" id="iou-amount" placeholder="é‡‘é¡" class="flex-1 text-lg text-right w-full bg-transparent" inputmode="numeric"></div><input type="text" id="iou-note" placeholder="å‚™è¨»" class="w-full p-2 border rounded text-sm"><div class="flex gap-2 mt-3"><button onclick="deleteIOU()" id="btn-delete-iou" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden">åˆªé™¤</button><button onclick="saveIOU()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div></div><h4 class="text-sm font-bold text-gray-600 mb-2">åˆ—è¡¨:</h4><div id="iou-list-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner"></div></div></div>
    <div id="payer-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg"><h4 class="font-bold mb-3 text-center">ç®¡ç†æˆå“¡</h4><div id="payer-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto"></div><div class="flex gap-2"><input type="text" id="new-payer-name" placeholder="æ–°æˆå“¡åç¨±" class="flex-1 border p-1 text-sm rounded"><button onclick="addPayer()" class="bg-matcha text-white px-3 rounded text-sm">æ–°å¢</button></div><button onclick="closeModal('payer-modal')" class="w-full mt-3 bg-gray-200 py-1 rounded text-sm">é—œé–‰</button></div></div>
    
    <!-- EXPENSE MODAL (Major Upgrade for Multi-Pay) -->
    <div id="expense-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('expense-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center">è¨˜ä¸‹ä¸€ç­†å¸³</h3>
            <input type="hidden" id="ex-id">
            
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="ex-category" class="w-full bg-white border rounded p-2 text-sm"><option value="é£²é£Ÿ">ğŸœ é£²é£Ÿ</option><option value="äº¤é€š">ğŸšƒ äº¤é€š</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="å…¶ä»–">âœ¨ å…¶ä»–</option></select>
                    <input type="text" id="ex-note" placeholder="å‚™è¨»" class="w-full bg-white border-b p-2 text-sm">
                </div>
                <div class="flex items-center gap-2 bg-white border rounded p-2">
                    <select id="ex-currency" class="bg-transparent text-sm font-bold"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
                    <input type="number" id="ex-amount" placeholder="ç¸½é‡‘é¡" class="flex-1 text-lg text-right w-full" inputmode="numeric">
                </div>
                
                <!-- Payment Mode Switch -->
                <div class="bg-white p-2 rounded border">
                    <div class="flex text-xs mb-2 border-b pb-1">
                        <button onclick="togglePaymentMode('single')" id="btn-pay-single" class="flex-1 font-bold text-center text-fuji border-r">å–®äººä»˜æ¬¾</button>
                        <button onclick="togglePaymentMode('multi')" id="btn-pay-multi" class="flex-1 text-gray-400 text-center">å¤šäººåˆ†æ“”</button>
                    </div>
                    
                    <!-- Single Payer Mode -->
                    <div id="mode-single-payer">
                        <label class="block text-xs text-gray-400 mb-1">ä»˜æ¬¾äºº</label>
                        <select id="ex-payer" class="w-full bg-gray-50 border rounded p-1 text-sm"></select>
                    </div>

                    <!-- Multi Payer Mode -->
                    <div id="mode-multi-payer" class="hidden space-y-2">
                        <label class="block text-xs text-gray-400">èª°ä»˜äº†å¤šå°‘?</label>
                        <div id="multi-payer-inputs" class="max-h-32 overflow-y-auto space-y-1"></div>
                        <div class="text-right text-xs text-red-400" id="multi-pay-warning"></div>
                    </div>
                </div>

                <div class="flex gap-2 text-sm items-center">
                   <div class="w-full">
                       <label class="block text-xs text-gray-400 mb-1">åˆ†æ”¤äººæ•¸ (é™¤ä»¥)</label>
                       <input type="number" id="ex-people" value="1" min="1" class="w-full bg-white border rounded p-1 text-center">
                   </div>
                </div>

                <div class="border-2 border-dashed rounded-lg p-2 text-center relative">
                    <input type="file" id="ex-photo" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentPhotoBase64 = base64; document.getElementById('photo-preview').src = base64; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); })">
                    <div id="photo-placeholder" class="text-xs text-gray-400"><i class="fa-solid fa-camera mb-1 block"></i> ä¸Šå‚³æ”¶æ“š/ç…§ç‰‡</div>
                    <img id="photo-preview" class="hidden h-24 mx-auto object-contain">
                </div>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button onclick="deleteExpense()" id="btn-delete-expense" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden">åˆªé™¤</button>
                <button onclick="saveExpense()" class="flex-[2] bg-clay text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- Deposit Modal (New) -->
    <div id="deposit-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-xs rounded-xl p-5 shadow-lg relative">
             <button onclick="closeModal('deposit-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h4 class="font-bold mb-3 text-center text-matcha"><i class="fa-solid fa-piggy-bank"></i> å…¬è²»å…¥é‡‘</h4>
            <div class="space-y-3">
                 <div><label class="text-xs text-gray-500">èª°å­˜éŒ¢?</label><select id="dep-payer" class="w-full border p-2 rounded"></select></div>
                 <div><label class="text-xs text-gray-500">é‡‘é¡ (TWD)</label><input type="number" id="dep-amount" class="w-full border p-2 rounded text-lg font-bold text-right" placeholder="0"></div>
                 <button onclick="saveDeposit()" class="w-full bg-matcha text-white py-2 rounded font-bold">ç¢ºèªå…¥é‡‘</button>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#f9f7f2] border-t border-gray-200 pt-2 pb-safe px-6 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.03)]" style="padding-bottom: calc(10px + var(--sab));">
        <div class="flex justify-between items-center w-full mx-auto pb-1 max-w-md">
            <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center text-gray-400 transition flex-1" data-target="plan"><i class="fa-solid fa-map text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è¡Œç¨‹</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="guide"><i class="fa-solid fa-book-open text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">å°è¦½</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="wallet"><i class="fa-solid fa-wallet text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è¨˜å¸³</span></button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="lists"><i class="fa-solid fa-list-check text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">æ¸…å–®</span></button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="info"><i class="fa-solid fa-circle-info text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è³‡è¨Š</span></button>
        </div>
    </nav>

    <!-- JAVASCRIPT -->
    <script>
        let flights = [], itinerary = [], mustEatList = [], expenses = [], guides = [], todos = [], shoppingList = [], payers = [], manualDebts = [], deposits = [], memoText = "";
        let gistToken = localStorage.getItem('gist_token') || "";
        let gistId = localStorage.getItem('gist_id') || "";
        const GIST_FILE_NAME = "travel_data_v2.json";
        window.autoUploadTimer = null; 

        // [RECOVERY DATA]
        const RECOVERED_ITINERARY = [{"id":"day_1","date":"1/10 Day 1 æˆç”°","highlight":false,"content":"18:00 æŠµé”æˆç”°æ©Ÿå ´\nAeon Mall è¶…å¸‚åƒé€›","accommodation":"æˆç”°æ©Ÿå ´å‘¨é‚Š","accommodationUrl":"","transportation":{"content":"æ­ä¹˜ Skyliner","note":"äº‹å…ˆè²·ç¥¨","time":"18:40"},"meals":{"b":{"name":""},"l":{"name":""},"d":{"name":"è¶…å¸‚ä¾¿ç•¶"}}},{"id":"day_2","date":"Day 2 æ–°å®¿","highlight":false,"content":"æ·ºè‰é›·é–€\næ–°å®¿ (æ–°å®¿ç´ é£Ÿæ‹‰éºµ / 3Dè²“ / å“¥å‰æ‹‰)\næ±äº¬éƒ½å»³å…è²»å¤œæ™¯","accommodation":"æ±äº¬å¸‚å€","accommodationUrl":"","meals":{"b":{"name":"è¶…å•†"},"l":{"name":"æ–°å®¿ç´ é£Ÿæ‹‰éºµ"},"d":{"name":"è‡ªç†"}}},{"id":"day_4","date":"Day 4 è¼•äº•æ¾¤","highlight":true,"content":"è»Šç«™å¯„è¡Œæ\nè¼•äº•æ¾¤ Outlet çˆ†è²·\nç©é›ª (Snow Park)","accommodation":"Cypress è¼•äº•æ¾¤","transportation":{"content":"æ–°å¹¹ç·šå¾€è¼•äº•æ¾¤","time":"09:00"},"meals":{"b":{"name":"ä¾¿ç•¶"},"l":{"name":"Outlet"},"d":{"name":"é£¯åº—è‡ªåŠ©"}}}];
        const RECOVERED_PAYERS = ["æˆ‘", "æ—…ä¼´", "å…¬è²»"];
        
        // --- Core & Gist Logic ---
        function updateCloudStatus(msg){const s=document.getElementById('cloud-status');s.innerHTML=`<i class="fa-brands fa-github"></i> <span>${msg}</span>`;if(msg.includes("æˆåŠŸ"))s.className="text-[10px] bg-matcha/50 text-white px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-green-300";else s.className="text-[10px] bg-gray-200/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200";setTimeout(()=>{if(s)s.className="text-[10px] bg-gray-200/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200"},2000);}
        function saveGistConfig(){const id=document.getElementById('gist-id-input').value.trim(),token=document.getElementById('gist-token-input').value.trim();if(!id||!token){alert("å¿…å¡«");return}localStorage.setItem('gist_id',id);localStorage.setItem('gist_token',token);gistId=id;gistToken=token;alert("è¨­å®šå·²å„²å­˜");forceDownload();}
        window.forceUpload=async function(){if(!gistId||!gistToken){updateCloudStatus("æœªé€£ç·š");return}updateCloudStatus("ä¸Šå‚³ä¸­...");const payload={flights,itinerary,mustEatList,expenses,guides,todos,shoppingList,payers,manualDebts,deposits,memo:memoText,lastUpdate:new Date().toISOString()};try{const r=await fetch(`https://api.github.com/gists/${gistId}`,{method:'PATCH',headers:{'Authorization':`token ${gistToken}`,'Content-Type':'application/json'},body:JSON.stringify({files:{[GIST_FILE_NAME]:{content:JSON.stringify(payload)}}})});if(r.ok)updateCloudStatus("ä¸Šå‚³æˆåŠŸ");else throw new Error();}catch(e){console.error(e);updateCloudStatus("ä¸Šå‚³å¤±æ•—");}}
        window.forceDownload=async function(){if(!gistId||!gistToken){updateCloudStatus("æœªé€£ç·š");return}updateCloudStatus("ä¸‹è¼‰ä¸­...");try{const r=await fetch(`https://api.github.com/gists/${gistId}`,{method:'GET',headers:{'Authorization':`token ${gistToken}`}});const d=await r.json();const f=d.files[GIST_FILE_NAME];if(!f){alert("ç„¡è³‡æ–™");return}const data=JSON.parse(f.content);
            if(data.flights){localStorage.setItem('flights',JSON.stringify(data.flights));localStorage.setItem('itinerary_v2',JSON.stringify(data.itinerary));localStorage.setItem('mustEatList',JSON.stringify(data.mustEatList));localStorage.setItem('expenses_v2',JSON.stringify(data.expenses));localStorage.setItem('guides',JSON.stringify(data.guides));localStorage.setItem('todos',JSON.stringify(data.todos));localStorage.setItem('shoppingList_v2',JSON.stringify(data.shoppingList));localStorage.setItem('payers',JSON.stringify(data.payers));localStorage.setItem('manualDebts_v1',JSON.stringify(data.manualDebts));localStorage.setItem('deposits',JSON.stringify(data.deposits||[]));if(data.memo)localStorage.setItem('memo',data.memo);updateCloudStatus("å·²åŒæ­¥");window.refreshUI();}
        }catch(e){updateCloudStatus("é€£ç·šå¤±æ•—");}}

        // --- Data Handling ---
        function reloadLocalData() {
            flights = JSON.parse(localStorage.getItem('flights')) || [];
            itinerary = JSON.parse(localStorage.getItem('itinerary_v2')) || RECOVERED_ITINERARY;
            mustEatList = JSON.parse(localStorage.getItem('mustEatList')) || [];
            expenses = JSON.parse(localStorage.getItem('expenses_v2')) || JSON.parse(localStorage.getItem('expenses')) || []; // v2 for multi-payer support
            guides = JSON.parse(localStorage.getItem('guides')) || [];
            todos = JSON.parse(localStorage.getItem('todos')) || [];
            shoppingList = JSON.parse(localStorage.getItem('shoppingList_v2')) || [];
            payers = JSON.parse(localStorage.getItem('payers')) || RECOVERED_PAYERS;
            if(!payers.includes("å…¬è²»")) payers.push("å…¬è²»");
            manualDebts = JSON.parse(localStorage.getItem('manualDebts_v1')) || [];
            deposits = JSON.parse(localStorage.getItem('deposits')) || [];
            memoText = localStorage.getItem('memo') || "";
            
            // Normalize itinerary structure
             itinerary = itinerary.map(d => ({ ...d, transportation: d.transportation||{content:'',note:'',time:'',photo:''}, meals: { b: { name: d.meals?.b?.name||'', url: d.meals?.b?.url||'', note: d.meals?.b?.note||'' }, l: { name: d.meals?.l?.name||'', url: d.meals?.l?.url||'', note: d.meals?.l?.note||'' }, d: { name: d.meals?.d?.name||'', url: d.meals?.d?.url||'', note: d.meals?.d?.note||'' } } }));
        }
        function saveData() {
            localStorage.setItem('flights', JSON.stringify(flights));
            localStorage.setItem('itinerary_v2', JSON.stringify(itinerary));
            localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
            localStorage.setItem('expenses_v2', JSON.stringify(expenses)); // Save as v2
            localStorage.setItem('guides', JSON.stringify(guides));
            localStorage.setItem('todos', JSON.stringify(todos));
            localStorage.setItem('shoppingList_v2', JSON.stringify(shoppingList));
            localStorage.setItem('payers', JSON.stringify(payers));
            localStorage.setItem('manualDebts_v1', JSON.stringify(manualDebts));
            localStorage.setItem('deposits', JSON.stringify(deposits));
            localStorage.setItem('memo', memoText); 
            if (gistId && gistToken) { clearTimeout(window.autoUploadTimer); window.autoUploadTimer = setTimeout(() => { forceUpload(); }, 2000); }
        }
        window.refreshUI = function() { reloadLocalData(); renderFlights(); renderItinerary(); renderGuides(); renderExpenses(); renderMustEatList(); renderChecklist(); renderShoppingList(); document.getElementById('memo-pad').value = memoText; renderPayerOptions(); }
        window.resetToDefaults = function() { if(confirm("ç¢ºå®šé‡ç½®?")){ localStorage.clear(); location.reload(); } }

        // --- Common Helpers ---
        function processImage(input, cb) { if(input.files && input.files[0]){ const r=new FileReader(); r.onload=function(e){const i=new Image();i.onload=function(){const c=document.createElement('canvas'),x=c.getContext('2d'),w=1000;let wd=i.width,ht=i.height;if(wd>w){ht*=w/wd;wd=w;}c.width=wd;c.height=ht;x.drawImage(i,0,0,wd,ht);cb(c.toDataURL('image/jpeg',0.8));};i.src=e.target.result;};r.readAsDataURL(input.files[0]); } }
        function openModal(id){document.getElementById(id).classList.remove('hidden');setTimeout(()=>document.getElementById(id).classList.add('visible'),10);}
        function closeModal(id){const el=document.getElementById(id);el.classList.remove('visible');setTimeout(()=>el.classList.add('hidden'),300);}
        function switchTab(t){document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden'));document.getElementById('view-'+t).classList.remove('hidden');document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));document.querySelector(`[data-target="${t}"]`).classList.add('active');window.scrollTo(0,0);}
        function toggleZoom(img) { const c = document.getElementById('lightbox-container'); if (img.classList.contains('zoomed')) { img.classList.remove('zoomed'); img.classList.add('max-w-full', 'max-h-full'); c.classList.remove('zoomed-mode'); } else { img.classList.add('zoomed'); img.classList.remove('max-w-full', 'max-h-full'); c.classList.add('zoomed-mode'); } }
        function viewPhoto(src) { const img = document.getElementById('lightbox-image'); img.src = src; img.classList.remove('zoomed'); img.classList.add('max-w-full', 'max-h-full'); document.getElementById('lightbox-container').classList.remove('zoomed-mode'); openModal('lightbox-modal'); }

        /* --- ITINERARY & ACCOMMODATION UPGRADE --- */
        function renderItinerary() {
            const c=document.getElementById('itinerary-container'); c.innerHTML='';
            itinerary.forEach((day)=>{
                let content=day.content;
                // Highlight keywords
                guides.forEach(g=>{ content=content.replace(new RegExp(g.title,'gi'),`<span class="font-bold border-b-2 border-matcha cursor-pointer hover:bg-matcha/20" onclick="jumpToGuide(${g.id})">${g.title}</span>`); });
                
                content = content.split('\n').map(line => {
                    const trimmed = line.trim();
                    if(!trimmed) return '';
                    return `<li class="flex items-start text-base"><span class="mr-2 mt-2 w-2 h-2 bg-sakura rounded-full flex-shrink-0 border border-red-200"></span><span class="flex-1">${trimmed}</span></li>`;
                }).join('');

                const photosHtml = day.photos?.length ? `<div class="mt-3 grid grid-cols-3 gap-1 rounded-lg overflow-hidden">${day.photos.map(p=>`<img src="${p}" class="w-full aspect-square object-cover cursor-pointer hover:opacity-90" onclick="viewPhoto('${p}')">`).join('')}</div>` : '';
                
                // Meal Buttons
                const mealConfig = { b: { icon: 'fa-mug-hot', color: 'orange', label: 'æ—©é¤' }, l: { icon: 'fa-utensils', color: 'green', label: 'åˆé¤' }, d: { icon: 'fa-wine-glass', color: 'purple', label: 'æ™šé¤' } };
                const mealButtons = ['b', 'l', 'd'].map(type => {
                    const meal = day.meals[type];
                    if (!meal || !meal.name) return '';
                    const conf = mealConfig[type];
                    const url = meal.url ? meal.url : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(meal.name)}`;
                    return `<div class="inline-flex items-center text-xs rounded-full border shadow-sm overflow-hidden bg-${conf.color}-50 border-${conf.color}-100 mr-2 mb-2 group/meal"><button onclick="switchTab('wallet'); openExpenseModal(null, {note: '${conf.label}: ${meal.name}', cat: 'é£²é£Ÿ'})" class="px-2 py-1.5 hover:bg-${conf.color}-200 text-${conf.color}-600 border-r border-${conf.color}-200 transition"><i class="fa-solid ${conf.icon}"></i></button><a href="${url}" target="_blank" class="px-3 py-1.5 text-${conf.color}-700 hover:bg-${conf.color}-100 hover:underline font-hand block">${meal.name}</a></div>`;
                }).join('');

                // Accommodation Link Logic
                let accomHtml = '';
                if(day.accommodation) {
                    const hotelUrl = day.accommodationUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(day.accommodation)}`;
                    accomHtml = `<div class="mt-3 pt-2 border-t border-dashed border-gray-200 text-xs flex items-center justify-between">
                        <span class="text-indigo-500 font-bold flex items-center gap-2"><i class="fa-solid fa-bed"></i> ${day.accommodation}</span>
                        <a href="${hotelUrl}" target="_blank" class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full hover:bg-indigo-100 transition"><i class="fa-solid fa-location-dot mr-1"></i>å°èˆª</a>
                    </div>`;
                }

                c.innerHTML+=`
                <div class="relative pl-8 border-l-2 ${day.highlight?'border-sakura':'border-gray-200'} pb-8 group">
                    <div class="absolute -left-2.5 top-0 w-5 h-5 rounded-full ${day.highlight?'bg-sakura':'bg-gray-300'} border-4 border-paper shadow-sm"></div>
                    <div class="flex justify-between mb-2 items-end">
                        <h3 class="font-black text-2xl handwritten ${day.highlight?'text-red-400':'text-pencil'}">${day.date}</h3>
                        <button onclick="openDayEditor('${day.id}')" class="text-gray-300 hover:text-fuji transition"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 relative">
                        ${day.highlight?`<div class="absolute -top-2 -right-2 text-2xl opacity-50 rotate-12">ğŸŒ¸</div>`:''}
                        <ul class="text-sm space-y-3 leading-relaxed text-gray-600 font-hand text-lg">${content}</ul>
                        ${photosHtml}
                        ${accomHtml}
                        ${mealButtons ? `<div class="mt-2 flex flex-wrap">${mealButtons}</div>` : ''}
                    </div>
                </div>`;
            });
        }
        
        // --- Day Editor Functions ---
        function addNewDay(){itinerary.push({id:'day_'+Date.now(),date:"New Day",highlight:false,content:"...",accommodation:"",meals:{b:{},l:{},d:{}}}); saveData(); renderItinerary();}
        function openDayEditor(id){ const d=itinerary.find(i=>i.id===id); if(!d)return; document.getElementById('day-id-edit').value=d.id; document.getElementById('day-date-edit').value=d.date; document.getElementById('day-highlight-edit').checked=d.highlight; document.getElementById('day-content-edit').value=d.content; document.getElementById('day-accommodation-edit').value=d.accommodation; document.getElementById('day-accommodation-url-edit').value=d.accommodationUrl; tempDayPhotos = d.photos ? [...d.photos] : []; renderDayPhotosPreview(); document.getElementById('meal-b-name').value=d.meals.b.name; document.getElementById('meal-b-url').value=d.meals.b.url; document.getElementById('meal-b-note').value=d.meals.b.note; document.getElementById('meal-l-name').value=d.meals.l.name; document.getElementById('meal-l-url').value=d.meals.l.url; document.getElementById('meal-l-note').value=d.meals.l.note; document.getElementById('meal-d-name').value=d.meals.d.name; document.getElementById('meal-d-url').value=d.meals.d.url; document.getElementById('meal-d-note').value=d.meals.d.note; openModal('day-modal'); }
        function saveDay(){ const idx=itinerary.findIndex(i=>i.id===document.getElementById('day-id-edit').value); if(idx<0)return; const i=itinerary[idx]; i.date=document.getElementById('day-date-edit').value; i.highlight=document.getElementById('day-highlight-edit').checked; i.content=document.getElementById('day-content-edit').value; i.accommodation=document.getElementById('day-accommodation-edit').value; i.accommodationUrl=document.getElementById('day-accommodation-url-edit').value; i.photos=[...tempDayPhotos]; i.meals={ b:{name:document.getElementById('meal-b-name').value,url:document.getElementById('meal-b-url').value,note:document.getElementById('meal-b-note').value}, l:{name:document.getElementById('meal-l-name').value,url:document.getElementById('meal-l-url').value,note:document.getElementById('meal-l-note').value}, d:{name:document.getElementById('meal-d-name').value,url:document.getElementById('meal-d-url').value,note:document.getElementById('meal-d-note').value} }; saveData(); renderItinerary(); closeModal('day-modal'); }
        function deleteDay(){if(confirm("Del?")){itinerary=itinerary.filter(d=>d.id!==document.getElementById('day-id-edit').value); saveData(); renderItinerary(); closeModal('day-modal');}}
        let tempDayPhotos = []; function addDayPhoto(input) { processImage(input, (base64) => { tempDayPhotos.push(base64); renderDayPhotosPreview(); }); } function renderDayPhotosPreview() { document.getElementById('day-photos-preview').innerHTML = tempDayPhotos.map((p, i) => `<div class="relative"><img src="${p}" class="w-full h-full rounded"><button onclick="removeDayPhoto(${i})" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 text-xs">x</button></div>`).join(''); } function removeDayPhoto(i) { tempDayPhotos.splice(i,1); renderDayPhotosPreview(); }

        /* --- WALLET: Multi-Payer & Public Fund Logic --- */
        let paymentMode = 'single';

        function togglePaymentMode(mode) {
            paymentMode = mode;
            const btnSingle = document.getElementById('btn-pay-single');
            const btnMulti = document.getElementById('btn-pay-multi');
            const divSingle = document.getElementById('mode-single-payer');
            const divMulti = document.getElementById('mode-multi-payer');
            
            if(mode === 'single') {
                btnSingle.classList.add('text-fuji', 'font-bold', 'border-r'); btnSingle.classList.remove('text-gray-400');
                btnMulti.classList.add('text-gray-400'); btnMulti.classList.remove('text-fuji', 'font-bold');
                divSingle.classList.remove('hidden'); divMulti.classList.add('hidden');
                document.getElementById('ex-amount').readOnly = false;
                document.getElementById('ex-amount').placeholder = "ç¸½é‡‘é¡";
            } else {
                btnMulti.classList.add('text-fuji', 'font-bold'); btnMulti.classList.remove('text-gray-400');
                btnSingle.classList.add('text-gray-400'); btnSingle.classList.remove('text-fuji', 'font-bold', 'border-r');
                divMulti.classList.remove('hidden'); divSingle.classList.add('hidden');
                document.getElementById('ex-amount').readOnly = true;
                document.getElementById('ex-amount').placeholder = "è‡ªå‹•è¨ˆç®—";
                renderMultiPayerInputs();
            }
        }

        function renderMultiPayerInputs() {
            const container = document.getElementById('multi-payer-inputs');
            container.innerHTML = payers.filter(p=>p!=='å…¬è²»').map(p => `
                <div class="flex items-center justify-between bg-gray-50 p-1 rounded">
                    <span class="text-xs font-bold w-16 truncate">${p}</span>
                    <input type="number" data-payer="${p}" class="multi-pay-input w-24 text-right text-sm border-b bg-transparent outline-none" placeholder="0" oninput="calculateTotalFromMulti()">
                </div>
            `).join('');
        }

        function calculateTotalFromMulti() {
            const inputs = document.querySelectorAll('.multi-pay-input');
            let total = 0;
            inputs.forEach(input => { total += parseFloat(input.value) || 0; });
            document.getElementById('ex-amount').value = total;
        }

        function openExpenseModal(id=null, pre={}) {
            currentPhotoBase64=null; document.getElementById('photo-preview').classList.add('hidden'); document.getElementById('photo-placeholder').classList.remove('hidden'); document.getElementById('btn-delete-expense').classList.add('hidden');
            renderPayerOptions();
            togglePaymentMode('single'); // Reset to single by default

            if(id){
                const ex=expenses.find(e=>e.id==id);
                document.getElementById('ex-id').value=ex.id; document.getElementById('ex-category').value=ex.cat; document.getElementById('ex-note').value=ex.note; document.getElementById('ex-currency').value=ex.curr; document.getElementById('ex-amount').value=ex.amt; document.getElementById('ex-people').value=ex.ppl;
                
                if(ex.multiPayers) {
                    togglePaymentMode('multi');
                    // Pre-fill multi inputs
                    setTimeout(() => {
                        for (const [p, amt] of Object.entries(ex.multiPayers)) {
                            const inp = document.querySelector(`.multi-pay-input[data-payer="${p}"]`);
                            if(inp) inp.value = amt;
                        }
                    }, 100);
                } else {
                    document.getElementById('ex-payer').value=ex.payer;
                }

                if(ex.photo){ currentPhotoBase64=ex.photo; document.getElementById('photo-preview').src=ex.photo; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); }
                document.getElementById('btn-delete-expense').classList.remove('hidden');
            } else {
                ['ex-id','ex-amount','ex-note'].forEach(k=>document.getElementById(k).value='');
                if(pre.note) document.getElementById('ex-note').value=pre.note;
                if(pre.cat) document.getElementById('ex-category').value=pre.cat;
            }
            openModal('expense-modal');
        }

        function saveExpense() {
            const id=document.getElementById('ex-id').value;
            const amt=parseFloat(document.getElementById('ex-amount').value);
            if(!amt) return alert("è«‹è¼¸å…¥é‡‘é¡");

            let payerData = {};
            let payerName = "";

            if (paymentMode === 'multi') {
                const inputs = document.querySelectorAll('.multi-pay-input');
                let multiTotal = 0;
                inputs.forEach(input => {
                    const val = parseFloat(input.value);
                    if (val > 0) {
                        payerData[input.getAttribute('data-payer')] = val;
                        multiTotal += val;
                    }
                });
                if (Math.abs(multiTotal - amt) > 1) return alert("åˆ†æ“”é‡‘é¡ç¸½å’Œä¸ç­‰æ–¼ç¸½é‡‘é¡ï¼");
                payerName = "å¤šäººåˆ†æ“”";
            } else {
                payerName = document.getElementById('ex-payer').value;
            }

            const ex={
                id:id?parseInt(id):Date.now(),
                cat:document.getElementById('ex-category').value,
                note:document.getElementById('ex-note').value,
                curr:document.getElementById('ex-currency').value,
                amt,
                payer: payerName,
                multiPayers: paymentMode === 'multi' ? payerData : null,
                ppl:parseInt(document.getElementById('ex-people').value)||1,
                photo:currentPhotoBase64
            };
            
            if(id){const idx=expenses.findIndex(e=>e.id==id);if(idx>-1)expenses[idx]=ex;}else{expenses.unshift(ex);}
            saveData(); renderExpenses(); closeModal('expense-modal');
        }

        // Deposit Logic
        function openDepositModal() {
            const sel = document.getElementById('dep-payer');
            sel.innerHTML = payers.filter(p=>p!=='å…¬è²»').map(p=>`<option value="${p}">${p}</option>`).join('');
            document.getElementById('dep-amount').value = '';
            openModal('deposit-modal');
        }
        function saveDeposit() {
            const p = document.getElementById('dep-payer').value;
            const a = parseFloat(document.getElementById('dep-amount').value);
            if(!a) return;
            deposits.push({ id: Date.now(), payer: p, amount: a, date: new Date().toISOString() });
            saveData(); renderExpenses(); closeModal('deposit-modal');
        }

        function renderExpenses() { 
            const rate = parseFloat(document.getElementById('exchange-rate').value); 
            // 1. Calculate Public Fund
            let fundIn = 0;
            deposits.forEach(d => fundIn += d.amount);
            
            // 2. Calculate Expenses
            let paid = new Map(payers.map(p=>[p,0])); // Who paid how much (in TWD)
            let fundSpent = 0; // How much public fund was used
            let totalSpent = 0;
            
            expenses.forEach(e=>{
                const v = (e.curr==='JPY' ? e.amt*rate : e.amt); 
                totalSpent += v;
                
                if (e.multiPayers) {
                    for (const [p, amt] of Object.entries(e.multiPayers)) {
                        const subVal = (e.curr==='JPY' ? amt*rate : amt);
                        paid.set(p, (paid.get(p)||0) + subVal);
                    }
                } else {
                    if (e.payer === 'å…¬è²»') {
                        fundSpent += v;
                    } else {
                        paid.set(e.payer, (paid.get(e.payer)||0) + v);
                    }
                }
            });

            // 3. Deposit Logic: Treat deposits as "User Paid, Public Fund Consumed (negative)"? 
            // Better: User Paid X, Public Fund OWES User X.
            // But Public Fund is a shared pot. 
            // Correct Logic: 
            // Users have paid: Expenses(Personal) + Deposits(To Fund).
            // Users should have paid: (Total Expense - Fund Spent) / N. (Assuming Fund is neutral).
            // Actually, simplest logic: "Public Fund" is just another user who happens to be prepaid.
            
            deposits.forEach(d => {
                paid.set(d.payer, (paid.get(d.payer)||0) + d.amount); // User paid into the system
                paid.set('å…¬è²»', (paid.get('å…¬è²»')||0) - d.amount); // Fund "received" money (negative paid?) -> No, treat Fund balance separately.
            });

            // Let's use standard Splitwise logic.
            // Total Cost of Trip = Sum of all Expenses.
            // Total Paid by each User = Direct Expense Payments + Deposits.
            // Fair Share = Total Cost / N (Users).
            // Wait, "Public Fund" expenses are shared by everyone. "Private" expenses (if we had them) would be specific.
            // Assuming ALL expenses here are shared.
            
            const humanPayers = payers.filter(p => p !== 'å…¬è²»');
            const splitAmount = totalSpent / humanPayers.length; // Everyone's fair share of TOTAL SPEND
            
            // Net Balance = Paid - Fair Share.
            // But we must account for Public Fund. 
            // The Public Fund pays for some stuff. That money came from Users (Deposits).
            // So: Paid[User] = DirectExp + Deposit.
            // FairShare[User] = TotalSpent / N.
            // Net[User] = Paid[User] - FairShare[User].
            // If Net is positive, you paid more than share -> get back.
            // If Net is negative, you owe.
            
            let net = new Map();
            humanPayers.forEach(p => {
                const userPaid = paid.get(p) || 0;
                net.set(p, userPaid - splitAmount);
            });

            // Manual Debts (IOUs) adjust the Net
            manualDebts.forEach(d=>{ 
                if (net.has(d.debtor)) net.set(d.debtor, net.get(d.debtor) - d.amount); 
                if (net.has(d.creditor)) net.set(d.creditor, net.get(d.creditor) + d.amount); 
            }); 

            // Update UI
            document.getElementById('public-fund-balance').innerText = `NT$ ${Math.round(fundIn - fundSpent)}`;
            document.getElementById('wallet-total-display').innerText = 'NT$ '+Math.round(totalSpent);
            
            let dashboardHtml = humanPayers.map(p=>`<div class="p-2 bg-black/20 rounded border border-white/5"><div class="font-bold text-gray-200 text-[10px] mb-1">${p}</div><div class="font-mono text-lg font-bold ${net.get(p)>=0?'text-green-400':'text-red-400'}">${net.get(p)>=0?'+':''}${Math.round(net.get(p))}</div></div>`).join('');
            document.getElementById('individual-stats-dashboard').innerHTML = dashboardHtml;

            let debtors = [], creditors = []; 
            net.forEach((v,k) => { if(v<-10) debtors.push({p:k,v}); else if(v>10) creditors.push({p:k,v}); }); 
            document.getElementById('settlement-summary').innerHTML = debtors.length===0 ? '<div class="text-center opacity-50">å¸³å‹™å¹³è¡¡ ğŸ‰</div>' : debtors.map(d=>`<div>${d.p} éœ€å†æ”¯ä»˜ <span class="text-red-500 font-bold">${Math.round(Math.abs(d.v))}</span></div>`).join(''); 
            
            // Expense List Rendering
            const filter = document.getElementById('wallet-filter').value; 
            const filtered = filter === 'ALL' ? expenses : expenses.filter(e => e.payer === filter || (e.multiPayers && e.multiPayers[filter])); 
            
            document.getElementById('expense-list').innerHTML = filtered.map(e=>{
                const displayAmt = Math.round(e.curr=='JPY'?e.amt*rate:e.amt);
                return `<div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex gap-3 relative overflow-hidden" onclick="openExpenseModal(${e.id})">
                <div class="absolute left-0 top-0 h-full w-1 ${e.curr=='JPY'?'bg-sakura':'bg-fuji'}"></div>
                <div class="w-12 h-12 bg-gray-50 rounded-full flex-shrink-0 flex items-center justify-center border border-gray-100 mt-1">${e.photo?`<img src="${e.photo}" class="w-full h-full object-cover rounded-full">`:'<i class="fa-solid fa-receipt text-gray-300"></i>'}</div>
                <div class="flex-1">
                    <div class="flex justify-between"><b>${e.note}</b><span class="font-mono text-clay font-bold">NT$ ${displayAmt}</span></div>
                    <div class="text-xs text-gray-400 mt-1 flex justify-between">
                        <span>${e.payer} ä»˜æ¬¾</span>
                        <span class="font-mono">${e.curr} ${e.amt}</span>
                    </div>
                </div></div>`;
            }).join(''); 
        }

        /* --- AI CHATBOT LOGIC --- */
        function toggleAIChat() {
            const m = document.getElementById('ai-chat-modal');
            if(m.classList.contains('hidden')){ m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('pointer-events-none'),10); } 
            else { m.classList.add('hidden'); m.classList.add('pointer-events-none'); }
        }

        function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const text = input.value.trim();
            if(!text) return;
            
            appendChatMsg(text, 'user');
            input.value = '';
            
            // Show Typing
            const history = document.getElementById('ai-chat-history');
            const typingId = 'typing-' + Date.now();
            history.innerHTML += `<div id="${typingId}" class="chat-msg chat-ai"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;
            history.scrollTop = history.scrollHeight;

            // Simulate AI Delay & Logic
            setTimeout(() => {
                document.getElementById(typingId).remove();
                let reply = "";
                
                if (text.includes("åˆ†æ") || text.includes("æ“æ“ åº¦")) {
                    const crowdedDays = itinerary.map(d => {
                        const count = (d.content.match(/\n/g) || []).length + 1;
                        let status = "èˆ’é© ğŸ˜Š";
                        if(count > 4) status = "æœ‰é»è¶• ğŸƒ";
                        if(count > 6) status = "éå¸¸æ“æ“  ğŸ”¥";
                        return `<li><b>${d.date.split(' ')[0]}</b>: ${status}</li>`;
                    }).join('');
                    reply = `æ ¹æ“šä½ çš„è¡Œç¨‹åˆ†æï¼š<ul class="list-disc pl-4 mt-1">${crowdedDays}</ul><div class="mt-2 text-xs">å»ºè­°ï¼šæ¯å¤©å®‰æ’ 3-4 å€‹å¤§é»æœ€å‰›å¥½å–”ï¼</div>`;
                } else if (text.includes("æ‰“åŒ…") || text.includes("æ¸…å–®")) {
                    reply = `æ±äº¬ 1-2 æœˆå¹³å‡æ°£æº«ç´„ 5Â°Cï¼Œå»ºè­°æ”œå¸¶ï¼š
                    <ul class="list-disc pl-4 mt-2">
                        <li>è­·ç…§ (æœ‰æ•ˆæœŸé™6å€‹æœˆä»¥ä¸Š)</li>
                        <li>ç¶²å¡ / eSIM (å»ºè­°å…ˆè²·å¥½)</li>
                        <li>è½‰æ¥é ­ (æ—¥æœ¬å…©å­”æ‰æ’ï¼Œå°ç£é€šç”¨)</li>
                        <li>ä¿æš–å¤§è¡£ (å®¤å…§æœ‰æš–æ°£ï¼Œå»ºè­°æ´‹è”¥å¼)</li>
                        <li>ä¿æ¿•ç”¨å“ (æ—¥æœ¬å¾ˆä¹¾ï¼)</li>
                        <li>å°‘é‡æ—¥å¹£ç¾é‡‘ (æœ‰äº›å°åº—åªæ”¶ç¾)</li>
                    </ul>`;
                } else if (text.includes("ä½ å¥½") || text.includes("å—¨")) {
                    reply = "ä½ å¥½ï¼æº–å‚™å¥½è¦å»æ—…è¡Œäº†å—ï¼Ÿæˆ‘å¯ä»¥å¹«ä½ æª¢æŸ¥è¡Œç¨‹æˆ–æé†’æ‰“åŒ…å–”ï¼";
                } else {
                    reply = "æˆ‘ä¸ç¢ºå®šä½ çš„æ„æ€ï¼Œè©¦è©¦å•æˆ‘ã€Œ<b>æ“æ“ åº¦åˆ†æ</b>ã€æˆ–ã€Œ<b>æ‰“åŒ…æ¸…å–®</b>ã€ï¼Ÿ";
                }
                appendChatMsg(reply, 'ai');
            }, 1000);
        }

        function appendChatMsg(html, role) {
            const history = document.getElementById('ai-chat-history');
            history.innerHTML += `<div class="chat-msg chat-${role}">${html}</div>`;
            history.scrollTop = history.scrollHeight;
        }

        // --- Other Helpers ---
        function deleteExpense(){const id=document.getElementById('ex-id').value;if(id&&confirm("Del?")){expenses=expenses.filter(e=>e.id!=id); saveData(); renderExpenses(); closeModal('expense-modal');}}
        function renderPayerOptions(){const h=payers.map(p=>`<option value="${p}">${p}</option>`).join('');document.getElementById('ex-payer').innerHTML=h;document.getElementById('wallet-filter').innerHTML='<option value="ALL">å…¨éƒ¨</option>'+h;}
        function addPayer(){const n=document.getElementById('new-payer-name').value;if(n&&!payers.includes(n)){payers.push(n); saveData(); renderPayerOptions(); openPayerModal(); renderExpenses();}}
        function removePayer(i){payers.splice(i,1); saveData(); renderPayerOptions(); openPayerModal(); renderExpenses();}
        function openPayerModal(){document.getElementById('payer-list').innerHTML=payers.map((p,i)=>`<div class="flex justify-between p-2 bg-gray-50 rounded"><span>${p}</span>${payers.length>1?`<button onclick="removePayer(${i})" class="text-red-400">x</button>`:''}</div>`).join(''); openModal('payer-modal');}
        
        // --- Lists & Other standard functions (minimized but functional) ---
        function renderMustEatList() { const container = document.getElementById('must-eat-list'); container.innerHTML = ''; const sortedList = [...mustEatList].sort((a, b) => a.location.localeCompare(b.location, 'zh-TW')); let currentGroup = ''; let groupHtml = ''; sortedList.forEach(item => { if (item.location !== currentGroup) { if (currentGroup !== '') { groupHtml += '</div>'; container.innerHTML += groupHtml; } currentGroup = item.location; groupHtml = `<div class="mb-4 pt-3"><h4 class="text-lg font-black handwritten text-matcha border-b-2 border-matcha/30 inline-block px-2 mb-2">${currentGroup}</h4><div class="mt-1 space-y-2">`; } const checked = item.items ? item.items.filter(i => i.done).length : 0; groupHtml += `<div id="eat-item-${item.id}" class="bg-white p-3 rounded shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-yellow-50/50" onclick="openMustEatModal('${item.id}')"><div class="flex-1"><div class="font-bold text-gray-700 font-hand text-lg">${item.name}</div><div class="text-xs text-gray-400 mt-1">${item.note || ''}</div></div><div class="text-right text-xs font-mono bg-gray-100 px-2 py-1 rounded-full text-gray-500">${checked}/${item.items?.length||0}</div></div>`; }); if (currentGroup !== '') { groupHtml += '</div>'; container.innerHTML += groupHtml; } }
        let currentMustEatItems = []; function openMustEatModal(id=null) { ['eat-id','eat-name','eat-location','eat-note'].forEach(k=>document.getElementById(k).value=''); currentMustEatItems = []; if (id) { const item = mustEatList.find(i => i.id === id); document.getElementById('eat-id').value = item.id; document.getElementById('eat-name').value = item.name; document.getElementById('eat-location').value = item.location; document.getElementById('eat-note').value = item.note; currentMustEatItems = JSON.parse(JSON.stringify(item.items || [])); } renderFoodItemsInModal(); openModal('must-eat-modal'); }
        function renderFoodItemsInModal() { document.getElementById('must-eat-items-container').innerHTML = currentMustEatItems.map(item => `<div class="flex items-center justify-between p-2 border-b border-dashed ${item.done ? 'opacity-50' : ''}"><div class="flex-1 flex items-center"><input type="checkbox" onchange="toggleFoodItemDone('${item.id}')" ${item.done ? 'checked' : ''} class="mr-2 accent-matcha"><span class="${item.done ? 'line-through' : ''}">${item.foodName}</span></div><div class="flex gap-2 items-center"><span class="text-xs font-mono">Â¥${item.price}</span><button onclick="deleteFoodItem('${item.id}')" class="text-gray-300 hover:text-red-400">x</button></div></div>`).join(''); }
        function addNewFoodItem() { const name = document.getElementById('new-food-name').value; if (!name) return; currentMustEatItems.push({ id: 'f'+Date.now(), foodName: name, price: parseFloat(document.getElementById('new-food-price').value)||0, done: false, url: document.getElementById('new-food-url').value }); document.getElementById('new-food-name').value=''; renderFoodItemsInModal(); }
        function toggleFoodItemDone(id) { const i = currentMustEatItems.find(x => x.id === id); if(i) i.done = !i.done; renderFoodItemsInModal(); saveData(); }
        function deleteFoodItem(id) { currentMustEatItems = currentMustEatItems.filter(x => x.id !== id); renderFoodItemsInModal(); saveData(); }
        function saveMustEatItem() { const id = document.getElementById('eat-id').value; const name = document.getElementById('eat-name').value; const location = document.getElementById('eat-location').value; const note = document.getElementById('eat-note').value; if (!location) return; const newItem = { id: id || 'eat' + Date.now(), name, location, note, items: currentMustEatItems }; if (id) { const idx = mustEatList.findIndex(i => i.id === id); if (idx > -1) mustEatList[idx] = newItem; } else { mustEatList.push(newItem); } saveData(); renderMustEatList(); renderItinerary(); closeModal('must-eat-modal'); }
        function deleteMustEatItem() { const id = document.getElementById('eat-id').value; if (id && confirm("Del?")) { mustEatList = mustEatList.filter(i => i.id !== id); saveData(); renderMustEatList(); renderItinerary(); closeModal('must-eat-modal'); } }
        function renderChecklist(){document.getElementById('checklist-container').innerHTML=todos.map((t,i)=>`<li class="flex items-center gap-2 p-2 border-b border-gray-100"><input type="checkbox" onchange="toggleTodo(${i})" ${t.done?'checked':''} class="accent-fuji"><input class="flex-1 bg-transparent font-hand text-lg ${t.done?'line-through text-gray-300':''}" value="${t.text}" onchange="updateTodo(${i},this.value)"><button onclick="deleteTodo(${i})" class="text-gray-300">x</button></li>`).join('');}
        function addTodo(){const v=document.getElementById('new-todo').value;if(v){todos.push({text:v,done:false}); saveData(); renderChecklist();document.getElementById('new-todo').value='';}}
        function toggleTodo(i){todos[i].done=!todos[i].done; saveData(); renderChecklist();}
        function updateTodo(i,v){todos[i].text=v; saveData();}
        function deleteTodo(i){todos.splice(i,1); saveData(); renderChecklist();}
        function renderShoppingList() { const p=document.getElementById('shopping-list-pending'), d=document.getElementById('shopping-list-done'); p.innerHTML=''; d.innerHTML=''; shoppingList.forEach(s=>{ const h=`<div class="p-2 border shadow-sm rounded bg-white ${s.done?'opacity-50':''}" onclick="openShoppingModal(${s.id})">${s.photo?`<img src="${s.photo}" class="w-full h-24 object-cover mb-2 rounded-sm">`:''}<b>${s.name}</b><br><span class="text-xs">Qty:${s.qty} Â¥${s.price}</span></div>`; if(s.done)d.innerHTML+=h; else p.innerHTML+=h; }); }
        let currentShopPhoto = null; function openShoppingModal(id=null){ ['shop-id','shop-name','shop-qty','shop-price'].forEach(k=>document.getElementById(k).value=''); currentShopPhoto=null; document.getElementById('shop-photo-preview').classList.add('hidden'); document.getElementById('shop-photo-text').classList.remove('hidden'); if(id){const s=shoppingList.find(i=>i.id===id); document.getElementById('shop-id').value=s.id; document.getElementById('shop-name').value=s.name; document.getElementById('shop-qty').value=s.qty; document.getElementById('shop-price').value=s.price; if(s.photo){currentShopPhoto=s.photo; document.getElementById('shop-photo-preview').src=s.photo; document.getElementById('shop-photo-preview').classList.remove('hidden'); document.getElementById('shop-photo-text').classList.add('hidden');}} openModal('shopping-modal'); }
        function saveShoppingItem(){ const id=document.getElementById('shop-id').value, name=document.getElementById('shop-name').value; if(!name)return; const item={id:id?parseInt(id):Date.now(), name, qty:document.getElementById('shop-qty').value, price:document.getElementById('shop-price').value, photo:currentShopPhoto, done:false}; if(id){const idx=shoppingList.findIndex(i=>i.id==id);if(idx>-1)shoppingList[idx]=item;}else{shoppingList.push(item);} saveData(); renderShoppingList(); closeModal('shopping-modal'); }
        function deleteShoppingItem(){const id=document.getElementById('shop-id').value;if(id&&confirm("Del?")){shoppingList=shoppingList.filter(i=>i.id!=id); saveData(); renderShoppingList(); closeModal('shopping-modal');}}
        
        // IOU Logic
        function renderIOUList() { document.getElementById('iou-list-container').innerHTML = manualDebts.map(iou => `<div class="flex justify-between items-center p-2 border-b bg-gray-50 rounded-sm cursor-pointer hover:bg-gray-100" onclick="openIOUModal('${iou.id}')"><div class="flex-1 mr-2"><span class="text-xs text-gray-500 block">${iou.note || 'èª¿æ•´'}</span><span class="text-sm font-bold text-gray-700">${iou.debtor} æ¬  ${iou.creditor}</span></div><span class="text-sm font-mono text-fuji font-bold">NT$ ${Math.round(iou.amount).toLocaleString()}</span></div>`).join(''); }
        function openIOUModal(id = null) { const payerOpts = payers.map(p => `<option value="${p}">${p}</option>`).join(''); document.getElementById('iou-creditor').innerHTML = payerOpts; document.getElementById('iou-debtor').innerHTML = payerOpts; renderIOUList(); document.getElementById('btn-delete-iou').classList.add('hidden'); ['iou-id','iou-amount','iou-note'].forEach(k=>document.getElementById(k).value=''); if (id) { const iou = manualDebts.find(i => i.id == id); document.getElementById('iou-id').value = iou.id; document.getElementById('iou-creditor').value = iou.creditor; document.getElementById('iou-debtor').value = iou.debtor; document.getElementById('iou-amount').value = iou.amount; document.getElementById('iou-note').value = iou.note || ''; document.getElementById('btn-delete-iou').classList.remove('hidden'); } openModal('iou-modal'); }
        function saveIOU() { const id = document.getElementById('iou-id').value, creditor = document.getElementById('iou-creditor').value, debtor = document.getElementById('iou-debtor').value, amount = parseFloat(document.getElementById('iou-amount').value), note = document.getElementById('iou-note').value; if (!amount || creditor === debtor) return; const newIOU = { id: id || 'iou' + Date.now(), creditor, debtor, amount, note }; if (id) { const idx = manualDebts.findIndex(i => i.id == id); if (idx > -1) manualDebts[idx] = newIOU; } else { manualDebts.push(newIOU); } saveData(); renderExpenses(); closeModal('iou-modal'); }
        function deleteIOU() { const id = document.getElementById('iou-id').value; if (id && confirm("Del?")) { manualDebts = manualDebts.filter(i => i.id != id); saveData(); renderExpenses(); closeModal('iou-modal'); } }
        
        // Flight, Guide List (Standard)
        function renderFlights(){const c=document.getElementById('flight-list-container');c.innerHTML='';if(flights.length===0){c.innerHTML='<div class="text-center py-8 bg-white rounded-xl shadow-sm"><p class="text-gray-300 handwritten text-xl">å°šç„¡èˆªç­è³‡æ–™</p><p class="text-xs text-gray-300 mt-2">é»æ“Šå³ä¸Šè§’æ–°å¢</p></div>';return}flights.forEach(f=>{c.innerHTML+=`<div class="bg-white rounded-[24px] p-5 shadow-soft mb-5 relative group transition-transform hover:-translate-y-1 hand-card" onclick="${f.url?`window.open('${f.url}')`:''}"><div class="absolute top-3 right-4 flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="event.stopPropagation(); editFlight(${f.id})" class="text-gray-300 hover:text-fuji"><i class="fa-solid fa-pen"></i></button><button onclick="event.stopPropagation(); deleteFlight(${f.id})" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button></div><div class="flex justify-between items-center mb-5 px-4 mt-2"><span class="text-4xl font-black handwritten text-pencil tracking-wider">${f.dep}</span><i class="fa-solid fa-plane text-2xl text-fuji transform rotate-[-45deg] mb-2"></i><span class="text-4xl font-black handwritten text-pencil tracking-wider">${f.arr}</span></div><div class="bg-fuji-light rounded-2xl py-3 px-4 text-center"><div class="text-xl font-bold text-fuji handwritten mb-1 tracking-wider">${f.code}</div><div class="text-xs text-gray-400 font-hand font-bold tracking-wide">${f.date} | ${f.time}</div></div></div>`;});}
        function saveFlight(){const id=document.getElementById('flight-id').value;const f={id:id?parseInt(id):Date.now(),dep:document.getElementById('flight-dep').value,arr:document.getElementById('flight-arr').value,code:document.getElementById('flight-code').value,time:document.getElementById('flight-time').value,date:document.getElementById('flight-date').value,url:document.getElementById('flight-url').value};if(!f.dep)return;if(id){const idx=flights.findIndex(i=>i.id==id);if(idx>-1)flights[idx]=f;}else{flights.push(f);}saveData();renderFlights();closeModal('flight-modal');}
        function deleteFlight(id){if(confirm("Del?")){flights=flights.filter(f=>f.id!==id);saveData();renderFlights();}}
        function editFlight(id){const f=flights.find(i=>i.id===id);document.getElementById('flight-id').value=f.id;document.getElementById('flight-dep').value=f.dep;document.getElementById('flight-arr').value=f.arr;document.getElementById('flight-code').value=f.code;document.getElementById('flight-time').value=f.time;document.getElementById('flight-date').value=f.date;document.getElementById('flight-url').value=f.url;openModal('flight-modal');}
        function openFlightModal(){['flight-id','flight-dep','flight-arr','flight-code','flight-time','flight-date','flight-url'].forEach(k=>document.getElementById(k).value='');openModal('flight-modal');}
        function renderGuides(){const l=document.getElementById('guide-list');l.innerHTML='';if(window.guideSortable){window.guideSortable.destroy();window.guideSortable=null}guides.forEach(g=>{l.innerHTML+=`<div id="guide-${g.id}" data-id="${g.id}" class="hand-card p-0 overflow-hidden relative group"><div class="drag-handle absolute top-0 left-0 h-full w-8 bg-black/5 flex items-center justify-center z-10 cursor-grab hover:bg-black/10"><i class="fa-solid fa-ellipsis-vertical text-gray-400"></i></div><button onclick="openGuideModal(${g.id})" class="absolute top-2 right-2 z-20 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center shadow"><i class="fa-solid fa-pen text-gray-500"></i></button>${g.photo?`<img src="${g.photo}" class="w-full h-40 object-cover" onclick="viewPhoto('${g.photo}')">`:''} <div class="p-4 pl-10"><h3 class="font-bold text-lg font-hand">${g.title}</h3><p class="text-sm whitespace-pre-line text-gray-600 mt-1 leading-relaxed">${g.desc}</p></div></div>`});window.guideSortable=new Sortable(l,{handle:'.drag-handle',animation:150,onEnd:function(e){const i=guides.splice(e.oldIndex,1)[0];guides.splice(e.newIndex,0,i);saveData();renderItinerary();}});}
        let currentGuidePhoto=null; function openGuideModal(id=null){currentGuidePhoto=null;document.getElementById('guide-photo-preview').classList.add('hidden');document.getElementById('guide-photo-text').classList.remove('hidden');if(id){const g=guides.find(i=>i.id==id);document.getElementById('guide-id').value=g.id;document.getElementById('guide-title').value=g.title;document.getElementById('guide-desc').value=g.desc;if(g.photo){currentGuidePhoto=g.photo;document.getElementById('guide-photo-preview').src=g.photo;document.getElementById('guide-photo-preview').classList.remove('hidden');document.getElementById('guide-photo-text').classList.add('hidden');}}else{['guide-id','guide-title','guide-desc','guide-coords'].forEach(k=>document.getElementById(k).value='');}openModal('guide-modal');}
        function saveGuide(){const id=document.getElementById('guide-id').value,t=document.getElementById('guide-title').value;if(!t)return;const n={id:id?parseInt(id):Date.now(),title:t,desc:document.getElementById('guide-desc').value,photo:currentGuidePhoto};if(id){const idx=guides.findIndex(i=>i.id==id);if(idx>-1)guides[idx]=n;}else{guides.push(n);}saveData();renderGuides();closeModal('guide-modal');}
        function jumpToGuide(id){switchTab('guide');setTimeout(()=>{document.getElementById('guide-'+id)?.scrollIntoView({behavior:'smooth'});},100);}
        document.getElementById('memo-pad').addEventListener('input',(e)=>{memoText=e.target.value;saveData();});

        window.onload=function(){ reloadLocalData(); if(gistId){document.getElementById('gist-id-input').value=gistId;document.getElementById('gist-token-input').value=gistToken;updateCloudStatus("é€£ç·šä¸­...");forceDownload().then(()=>{window.refreshUI()}).catch(()=>{window.refreshUI()});}else{updateCloudStatus("æœªé€£ç·š");window.refreshUI();} switchTab('plan'); }
    </script>
</body>
</html>
