<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="旅の記">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f9f7f2">

    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">

    <title>一起旅行吧 </title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@400;500;700;900&family=Noto+Serif+TC:wght@400;700;900&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'paper': '#f9f7f2', 'sakura': '#f8c3cd', 'matcha': '#bccc9a', 
                        'fuji': '#7b90d2', 'fuji-light': '#eff6ff', 'pencil': '#595857', 
                        'ink': '#2c2c2c', 'clay': '#b5651d', 'cream': '#fffdf5', 'veggie': '#4ade80'
                    },
                    fontFamily: { 
                        'maru': ['"Zen Maru Gothic"', 'sans-serif'], 
                        'hand': ['"Yomogi"', '"Zen Maru Gothic"', 'cursive'],
                        'serif': ['"Noto Serif TC"', 'serif']
                    },
                    boxShadow: { 'soft': '0 4px 20px rgba(0,0,0,0.03)', 'float': '0 8px 30px rgba(0,0,0,0.08)' },
                    animation: { 'highlight': 'highlight 2s ease-out forwards', 'slide-in': 'slideIn 0.3s ease-out', 'wave': 'wave 1.2s infinite ease-in-out' },
                    keyframes: { 
                        highlight: { '0%': { backgroundColor: 'rgba(252, 211, 77, 0.5)' }, '100%': { backgroundColor: 'transparent' } },
                        slideIn: { '0%': { opacity: 0, transform: 'translateX(10px)' }, '100%': { opacity: 1, transform: 'translateX(0)' } },
                        wave: { '0%, 100%': { height: '20%' }, '50%': { height: '100%' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Serif TC', sans-serif;
            background-color: #f9f7f2;
            color: #595857;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 24px 24px;
            background-position: center top;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            min-height: 100vh;
            padding-bottom: calc(80px + var(--sab));
        }

        .handwritten {
            font-family: 'Yomogi', cursive;
        }

        .modal {
            transition: opacity 0.2s ease-in-out;
        }

        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .hand-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            position: relative;
            transition: transform 0.2s;
            border: 1px solid rgba(0, 0, 0, 0.02);
        }

        .nav-item.active i,
        .nav-item.active span {
            color: #7b90d2;
            font-weight: 900;
        }

        .zoom-container {
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .zoom-container img {
            transition: transform 0.2s;
            cursor: zoom-in;
        }

        .zoom-container img.zoomed {
            max-width: none !important;
            max-height: none !important;
            cursor: zoom-out;
            cursor: grab;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .deco-icon {
            position: absolute;
            pointer-events: none;
            opacity: 0.15;
            z-index: 0;
            font-size: 2rem;
            transform: rotate(10deg);
        }

        /* Voice Wave CSS (Tailwind integrated but kept for specific styling) */
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
        }

        .voice-wave span {
            display: block;
            width: 3px;
            height: 100%;
            background-color: #7b90d2;
            border-radius: 3px;
            animation: wave 1.2s infinite ease-in-out;
        }

        .voice-wave span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .voice-wave span:nth-child(3) {
            animation-delay: 0.4s;
        }

        .weather-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 1.2rem;
            transition: transform 0.2s;
            text-decoration: none;
            margin-left: 8px;
            border: 1px solid #f0f0f0;
        }

        .weather-badge:hover {
            transform: scale(1.1);
        }

        .drag-handle {
            cursor: grab;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.02);
            position: absolute;
            left: 0;
            top: 0;
            z-index: 10;
            border-right: 1px solid rgba(0, 0, 0, 0.03);
        }

        .drag-handle:active {
            cursor: grabbing;
            background-color: rgba(0, 0, 0, 0.05);
        }

        .meal-clickable:active {
            background-color: #f3f4f6;
            border-radius: 4px;
        }

        .guide-link {
            color: #bccc9a;
            font-weight: bold;
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <header
        class="pb-2 px-4 text-center sticky top-0 bg-[#f9f7f2]/95 z-40 backdrop-blur-sm transition-all duration-300 relative border-b border-gray-100/50"
        style="padding-top: max(1.5rem, var(--sat));">
        <h1 class="text-4xl font-black tracking-widest text-ink handwritten relative inline-block mt-2"
            style="font-weight: 900;">
            <span class="absolute -top-5 -left-8 text-3xl rotate-[-15deg] opacity-80">✈️</span>
            旅の記
            <div class="absolute bottom-1 left-0 w-full h-3 bg-sakura/40 -z-10 rounded-full transform -rotate-1"></div>
        </h1>
        <div class="flex justify-center items-center gap-3 mt-2">
            <p class="text-[10px] text-fuji font-bold tracking-[0.2em] font-serif uppercase handwritten">My Travel
                Logbook</p>
            <div id="cloud-status"
                class="text-[10px] bg-gray-200/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 cursor-default">
                <i class="fa-solid fa-code-branch"></i> <span>未連線</span></div>
            <button onclick="forceDownload()" class="text-[10px] bg-white text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 hover:bg-fuji-light hover:text-fuji hover:border-fuji-light shadow-sm"><i class="fa-solid fa-rotate-right"></i> <span>同步</span></button>
        </div>
    </header>

    <main id="app" class="px-4 w-full mx-auto min-h-screen max-w-5xl relative pb-24">

        <div class="deco-icon top-4 left-4 text-4xl">🌸</div>
        <div class="deco-icon top-20 right-10 text-3xl text-blue-200 rotate-[-20deg]">🍙</div>
        <div class="deco-icon bottom-32 left-8 text-3xl text-green-200">🍡</div>
        <div class="deco-icon top-1/3 right-4 text-5xl text-red-100 rotate-[15deg]">⛩️</div>

        <!-- PLAN SECTION -->
        <section id="view-plan" class="view-section animate-fade relative z-10">
            <div class="flex justify-between items-center mb-6 mt-6">
                <h3 class="text-pencil font-bold handwritten text-xl flex items-center">
                    <i class="fa-solid fa-plane-departure mr-2 text-xl text-fuji"></i>航班資訊</h3>
                <button onclick="openFlightModal()" class="text-xs bg-white border border-fuji/30 text-fuji px-4 py-2 rounded-xl shadow-sm active:scale-95 font-bold hover:bg-fuji hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-plus"></i> 新增</button>
            </div>

            <div id="flight-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10"></div>

            <div class="flex justify-between items-center mb-4 border-t-2 border-dashed border-gray-200 pt-8 mt-6">
                <h3 class="text-pencil font-bold handwritten text-xl flex items-center">
                    <i class="fa-solid fa-map-location-dot mr-2 text-xl text-matcha"></i>每日行程</h3>
            </div>

            <!-- Hint -->
            <p
                class="text-xs text-gray-400 mb-6 text-center handwritten flex justify-center items-center gap-4 bg-white/60 py-2 rounded-full mx-auto max-w-xs backdrop-blur-sm shadow-sm">
                <span><i class="fa-solid fa-utensils text-orange-400"></i> 點擊<i class="fa-solid fa-utensils"></i>記帳，點文字跳轉</span>
            </p>

            <div id="itinerary-container" class="space-y-6 md:grid md:grid-cols-2 md:space-y-0 md:gap-6 items-start">
            </div>

            <button onclick="addNewDay()" class="w-full mt-8 mb-8 border-2 border-dashed border-gray-300 text-gray-400 rounded-2xl py-4 hover:bg-white hover:border-matcha hover:text-matcha transition font-bold text-sm bg-white/50 handwritten flex items-center justify-center gap-2 group">
                <i class="fa-solid fa-plus-circle group-hover:scale-110 transition"></i> 寫下一頁回憶
            </button>
        </section>

        <!-- GUIDE SECTION -->
        <section id="view-guide" class="view-section hidden relative z-10">
            <div class="flex justify-between items-end mb-6 mt-6">
                <h2 class="text-2xl font-bold text-pencil handwritten flex items-center gap-2">
                    <span class="text-3xl">🎐</span> 深度導覽</h2>
                <button onclick="openGuideModal()" class="text-sm bg-matcha/20 text-green-800 px-4 py-1.5 rounded-full border border-matcha/50 hover:bg-matcha hover:text-white transition font-bold shadow-sm"><i class="fa-solid fa-plus mr-1"></i>新增景點</button>
            </div>
            <div id="guide-list" class="space-y-6 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-6"></div>
            <p class="text-center text-xs text-gray-300 mt-6 handwritten"><i class="fa-solid fa-grip-vertical mr-1"></i>
                按住左側拖曳排序</p>
        </section>

        <!-- WALLET SECTION -->
        <section id="view-wallet" class="view-section hidden relative z-10">
            <div class="flex justify-between items-center mt-6 mb-6">
                <h2 class="text-2xl font-bold text-pencil handwritten flex items-center gap-2">
                    <span class="text-3xl">👛</span> 旅費</h2>
                <div class="flex items-center gap-1 bg-white px-2 py-1.5 rounded-xl shadow-sm border border-gray-100">
                    <span class="text-[10px] text-gray-400 font-mono font-bold mr-1">匯率</span>
                    <input type="number" id="exchange-rate" value="0.215" step="0.001" onchange="renderExpenses()" class="w-14 text-center rounded text-sm outline-none border-b border-gray-200 py-1 text-fuji font-bold bg-transparent">
                    <button onclick="updateExchangeRate()" id="btn-rate-update" class="w-6 h-6 rounded-full bg-gray-50 text-gray-400 hover:text-fuji hover:bg-fuji-light transition flex items-center justify-center ml-1"><i class="fa-solid fa-arrows-rotate text-xs"></i></button>
                </div>
            </div>

            <!-- Public Fund Card -->
            <div
                class="bg-gradient-to-r from-gray-800 to-gray-700 text-white rounded-2xl p-4 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute right-[-20px] top-[-20px] text-8xl opacity-10 rotate-12">
                    <i class="fa-solid fa-scale-balanced"></i></div>
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-lg"><i class="fa-solid fa-users-line mr-2"></i>公費總覽</h3>
                    <button onclick="openPublicFundModal()" class="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full backdrop-blur-sm transition"><i class="fa-solid fa-gear"></i> 設定</button>
                </div>
                <div class="flex justify-between items-end">
                    <div>
                        <div class="text-xs text-gray-300 mb-1">公費剩餘 (JPY)</div>
                        <div class="text-3xl font-mono font-bold tracking-tight" id="pf-remaining">¥0</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-300 mb-1">總預算</div>
                        <div class="font-mono font-bold" id="pf-total">¥0</div>
                    </div>
                </div>
            </div>

            <!-- Auto Charts Section -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4 transition-all"
                id="wallet-charts-section">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-sm font-bold text-gray-600 flex items-center gap-1">
                        <i class="fa-solid fa-chart-pie text-fuji"></i> 自動分析圖表</h4>
                    <span class="text-[10px] text-gray-400">依成員消費額統計</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="h-32 relative flex items-center justify-center"><canvas
                            id="inlineCategoryChart"></canvas></div>
                    <div class="h-32 relative flex items-center justify-center"><canvas id="inlineMemberChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-2">
                <h4 class="text-sm font-bold text-gray-400 flex items-center gap-2">
                    <i class="fa-solid fa-calculator"></i> 費用分析</h4>
                <button onclick="calculateSettlement()" class="text-xs bg-ink text-white px-3 py-1.5 rounded-lg shadow hover:bg-gray-700 transition font-bold"><i class="fa-solid fa-money-bill-transfer mr-1"></i>結算建議</button>
            </div>

            <div class="flex overflow-x-auto gap-4 pb-4 no-scrollbar mb-4 md:grid md:grid-cols-4 md:overflow-visible"
                id="wallet-dashboard-container"></div>

            <div class="flex justify-between items-center mb-4 mt-4 px-1">
                <h4 class="text-sm font-bold text-gray-400 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left"></i> 最近支出</h4>
                <div class="flex gap-2">
                    <button onclick="openMemberModal()" class="text-xs text-gray-500 bg-white border border-gray-200 rounded-lg px-3 py-1.5 hover:bg-gray-50 shadow-sm transition"><i class="fa-solid fa-users-gear mr-1"></i>成員與頭像</button>
                    <button onclick="openIOUModal()" class="text-xs text-fuji bg-fuji/5 border border-fuji/20 rounded-lg px-3 py-1.5 hover:bg-fuji/10 shadow-sm transition"><i class="fa-solid fa-hand-holding-dollar mr-1"></i>借款</button>
                </div>
            </div>
            <div id="expense-list" class="space-y-3 pb-24 md:grid md:grid-cols-2 md:gap-3 md:space-y-0"></div>
            <div class="fixed bottom-24 right-6 md:right-10 z-30">
                <button onclick="openExpenseModal()" class="bg-ink text-white rounded-full h-14 px-6 shadow-float flex items-center gap-2 hover:scale-105 transition active:scale-95 group border-2 border-white/20">
                    <i class="fa-solid fa-pen-nib text-xl group-hover:rotate-12 transition"></i> <span class="font-bold handwritten tracking-widest text-lg">記一筆</span>
                </button>
            </div>
        </section>

        <!-- LISTS SECTION -->
        <section id="view-lists" class="view-section hidden relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- Must Eat -->
                <div class="hand-card p-6 bg-[#fffdf0] relative border-l-8 border-[#fffdf0]">
                    <div class="absolute -right-2 -top-2 text-4xl opacity-20 rotate-12">🍜</div>
                    <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-300 pb-2">
                        <h3 class="text-xl font-bold text-pencil handwritten flex items-center gap-2">
                            <i class="fa-solid fa-utensils text-matcha"></i> 必吃清單</h3>
                        <button onclick="openMustEatModal()" class="text-xs bg-matcha/10 text-green-700 px-3 py-1.5 rounded-lg border border-matcha/30 shadow-sm hover:bg-matcha hover:text-white transition font-bold">新增/編輯</button>
                    </div>
                    <div id="must-eat-list" class="space-y-3"></div>
                </div>

                <!-- Shopping -->
                <div class="hand-card p-0 bg-white relative border-l-8 border-white overflow-hidden flex flex-col"
                    id="shopping-card">
                    <div class="p-6 pb-2">
                        <div class="absolute -right-2 -top-2 text-4xl opacity-20 rotate-[-10]">🛍️</div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-pencil handwritten flex items-center gap-2">
                                <i class="fa-solid fa-bag-shopping text-red-400"></i> 購物清單</h3>
                            <div class="flex gap-2">
                                <button onclick="openShopOwnerModal()" class="text-xs bg-gray-50 text-gray-500 px-3 py-1.5 rounded-lg border border-gray-100 hover:bg-gray-200 transition font-bold shadow-sm" title="管理購物者"><i class="fa-solid fa-user-pen"></i></button>
                                <button onclick="openShoppingModal()" class="text-xs bg-red-50 text-red-500 px-3 py-1.5 rounded-lg border border-red-100 hover:bg-red-400 hover:text-white transition font-bold shadow-sm">新增</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 rounded-lg p-2 mb-2">
                            <button onclick="prevShopList()" class="w-8 h-8 rounded-full bg-white text-gray-400 hover:text-gray-600 shadow-sm flex items-center justify-center active:scale-95"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                            <div class="text-center">
                                <span id="shop-owner-name" class="font-bold text-gray-700 handwritten text-lg block"></span>
                                <div id="shop-owner-dots" class="flex justify-center gap-1 mt-1 h-2"></div>
                            </div>
                            <button onclick="nextShopList()" class="w-8 h-8 rounded-full bg-white text-gray-400 hover:text-gray-600 shadow-sm flex items-center justify-center active:scale-95"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                        </div>
                    </div>
                    <div id="shopping-swipe-area" class="flex-1 p-6 pt-0 min-h-[300px] touch-pan-y">
                        <!-- Categories Render Here -->
                        <div id="shopping-list-container" class="space-y-4 animate-slide-in"></div>
                    </div>
                </div>

                <div class="hand-card p-6 bg-[#f0f4f8] border-l-8 border-[#f0f4f8]">
                    <h3 class="text-lg font-bold text-center mb-4 text-fuji handwritten">
                        <i class="fa-solid fa-suitcase mr-2"></i>行李確認</h3>
                    <ul id="checklist-container" class="space-y-2"></ul>
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="new-todo" placeholder="新增項目..." class="flex-1 bg-transparent border-b border-gray-300 text-sm outline-none font-hand focus:border-fuji transition px-1">
                        <button onclick="addTodo()" class="text-fuji hover:scale-110 transition"><i class="fa-solid fa-circle-plus fa-lg"></i></button>
                    </div>
                </div>
                <div class="hand-card p-6 bg-[#fffff0] rotate-1 shadow-md border-t-8 border-[#e6e6d8]/30">
                    <div class="absolute top-0 left-0 w-full h-4 bg-yellow-400/10"></div>
                    <h3 class="text-lg font-bold mb-2 handwritten text-yellow-800 flex items-center gap-2">
                        <i class="fa-solid fa-note-sticky"></i> 隨手記 (MEMO)</h3>
                    <textarea id="memo-pad" class="w-full h-48 p-3 bg-transparent border-none resize-none text-sm leading-8 outline-none text-gray-700 handwritten" style="background-image: repeating-linear-gradient(transparent, transparent 31px, #e5e5e5 32px); line-height: 32px;" placeholder="在這裡隨手記下想法... (輸入後自動同步)"></textarea>
                </div>
            </div>
        </section>

        <!-- INFO SECTION (MODIFIED FOR NEW AI TRANSLATION) -->
        <section id="view-info" class="view-section hidden relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">

                <!-- NEW AI TRANSLATOR CARD -->
                <div class="hand-card p-5 bg-white border border-gray-100 shadow-sm mb-6">
                    <h3 class="font-bold text-gray-700 handwritten text-xl flex items-center gap-2 mb-3">
                        <span class="bg-fuji text-white rounded-full w-8 h-8 flex items-center justify-center text-sm"><i class="fa-solid fa-robot"></i></span>
                        AI 智慧翻譯
                    </h3>

                    <!-- Input Area -->
                    <div class="relative mb-4">
                        <textarea id="ai-trans-input" class="w-full h-32 p-4 bg-gray-50 rounded-2xl border border-gray-200 resize-none text-lg font-bold text-gray-700 outline-none focus:border-fuji focus:bg-white transition" placeholder="請輸入或點擊麥克風說話..."></textarea>

                        <!-- Voice Wave Animation (Hidden by default) -->
                        <div id="ai-voice-anim" class="hidden absolute bottom-3 right-3 flex gap-1 items-end h-6">
                            <span class="w-1 bg-fuji animate-[wave_1s_infinite] h-2"></span>
                            <span class="w-1 bg-fuji animate-[wave_1.2s_infinite] h-4"></span>
                            <span class="w-1 bg-fuji animate-[wave_0.8s_infinite] h-3"></span>
                            <span class="w-1 bg-fuji animate-[wave_1.1s_infinite] h-5"></span>
                        </div>
                    </div>

                    <!-- Functional Buttons Grid -->
                    <div class="grid grid-cols-4 gap-2">
                        <!-- 1. Voice Input -->
                        <button onclick="startDictation()" class="col-span-1 bg-fuji/10 text-fuji hover:bg-fuji hover:text-white rounded-xl py-3 flex flex-col items-center justify-center gap-1 transition active:scale-95 group">
                            <i class="fa-solid fa-microphone text-xl group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">語音輸入</span>
                        </button>

                        <!-- 2. Google Translate -->
                        <button onclick="doTranslate('google')" class="col-span-1 bg-blue-50 text-blue-600 hover:bg-blue-500 hover:text-white rounded-xl py-3 flex flex-col items-center justify-center gap-1 transition active:scale-95">
                            <i class="fa-brands fa-google text-xl"></i>
                            <span class="text-[10px] font-bold">Google譯</span>
                        </button>

                        <!-- 3. DeepL AI Translate -->
                        <button onclick="doTranslate('deepl')" class="col-span-1 bg-gray-100 text-gray-700 hover:bg-gray-800 hover:text-white rounded-xl py-3 flex flex-col items-center justify-center gap-1 transition active:scale-95" title="AI 精準翻譯">
                            <i class="fa-solid fa-brain text-xl"></i>
                            <span class="text-[10px] font-bold">DeepL(AI)</span>
                        </button>

                        <!-- 4. Camera Translate -->
                        <button onclick="openCameraTranslate()" class="col-span-1 bg-pink-50 text-pink-500 hover:bg-pink-400 hover:text-white rounded-xl py-3 flex flex-col items-center justify-center gap-1 transition active:scale-95">
                            <i class="fa-solid fa-camera text-xl"></i>
                            <span class="text-[10px] font-bold">拍照翻譯</span>
                        </button>
                    </div>

                    <div class="mt-3 flex justify-between items-center px-1">
                        <button onclick="document.getElementById('ai-trans-input').value=''" class="text-xs text-gray-400 hover:text-red-400"><i class="fa-solid fa-eraser"></i> 清空</button>
                        <span class="text-[10px] text-gray-300">支援日文/中文雙向自動偵測</span>
                    </div>
                </div>

                <div class="space-y-6">
                    <div
                        class="hand-card p-0 overflow-hidden bg-blue-50/30 border border-blue-100 group hover:shadow-lg transition">
                        <div class="p-4 bg-gradient-to-r from-blue-500/10 to-transparent flex justify-between items-center cursor-pointer"
                            onclick="toggleVJW()">
                            <h3 class="font-bold text-blue-800 handwritten text-lg flex items-center gap-2">
                                <i class="fa-solid fa-passport"></i>Visit Japan Web</h3>
                            <div class="flex gap-2 items-center">
                                <a href="https://www.vjw.digital.go.jp/" target="_blank"
                                    onclick="event.stopPropagation()"
                                    class="text-xs bg-white text-blue-500 px-3 py-1.5 rounded-full shadow-sm hover:bg-blue-500 hover:text-white transition font-bold"><i class="fa-solid fa-link"></i></a>
                                <i id="vjw-arrow" class="fa-solid fa-chevron-down text-blue-300 transition-transform"></i>
                            </div>
                        </div>
                        <div id="vjw-content" class="transition-all duration-300 overflow-hidden">
                            <div class="p-4 pb-6">
                                <div id="vjw-container"
                                    class="flex overflow-x-auto gap-4 snap-x snap-mandatory pb-4 no-scrollbar items-start">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <a href="https://tenki.jp/" target="_blank"
                            class="hand-card p-4 flex flex-col items-center justify-center hover:bg-blue-50 transition group">
                            <i class="fa-solid fa-cloud-sun-rain text-3xl text-fuji mb-2 group-hover:scale-110 transition"></i><span class="font-bold text-sm text-gray-600">Tenki.jp 天氣</span>
                        </a>
                        <a href="https://www.google.com/maps/search/drugstore" target="_blank"
                            class="hand-card p-4 flex flex-col items-center justify-center hover:bg-pink-50 transition group">
                            <i class="fa-solid fa-store text-3xl text-sakura mb-2 group-hover:scale-110 transition"></i><span class="font-bold text-sm text-gray-600">附近藥妝</span>
                        </a>
                    </div>
                    <details class="group hand-card overflow-hidden border border-gray-200">
                        <summary
                            class="flex justify-between items-center p-4 cursor-pointer bg-gray-50 hover:bg-gray-100 transition list-none">
                            <span class="text-xs font-bold text-gray-500 flex items-center gap-2"><i class="fa-brands fa-github text-lg"></i> 雲端同步設定</span>
                            <span class="text-gray-400 group-open:rotate-180 transition text-xs"><i class="fa-solid fa-chevron-down"></i></span>
                        </summary>
                        <div class="p-4 bg-white space-y-3 border-t border-gray-100">
                            <div class="text-[10px] text-gray-400 mb-2">設定 Gist ID 後，資料變動將自動上傳。</div>
                            <div><label class="text-[10px] font-bold text-gray-400 block mb-1">Gist ID</label><input type="text" id="gist-id-input" placeholder="Gist ID" class="w-full border p-2 rounded text-xs font-mono bg-gray-50 outline-none focus:border-matcha">
                            </div>
                            <div><label class="text-[10px] font-bold text-gray-400 block mb-1">Token</label><input type="password" id="gist-token-input" placeholder="Token" class="w-full border p-2 rounded text-xs font-mono bg-gray-50 outline-none focus:border-matcha">
                            </div>
                            <button onclick="saveGistConfig()" class="w-full bg-ink text-white px-3 py-2 rounded text-xs font-bold hover:bg-gray-800 transition">儲存設定</button>
                        </div>
                    </details>
                </div>
            </div>
        </section>
    </main>

    <!-- EXPENSE MODAL (Revamped Fixed) -->
    <div id="expense-modal"
        class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#fffdf9] w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative hand-card border border-white">
            <button onclick="closeModal('expense-modal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-bold mb-6 text-center text-gray-700 tracking-wide">記一筆</h3>
            <input type="hidden" id="ex-id">

            <!-- Amount -->
            <div class="flex items-center justify-center gap-2 mb-6">
                <select id="ex-currency" class="bg-gray-100 text-gray-600 font-bold rounded-lg px-2 py-1 outline-none text-sm border-none">
                    <option value="JPY">JPY</option>
                    <option value="TWD">TWD</option>
                </select>
                <input type="number" id="ex-amount" placeholder="0" class="text-4xl font-bold text-center w-40 outline-none bg-transparent border-b-2 border-gray-100 focus:border-sakura text-gray-700" inputmode="numeric">
            </div>

            <!-- Category -->
            <div class="flex justify-between mb-4 overflow-x-auto pb-2 no-scrollbar gap-2" id="expense-categories">
            </div>

            <!-- Payer (Who paid) - FIXED: Dropdown -->
            <div class="mb-4 bg-fuji-light/30 p-3 rounded-xl border border-fuji/10">
                <label class="block text-xs text-fuji mb-1 font-bold ml-1"><i class="fa-solid fa-hand-holding-dollar mr-1"></i>墊付人 (誰先出錢)</label>
                <div class="relative">
                    <select id="ex-paid-by" class="w-full bg-white rounded-lg p-2 text-sm font-bold text-gray-700 border border-fuji/20 focus:border-fuji outline-none appearance-none"></select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                        <i class="fa-solid fa-chevron-down text-xs"></i></div>
                </div>
            </div>

            <!-- Splitters (Shared by) -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs text-gray-400 font-bold ml-1">分攤人 (平分費用)</label>
                    <button onclick="toggleAllPayers()" class="text-[10px] text-fuji bg-fuji-light px-2 py-0.5 rounded font-bold">全選/全取消</button>
                </div>
                <div id="ex-split-container" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="mb-4">
                <input type="text" id="ex-note" placeholder="備註說明..." class="w-full bg-gray-50 rounded-xl p-3 text-sm outline-none border border-gray-100">
            </div>

            <div class="flex gap-3 items-center mb-6">
                <div
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 relative overflow-hidden cursor-pointer hover:bg-gray-200">
                    <i class="fa-solid fa-camera"></i>
                    <input type="file" id="ex-photo" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentPhotoBase64 = base64; document.getElementById('ex-photo-preview-mini').src = base64; document.getElementById('ex-photo-preview-mini').classList.remove('hidden'); })">
                    <img id="ex-photo-preview-mini" class="hidden absolute inset-0 w-full h-full object-cover">
                </div>
                <span class="text-xs text-gray-400">收據</span>
            </div>

            <div class="flex gap-3">
                <button onclick="deleteExpense()" id="btn-delete-expense" class="w-12 h-12 rounded-full bg-gray-100 text-gray-400 hidden"><i class="fa-solid fa-trash-can"></i></button>
                <button onclick="saveExpense()" class="flex-1 bg-ink text-white py-3 rounded-full font-bold shadow-lg">確認儲存</button>
            </div>
        </div>
    </div>

    <!-- SETTLEMENT MODAL -->
    <div id="settlement-modal"
        class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div
            class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl relative hand-card max-h-[85vh] overflow-y-auto">
            <button onclick="closeModal('settlement-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-bold mb-4 text-center handwritten text-ink">結算建議書</h3>

            <div class="bg-blue-50 p-4 rounded-xl mb-6 border border-blue-100">
                <h4 class="font-bold text-blue-800 text-sm mb-2"><i class="fa-solid fa-money-bill-transfer"></i> 建議轉帳路徑
                </h4>
                <div id="settlement-plan" class="space-y-3 text-sm"></div>
            </div>

            <h4 class="font-bold text-gray-600 text-sm mb-2">收支平衡表 (NT$)</h4>
            <div class="h-48 relative flex items-center justify-center mb-4">
                <canvas id="settlementChart"></canvas>
            </div>

            <div id="settlement-details" class="space-y-2 text-xs text-gray-500 bg-gray-50 p-3 rounded-lg"></div>

            <button onclick="closeModal('settlement-modal')" class="w-full mt-4 bg-ink text-white py-3 rounded-xl font-bold">了解</button>
        </div>
    </div>

    <!-- FLIGHT MODAL -->
    <div id="flight-modal"
        class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-3xl p-6 shadow-2xl relative hand-card">
            <button onclick="closeModal('flight-modal')" class="absolute top-3 right-3 text-gray-400 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center handwritten">編輯航班</h3>
            <div class="space-y-4">
                <input type="hidden" id="flight-id">
                <div class="flex gap-4 items-center">
                    <input type="text" id="flight-dep" placeholder="TPE" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white">
                    <i class="fa-solid fa-plane text-gray-300"></i>
                    <input type="text" id="flight-arr" placeholder="NRT" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white">
                </div>
                <div class="bg-fuji-light p-4 rounded-xl">
                    <input type="text" id="flight-code" placeholder="航班代號 (例: IT202)" class="w-full p-2 border-b border-fuji/20 bg-transparent text-center font-bold text-fuji handwritten text-xl mb-2 focus:outline-none placeholder-fuji/40">
                    <input type="text" id="flight-date" placeholder="日期 (例: 1/10 去程)" class="w-full p-1 bg-transparent text-center text-sm font-hand text-gray-500 mb-1 focus:outline-none">
                    <input type="text" id="flight-time" placeholder="時間 (例: 14:00 - 18:00)" class="w-full p-1 bg-transparent text-center text-sm font-hand text-gray-500 focus:outline-none">
                </div>
                <input type="url" id="flight-url" placeholder="連結 (e-ticket)" class="w-full p-2 border rounded-lg bg-white text-xs text-center outline-none">
                <button onclick="saveFlight()" class="w-full bg-fuji text-white py-3 rounded-xl font-bold mt-2 shadow-lg shadow-fuji/30 hover:bg-fuji/90 transition handwritten tracking-widest">儲 存</button>
            </div>
        </div>
    </div>

    <!-- DAY MODAL -->
    <div id="day-modal"
        class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div
            class="bg-[#f9f7f2] w-full max-w-lg rounded-2xl p-4 shadow-2xl relative hand-card h-[85vh] overflow-y-auto border-4 border-white">
            <button onclick="closeModal('day-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-2 text-center handwritten">編輯行程</h3>
            <input type="hidden" id="day-id-edit">

            <div class="flex gap-2 items-center mb-2">
                <input type="text" id="day-date-edit" class="flex-1 p-2 border-b-2 border-matcha bg-transparent font-bold font-hand text-xl focus:outline-none" placeholder="日期標題">
                <select id="day-weather-edit" class="bg-white border rounded p-1 text-2xl outline-none shadow-sm h-10 w-24">
                     <option value="">☁ 天氣</option>
                     <option value="sunny">☀ 晴</option>
                     <option value="cloudy">☁ 陰</option>
                     <option value="rain">☂ 雨</option>
                     <option value="snow">⛄ 雪</option>
                 </select>
            </div>

            <button onclick="searchDayWeather()" class="w-full bg-blue-50 text-blue-500 text-xs py-2 rounded-lg mb-4 font-bold border border-blue-100 hover:bg-blue-100 transition shadow-sm">
                <i class="fa-solid fa-magnifying-glass mr-1"></i> 搜尋當日天氣
            </button>

            <label class="flex items-center space-x-2 text-sm text-gray-600 mb-4 bg-yellow-50 p-2 rounded"><input type="checkbox" id="day-highlight-edit" class="accent-red-400"><span>標記為重點天數 (Highlight)</span></label>

            <div class="mb-4 bg-white p-2 rounded border border-gray-200 shadow-inner">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-gray-400">當日相片集</h4>
                    <div class="relative overflow-hidden inline-block">
                        <button class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs hover:bg-gray-200"><i class="fa-solid fa-plus"></i> 新增</button>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addDayPhoto(this)">
                    </div>
                </div>
                <div id="day-photos-preview" class="grid grid-cols-3 gap-2"></div>
            </div>

            <div class="mb-4">
                <input type="text" id="day-accommodation-edit" class="w-full p-2 border rounded text-sm mb-2" placeholder="住宿地點 (可直接貼 Google Maps 連結)">
                <input type="url" id="day-accommodation-url-edit" class="w-full p-2 border rounded text-sm" placeholder="Google Maps 連結 (選填)">
            </div>

            <div class="mb-4 border-t pt-3 bg-gray-50 p-2 rounded-lg border border-gray-100">
                <h4 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1">
                    <i class="fa-solid fa-train"></i> 交通方式</h4>
                <div class="flex gap-2 mb-2">
                    <input type="time" id="day-trans-time" class="w-1/3 p-2 border border-gray-300 rounded text-sm">
                    <input type="text" id="day-trans-content" placeholder="內容 (如: 搭新幹線)" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                </div>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="day-trans-note" placeholder="備註 (如: 買票)" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                </div>
                <div
                    class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative hover:bg-white bg-white">
                    <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentTransPhoto = base64; document.getElementById('trans-photo-preview').src = base64; document.getElementById('trans-photo-preview').classList.remove('hidden'); document.getElementById('trans-photo-text').classList.add('hidden'); })">
                    <div id="trans-photo-text" class="text-xs text-gray-400">
                        <i class="fa-solid fa-ticket mb-1 block"></i> 上傳車票/時刻表</div>
                    <img id="trans-photo-preview" class="hidden h-20 mx-auto object-contain rounded">
                    <button onclick="clearTransPhoto()" class="absolute top-1 right-1 bg-gray-200 rounded-full w-5 h-5 text-[10px] text-gray-500 z-10"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>

            <textarea id="day-content-edit" class="w-full h-32 p-3 border rounded-lg bg-white text-sm mb-4 font-hand leading-relaxed" placeholder="行程內容... (請用反斜線 '\' 分隔每項活動，若內容包含'深度導覽'的標題，會自動產生連結)"></textarea>

            <div class="bg-white p-3 rounded-lg border mb-4 space-y-4 shadow-sm">
                <h4 class="text-xs font-bold text-gray-400 border-b pb-1">三餐安排 (輸入連結可跳轉)</h4>
                <div class="border-b pb-2">
                    <div class="flex gap-2 mb-1 items-center">
                        <i class="fa-solid fa-mug-hot text-orange-300 w-5"></i>
                        <input type="text" id="meal-b-name" placeholder="早餐名稱" class="flex-1 text-sm font-bold bg-transparent border-b border-gray-100">
                    </div>
                    <input type="url" id="meal-b-link" placeholder="早餐連結 (Google Maps/Tabelog...)" class="w-full text-xs text-fuji bg-gray-50 p-1 rounded">
                </div>
                <div class="border-b pb-2">
                    <div class="flex gap-2 mb-1 items-center">
                        <i class="fa-solid fa-utensils text-green-400 w-5"></i>
                        <input type="text" id="meal-l-name" placeholder="午餐名稱" class="flex-1 text-sm font-bold bg-transparent border-b border-gray-100">
                    </div>
                    <input type="url" id="meal-l-link" placeholder="午餐連結" class="w-full text-xs text-fuji bg-gray-50 p-1 rounded">
                </div>
                <div>
                    <div class="flex gap-2 mb-1 items-center">
                        <i class="fa-solid fa-wine-glass text-purple-400 w-5"></i>
                        <input type="text" id="meal-d-name" placeholder="晚餐名稱" class="flex-1 text-sm font-bold bg-transparent border-b border-gray-100">
                    </div>
                    <input type="url" id="meal-d-link" placeholder="晚餐連結" class="w-full text-xs text-fuji bg-gray-50 p-1 rounded">
                </div>
            </div>

            <textarea id="day-note-edit" class="w-full h-20 p-2 border border-yellow-200 bg-yellow-50 rounded text-sm mb-4 handwritten" placeholder="每日備註..."></textarea>

            <div class="flex gap-2">
                <button onclick="deleteDay()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm">刪除</button><button onclick="saveDay()" class="flex-[2] bg-matcha text-white py-2 rounded-lg font-bold shadow">儲存</button>
            </div>
        </div>
    </div>

    <!-- GUIDE MODAL -->
    <div id="guide-modal"
        class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('guide-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="font-bold mb-3 handwritten text-lg">新增/編輯景點導覽</h3>
            <input type="hidden" id="guide-id">
            <input type="text" id="guide-title" placeholder="景點名稱" class="w-full mb-3 border-b bg-transparent p-2 font-bold font-hand text-lg focus:border-matcha outline-none">
            <textarea id="guide-desc" placeholder="介紹內容..." class="w-full mb-3 border bg-white p-2 rounded h-24 text-sm"></textarea>
            <div class="flex gap-2 mb-3">
                <input type="text" id="guide-price" placeholder="預算/門票 (如: ¥2000)" class="w-1/2 border rounded p-2 text-xs bg-white">
                <input type="text" id="guide-time" placeholder="營業/建議時間 (10:00-20:00)" class="w-1/2 border rounded p-2 text-xs bg-white">
            </div>
            <div
                class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative mb-3 hover:bg-white bg-white/50">
                <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentGuidePhoto = base64; document.getElementById('guide-photo-preview').src = base64; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden'); })">
                <div id="guide-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-image mb-1 block"></i>
                    更新照片</div>
                <img id="guide-photo-preview" class="hidden h-32 mx-auto object-cover rounded">
            </div>
            <button onclick="saveGuide()" class="w-full bg-matcha text-white py-2 rounded-lg font-bold">儲存</button>
        </div>
    </div>

    <!-- PUBLIC FUND MODALS -->
    <div id="pf-settings-modal"
        class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg hand-card">
            <h4 class="font-bold mb-3 text-center text-lg handwritten">公費設定</h4>
            <div class="mb-4">
                <label class="text-xs text-gray-400 block mb-1">公費總金額 (JPY)</label>
                <input type="number" id="pf-total-input" class="w-full border p-2 rounded text-lg font-bold font-mono outline-none focus:border-matcha text-center">
            </div>
            <button onclick="savePublicFundSettings()" class="w-full bg-gray-800 text-white py-2 rounded-lg text-sm font-bold shadow">儲存</button>
            <button onclick="closeModal('pf-settings-modal')" class="w-full mt-2 bg-gray-100 text-gray-500 py-2 rounded-lg text-sm">取消</button>
        </div>
    </div>

    <!-- SHOPPING MODAL (FIXED TAGS) -->
    <div id="shopping-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('shopping-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="font-bold mb-3 text-center">購物項目</h3>
            <input type="hidden" id="shop-id">
            <input type="text" id="shop-name" placeholder="商品名稱" class="w-full mb-3 border-b bg-transparent p-2 font-bold">

            <div class="mb-3">
                <label class="text-xs text-gray-400">分類 (可直接輸入)</label>
                <input type="text" id="shop-category" placeholder="例: 藥妝, Outlet, 超商..." class="w-full border rounded p-2 text-sm bg-white mb-2">
                <div class="flex flex-wrap gap-2">
                    <button onclick="setShopCat('藥妝')" class="text-xs bg-pink-50 text-pink-500 px-2 py-1 rounded-full border border-pink-100">藥妝</button>
                    <button onclick="setShopCat('Outlet')" class="text-xs bg-blue-50 text-blue-500 px-2 py-1 rounded-full border border-blue-100">Outlet</button>
                    <button onclick="setShopCat('便利商店')" class="text-xs bg-green-50 text-green-500 px-2 py-1 rounded-full border border-green-100">便利商店</button>
                    <button onclick="setShopCat('伴手禮')" class="text-xs bg-red-50 text-red-500 px-2 py-1 rounded-full border border-red-100">伴手禮</button>
                    <button onclick="setShopCat('電器')" class="text-xs bg-gray-50 text-gray-500 px-2 py-1 rounded-full border border-gray-100">電器</button>
                    <button onclick="setShopCat('服飾')" class="text-xs bg-purple-50 text-purple-500 px-2 py-1 rounded-full border border-purple-100">服飾</button>
                </div>
            </div>

            <div class="flex gap-2 mb-3">
                <div class="flex-1"><label class="text-xs text-gray-400">數量</label><input type="number" id="shop-qty" value="1" class="w-full border rounded p-2 text-sm">
                </div>
                <div class="flex-[2]"><label class="text-xs text-gray-400">單價 (JPY)</label><input type="number" id="shop-price" placeholder="0" class="w-full border rounded p-2 text-sm">
                </div>
            </div>

            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center relative mb-4 bg-white">
                <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentShopPhoto = base64; document.getElementById('shop-photo-preview').src = base64; document.getElementById('shop-photo-preview').classList.remove('hidden'); document.getElementById('shop-photo-text').classList.add('hidden'); })">
                <div id="shop-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-camera mb-1 block"></i> 照片
                </div>
                <img id="shop-photo-preview" class="hidden h-32 mx-auto object-contain rounded">
            </div>

            <div class="flex gap-2">
                <button onclick="deleteShoppingItem()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg">刪除</button>
                <button onclick="saveShoppingItem()" class="flex-[2] bg-red-400 text-white py-2 rounded-lg font-bold shadow">儲存</button>
            </div>
        </div>
    </div>

    <!-- SHOPPING CONFIRM MODAL -->
    <div id="shop-confirm-modal"
        class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl relative hand-card text-center">
            <div class="text-4xl mb-2">🛍️</div>
            <h3 class="font-bold text-lg mb-2 text-gray-800">購買確認</h3>
            <p class="text-gray-500 text-sm mb-6">這筆消費是否要加入記帳？</p>
            <input type="hidden" id="confirm-shop-id">
            <div class="space-y-3">
                <button onclick="confirmShopAction('expense')" class="w-full bg-ink text-white py-3 rounded-xl font-bold shadow-lg text-sm">是，加入記帳 (並標記已買)</button>
                <button onclick="confirmShopAction('cancel')" class="w-full bg-white border border-gray-200 text-gray-500 py-3 rounded-xl font-bold text-sm hover:bg-gray-50">否，取消 (保留在清單)</button>
                <div class="pt-2">
                    <button onclick="confirmShopAction('done_only')" class="text-xs text-gray-400 hover:text-gray-600 underline">純標記已買 (不記帳)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Modals -->
    <div id="must-eat-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div
            class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('must-eat-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center text-matcha">🍽️ 編輯必吃地點</h3><input type="hidden" id="eat-loc-id">
            <div class="mb-4"><label class="text-xs text-gray-400 block mb-1">地點名稱</label><input type="text" id="eat-location" placeholder="例如: 輕井澤、築地市場" class="w-full p-2 border-b-2 border-matcha/50 bg-transparent font-bold text-lg focus:outline-none">
            </div><label class="text-xs text-gray-400 block mb-2">主題/餐廳列表</label>
            <div id="eat-themes-container" class="space-y-3 mb-4"></div>
            <button onclick="addThemeRow()" class="w-full py-2 border-2 border-dashed border-matcha/30 text-matcha rounded-lg text-sm font-bold mb-4 hover:bg-matcha/10 transition"><i class="fa-solid fa-plus"></i> 新增主題</button>
            <div class="flex gap-2">
                <button onclick="deleteMustEatLocation()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hover:bg-red-100">刪除整組</button><button onclick="saveMustEatLocation()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow hover:bg-fuji/80">儲存</button>
            </div>
        </div>
    </div>
    <div id="manage-shop-lists-modal"
        class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg hand-card">
            <h4 class="font-bold mb-3 text-center text-lg handwritten">管理購物清單</h4>
            <div id="shop-lists-container" class="space-y-2 mb-3 max-h-60 overflow-y-auto"></div>
            <div class="flex gap-2 border-t pt-3">
                <input type="text" id="new-shop-list-name" placeholder="輸入名稱 (如: 媽媽)" class="flex-1 border p-2 text-sm rounded bg-gray-50 outline-none focus:border-red-300"><button onclick="addShopList()" class="bg-red-400 text-white px-3 rounded text-sm font-bold shadow-sm">新增</button>
            </div>
            <button onclick="closeModal('manage-shop-lists-modal')" class="w-full mt-3 bg-gray-100 text-gray-500 py-2 rounded-lg text-sm hover:bg-gray-200 transition">完成</button>
        </div>
    </div>
    <div id="iou-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div
            class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('iou-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center text-fuji">🤝 手動欠款/借款</h3><input type="hidden" id="iou-id">
            <div class="space-y-3 p-3 border rounded-lg bg-white mb-4">
                <div class="text-xs text-gray-500 mb-1">誰借給誰？</div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">債權人</label><select id="iou-creditor" class="w-full bg-white border rounded p-1 text-sm"></select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">債務人</label><select id="iou-debtor" class="w-full bg-white border rounded p-1 text-sm"></select>
                    </div>
                </div>
                <div class="flex items-center gap-2 bg-gray-50 border rounded p-2">
                    <span class="font-bold text-sm">TWD</span><input type="number" id="iou-amount" placeholder="金額" class="flex-1 text-lg text-right w-full bg-transparent" inputmode="numeric">
                </div><input type="text" id="iou-note" placeholder="備註" class="w-full p-2 border rounded text-sm">
                <div class="flex gap-2 mt-3">
                    <button onclick="deleteIOU()" id="btn-delete-iou" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden">刪除</button><button onclick="saveIOU()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow">儲存</button>
                </div>
            </div>
            <h4 class="text-sm font-bold text-gray-600 mb-2">列表:</h4>
            <div id="iou-list-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner"></div>
        </div>
    </div>
    <div id="member-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg">
            <h4 class="font-bold mb-3 text-center">管理成員與頭像</h4>
            <div id="member-list" class="space-y-2 mb-3 max-h-60 overflow-y-auto"></div>
            <div class="flex gap-2">
                <input type="text" id="new-payer-name" placeholder="新成員名稱" class="flex-1 border p-1 text-sm rounded"><button onclick="addPayer()" class="bg-matcha text-white px-3 rounded text-sm">新增</button>
            </div>
            <button onclick="closeModal('member-modal')" class="w-full mt-3 bg-gray-200 py-1 rounded text-sm">關閉</button>
        </div>
    </div>
    <div id="lightbox-modal"
        class="modal hidden fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center p-4 backdrop-blur-sm"
        onclick="closeModal('lightbox-modal')">
        <div
            class="absolute top-4 right-4 text-white/80 z-50 cursor-pointer bg-white/10 rounded-full w-10 h-10 flex items-center justify-center hover:bg-white/20 transition">
            <i class="fa-solid fa-times"></i></div>
        <div id="lightbox-container" class="zoom-container w-full h-full flex items-center justify-center"
            onclick="event.stopPropagation()"><img id="lightbox-image" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded" onclick="toggleZoom(this)">
        </div>
    </div>

    <!-- NAV BAR -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#f9f7f2]/95 border-t border-gray-200 pt-2 pb-safe px-6 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] backdrop-blur-sm"
        style="padding-bottom: calc(10px + var(--sab));">
        <div class="flex justify-between items-center w-full mx-auto pb-1 max-w-lg">
            <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center text-gray-400 transition flex-1" data-target="plan"><i class="fa-solid fa-map text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">行程</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="guide"><i class="fa-solid fa-book-open text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">導覽</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="wallet"><i class="fa-solid fa-wallet text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">記帳</span></button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="lists"><i class="fa-solid fa-list-check text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">清單</span></button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="info"><i class="fa-solid fa-circle-info text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">資訊</span></button>
        </div>
    </nav>

    <script>
        // --- DATA & CONFIG ---
        const PRELOADED_GUIDES = [
            {id: 101, title: "輕井澤王子 Outlet", price: "免費", desc: "必逛！車站南口直達。\n推薦品牌：BEAMS, Nike, Gucci, Le Creuset。", photo: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Karuizawa_Prince_Shopping_Plaza_East.JPG/1200px-Karuizawa_Prince_Shopping_Plaza_East.JPG", time: "10:00 - 19:00"},
            {id: 102, title: "石之教堂", price: "免費", desc: "內村鑑三紀念堂。建築與自然融合。\n注意：婚禮進行時無法參觀。", photo: "https://www.stonechurch.jp/images/top/main_01_sp.jpg", time: "09:00 - 18:00"},
            {id: 103, title: "淺草雷門", price: "免費", desc: "東京最著名地標。仲見世通吃人形燒、炸肉餅。", photo: "https://live.staticflickr.com/65535/51866385172_9780a42e5d_b.jpg", time: "全天"},
            {id: 104, title: "東京鐵塔", price: "¥1200~", desc: "紅色經典。推薦預約 Top Deck Tour。", photo: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/Tokyo_Tower_special_light_up_2020.jpg/800px-Tokyo_Tower_special_light_up_2020.jpg", time: "09:00 - 23:00"}
        ];

        const WEATHER_MAP = {'sunny': '☀', 'cloudy': '☁', 'rain': '☂', 'snow': '⛄'};
        const expenseCategories = [{ id: '餐飲', icon: 'fa-utensils', color: 'bg-yellow-100 text-yellow-600' }, { id: '交通', icon: 'fa-train-subway', color: 'bg-blue-100 text-blue-600' }, { id: '購物', icon: 'fa-bag-shopping', color: 'bg-pink-100 text-pink-600' }, { id: '門票', icon: 'fa-ticket', color: 'bg-green-100 text-green-600' }, { id: '住宿', icon: 'fa-bed', color: 'bg-purple-100 text-purple-600' }, { id: '其他', icon: 'fa-asterisk', color: 'bg-gray-100 text-gray-600' }];
        const RECOVERED_PAYERS = ["我", "旅伴", "公費"];

        let flights=[], itinerary=[], mustEatList=[], expenses=[], guides=[], shoppingList=[], payers=[], payerProfiles={}, manualDebts=[], memoText="", todos=[], shoppingOwners=["我的清單"];
        let vjwData={isOpen:true,items:[]}, publicFundConfig={total:0,currency:'JPY'};
        let currentShopOwnerIdx=0, inlineCategoryChart=null, inlineMemberChart=null, settlementChart=null, gistId="", gistToken="";
        let tempThemes=[], currentPhotoBase64=null, currentGuidePhoto=null, currentShopPhoto=null, currentTransPhoto=null, tempDayPhotos=[], selectedPayers=[], selectedCat='餐飲';

        // --- CORE ---
        function reloadLocalData() {
            flights = JSON.parse(localStorage.getItem('flights')) || [];
            itinerary = JSON.parse(localStorage.getItem('itinerary_v3')) || [];
            mustEatList = JSON.parse(localStorage.getItem('mustEatList')) || [];
            expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            guides = JSON.parse(localStorage.getItem('guides')) || [];
            if (guides.length === 0) guides = [...PRELOADED_GUIDES];
            shoppingList = JSON.parse(localStorage.getItem('shoppingList_v3')) || [];
            shoppingOwners = JSON.parse(localStorage.getItem('shoppingOwners')) || ["我的清單"];
            payers = JSON.parse(localStorage.getItem('payers')) || RECOVERED_PAYERS;
            if(!payers.includes("公費")) payers.push("公費");
            payerProfiles = JSON.parse(localStorage.getItem('payerProfiles')) || {};
            manualDebts = JSON.parse(localStorage.getItem('manualDebts_v1')) || [];
            todos = JSON.parse(localStorage.getItem('todos')) || [];
            memoText = localStorage.getItem('memo') || "";
            publicFundConfig = JSON.parse(localStorage.getItem('publicFundConfig_v2')) || { total: 0, currency: 'JPY' };
            vjwData = JSON.parse(localStorage.getItem('vjwData')) || { isOpen: true, items: [] };
            gistId = localStorage.getItem('gist_id') || ""; gistToken = localStorage.getItem('gist_token') || "";
            mustEatList.forEach(m => { if(!m.themes) m.themes = []; });
            
            // Migration for expenses to support paidBy/splitBy
            expenses.forEach(e => {
                if (!e.splitBy) {
                    e.splitBy = (e.payer || "").split(',').filter(x=>x);
                    e.paidBy = e.splitBy[0] || "我"; // Default to first person or me
                }
            });
        }
        function saveData() {
            localStorage.setItem('flights', JSON.stringify(flights));
            localStorage.setItem('itinerary_v3', JSON.stringify(itinerary));
            localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('guides', JSON.stringify(guides));
            localStorage.setItem('shoppingList_v3', JSON.stringify(shoppingList));
            localStorage.setItem('shoppingOwners', JSON.stringify(shoppingOwners));
            localStorage.setItem('payers', JSON.stringify(payers));
            localStorage.setItem('payerProfiles', JSON.stringify(payerProfiles));
            localStorage.setItem('manualDebts_v1', JSON.stringify(manualDebts));
            localStorage.setItem('todos', JSON.stringify(todos));
            localStorage.setItem('memo', memoText); 
            localStorage.setItem('publicFundConfig_v2', JSON.stringify(publicFundConfig));
            localStorage.setItem('vjwData', JSON.stringify(vjwData));
            if (gistId && gistToken) { clearTimeout(window.autoUploadTimer); window.autoUploadTimer = setTimeout(forceUpload, 2000); }
        }

        // --- GIST SYNC ---
        function forceDownload() {
            if(!gistId) return updateCloudStatus("未連線");
            updateCloudStatus("下載中...");
            fetch(`https://api.github.com/gists/${gistId}?t=${Date.now()}`, {headers: {'Authorization': `token ${gistToken}`}})
            .then(r=>r.json()).then(async d=>{
                let content = d.files["travel_data.json"].content;
                if(d.files["travel_data.json"].truncated) { const r=await fetch(d.files["travel_data.json"].raw_url); content=await r.text(); }
                const c = JSON.parse(content);
                localStorage.setItem('flights',JSON.stringify(c.flights||[]));
                localStorage.setItem('itinerary_v3',JSON.stringify(c.itinerary||[]));
                localStorage.setItem('expenses',JSON.stringify(c.expenses||[]));
                localStorage.setItem('guides',JSON.stringify(c.guides||[]));
                localStorage.setItem('shoppingList_v3',JSON.stringify(c.shoppingList||[]));
                localStorage.setItem('publicFundConfig_v2',JSON.stringify(c.publicFundConfig||{total:0}));
                localStorage.setItem('memo',c.memo||"");
                updateCloudStatus("同步成功"); window.refreshUI(); alert("同步成功");
            }).catch(()=>updateCloudStatus("下載失敗"));
        }
        async function forceUpload() {
            if(!gistId) return;
            updateCloudStatus("上傳中...");
            const payload = { flights, itinerary, mustEatList, expenses, guides, shoppingList, payers, publicFundConfig, memo: memoText, lastUpdate: new Date() };
            try { await fetch(`https://api.github.com/gists/${gistId}`, { method: 'PATCH', headers: { 'Authorization': `token ${gistToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ files: { "travel_data.json": { content: JSON.stringify(payload) } } }) }); updateCloudStatus("已同步"); } catch(e){ updateCloudStatus("上傳失敗"); }
        }
        function updateCloudStatus(msg) { document.getElementById('cloud-status').innerHTML = `<i class="fa-solid fa-code-branch"></i> <span>${msg}</span>`; }
        function saveGistConfig() { gistId=document.getElementById('gist-id-input').value; gistToken=document.getElementById('gist-token-input').value; localStorage.setItem('gist_id',gistId); localStorage.setItem('gist_token',gistToken); alert("已儲存"); forceDownload(); }

        window.refreshUI = function() { reloadLocalData(); renderFlights(); renderItinerary(); renderGuides(); renderExpenses(); renderMustEatList(); renderChecklist(); renderShoppingList(); document.getElementById('memo-pad').value = memoText; renderVJW(); if(gistId){document.getElementById('gist-id-input').value=gistId;document.getElementById('gist-token-input').value=gistToken;} }

        // --- UI UTILS ---
        function openModal(id){document.getElementById(id).classList.remove('hidden');setTimeout(()=>document.getElementById(id).classList.add('visible'),10);}
        function closeModal(id){const el=document.getElementById(id);el.classList.remove('visible');setTimeout(()=>el.classList.add('hidden'),200);}
        function switchTab(t){ document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); document.getElementById('view-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); document.querySelector(`[data-target="${t}"]`).classList.add('active'); window.scrollTo(0,0); }
        function processImage(input, cb) { if(input.files[0]){const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas'),x=c.getContext('2d'),max=800;let w=i.width,h=i.height;if(w>h&&w>max){h*=max/w;w=max}else if(h>max){w*=max/h;h=max}c.width=w;c.height=h;x.drawImage(i,0,0,w,h);cb(c.toDataURL('image/jpeg',0.6))};i.src=e.target.result};r.readAsDataURL(input.files[0])} }
        function viewPhoto(src) { document.getElementById('lightbox-image').src = src; openModal('lightbox-modal'); }
        function toggleZoom(img) { if(img.classList.contains('zoomed')){img.classList.remove('zoomed');}else{img.classList.add('zoomed');} }

        // --- TRANSLATE & VOICE (NEW AI VERSION) ---
        function startDictation() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("您的瀏覽器不支援語音輸入，請使用 Chrome 或 Safari。");
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-TW'; // 設定語音為中文 (也可設為 ja-JP)
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const anim = document.getElementById('ai-voice-anim');
            const input = document.getElementById('ai-trans-input');
            
            recognition.onstart = () => {
                anim.classList.remove('hidden');
                input.placeholder = "正在聆聽...";
            };

            recognition.onend = () => {
                anim.classList.add('hidden');
                input.placeholder = "請輸入或點擊麥克風說話...";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                input.value += (input.value ? ' ' : '') + transcript;
            };

            recognition.start();
        }

        function doTranslate(engine) {
            const text = document.getElementById('ai-trans-input').value.trim();
            if (!text) {
                alert("請先輸入或說出要翻譯的內容");
                return;
            }
            
            const encodedText = encodeURIComponent(text);
            let url = "";

            if (engine === 'deepl') {
                url = `https://www.deepl.com/translator#zh/ja/${encodedText}`;
            } else {
                url = `https://translate.google.com/?sl=auto&tl=ja&text=${encodedText}&op=translate`;
            }
            
            window.open(url, '_blank');
        }

        function openCameraTranslate() {
            const url = "https://translate.google.com/?op=images&sl=auto&tl=ja";
            window.open(url, '_blank');
        }


        // --- ITINERARY ---
        function searchDayWeather() {
            const date = document.getElementById('day-date-edit').value;
            const loc = document.getElementById('day-accommodation-edit').value || "Japan";
            if(!date) return alert("請先輸入日期");
            window.open(`https://www.google.com/search?q=${loc}+weather+${date}`, '_blank');
        }

        function checkUrl(str) {
            if(!str) return null;
            if(str.startsWith('http') || str.startsWith('www')) return str;
            return null;
        }

        function quickExpense(note, cat) {
            document.getElementById('ex-note').value = note;
            selectedCat = cat;
            openExpenseModal();
        }

        function jumpToGuide(title) {
            switchTab('guide');
            const g = guides.find(i => i.title === title);
            if(g) {
                setTimeout(() => {
                    document.getElementById(`guide-${g.id}`).scrollIntoView({behavior: "smooth", block: "center"});
                    document.getElementById(`guide-${g.id}`).classList.add('animate-highlight');
                }, 300);
            }
        }
        
        function linkifyContent(text) {
             let html = text.replace(/\n/g, '<br>');
             guides.forEach(g => {
                 if (g.title.length > 1) { 
                     const regex = new RegExp(`(${g.title})`, 'g');
                     html = html.replace(regex, `<span class="guide-link" onclick="jumpToGuide('$1')">$1</span>`);
                 }
             });
             return html.split('<br>').map(line => `<li class="flex items-start text-base"><span class="mr-2 mt-2 w-2 h-2 bg-sakura rounded-full flex-shrink-0 border border-red-200"></span><span class="flex-1">${line}</span></li>`).join('');
        }

        function renderItinerary() {
            const c = document.getElementById('itinerary-container'); 
            c.innerHTML = '';
            
            itinerary.forEach((day) => {
                let contentHtml = linkifyContent(day.content);
                const wIcon = WEATHER_MAP[day.weather] || '';
                const wHtml = wIcon ? `<a href="https://tenki.jp/" target="_blank" class="weather-badge ml-2" title="查看天氣">${wIcon}</a>` : '';
                const photosHtml = day.photos?.length ? `<div class="mt-3 grid grid-cols-3 gap-1 rounded-lg overflow-hidden">${day.photos.map(p=>`<img src="${p}" class="w-full aspect-square object-cover cursor-pointer hover:opacity-90" onclick="viewPhoto('${p}')">`).join('')}</div>` : '';
                const accLink = day.accommodationUrl || checkUrl(day.accommodation);
                const accHtml = day.accommodation ? `<div class="mt-3 text-sm text-gray-600 flex items-center gap-2 border-t pt-3 border-dashed border-gray-200"><i class="fa-solid fa-bed text-fuji"></i> ${accLink ? `<a href="${accLink}" target="_blank" class="underline decoration-dotted hover:text-fuji font-bold">${day.accommodation}</a>` : `<span class="font-bold">${day.accommodation}</span>`}</div>` : '';
                const transHtml = (day.transportation && (day.transportation.content || day.transportation.photo)) ? 
                    `<div class="mt-2 bg-gray-50 p-3 rounded-lg border border-gray-100 text-sm">
                        <div class="font-bold text-gray-500 flex items-center gap-2 mb-1">
                            <i class="fa-solid fa-train text-blue-400"></i> 交通 
                            ${day.transportation.time ? `<span class="text-xs font-normal bg-white px-2 py-0.5 rounded border border-gray-200 text-gray-400">${day.transportation.time}</span>` : ''}
                        </div>
                        <div class="ml-6 text-gray-700 font-medium">${day.transportation.content || ''}</div>
                        ${day.transportation.note ? `<div class="ml-6 text-xs text-gray-400 mt-1">${day.transportation.note}</div>` : ''}
                        ${day.transportation.photo ? `<div class="mt-2 ml-6"><button onclick="viewPhoto('${day.transportation.photo}')" class="text-xs bg-white border border-blue-200 text-blue-500 px-2 py-1 rounded shadow-sm hover:bg-blue-50 transition flex items-center gap-1"><i class="fa-solid fa-ticket"></i> 查看車票/時刻表</button></div>` : ''}
                    </div>` : '';

                const renderMealItem = (type, icon, color) => {
                    const m = day.meals?.[type];
                    if(!m || !m.name) return '';
                    const linkPart = m.link ? `<a href="${m.link}" target="_blank" class="hover:text-fuji underline decoration-dotted ml-1">${m.name}</a>` : `<span class="ml-1">${m.name}</span>`;
                    return `<div class="flex items-center gap-1 meal-clickable p-1 rounded transition">
                                <i class="fa-solid ${icon} ${color} cursor-pointer hover:scale-125 transition" onclick="quickExpense('${m.name}', '餐飲')" title="點擊記帳"></i> 
                                ${linkPart}
                            </div>`;
                };

                const mealsHtml = (day.meals && (day.meals.b?.name || day.meals.l?.name || day.meals.d?.name)) ? 
                    `<div class="mt-3 flex gap-4 text-xs text-gray-500 border-t border-dashed border-gray-200 pt-2 justify-between px-2">
                        ${renderMealItem('b', 'fa-mug-hot', 'text-orange-300')}
                        ${renderMealItem('l', 'fa-utensils', 'text-green-400')}
                        ${renderMealItem('d', 'fa-wine-glass', 'text-purple-400')}
                    </div>` : '';
                
                const noteHtml = day.dayNote ? `<div class="mt-3 p-2 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-100 handwritten leading-relaxed"><i class="fa-solid fa-pencil mr-1"></i> ${day.dayNote}</div>` : '';

                c.innerHTML += `<div class="relative pl-8 border-l-2 ${day.highlight?'border-sakura':'border-gray-200'} pb-8 group">
                    <div class="absolute -left-2.5 top-0 w-5 h-5 rounded-full ${day.highlight?'bg-sakura':'bg-gray-300'} border-4 border-paper shadow-sm"></div>
                    <div class="flex justify-between mb-2 items-center">
                        <div class="flex items-center">
                            <h3 class="font-black text-2xl handwritten ${day.highlight?'text-red-400':'text-pencil'}">${day.date}</h3>
                            ${wHtml}
                        </div>
                        <button onclick="openDayEditor('${day.id}')" class="text-gray-300 hover:text-fuji transition p-2"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 relative">
                        <ul class="text-sm space-y-3 leading-relaxed text-gray-700 font-maru font-bold text-lg mb-3">${contentHtml}</ul>
                        ${photosHtml}
                        ${accHtml}
                        ${transHtml}
                        ${mealsHtml}
                        ${noteHtml}
                    </div>
                </div>`;
            });
        }
        
        function openDayEditor(id){ const d=itinerary.find(i=>i.id===id); if(!d)return; document.getElementById('day-id-edit').value=d.id; document.getElementById('day-date-edit').value=d.date; document.getElementById('day-weather-edit').value=d.weather||""; document.getElementById('day-highlight-edit').checked=d.highlight; document.getElementById('day-content-edit').value=d.content; document.getElementById('day-accommodation-edit').value=d.accommodation; document.getElementById('day-accommodation-url-edit').value=d.accommodationUrl; document.getElementById('day-trans-content').value=d.transportation?.content||''; document.getElementById('day-trans-note').value=d.transportation?.note||''; document.getElementById('day-trans-time').value=d.transportation?.time||''; currentTransPhoto=d.transportation?.photo; if(currentTransPhoto){ document.getElementById('trans-photo-preview').src = currentTransPhoto; document.getElementById('trans-photo-preview').classList.remove('hidden'); document.getElementById('trans-photo-text').classList.add('hidden'); } else { clearTransPhoto(); } document.getElementById('day-note-edit').value=d.dayNote||''; tempDayPhotos = d.photos ? [...d.photos] : []; renderDayPhotosPreview(); ['b','l','d'].forEach(t=>{document.getElementById('meal-'+t+'-name').value=d.meals?.[t]?.name||''; document.getElementById('meal-'+t+'-link').value=d.meals?.[t]?.link||''}); openModal('day-modal'); }
        function saveDay(){ const idx=itinerary.findIndex(i=>i.id===document.getElementById('day-id-edit').value); if(idx<0)return; const i=itinerary[idx]; i.date=document.getElementById('day-date-edit').value; i.weather=document.getElementById('day-weather-edit').value; i.highlight=document.getElementById('day-highlight-edit').checked; i.content=document.getElementById('day-content-edit').value; i.accommodation=document.getElementById('day-accommodation-edit').value; i.accommodationUrl=document.getElementById('day-accommodation-url-edit').value; i.transportation={content:document.getElementById('day-trans-content').value, note:document.getElementById('day-trans-note').value, time:document.getElementById('day-trans-time').value, photo:currentTransPhoto}; i.dayNote=document.getElementById('day-note-edit').value; i.photos=[...tempDayPhotos]; i.meals={b:{name:document.getElementById('meal-b-name').value, link:document.getElementById('meal-b-link').value},l:{name:document.getElementById('meal-l-name').value, link:document.getElementById('meal-l-link').value},d:{name:document.getElementById('meal-d-name').value, link:document.getElementById('meal-d-link').value}}; saveData(); renderItinerary(); closeModal('day-modal'); }
        function addNewDay(){itinerary.push({id:'day_'+Date.now(),date:"New Day",highlight:false,content:"...",weather:""}); saveData(); renderItinerary();}
        function deleteDay(){if(confirm("Del?")){itinerary=itinerary.filter(d=>d.id!==document.getElementById('day-id-edit').value); saveData(); renderItinerary(); closeModal('day-modal');}}
        function addDayPhoto(input) { processImage(input, (base64) => { tempDayPhotos.push(base64); renderDayPhotosPreview(); }); }
        function renderDayPhotosPreview() { document.getElementById('day-photos-preview').innerHTML = tempDayPhotos.map((p, i) => `<div class="relative"><img src="${p}" class="w-full h-full rounded"><button onclick="tempDayPhotos.splice(${i},1);renderDayPhotosPreview()" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 text-xs">x</button></div>`).join(''); }
        function clearTransPhoto() { currentTransPhoto = null; document.getElementById('trans-photo-preview').src = ''; document.getElementById('trans-photo-preview').classList.add('hidden'); document.getElementById('trans-photo-text').classList.remove('hidden'); }

        // --- GUIDE ---
        function renderGuides(){
            const l=document.getElementById('guide-list'); l.innerHTML='';
            if(window.guideSortable) window.guideSortable.destroy(); 
            
            guides.forEach(g=>{
                l.innerHTML+=`<div id="guide-${g.id}" data-id="${g.id}" class="hand-card p-0 overflow-hidden relative group transition-colors duration-500">
                    <div class="drag-handle absolute top-0 left-0 h-full w-10 bg-black/5 flex items-center justify-center z-20 cursor-grab hover:bg-black/10 transition-colors"><i class="fa-solid fa-grip-vertical text-gray-400"></i></div>
                    <button onclick="event.stopPropagation(); openGuideModal(${g.id})" class="absolute top-2 right-2 z-50 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center shadow hover:bg-white"><i class="fa-solid fa-pen text-gray-500"></i></button>
                    ${g.photo?`<img src="${g.photo}" class="w-full h-40 object-cover ml-10" style="width:calc(100% - 2.5rem)" onclick="viewPhoto('${g.photo}')">`:''} 
                    <div class="p-4 pl-14">
                        <h3 class="font-bold text-lg font-hand text-xl">${g.title}</h3>
                        <div class="flex gap-2 mb-2 mt-1">
                            ${g.price ? `<span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-0.5 rounded"><i class="fa-solid fa-tag"></i> ${g.price}</span>` : ''}
                            ${g.time ? `<span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded"><i class="fa-regular fa-clock"></i> ${g.time}</span>` : ''}
                        </div>
                        <p class="text-sm whitespace-pre-line text-gray-600 leading-relaxed">${g.desc}</p>
                    </div></div>`;
            });
            window.guideSortable = new Sortable(l, { handle: '.drag-handle', animation: 150, onEnd: function (evt) { const item = guides.splice(evt.oldIndex, 1)[0]; guides.splice(evt.newIndex, 0, item); saveData(); } });
        }
        function openGuideModal(id=null) { currentGuidePhoto=null; document.getElementById('guide-photo-preview').classList.add('hidden'); document.getElementById('guide-photo-text').classList.remove('hidden'); if(id){const g=guides.find(i=>i.id==id); document.getElementById('guide-id').value=g.id; document.getElementById('guide-title').value=g.title; document.getElementById('guide-desc').value=g.desc; document.getElementById('guide-price').value=g.price||""; document.getElementById('guide-time').value=g.time||""; if(g.photo){currentGuidePhoto=g.photo; document.getElementById('guide-photo-preview').src=g.photo; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden');}} else { ['guide-id','guide-title','guide-desc','guide-price','guide-time'].forEach(k=>document.getElementById(k).value=''); } openModal('guide-modal'); }
        function saveGuide() { const id=document.getElementById('guide-id').value, t=document.getElementById('guide-title').value; if(!t)return; const newItem = {id:id?parseInt(id):Date.now(), title:t, desc:document.getElementById('guide-desc').value, price:document.getElementById('guide-price').value, time:document.getElementById('guide-time').value, photo:currentGuidePhoto||(id?guides.find(i=>i.id==id).photo:null)}; if(id){const idx=guides.findIndex(i=>i.id==id);if(idx>-1)guides[idx]=newItem;}else{guides.push(newItem);} saveData(); renderGuides(); closeModal('guide-modal'); }

        // --- FLIGHTS ---
        function renderFlights() { document.getElementById('flight-list-container').innerHTML = flights.map(f=>`<div class="bg-white rounded-[24px] p-5 shadow-soft relative hand-card"><button onclick="editFlight(${f.id})" class="absolute top-3 right-3 text-gray-300"><i class="fa-solid fa-pen"></i></button><div class="flex justify-between items-center mb-4"><span class="text-4xl font-black handwritten text-pencil">${f.dep}</span><i class="fa-solid fa-plane text-fuji rotate-[-45deg]"></i><span class="text-4xl font-black handwritten text-pencil">${f.arr}</span></div><div class="bg-fuji-light rounded-2xl py-2 px-4 text-center"><div class="font-bold text-fuji">${f.code}</div><div class="text-xs text-gray-400">${f.date} ${f.time}</div></div></div>`).join(''); }
        function saveFlight(){ const id=document.getElementById('flight-id').value; const f={id:id?parseInt(id):Date.now(), dep:document.getElementById('flight-dep').value, arr:document.getElementById('flight-arr').value, code:document.getElementById('flight-code').value, time:document.getElementById('flight-time').value, date:document.getElementById('flight-date').value, url:document.getElementById('flight-url').value}; if(id){const idx=flights.findIndex(i=>i.id==id);if(idx>-1)flights[idx]=f;}else{flights.push(f);} saveData(); renderFlights(); closeModal('flight-modal'); }
        function editFlight(id){ const f=flights.find(i=>i.id==id); if(f){document.getElementById('flight-id').value=f.id;document.getElementById('flight-dep').value=f.dep;document.getElementById('flight-arr').value=f.arr;document.getElementById('flight-code').value=f.code;document.getElementById('flight-date').value=f.date;document.getElementById('flight-time').value=f.time;document.getElementById('flight-url').value=f.url;openModal('flight-modal');} }
        function openFlightModal(){ ['flight-id','flight-dep','flight-arr','flight-code','flight-date','flight-time','flight-url'].forEach(k=>document.getElementById(k).value=''); openModal('flight-modal'); }

        // --- WALLET & CHARTS & SETTLEMENT ---
        function renderExpenses() {
            const list = document.getElementById('expense-list'); list.innerHTML = '';
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const pfTotal = publicFundConfig.total || 0;
            let pfSpent = 0;

            expenses.sort((a,b) => b.id - a.id).forEach(e => {
                const cat = expenseCategories.find(c => c.id === e.cat) || expenseCategories[5];
                const amt = parseFloat(e.amt);
                const paidBy = e.paidBy || e.payer.split(',')[0]; // fallback
                if (paidBy === '公費') pfSpent += (e.curr === 'JPY' ? amt : amt / rate);

                const splitDisplay = e.splitBy && e.splitBy.length > 0 ? e.splitBy.join(', ') : (e.payer||"");

                list.innerHTML += `<div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-50 flex items-center gap-3 relative overflow-hidden" onclick="openExpenseModal(${e.id})">
                    <div class="w-10 h-10 rounded-full ${cat.color} flex items-center justify-center flex-shrink-0 text-sm"><i class="fa-solid ${cat.icon}"></i></div>
                    <div class="flex-1">
                        <div class="font-bold text-gray-700 text-sm truncate">${e.note || cat.id}</div>
                        <div class="text-[10px] text-gray-400"><span class="font-bold text-fuji">${paidBy}</span> 先付 <i class="fa-solid fa-caret-right text-gray-300"></i> ${splitDisplay}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold font-mono text-gray-800">${e.curr} ${amt.toLocaleString()}</div>
                        ${e.curr === 'JPY' ? `<div class="text-[10px] text-gray-400">≈ NT$ ${Math.round(amt * rate).toLocaleString()}</div>` : ''}
                    </div>
                </div>`;
            });
            
            const pfRemaining = pfTotal - pfSpent;
            document.getElementById('pf-total').innerText = `¥${pfTotal.toLocaleString()}`;
            document.getElementById('pf-remaining').innerText = `¥${Math.round(pfRemaining).toLocaleString()}`;
            document.getElementById('pf-remaining').className = `text-3xl font-mono font-bold tracking-tight ${pfRemaining < 0 ? 'text-red-300' : 'text-white'}`;

            const dash = document.getElementById('wallet-dashboard-container'); dash.innerHTML = '';
            
            // Calc total consumption per person (not who paid)
            payers.forEach(p => {
                if (p === '公費') return;
                let totalConsumed = 0;
                expenses.forEach(e => { 
                    if(e.splitBy && e.splitBy.includes(p)) {
                         const amt = (e.curr==='JPY' ? e.amt*rate : e.amt);
                         totalConsumed += amt / e.splitBy.length;
                    }
                });
                dash.innerHTML += `<div class="min-w-[140px] p-4 bg-white rounded-[24px] shadow-sm border border-gray-100"><div class="font-bold text-gray-700 text-sm mb-1">${p} 消費</div><div class="text-lg font-bold font-mono text-gray-800">NT$ ${Math.round(totalConsumed).toLocaleString()}</div></div>`;
            });
            
            updateInlineCharts(rate);
        }
        
        function updateInlineCharts(rate) {
            // 1. Category Breakdown
            const catData = {};
            expenses.forEach(e => {
                const amt = e.curr === 'JPY' ? e.amt * rate : e.amt;
                catData[e.cat] = (catData[e.cat] || 0) + amt;
            });
            
            const ctxCat = document.getElementById('inlineCategoryChart').getContext('2d');
            if(inlineCategoryChart) inlineCategoryChart.destroy();
            inlineCategoryChart = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catData),
                    datasets: [{ data: Object.values(catData), backgroundColor: ['#f8c3cd', '#bccc9a', '#7b90d2', '#b5651d', '#eff6ff', '#e5e7eb'], borderWidth: 0 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // 2. Member Consumption (Spending share)
            const memberData = {};
            payers.forEach(p => memberData[p] = 0);
            expenses.forEach(e => {
                const amt = (e.curr === 'JPY' ? e.amt * rate : e.amt);
                if(e.splitBy && e.splitBy.length > 0) {
                      const share = amt / e.splitBy.length;
                      e.splitBy.forEach(p => { if(memberData[p] !== undefined) memberData[p] += share; });
                }
            });
            
            const ctxMem = document.getElementById('inlineMemberChart').getContext('2d');
            if(inlineMemberChart) inlineMemberChart.destroy();
            inlineMemberChart = new Chart(ctxMem, {
                type: 'bar',
                data: {
                    labels: Object.keys(memberData),
                    datasets: [{ label: 'NT$ 消費', data: Object.values(memberData), backgroundColor: '#7b90d2', borderRadius: 4 }]
                },
                options: { maintainAspectRatio: false, indexAxis: 'y', scales: { x: { display: false }, y: { grid: { display: false }, ticks: { font: { size: 10 } } } }, plugins: { legend: { display: false } } }
            });
        }
        
        // --- SETTLEMENT LOGIC ---
        function calculateSettlement() {
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const balances = {};
            payers.forEach(p => balances[p] = 0);

            // Calculate Net Balance: (Amount Paid) - (Fair Share Consumed)
            expenses.forEach(e => {
                const amt = (e.curr === 'JPY' ? e.amt * rate : e.amt);
                const payer = e.paidBy || "我";
                const consumers = e.splitBy || [];
                
                if (balances[payer] !== undefined) balances[payer] += amt; // Payer gets credit
                
                if (consumers.length > 0) {
                    const share = amt / consumers.length;
                    consumers.forEach(c => {
                        if (balances[c] !== undefined) balances[c] -= share; // Consumer gets debit
                    });
                }
            });

            // Manual Debts (IOUs)
            manualDebts.forEach(d => {
                if (balances[d.creditor] !== undefined) balances[d.creditor] += parseFloat(d.amount);
                if (balances[d.debtor] !== undefined) balances[d.debtor] -= parseFloat(d.amount);
            });

            // Exclude "Public Fund" from personal settlement suggestions (usually it's a sunk cost or managed separately)
            
            // Generate Transfers
            let debtors = [];
            let creditors = [];
            
            Object.keys(balances).forEach(p => {
                if(p === '公費') return; // Skip public fund in P2P logic
                if (balances[p] < -1) debtors.push({ name: p, amount: balances[p] }); // Tolerance of 1 dollar
                else if (balances[p] > 1) creditors.push({ name: p, amount: balances[p] });
            });

            debtors.sort((a, b) => a.amount - b.amount); // Ascending (most negative first)
            creditors.sort((a, b) => b.amount - a.amount); // Descending (most positive first)

            let planHtml = '';
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                let debt = Math.abs(debtors[i].amount);
                let credit = creditors[j].amount;
                let transfer = Math.min(debt, credit);
                
                planHtml += `<div class="flex justify-between border-b border-blue-200 pb-1 mb-1 last:border-0"><span class="font-bold text-gray-700">${debtors[i].name}</span> <span class="text-gray-400 text-xs mx-1">給</span> <span class="font-bold text-gray-700">${creditors[j].name}</span> <span class="font-mono font-bold text-blue-600">NT$${Math.round(transfer)}</span></div>`;
                
                debtors[i].amount += transfer;
                creditors[j].amount -= transfer;
                
                if (Math.abs(debtors[i].amount) < 1) i++;
                if (creditors[j].amount < 1) j++;
            }
            
            if (!planHtml) planHtml = '<div class="text-center text-gray-400">目前帳目平衡，無需轉帳。</div>';
            
            document.getElementById('settlement-plan').innerHTML = planHtml;
            document.getElementById('settlement-details').innerHTML = Object.entries(balances).map(([k,v]) => `<div>${k}: ${v>=0?'+':''}${Math.round(v)}</div>`).join('');

            // Chart
            const ctxSet = document.getElementById('settlementChart').getContext('2d');
            if(settlementChart) settlementChart.destroy();
            settlementChart = new Chart(ctxSet, {
                type: 'bar',
                data: {
                    labels: Object.keys(balances),
                    datasets: [{ 
                        label: '淨餘額 (NT$)', 
                        data: Object.values(balances), 
                        backgroundColor: Object.values(balances).map(v => v >= 0 ? '#bccc9a' : '#f8c3cd'),
                        borderRadius: 4 
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } } } }
            });

            openModal('settlement-modal');
        }

        function openPublicFundModal() { document.getElementById('pf-total-input').value = publicFundConfig.total || 0; openModal('pf-settings-modal'); }
        function savePublicFundSettings() { publicFundConfig.total = parseFloat(document.getElementById('pf-total-input').value) || 0; saveData(); renderExpenses(); closeModal('pf-settings-modal'); }

        function openExpenseModal(id=null) { 
            // Render Categories
            document.getElementById('expense-categories').innerHTML = expenseCategories.map(c => `<div onclick="selectedCat='${c.id}';openExpenseModal(document.getElementById('ex-id').value||null)" class="w-10 h-10 rounded-full flex items-center justify-center cursor-pointer ${selectedCat===c.id?'ring-2 ring-black '+c.color:'bg-gray-50 text-gray-400'}"><i class="fa-solid ${c.icon}"></i></div>`).join('');
            
            // Render Payers Options for Dropdown (FIXED)
            const payerSelect = document.getElementById('ex-paid-by');
            payerSelect.innerHTML = payers.map(p => `<option value="${p}">${p}</option>`).join('');
            
            document.getElementById('btn-delete-expense').classList.add('hidden');
            
            if(id) { 
                const ex = expenses.find(e => e.id == id); 
                document.getElementById('ex-id').value = ex.id; 
                document.getElementById('ex-amount').value = ex.amt; 
                document.getElementById('ex-currency').value = ex.curr; 
                document.getElementById('ex-note').value = ex.note; 
                
                // Select value for dropdown
                payerSelect.value = ex.paidBy || "我";

                selectedCat = ex.cat; 
                selectedPayers = ex.splitBy || []; 
                document.getElementById('btn-delete-expense').classList.remove('hidden'); 
                if(ex.photo){document.getElementById('ex-photo-preview-mini').src=ex.photo;document.getElementById('ex-photo-preview-mini').classList.remove('hidden')} 
            }
            else { 
                // FORCE RESET for new entry (FIXED)
                document.getElementById('ex-id').value = ''; 
                document.getElementById('ex-amount').value = ''; 
                document.getElementById('ex-note').value = ''; 
                document.getElementById('ex-currency').value = 'JPY';
                
                payerSelect.value = "我";
                if (!payers.includes("我") && payers.length > 0) payerSelect.value = payers[0];

                selectedPayers = payers.filter(p => p !== '公費'); 
                selectedCat = '餐飲'; // Reset category default
                currentPhotoBase64 = null;
                document.getElementById('ex-photo-preview-mini').src = "";
                document.getElementById('ex-photo-preview-mini').classList.add('hidden');
                
                // Re-render categories to show correct selection
                document.getElementById('expense-categories').innerHTML = expenseCategories.map(c => `<div onclick="selectedCat='${c.id}';openExpenseModal(document.getElementById('ex-id').value||null)" class="w-10 h-10 rounded-full flex items-center justify-center cursor-pointer ${selectedCat===c.id?'ring-2 ring-black '+c.color:'bg-gray-50 text-gray-400'}"><i class="fa-solid ${c.icon}"></i></div>`).join('');
            }
            
            renderSplitButtons(); 
            openModal('expense-modal'); 
        }

        function renderSplitButtons() {
            document.getElementById('ex-split-container').innerHTML = payers.map(p => `<button onclick="togglePayer('${p}')" class="px-3 py-1.5 rounded-full text-xs border font-bold transition-all ${selectedPayers.includes(p) ? 'bg-ink text-white border-ink' : 'bg-white text-gray-500'}">${p}</button>`).join('');
        }
        
        function togglePayer(p) { if(selectedPayers.includes(p)) selectedPayers=selectedPayers.filter(x=>x!==p); else selectedPayers.push(p); renderSplitButtons(); }
        function toggleAllPayers() {
            const allHumanPayers = payers.filter(p => p !== '公費');
            if (selectedPayers.length === allHumanPayers.length) selectedPayers = [];
            else selectedPayers = [...allHumanPayers];
            renderSplitButtons();
        }

        function saveExpense() { 
            const id=document.getElementById('ex-id').value, amt=parseFloat(document.getElementById('ex-amount').value); 
            if(!amt) return; 
            
            // Handle Payer Input from Dropdown
            let paidBy = document.getElementById('ex-paid-by').value;

            const ex = {
                id:id?parseInt(id):Date.now(), 
                cat:selectedCat, 
                note:document.getElementById('ex-note').value, 
                curr:document.getElementById('ex-currency').value, 
                amt, 
                paidBy: paidBy,
                splitBy: selectedPayers.length > 0 ? selectedPayers : [paidBy], // If no splitters, assume personal expense
                payer: selectedPayers.join(','), // Legacy support
                photo: currentPhotoBase64
            }; 
            
            if(id){const idx=expenses.findIndex(e=>e.id==id);expenses[idx]=ex;}else{expenses.push(ex);} 
            saveData(); renderExpenses(); closeModal('expense-modal'); 
        }
        function deleteExpense(){ if(confirm("Del?")){ expenses=expenses.filter(e=>e.id!=document.getElementById('ex-id').value); saveData(); renderExpenses(); closeModal('expense-modal'); } }

        // --- SHOPPING (V18 ENHANCED) ---
        function renderShoppingList() {
            const owner = shoppingOwners[currentShopOwnerIdx] || "我的清單"; 
            const items = shoppingList.filter(s => (s.owner || shoppingOwners[0]) === owner);
            const container = document.getElementById('shopping-list-container');
            container.innerHTML = '';

            const grouped = {};
            items.forEach(item => {
                const cat = item.category || '未分類';
                if(!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(item);
            });

            Object.keys(grouped).sort().forEach(cat => {
                const catItems = grouped[cat];
                const doneItems = catItems.filter(i => i.done);
                const pendingItems = catItems.filter(i => !i.done);
                
                let html = `<div class="bg-gray-50/50 rounded-xl p-3 border border-gray-100">
                    <h5 class="font-bold text-gray-400 text-xs mb-2 flex items-center gap-1"><i class="fa-solid fa-tag"></i> ${cat}</h5>
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        ${pendingItems.map(s => renderShopItem(s, false)).join('')}
                    </div>`;
                
                if (doneItems.length > 0) {
                     html += `<div class="border-t border-gray-200/50 pt-2 opacity-60 grayscale filter">
                        ${doneItems.map(s => renderShopItem(s, true)).join('')}
                     </div>`;
                }
                html += `</div>`;
                container.innerHTML += html;
            });
            document.getElementById('shop-owner-name').innerText = owner;
        }

        function renderShopItem(s, isDone) {
            return `<div class="relative p-2 border shadow-sm rounded bg-white flex items-start gap-2" onclick="openShoppingModal(${s.id})">
                <div class="mt-1 w-5 h-5 border-2 rounded flex-shrink-0 cursor-pointer ${isDone?'bg-red-400 border-red-400':''}" onclick="event.stopPropagation();triggerShopAction(${s.id}, ${isDone})"></div>
                <div class="min-w-0">
                    <div class="font-bold truncate text-sm">${s.name}</div>
                    <div class="text-[10px] text-gray-400">¥${s.price} x ${s.qty}</div>
                </div>
            </div>`;
        }

        function triggerShopAction(id, isDone) {
            if(isDone) {
                const s = shoppingList.find(i=>i.id===id);
                s.done = false;
                saveData(); renderShoppingList();
            } else {
                document.getElementById('confirm-shop-id').value = id;
                openModal('shop-confirm-modal');
            }
        }

        function confirmShopAction(action) {
            const id = parseInt(document.getElementById('confirm-shop-id').value);
            const s = shoppingList.find(i=>i.id===id);
            if(!s) return;

            if (action === 'expense') {
                closeModal('shop-confirm-modal');
                const categoryNote = s.category ? ` (${s.category})` : '';
                document.getElementById('ex-note').value = s.name + categoryNote;
                document.getElementById('ex-amount').value = s.price * s.qty;
                selectedCat = '購物';
                selectedPayers = ['我']; // Default split for shopping usually self, or change in modal
                openExpenseModal(); // Let user confirm payer/split
                s.done = true;
                saveData(); renderShoppingList();
            } else if (action === 'done_only') {
                s.done = true;
                saveData(); renderShoppingList();
                closeModal('shop-confirm-modal');
            } else if (action === 'cancel') {
                closeModal('shop-confirm-modal');
            }
        }

        function openShoppingModal(id=null){ 
            ['shop-id','shop-name','shop-qty','shop-price','shop-category'].forEach(k=>document.getElementById(k).value=''); 
            document.getElementById('shop-qty').value=1;
            currentShopPhoto=null; document.getElementById('shop-photo-preview').classList.add('hidden'); 
            if(id){
                const s=shoppingList.find(i=>i.id===id);
                document.getElementById('shop-id').value=s.id;document.getElementById('shop-name').value=s.name;document.getElementById('shop-qty').value=s.qty;document.getElementById('shop-price').value=s.price;document.getElementById('shop-category').value=s.category||'';
                if(s.photo){currentShopPhoto=s.photo;document.getElementById('shop-photo-preview').src=s.photo;document.getElementById('shop-photo-preview').classList.remove('hidden')}
            } 
            openModal('shopping-modal'); 
        }
        function saveShoppingItem(){ const id=document.getElementById('shop-id').value, name=document.getElementById('shop-name').value; if(!name)return; const item={ id:id?parseInt(id):Date.now(), name, qty:document.getElementById('shop-qty').value, price:document.getElementById('shop-price').value, category:document.getElementById('shop-category').value, photo:currentShopPhoto, done:false, owner: shoppingOwners[currentShopOwnerIdx] }; if(id){const idx=shoppingList.findIndex(i=>i.id==id);item.done=shoppingList[idx].done;shoppingList[idx]=item;}else{shoppingList.push(item);} saveData(); renderShoppingList(); closeModal('shopping-modal'); }
        function deleteShoppingItem(){ if(confirm("Del?")){shoppingList=shoppingList.filter(s=>s.id!=document.getElementById('shop-id').value);saveData();renderShoppingList();closeModal('shopping-modal');} }
        function nextShopList(){ currentShopOwnerIdx=(currentShopOwnerIdx+1)%shoppingOwners.length; renderShoppingList(); }
        function prevShopList(){ currentShopOwnerIdx=(currentShopOwnerIdx-1+shoppingOwners.length)%shoppingOwners.length; renderShoppingList(); }
        function setShopCat(val) { document.getElementById('shop-category').value = val; }
        
        function openShopOwnerModal(){ document.getElementById('shop-lists-container').innerHTML = shoppingOwners.map(n=>`<div class="bg-gray-50 p-2 border rounded text-sm">${n}</div>`).join(''); openModal('manage-shop-lists-modal'); }
        function addShopList(){ const n=document.getElementById('new-shop-list-name').value; if(n){shoppingOwners.push(n);saveData();openShopOwnerModal();renderShoppingList();} }

        // --- OTHER LISTS ---
        function renderMustEatList() {
            const c = document.getElementById('must-eat-list'); c.innerHTML = '';
            mustEatList.forEach(locItem => {
                const themesHtml = locItem.themes.map(t => `<div class="bg-white p-3 rounded shadow-sm border border-gray-100 mb-2 flex justify-between"><span class="${t.isVeg?'text-green-600 font-bold':''}">${t.isVeg?'🥗 ':''}${t.name}</span>${t.url?`<a href="${t.url}" target="_blank" class="text-fuji"><i class="fa-solid fa-link"></i></a>`:''}</div>`).join('');
                c.innerHTML += `<div class="mb-6 group relative"><button onclick="openMustEatModal('${locItem.id}')" class="absolute top-0 right-0 text-gray-300 hover:text-fuji px-2"><i class="fa-solid fa-pen"></i></button><h4 class="text-lg font-black handwritten text-matcha border-b-2 border-matcha/30 inline-block px-2 mb-3">${locItem.location}</h4><div class="pl-2 border-l-2 border-matcha/10">${themesHtml}</div></div>`;
            });
        }
        function openMustEatModal(id=null) {
            document.getElementById('eat-location').value = ''; tempThemes = []; document.getElementById('eat-loc-id').value = '';
            if(id) {
                const item = mustEatList.find(i => i.id === id);
                if(item) { document.getElementById('eat-loc-id').value = item.id; document.getElementById('eat-location').value = item.location; tempThemes = JSON.parse(JSON.stringify(item.themes)); }
            } else { tempThemes = [{id: Date.now(), name: '', url: '', isVeg: false}]; }
            renderThemeRows(); openModal('must-eat-modal');
        }
        function renderThemeRows() {
            document.getElementById('eat-themes-container').innerHTML = tempThemes.map((t, idx) => `
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 relative group mb-2">
                    <button onclick="tempThemes.splice(${idx},1);renderThemeRows()" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                    <div class="flex items-center gap-2 mb-2"><input type="text" placeholder="餐廳名稱" class="flex-1 bg-transparent border-b border-gray-300 text-sm font-bold" value="${t.name}" oninput="tempThemes[${idx}].name=this.value"><label class="text-xs text-green-600"><input type="checkbox" ${t.isVeg ? 'checked' : ''} onchange="tempThemes[${idx}].isVeg=this.checked"> 素食</label></div>
                    <input type="url" placeholder="網址" class="w-full bg-white border rounded text-xs p-1" value="${t.url||''}" oninput="tempThemes[${idx}].url=this.value">
                </div>
            `).join('');
        }
        function addThemeRow() { tempThemes.push({id: Date.now(), name: '', url: '', isVeg: false}); renderThemeRows(); }
        function saveMustEatLocation() {
            const id = document.getElementById('eat-loc-id').value, location = document.getElementById('eat-location').value;
            if(!location) return alert("請輸入地點名稱");
            const data = { id: id || 'loc_'+Date.now(), location, themes: tempThemes.filter(t => t.name) };
            if(id) { const idx = mustEatList.findIndex(i => i.id === id); if(idx > -1) mustEatList[idx] = data; } else { mustEatList.push(data); }
            saveData(); renderMustEatList(); closeModal('must-eat-modal');
        }
        function deleteMustEatLocation() { const id = document.getElementById('eat-loc-id').value; if(id && confirm("Del?")) { mustEatList = mustEatList.filter(i => i.id !== id); saveData(); renderMustEatList(); closeModal('must-eat-modal'); } }

        function renderChecklist(){document.getElementById('checklist-container').innerHTML=todos.map((t,i)=>`<li class="flex items-center gap-2 p-2 border-b border-gray-100"><input type="checkbox" onchange="toggleTodo(${i})" ${t.done?'checked':''} class="accent-fuji"><input class="flex-1 bg-transparent font-hand text-lg ${t.done?'line-through text-gray-300':''}" value="${t.text}" onchange="updateTodo(${i},this.value)"><button onclick="deleteTodo(${i})" class="text-gray-300">x</button></li>`).join('');}
        function addTodo(){const v=document.getElementById('new-todo').value;if(v){todos.push({text:v,done:false}); saveData(); renderChecklist();document.getElementById('new-todo').value='';}}
        function toggleTodo(i){todos[i].done=!todos[i].done; saveData(); renderChecklist();}
        function updateTodo(i,v){todos[i].text=v; saveData();}
        function deleteTodo(i){todos.splice(i,1); saveData(); renderChecklist();}
        function openMemberModal(){ document.getElementById('member-list').innerHTML=payers.map((p,i)=>`<div class="flex justify-between p-2 bg-gray-50 rounded items-center"><span class="font-bold text-sm">${p}</span>${p!=='公費'&&payers.length>2?`<button onclick="removePayer(${i})" class="text-red-400 text-xs px-2">刪除</button>`:''}</div>`).join(''); openModal('member-modal'); }
        function addPayer(){const n=document.getElementById('new-payer-name').value;if(n&&!payers.includes(n)){payers.push(n); saveData(); openMemberModal(); renderExpenses();}}
        function removePayer(i){if(confirm("Del?")){payers.splice(i,1); saveData(); openMemberModal(); renderExpenses();}}
        function openIOUModal(){ const h=payers.filter(p=>p!=='公費').map(p=>`<option value="${p}">${p}</option>`).join('');
            document.getElementById('iou-creditor').innerHTML = h;
            document.getElementById('iou-debtor').innerHTML = h;
            document.getElementById('iou-amount').value = '';
            document.getElementById('iou-note').value = '';
            document.getElementById('iou-id').value = '';
            document.getElementById('btn-delete-iou').classList.add('hidden');
            
            // 如果是編輯模式
            const editId = document.getElementById('iou-id').getAttribute('data-edit-id'); 
            if(editId) {
                const item = manualDebts.find(d => d.id == editId);
                if(item){
                    document.getElementById('iou-creditor').value = item.creditor;
                    document.getElementById('iou-debtor').value = item.debtor;
                    document.getElementById('iou-amount').value = item.amount;
                    document.getElementById('iou-note').value = item.note;
                    document.getElementById('iou-id').value = item.id;
                    document.getElementById('btn-delete-iou').classList.remove('hidden');
                }
                document.getElementById('iou-id').removeAttribute('data-edit-id');
            }

            renderIOUList();
            openModal('iou-modal');
        }

        function saveIOU() {
            const id = document.getElementById('iou-id').value;
            const creditor = document.getElementById('iou-creditor').value;
            const debtor = document.getElementById('iou-debtor').value;
            const amount = parseFloat(document.getElementById('iou-amount').value);
            const note = document.getElementById('iou-note').value;

            if (creditor === debtor) return alert("債權人與債務人不能相同");
            if (!amount) return alert("請輸入金額");

            const item = { id: id ? parseInt(id) : Date.now(), creditor, debtor, amount, note };
            
            if (id) {
                const idx = manualDebts.findIndex(d => d.id == id);
                if (idx > -1) manualDebts[idx] = item;
            } else {
                manualDebts.push(item);
            }
            saveData();
            renderIOUList();
            
            // 清空輸入
            document.getElementById('iou-amount').value = '';
            document.getElementById('iou-note').value = '';
            document.getElementById('iou-id').value = '';
            document.getElementById('btn-delete-iou').classList.add('hidden');
        }

        function deleteIOU() {
            const id = document.getElementById('iou-id').value;
            if(confirm("確定刪除這筆借款紀錄？")) {
                manualDebts = manualDebts.filter(d => d.id != id);
                saveData();
                renderIOUList();
                // 清空並重置
                document.getElementById('iou-amount').value = '';
                document.getElementById('iou-note').value = '';
                document.getElementById('iou-id').value = '';
                document.getElementById('btn-delete-iou').classList.add('hidden');
            }
        }

        function renderIOUList() {
            const container = document.getElementById('iou-list-container');
            container.innerHTML = manualDebts.map(d => `
                <div class="flex justify-between items-center p-2 border-b last:border-0 bg-gray-50 rounded mb-1" onclick="editIOU(${d.id})">
                    <div class="text-xs">
                        <span class="font-bold text-gray-700">${d.creditor}</span> 
                        <i class="fa-solid fa-arrow-right text-gray-300 mx-1"></i> 
                        <span class="font-bold text-gray-700">${d.debtor}</span>
                        <div class="text-gray-400 scale-90 origin-left">${d.note || ''}</div>
                    </div>
                    <div class="font-bold text-fuji">NT$${d.amount}</div>
                </div>
            `).join('');
        }

        function editIOU(id) {
            const item = manualDebts.find(d => d.id == id);
            if(item) {
                document.getElementById('iou-creditor').value = item.creditor;
                document.getElementById('iou-debtor').value = item.debtor;
                document.getElementById('iou-amount').value = item.amount;
                document.getElementById('iou-note').value = item.note;
                document.getElementById('iou-id').value = item.id;
                document.getElementById('btn-delete-iou').classList.remove('hidden');
            }
        }

        // --- VISIT JAPAN WEB ---
        function renderVJW() {
            const c = document.getElementById('vjw-container');
            const arrow = document.getElementById('vjw-arrow');
            const content = document.getElementById('vjw-content');
            
            if(vjwData.isOpen) {
                content.style.maxHeight = "500px";
                arrow.style.transform = "rotate(180deg)";
            } else {
                content.style.maxHeight = "0px";
                arrow.style.transform = "rotate(0deg)";
            }

            c.innerHTML = `
                <div class="flex flex-col items-center gap-2 cursor-pointer group min-w-[80px]" onclick="document.getElementById('vjw-upload').click()">
                    <div class="w-16 h-16 rounded-2xl bg-white border-2 border-dashed border-blue-200 flex items-center justify-center text-blue-300 group-hover:bg-blue-50 group-hover:border-blue-400 transition">
                        <i class="fa-solid fa-plus text-xl"></i>
                    </div>
                    <span class="text-xs text-blue-400 font-bold">新增截圖</span>
                    <input type="file" id="vjw-upload" accept="image/*" class="hidden" onchange="addVJWItem(this)">
                </div>
            `;

            vjwData.items.forEach((item, idx) => {
                c.innerHTML += `
                    <div class="relative group min-w-[120px]">
                        <button onclick="deleteVJWItem(${idx})" class="absolute -top-2 -right-2 bg-red-400 text-white w-5 h-5 rounded-full text-xs shadow-md z-10 opacity-0 group-hover:opacity-100 transition">x</button>
                        <img src="${item.img}" class="h-32 rounded-xl shadow-sm border border-gray-100 object-cover cursor-zoom-in hover:scale-105 transition" onclick="viewPhoto('${item.img}')">
                        <div class="text-center mt-1">
                            <input type="text" value="${item.note}" onchange="updateVJWNote(${idx}, this.value)" class="text-xs text-center bg-transparent border-b border-transparent focus:border-blue-300 outline-none w-24 text-gray-500" placeholder="備註...">
                        </div>
                    </div>
                `;
            });
        }

        function toggleVJW() {
            vjwData.isOpen = !vjwData.isOpen;
            saveData();
            renderVJW();
        }

        function addVJWItem(input) {
            processImage(input, (base64) => {
                vjwData.items.push({ img: base64, note: "QR Code" });
                saveData();
                renderVJW();
            });
        }

        function deleteVJWItem(idx) {
            if(confirm("刪除此截圖？")) {
                vjwData.items.splice(idx, 1);
                saveData();
                renderVJW();
            }
        }

        function updateVJWNote(idx, val) {
            vjwData.items[idx].note = val;
            saveData();
        }
        
        function updateExchangeRate() {
            const r = parseFloat(document.getElementById('exchange-rate').value);
            if(r) { state.exchangeRate = r; saveData(); renderExpenses(); alert('匯率已更新'); }
        }

        // --- INIT ---
        window.onload = function() {
            reloadLocalData();
            
            // Check current time to highlight itinerary
            const today = new Date();
            const dateStr = (today.getMonth()+1) + "/" + today.getDate();
            // Simple check logic could be added here
            
            // Initial Render
            renderFlights();
            renderItinerary();
            renderExpenses();
            renderMustEatList();
            renderChecklist();
            renderShoppingList();
            renderGuides();
            renderVJW();
            document.getElementById('memo-pad').value = memoText;
            
            // Set Gist inputs if exists
            if(gistId) {
                document.getElementById('gist-id-input').value = gistId;
                document.getElementById('gist-token-input').value = gistToken;
                updateCloudStatus("已連結");
                // Auto sync check
                if(localStorage.getItem('gist_id')) setTimeout(forceDownload, 500);
            }

            // Default Tab
            switchTab('plan');
        };
    </script>
</body>
</html>
