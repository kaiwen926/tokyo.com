<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—…ã®è¨˜">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f9f7f2">

    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">

    <title>ä¸€èµ·æ—…è¡Œå§</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@400;500;700;900&family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&family=Yomogi&family=Zen+Maru+Gothic:wght@400;500;700;900&family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet"> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'paper': '#f9f7f2', 'sakura': '#f8c3cd', 'matcha': '#bccc9a', 
                        'fuji': '#7b90d2', 'fuji-light': '#eff6ff', 'pencil': '#595857', 
                        'ink': '#2c2c2c', 'clay': '#b5651d', 'cream': '#fffdf5', 'veggie': '#4ade80'
                    },
                    fontFamily: { 
                        'maru': ['"Zen Maru Gothic"', 'sans-serif'], 
                        'hand': ['"Yomogi"', '"Zen Maru Gothic"', 'cursive'],
                        'serif': ['"Noto Serif TC"', 'serif']
                    },
                    boxShadow: { 'soft': '0 4px 20px rgba(0,0,0,0.03)', 'float': '0 8px 30px rgba(0,0,0,0.08)' },
                    animation: { 'highlight': 'highlight 2s ease-out forwards', 'slide-in': 'slideIn 0.3s ease-out' },
                    keyframes: { 
                        highlight: { '0%': { backgroundColor: 'rgba(252, 211, 77, 0.5)' }, '100%': { backgroundColor: 'transparent' } },
                        slideIn: { '0%': { opacity: 0, transform: 'translateX(10px)' }, '100%': { opacity: 1, transform: 'translateX(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body {
            font-family: 'Zen Maru Gothic', 'Noto Serif TC', sans-serif; 
            background-color: #f9f7f2; 
            color: #595857;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 24px 24px; background-position: center top;
            -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none;
            min-height: 100vh; padding-bottom: calc(80px + var(--sab));
            overflow-x: hidden;width: 100%;
         }
        .handwritten { font-family: 'Yomogi', cursive; }
        .modal { transition: opacity 0.2s ease-in-out; } .modal.hidden { opacity: 0; pointer-events: none; } .modal.visible { opacity: 1; pointer-events: auto; }
        .hand-card { background: #fff; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); position: relative; transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.02); }
        .nav-item.active i, .nav-item.active span { color: #7b90d2; font-weight: 900; } 
        .zoom-container { overflow: auto; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .zoom-container img { transition: transform 0.2s; cursor: zoom-in; }
        .zoom-container img.zoomed { max-width: none !important; max-height: none !important; cursor: zoom-out; cursor: grab; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .deco-icon { position: absolute; pointer-events: none; opacity: 0.15; z-index: 0; font-size: 2rem; transform: rotate(10deg); }
        .weather-badge { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 1.2rem; transition: transform 0.2s; text-decoration: none; margin-left: 8px; border: 1px solid #f0f0f0; }
        .weather-badge:hover { transform: scale(1.1); }
        .drag-handle { cursor: grab; touch-action: none; display: flex; align-items: center; justify-content: center; width: 40px; height: 100%; background-color: rgba(0,0,0,0.02); position: absolute; left: 0; top: 0; z-index: 10; border-right: 1px solid rgba(0,0,0,0.03); }
        .drag-handle:active { cursor: grabbing; background-color: rgba(0,0,0,0.05); }
        .guide-link { color: #000103; font-weight: 900; border-bottom: 2px dotted #000103; cursor: pointer;}
        .weather-group {display: flex;flex-direction: column;align-items: center;justify-content: center;margin-left: 12px;position: relative;top: -4px;}
        .temp-badge {font-family: 'Zen Maru Gothic', sans-serif; font-weight: 900;font-size: 0.75rem; line-height: 1;margin-bottom: 2px;padding: 2px 6px;border-radius: 10px;color: white;box-shadow: 1px 1px 0px rgba(0,0,0,0.1);transform: rotate(-5deg); text-shadow: 0 1px 0 rgba(0,0,0,0.1);white-space: nowrap;}
        .temp-hot { background-color: #ff8e8e; border: 2px solid #fff; color: #fff; } 
        .temp-warm { background-color: #ffcc66; border: 2px solid #fff; color: #fff; } 
        .temp-cool { background-color: #88ddcc; border: 2px solid #fff; color: #fff; } 
        .temp-cold { background-color: #88ccff; border: 2px solid #fff; color: #fff; } 
        .weather-group .weather-badge {margin-left: 0 !important;width: 28px; height: 28px;font-size: 1rem;box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .phrase-btn.active { background-color: #7b90d2; color: white; border-color: #7b90d2; }
       #view-plan h3, 
        #view-guide h2, 
        #view-wallet h2, 
        #view-lists h3, 
        .hand-card h3,
        #view-info h3 {
            font-family: 'Zen Kurenaido', sans-serif !important;
            font-weight: 600;
            letter-spacing: 0.1em;
            transform: rotate(-1deg);
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1);}
        #view-plan h3 i, #view-guide h2 i, #view-wallet h2 i, #view-lists h3 i, .hand-card h3 i {transform: rotate(1deg);display: inline-block;margin-right: 4px;}
        #view-lists .hand-card:nth-of-type(1) h3 { color: #8a9a6a !important; }
        #shopping-card h3 { color: #e08585 !important; }
        #view-lists .hand-card:nth-of-type(3) h3 { color: #7b90d2 !important; }
        #view-lists .hand-card:nth-of-type(4) h3 { color: #b5651d !important; }
        #view-info div.hand-card h3 { color: #7b90d2 !important;}
        #view-info details.hand-card summary h3,
        #view-info details.hand-card h3 { color: #e68a9f !important;}
        #view-info .mt-6 .hand-card h3 { color: #60a5fa !important; }
        #view-info .space-y-6 .hand-card h3 { color: #1e40af !important; }
        #view-info details:last-child summary span { color: #6b7280 !important; font-size: 1rem; }
        #view-plan h3, #view-wallet h2 { color: #595857 !important; }
 </style>
</head>
<body>

    <header class="pb-2 px-4 text-center sticky top-0 bg-[#f9f7f2]/95 z-40 backdrop-blur-sm transition-all duration-300 relative border-b border-gray-100/50" style="padding-top: max(1.5rem, var(--sat));">
        <h1 class="text-4xl font-black tracking-widest text-ink handwritten relative inline-block mt-2" style="font-weight: 900;">
            <span class="absolute -top-5 -left-8 text-3xl rotate-[-15deg] opacity-80">âœˆï¸</span>
            æ—…ã®è¨˜
            <div class="absolute bottom-1 left-0 w-full h-3 bg-sakura/40 -z-10 rounded-full transform -rotate-1"></div>
        </h1>
        <div class="flex justify-center items-center gap-3 mt-2">
            <p class="text-[10px] text-fuji font-bold tracking-[0.2em] font-serif uppercase handwritten">My Travel Logbook</p>
            <div id="cloud-status" class="text-[10px] bg-gray-200/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 cursor-default"><i class="fa-solid fa-code-branch"></i> <span>æœªé€£ç·š</span></div>
            <button onclick="forceDownload()" class="text-[10px] bg-white text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 hover:bg-fuji-light hover:text-fuji hover:border-fuji-light shadow-sm"><i class="fa-solid fa-rotate-right"></i> <span>åŒæ­¥</span></button>
        </div>
    </header>
    <main id="app" class="px-4 w-full mx-auto min-h-screen max-w-5xl relative pb-24 overflow-hidden">        
        <div class="deco-icon top-4 left-4 text-4xl">ğŸŒ¸</div>
        <div class="deco-icon top-20 right-10 text-3xl text-blue-200 rotate-[-20deg]">ğŸ™</div>
        <div class="deco-icon bottom-32 left-8 text-3xl text-green-200">ğŸ¡</div>
        <div class="deco-icon top-1/3 right-4 text-5xl text-red-100 rotate-[15deg]">â›©ï¸</div>
        <div class="deco-icon top-60 -left-4 text-6xl opacity-20 animate-pulse" style="position: absolute; z-index: 0; animation-duration: 10s;">â˜ï¸</div>
        <div class="deco-icon top-28 right-6 text-3xl opacity-10 rotate-12" style="position: absolute; z-index: 0;">âœˆï¸</div>
        <div class="deco-icon top-[600px] left-2 text-4xl opacity-10 rotate-45 text-pink-300" style="position: absolute; z-index: 0;">ğŸˆ</div>
        <div class="deco-icon top-[850px] right-10 text-3xl opacity-20 rotate-12 text-yellow-400" style="position: absolute; z-index: 0;">âœ¨</div>
        <div class="deco-icon bottom-24 right-0 text-[8rem] opacity-10" style="position: absolute; z-index: 0; transform: rotate(-5deg); filter: sepia(0.3);">ğŸ—»</div>
        <!-- PLAN SECTION -->
        <section id="view-plan" class="view-section animate-fade relative z-10">
            <div class="flex justify-between items-center mb-6 mt-6">
                <h3 class="text-pencil font-bold handwritten text-xl flex items-center"><i class="fa-solid fa-plane-departure mr-2 text-xl text-fuji"></i>èˆªç­è³‡è¨Š</h3>
                <button onclick="openFlightModal()" class="text-xs bg-white border border-fuji/30 text-fuji px-4 py-2 rounded-xl shadow-sm active:scale-95 font-bold hover:bg-fuji hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
            </div>
            
            <div id="flight-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10"></div>
            
            <div class="flex justify-between items-center mb-4 border-t-2 border-dashed border-gray-200 pt-8 mt-6">
                 <h3 class="text-pencil font-bold handwritten text-xl flex items-center"><i class="fa-solid fa-map-location-dot mr-2 text-xl text-matcha"></i>æ¯æ—¥è¡Œç¨‹</h3>
            </div>
          
          <div id="quick-nav-container" class="mb-8 px-2"></div>  
          <div id="itinerary-container" class="space-y-6 md:grid md:grid-cols-2 md:space-y-0 md:gap-6 items-start"></div>
            
            <button onclick="addNewDay()" class="w-full mt-8 mb-8 border-2 border-dashed border-gray-300 text-gray-400 rounded-2xl py-4 hover:bg-white hover:border-matcha hover:text-matcha transition font-bold text-sm bg-white/50 handwritten flex items-center justify-center gap-2 group">
                <i class="fa-solid fa-plus-circle group-hover:scale-110 transition"></i> å¯«ä¸‹ä¸€é å›æ†¶
            </button>
        </section>

        <!-- GUIDE SECTION -->
        <section id="view-guide" class="view-section hidden relative z-10">
            <div class="flex justify-between items-end mb-6 mt-6">
                <h2 class="text-2xl font-bold text-pencil handwritten flex items-center gap-2"><span class="text-3xl">ğŸ</span> æ·±åº¦å°è¦½</h2>
                <button onclick="openGuideModal()" class="text-sm bg-matcha/20 text-green-800 px-4 py-1.5 rounded-full border border-matcha/50 hover:bg-matcha hover:text-white transition font-bold shadow-sm"><i class="fa-solid fa-plus mr-1"></i>æ–°å¢æ™¯é»</button>
            </div>
            <div id="guide-list" class="space-y-6 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-6"></div>
            <p class="text-center text-xs text-gray-300 mt-6 handwritten"><i class="fa-solid fa-grip-vertical mr-1"></i> æŒ‰ä½å·¦å´æ‹–æ›³æ’åº</p>
        </section>

        <!-- WALLET SECTION -->
        <section id="view-wallet" class="view-section hidden relative z-10">
            <div class="flex justify-between items-center mt-6 mb-6">
                <h2 class="text-2xl font-bold text-pencil handwritten flex items-center gap-2"><span class="text-3xl">ğŸ‘›</span> æ—…è²»</h2>
                <div class="flex items-center gap-1 bg-white px-2 py-1.5 rounded-xl shadow-sm border border-gray-100">
                    <span class="text-[10px] text-gray-400 font-mono font-bold mr-1">åŒ¯ç‡</span>
                    <input type="number" id="exchange-rate" value="0.215" step="0.001" onchange="renderExpenses()" class="w-14 text-center rounded text-sm outline-none border-b border-gray-200 py-1 text-fuji font-bold bg-transparent">
                    <button onclick="updateExchangeRate()" id="btn-rate-update" class="w-6 h-6 rounded-full bg-gray-50 text-gray-400 hover:text-fuji hover:bg-fuji-light transition flex items-center justify-center ml-1"><i class="fa-solid fa-arrows-rotate text-xs"></i></button>
                </div>
            </div>

            <!-- Public Fund Card -->
            <div class="bg-gradient-to-r from-gray-800 to-gray-700 text-white rounded-2xl p-4 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute right-[-20px] top-[-20px] text-8xl opacity-10 rotate-12"><i class="fa-solid fa-scale-balanced"></i></div>
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-lg"><i class="fa-solid fa-users-line mr-2"></i>å…¬è²»ç¸½è¦½</h3>
                    <button onclick="openPublicFundModal()" class="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full backdrop-blur-sm transition"><i class="fa-solid fa-gear"></i> è¨­å®š</button>
                </div>
                <div class="flex justify-between items-end">
                    <div>
                        <div class="text-xs text-gray-300 mb-1">å…¬è²»å‰©é¤˜ (JPY)</div>
                        <div class="text-3xl font-mono font-bold tracking-tight" id="pf-remaining">Â¥0</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-300 mb-1">ç¸½é ç®—</div>
                        <div class="font-mono font-bold" id="pf-total">Â¥0</div>
                    </div>
                </div>
            </div>

            <!-- Auto Charts Section (Total Overview) -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4 transition-all" id="wallet-charts-section">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-sm font-bold text-gray-600 flex items-center gap-1"><i class="fa-solid fa-chart-pie text-fuji"></i> å…¨é«”é–‹éŠ·åˆ†æ</h4>
                    <span class="text-[10px] text-gray-400">ç¸½é«”æ¶ˆè²»çµ±è¨ˆ</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="h-32 relative flex items-center justify-center"><canvas id="inlineCategoryChart"></canvas></div>
                    <div class="h-32 relative flex items-center justify-center"><canvas id="inlineMemberChart"></canvas></div>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-2">
                 <h4 class="text-sm font-bold text-gray-400 flex items-center gap-2"><i class="fa-solid fa-calculator"></i> è²»ç”¨åˆ†æ (é»æ“Šæˆå“¡çœ‹è©³æƒ…)</h4>
                 <button onclick="calculateSettlement()" class="text-xs bg-ink text-white px-3 py-1.5 rounded-lg shadow hover:bg-gray-700 transition font-bold"><i class="fa-solid fa-money-bill-transfer mr-1"></i>çµç®—å»ºè­°</button>
            </div>

            <div class="flex overflow-x-auto gap-4 pb-4 no-scrollbar mb-4 md:grid md:grid-cols-4 md:overflow-visible" id="wallet-dashboard-container"></div>
            
            <div class="flex justify-between items-center mb-4 mt-4 px-1">
                <h4 class="text-sm font-bold text-gray-400 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> æœ€è¿‘æ”¯å‡º</h4>
                <div class="flex gap-2">
                    <button onclick="openMemberModal()" class="text-xs text-gray-500 bg-white border border-gray-200 rounded-lg px-3 py-1.5 hover:bg-gray-50 shadow-sm transition"><i class="fa-solid fa-users-gear mr-1"></i>æˆå“¡èˆ‡é ­åƒ</button>
                    <button onclick="openIOUModal()" class="text-xs text-fuji bg-fuji/5 border border-fuji/20 rounded-lg px-3 py-1.5 hover:bg-fuji/10 shadow-sm transition"><i class="fa-solid fa-hand-holding-dollar mr-1"></i>å€Ÿæ¬¾</button>
                </div>
            </div>
            <div id="expense-list" class="space-y-3 pb-24 md:grid md:grid-cols-2 md:gap-3 md:space-y-0"></div>
            <div class="fixed bottom-24 right-6 md:right-10 z-30">
                <button onclick="openExpenseModal()" class="bg-ink text-white rounded-full h-14 px-6 shadow-float flex items-center gap-2 hover:scale-105 transition active:scale-95 group border-2 border-white/20">
                    <i class="fa-solid fa-pen-nib text-xl group-hover:rotate-12 transition"></i> <span class="font-bold handwritten tracking-widest text-lg">è¨˜ä¸€ç­†</span>
                </button>
            </div>
        </section>

        <!-- LISTS SECTION -->
        <section id="view-lists" class="view-section hidden relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- Must Eat -->
                <div class="hand-card p-6 bg-[#fffdf0] relative border-l-8 border-[#fffdf0]">
                      <div class="absolute -right-2 -top-2 text-4xl opacity-20 rotate-12">ğŸœ</div>
                      <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-300 pb-2">
                        <h3 class="text-xl font-bold text-pencil handwritten flex items-center gap-2"><i class="fa-solid fa-utensils text-matcha"></i> å¿…åƒæ¸…å–®</h3>
                        <button onclick="openMustEatModal()" class="text-xs bg-matcha/10 text-green-700 px-3 py-1.5 rounded-lg border border-matcha/30 shadow-sm hover:bg-matcha hover:text-white transition font-bold">æ–°å¢/ç·¨è¼¯</button>
                      </div>
                      <div id="must-eat-list" class="space-y-3"></div>
                </div>

                <!-- Shopping -->
                <div class="hand-card p-0 bg-white relative border-l-8 border-white overflow-hidden flex flex-col" id="shopping-card">
                      <div class="p-6 pb-2">
                          <div class="absolute -right-2 -top-2 text-4xl opacity-20 rotate-[-10]">ğŸ›ï¸</div>
                          <div class="flex justify-between items-center mb-2">
                             <h3 class="text-xl font-bold text-pencil handwritten flex items-center gap-2"><i class="fa-solid fa-bag-shopping text-red-400"></i> è³¼ç‰©æ¸…å–®</h3>
                             <div class="flex gap-2">
                                 <button onclick="openShopOwnerModal()" class="text-xs bg-gray-50 text-gray-500 px-3 py-1.5 rounded-lg border border-gray-100 hover:bg-gray-200 transition font-bold shadow-sm" title="ç®¡ç†è³¼ç‰©è€…"><i class="fa-solid fa-user-pen"></i></button>
                                 <button onclick="openShoppingModal()" class="text-xs bg-red-50 text-red-500 px-3 py-1.5 rounded-lg border border-red-100 hover:bg-red-400 hover:text-white transition font-bold shadow-sm">æ–°å¢</button>
                             </div>
                          </div>
                          <div class="flex justify-between items-center bg-gray-50 rounded-lg p-2 mb-2">
                             <button onclick="prevShopList()" class="w-8 h-8 rounded-full bg-white text-gray-400 hover:text-gray-600 shadow-sm flex items-center justify-center active:scale-95"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                             <div class="text-center">
                                 <span id="shop-owner-name" class="font-bold text-gray-700 handwritten text-lg block"></span>
                                 <div id="shop-owner-dots" class="flex justify-center gap-1 mt-1 h-2"></div>
                             </div>
                             <button onclick="nextShopList()" class="w-8 h-8 rounded-full bg-white text-gray-400 hover:text-gray-600 shadow-sm flex items-center justify-center active:scale-95"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                          </div>
                      </div>
                      <div id="shopping-swipe-area" class="flex-1 p-6 pt-0 min-h-[300px] touch-pan-y">
                          <!-- Categories Render Here -->
                          <div id="shopping-list-container" class="space-y-4 animate-slide-in"></div>
                      </div>
                </div>
                
                <div class="hand-card p-6 bg-[#f0f4f8] border-l-8 border-[#f0f4f8]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-fuji handwritten"><i class="fa-solid fa-suitcase mr-2"></i>è¡Œæç¢ºèª</h3>
                        <button onclick="uncheckAllTodos()" class="text-xs bg-white/50 border border-fuji/20 text-fuji px-2 py-1 rounded-full shadow-sm hover:bg-white transition" title="å…¨éƒ¨å–æ¶ˆå‹¾é¸"><i class="fa-solid fa-rotate-left"></i> é‡ç½®ç‹€æ…‹</button>
                        <button onclick="restoreDefaultTodos()" class="text-xs bg-white/50 border border-fuji/20 text-fuji px-2 py-1 rounded-full shadow-sm hover:bg-white transition ml-2" title="æ¢å¾©å…§å»ºæ¸…å–®"><i class="fa-solid fa-list-ul"></i> æ¢å¾©é è¨­</button>
                    </div>
                    
                    <ul id="checklist-container" class="grid grid-cols-2 gap-x-4 gap-y-2"></ul>
                    <div class="mt-4 flex gap-2 border-t pt-2 border-gray-200/50">
                        <input type="text" id="new-todo" placeholder="æ–°å¢é …ç›®..." class="flex-1 bg-transparent border-b border-gray-300 text-sm outline-none font-hand focus:border-fuji transition px-1">
                        <button onclick="addTodo()" class="text-fuji hover:scale-110 transition"><i class="fa-solid fa-circle-plus fa-lg"></i></button>
                    </div>
                </div>
                 <div class="hand-card p-6 bg-[#fffff0] rotate-1 shadow-md border-t-8 border-[#e6e6d8]/30">
                    <div class="absolute top-0 left-0 w-full h-4 bg-yellow-400/10"></div>
                    <h3 class="text-lg font-bold mb-2 handwritten text-yellow-800 flex items-center gap-2"><i class="fa-solid fa-note-sticky"></i> éš¨æ‰‹è¨˜ (MEMO)</h3>
                   <textarea id="memo-pad" class="w-full h-48 px-3 py-1 bg-transparent border-none resize-none text-sm leading-8 outline-none text-gray-700 handwritten" style="background-image: repeating-linear-gradient(transparent, transparent 31px, #e5e5e5 32px); line-height: 32px;" placeholder="åœ¨é€™è£¡éš¨æ‰‹è¨˜ä¸‹æƒ³æ³•... (è¼¸å…¥å¾Œè‡ªå‹•åŒæ­¥)"></textarea>
                </div>
            </div>
        </section>

        <!-- INFO SECTION -->
<section id="view-info" class="view-section hidden relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                
                <div class="hand-card p-6 relative overflow-hidden group border-l-8 border-blue-200">
                    <div class="absolute -right-4 -top-4 text-6xl opacity-10 rotate-12 text-blue-400">ğŸ—¾</div>
                    <h3 class="font-bold text-blue-500 handwritten text-xl flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-language"></i> éš¨èº«ç¿»è­¯
                    </h3>
                    
                    <div class="relative mb-3">
                        <textarea id="trans-input" class="w-full h-24 p-3 pr-14 bg-blue-50/30 border border-blue-100 rounded-xl resize-none text-sm outline-none focus:border-blue-300 transition font-hand placeholder-gray-400" placeholder="è¼¸å…¥æ–‡å­—æˆ–æŒ‰å³ä¸‹è§’èªªè©±..."></textarea>
                        <button id="btn-mic" onclick="toggleVoiceInput()" class="absolute right-2 bottom-2 w-10 h-10 bg-white border border-blue-200 text-blue-500 rounded-full shadow-md flex items-center justify-center hover:bg-blue-500 hover:text-white transition active:scale-95 z-10">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <a href="https://translate.google.com/?sl=auto&tl=ja&op=images" target="_blank" class="bg-blue-100 text-blue-600 border border-blue-200 py-3 rounded-xl font-bold shadow-sm hover:bg-blue-500 hover:text-white transition flex items-center justify-center gap-2 no-underline text-sm">
                            <i class="fa-solid fa-camera"></i> æ‹ç…§ç¿»è­¯
                        </a>
                        <button onclick="openGoogleTranslate()" class="bg-blue-500 text-white py-3 rounded-xl font-bold shadow-sm hover:bg-blue-600 transition flex items-center justify-center gap-2 text-sm active:scale-95">
                            <i class="fa-solid fa-paper-plane"></i> æ–‡å­—ç¿»è­¯
                        </button>
                    </div>
                </div>

                <details class="hand-card p-0 border-l-8 border-sakura/20 group transition-all duration-300">
                    <summary class="p-6 cursor-pointer list-none flex justify-between items-center hover:bg-gray-50 transition relative select-none">
                        <h3 class="font-bold text-sakura handwritten text-xl flex items-center gap-2"><i class="fa-solid fa-comment-dots"></i> ç”Ÿå­˜æ—¥èªå­—å¡</h3>
                        <span class="text-sakura/50 group-open:rotate-180 transition-transform duration-300"><i class="fa-solid fa-chevron-down"></i></span>
                    </summary>
                    <div class="px-6 pb-6 animate-slide-in border-t border-gray-100/50 pt-4">
                         <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar mb-3">
                            <button onclick="renderPhrases('food')" class="phrase-btn active whitespace-nowrap bg-white border border-gray-200 text-gray-500 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-sakura hover:text-white hover:border-sakura transition" data-cat="food">ğŸ± é£Ÿ</button>
                            <button onclick="renderPhrases('vege')" class="phrase-btn whitespace-nowrap bg-white border border-gray-200 text-gray-500 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-veggie hover:text-white hover:border-veggie transition" data-cat="vege">ğŸ¥— ç´ é£Ÿ</button>
                            <button onclick="renderPhrases('shopping')" class="phrase-btn whitespace-nowrap bg-white border border-gray-200 text-gray-500 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-red-400 hover:text-white hover:border-red-400 transition" data-cat="shopping">ğŸ‘• è¡£ (è³¼ç‰©)</button>
                            <button onclick="renderPhrases('stay')" class="phrase-btn whitespace-nowrap bg-white border border-gray-200 text-gray-500 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-yellow-400 hover:text-white hover:border-yellow-400 transition" data-cat="stay">ğŸ  ä½</button>
                            <button onclick="renderPhrases('transport')" class="phrase-btn whitespace-nowrap bg-white border border-gray-200 text-gray-500 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-blue-400 hover:text-white hover:border-blue-400 transition" data-cat="transport">ğŸš… è¡Œ</button>
                        </div>
                        <div id="phrase-container" class="space-y-2 max-h-60 overflow-y-auto"><script>setTimeout(() => { if(typeof renderPhrases === 'function') renderPhrases('food'); }, 500);</script></div>
                    </div>
                </details>
            </div>

            <div class="mt-6 mb-6">
                <div class="hand-card p-4 border-l-8 border-blue-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-blue-400 handwritten text-xl flex items-center gap-2"><i class="fa-solid fa-map"></i> æ±äº¬äº¤é€šè·¯ç¶²åœ–</h3>
                        <a href="https://www.tokyometro.jp/en/subwaymap/pdf/routemap_en.pdf" target="_blank" class="text-xs bg-gray-100 text-gray-500 px-3 py-1 rounded-full hover:bg-gray-200"><i class="fa-solid fa-download"></i> PDF å®˜ç¶²</a>
                    </div>
                    <div class="relative rounded-xl overflow-hidden shadow-inner border border-gray-100 group cursor-pointer" onclick="viewPhoto('https://i.redd.it/qdlkazgfuyqd1.jpeg')">
                        <img src="https://i.redd.it/qdlkazgfuyqd1.jpeg" class="w-full h-48 object-cover object-center group-hover:scale-105 transition duration-500" alt="äº¤é€šåœ°åœ–">
                         <div class="absolute inset-0 bg-black/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <span class="bg-white/80 px-3 py-1 rounded-full text-xs font-bold text-gray-700 backdrop-blur-md"><i class="fa-solid fa-magnifying-glass-plus"></i> é»æ“Šæ”¾å¤§</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-3">
                <a href="https://tenki.jp/" target="_blank" class="flex flex-col items-center justify-center bg-blue-50 hover:bg-blue-100 p-3 rounded-xl transition group no-underline text-center h-24">
                    <i class="fa-solid fa-cloud-sun-rain text-2xl text-blue-400 mb-1 group-hover:scale-110 transition-transform"></i>
                    <span class="text-xs font-bold text-gray-500">å¤©æ°£</span>
                </a>
                <a href="https://www.google.com/maps/search/drugstore" target="_blank" class="flex flex-col items-center justify-center bg-pink-50 hover:bg-pink-100 p-3 rounded-xl transition group no-underline text-center h-24">
                    <i class="fa-solid fa-store text-2xl text-sakura mb-1 group-hover:scale-110 transition-transform"></i>
                    <span class="text-xs font-bold text-gray-500">è—¥å¦</span>
                </a>
                <a href="https://tabelog.com/" target="_blank" class="flex flex-col items-center justify-center bg-orange-50 hover:bg-orange-100 p-3 rounded-xl transition group no-underline text-center h-24">
                    <i class="fa-solid fa-utensils text-2xl text-orange-400 mb-1 group-hover:scale-110 transition-transform"></i>
                    <span class="text-xs font-bold text-gray-500">ç¾é£Ÿ</span>
                </a>
                <a href="https://transit.yahoo.co.jp/" target="_blank" class="flex flex-col items-center justify-center bg-red-50 hover:bg-red-100 p-3 rounded-xl transition group no-underline text-center h-24">
                    <i class="fa-solid fa-train-subway text-2xl text-red-400 mb-1 group-hover:scale-110 transition-transform"></i>
                    <span class="text-xs font-bold text-gray-500">äº¤é€š</span>
                </a>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 mt-6">
                <div class="space-y-6">
                    <div class="hand-card p-0 overflow-hidden bg-blue-50/30 border border-blue-100 group hover:shadow-lg transition">
                        <div class="p-4 bg-gradient-to-r from-blue-500/10 to-transparent flex justify-between items-center cursor-pointer" onclick="toggleVJW()">
                            <h3 class="font-bold text-blue-800 handwritten text-lg flex items-center gap-2"><i class="fa-solid fa-passport"></i>Visit Japan Web</h3>
                             <div class="flex gap-2 items-center">
                                <a href="https://www.vjw.digital.go.jp/" target="_blank" onclick="event.stopPropagation()" class="text-xs bg-white text-blue-500 px-3 py-1.5 rounded-full shadow-sm hover:bg-blue-500 hover:text-white transition font-bold"><i class="fa-solid fa-link"></i></a>
                                <i id="vjw-arrow" class="fa-solid fa-chevron-down text-blue-300 transition-transform"></i>
                            </div>
                        </div>
                        <div id="vjw-content" class="transition-all duration-300 overflow-hidden"><div class="p-4 pb-6"><div id="vjw-container" class="flex overflow-x-auto gap-4 snap-x snap-mandatory pb-4 no-scrollbar items-start"></div></div></div>
                    </div>

                     <details class="group hand-card overflow-hidden border border-gray-200">
                        <summary class="flex justify-between items-center p-4 cursor-pointer bg-gray-50 hover:bg-gray-100 transition list-none">
                            <span class="text-xs font-bold text-gray-500 flex items-center gap-2"><i class="fa-brands fa-github text-lg"></i> é›²ç«¯åŒæ­¥è¨­å®š</span>
                            <span class="text-gray-400 group-open:rotate-180 transition text-xs"><i class="fa-solid fa-chevron-down"></i></span>
                        </summary>
                        <div class="p-4 bg-white space-y-3 border-t border-gray-100">
                            <div class="text-[10px] text-gray-400 mb-2">è¨­å®š Gist ID å¾Œï¼Œè³‡æ–™è®Šå‹•å°‡è‡ªå‹•ä¸Šå‚³ã€‚</div>
                            <div><label class="text-[10px] font-bold text-gray-400 block mb-1">Gist ID</label><input type="text" id="gist-id-input" placeholder="Gist ID" class="w-full border p-2 rounded text-xs font-mono bg-gray-50 outline-none focus:border-matcha"></div>
                           <div><label class="text-[10px] font-bold text-gray-400 block mb-1">Token</label><input type="password" id="gist-token-input" placeholder="Token" class="w-full border p-2 rounded text-xs font-mono bg-gray-50 outline-none focus:border-matcha"></div>

                            <button onclick="saveGistConfig()" class="w-full bg-ink text-white px-3 py-2 rounded text-xs font-bold hover:bg-gray-800 transition mb-2">å„²å­˜è¨­å®š</button>
                            
                            <button onclick="forceUpload(true)" class="w-full bg-red-100 text-red-500 border border-red-200 px-3 py-2 rounded text-xs font-bold hover:bg-red-500 hover:text-white transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-cloud-arrow-up"></i> å¼·åˆ¶ä¸Šå‚³ (è¦†è“‹é›²ç«¯)
                            </button>
                            <p class="text-[9px] text-gray-400 text-center mt-1">âš ï¸ é€™æœƒæŠŠç›®å‰çš„ç•«é¢å…§å®¹å­˜åˆ°é›²ç«¯ï¼Œè«‹å°å¿ƒä½¿ç”¨</p>              
                       </div>
                    </details>
                </div>
            </div>
        </section>
<button id="btn-back-to-plan" onclick="goBackToPlan()" class="hidden fixed bottom-24 left-4 z-50 bg-white/90 backdrop-blur-sm border border-fuji text-fuji px-4 py-2 rounded-full shadow-lg font-bold text-sm hover:bg-fuji hover:text-white transition-all transform active:scale-95 flex items-center gap-2 animate-slide-in">
                           <i class="fa-solid fa-arrow-left-long"></i> è¿”å›è¡Œç¨‹</button> 
    </main>

    <!-- NEW: MEMBER ANALYSIS MODAL -->
    <div id="member-analysis-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative hand-card">
            <button onclick="closeModal('member-analysis-modal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center handwritten" id="analysis-title">æ¶ˆè²»åˆ†æ</h3>
            <div class="mb-4 flex flex-col items-center">
                 <div class="text-xs text-gray-400 mb-1">ç¸½æ¶ˆè²» (åˆ†æ”¤å¾Œ)</div>
                 <div id="analysis-total" class="text-3xl font-bold font-mono text-fuji">NT$0</div>
            </div>
            <div class="h-48 relative flex items-center justify-center mb-4">
                <canvas id="memberDetailChart"></canvas>
            </div>
            <div id="analysis-details" class="space-y-2 text-xs text-gray-500 bg-gray-50 p-3 rounded-lg overflow-y-auto max-h-40"></div>
        </div>
    </div>

    <!-- NEW: ACCOMMODATION PHOTOS MODAL -->
    <div id="acc-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[80vh] overflow-hidden flex flex-col">
            <button onclick="closeModal('acc-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center handwritten text-fuji flex items-center justify-center gap-2">
                <i class="fa-solid fa-bed"></i> ä½å®¿ç…§ç‰‡
            </h3>
            <div id="acc-modal-title" class="text-center text-sm font-bold text-gray-600 mb-4 truncate px-2"></div>
            
            <div class="flex-1 overflow-y-auto no-scrollbar mb-4 bg-white/50 rounded-xl border border-gray-100 p-2">
                <div id="acc-photos-grid" class="grid grid-cols-2 gap-2"></div>
            </div>
            
            <div class="relative w-full bg-fuji text-white py-3 rounded-xl font-bold text-center cursor-pointer shadow hover:bg-fuji/90 transition active:scale-95">
                <i class="fa-solid fa-camera mr-1"></i> æ–°å¢ç…§ç‰‡
                <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addAccPhoto(this)">
            </div>
        </div>
    </div>

    <!-- EXPENSE MODAL (Revamped Fixed) -->
    <div id="expense-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#fffdf9] w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative hand-card border border-white">
            <button onclick="closeModal('expense-modal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-bold mb-6 text-center text-gray-700 tracking-wide">è¨˜ä¸€ç­†</h3>
            <input type="hidden" id="ex-id">
            
            <!-- Amount -->
            <div class="flex items-center justify-center gap-2 mb-6">
                <select id="ex-currency" class="bg-gray-100 text-gray-600 font-bold rounded-lg px-2 py-1 outline-none text-sm border-none">
                    <option value="JPY">JPY</option>
                    <option value="TWD">TWD</option>
                </select>
                <input type="number" id="ex-amount" placeholder="0" class="text-4xl font-bold text-center w-40 outline-none bg-transparent border-b-2 border-gray-100 focus:border-sakura text-gray-700" inputmode="numeric">
            </div>

            <!-- Category -->
            <div class="flex justify-between mb-4 overflow-x-auto pb-2 no-scrollbar gap-2" id="expense-categories"></div>

            <!-- Payer (Who paid) - FIXED: Dropdown -->
            <div class="mb-4 bg-fuji-light/30 p-3 rounded-xl border border-fuji/10">
                <label class="block text-xs text-fuji mb-1 font-bold ml-1"><i class="fa-solid fa-hand-holding-dollar mr-1"></i>å¢Šä»˜äºº (èª°å…ˆå‡ºéŒ¢)</label>
                <div class="relative">
                    <select id="ex-paid-by" class="w-full bg-white rounded-lg p-2 text-sm font-bold text-gray-700 border border-fuji/20 focus:border-fuji outline-none appearance-none"></select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                </div>
            </div>

            <!-- Splitters (Shared by) -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs text-gray-400 font-bold ml-1">åˆ†æ”¤äºº (å¹³åˆ†è²»ç”¨)</label>
                    <button onclick="toggleAllPayers()" class="text-[10px] text-fuji bg-fuji-light px-2 py-0.5 rounded font-bold">å…¨é¸/å…¨å–æ¶ˆ</button>
                </div>
                <div id="ex-split-container" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="mb-4">
                <input type="text" id="ex-note" placeholder="å‚™è¨»èªªæ˜..." class="w-full bg-gray-50 rounded-xl p-3 text-sm outline-none border border-gray-100">
            </div>

            <div class="flex gap-3 items-center mb-6">
                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 relative overflow-hidden cursor-pointer hover:bg-gray-200">
                    <i class="fa-solid fa-camera"></i>
                    <input type="file" id="ex-photo" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentPhotoBase64 = base64; document.getElementById('ex-photo-preview-mini').src = base64; document.getElementById('ex-photo-preview-mini').classList.remove('hidden'); document.getElementById('btn-remove-ex-photo').classList.remove('hidden'); })">
                    <img id="ex-photo-preview-mini" class="hidden absolute inset-0 w-full h-full object-cover">
                </div>
                <span class="text-xs text-gray-400">æ”¶æ“š</span>
                
                <button id="btn-remove-ex-photo" onclick="removeExpensePhoto()" class="hidden text-xs text-red-400 border border-red-200 bg-red-50 px-2 py-1 rounded-full hover:bg-red-400 hover:text-white transition flex items-center gap-1">
                    <i class="fa-solid fa-trash-can"></i> ç§»é™¤
                </button>
            </div>
            <div class="flex gap-3">
                <button onclick="deleteExpense()" id="btn-delete-expense" class="w-12 h-12 rounded-full bg-gray-100 text-gray-400 hidden"><i class="fa-solid fa-trash-can"></i></button>
                <button onclick="saveExpense()" class="flex-1 bg-ink text-white py-3 rounded-full font-bold shadow-lg">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- SETTLEMENT MODAL -->
    <div id="settlement-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl relative hand-card max-h-[85vh] overflow-y-auto">
            <button onclick="closeModal('settlement-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-bold mb-4 text-center handwritten text-ink">çµç®—å»ºè­°æ›¸</h3>
            
            <div class="bg-blue-50 p-4 rounded-xl mb-6 border border-blue-100">
                <h4 class="font-bold text-blue-800 text-sm mb-2"><i class="fa-solid fa-money-bill-transfer"></i> å»ºè­°è½‰å¸³è·¯å¾‘</h4>
                <div id="settlement-plan" class="space-y-3 text-sm"></div>
            </div>

            <h4 class="font-bold text-gray-600 text-sm mb-2">æ”¶æ”¯å¹³è¡¡è¡¨ (NT$)</h4>
            <div class="h-48 relative flex items-center justify-center mb-4">
                <canvas id="settlementChart"></canvas>
            </div>
            
            <div id="settlement-details" class="space-y-2 text-xs text-gray-500 bg-gray-50 p-3 rounded-lg"></div>
            
            <button onclick="closeModal('settlement-modal')" class="w-full mt-4 bg-ink text-white py-3 rounded-xl font-bold">äº†è§£</button>
        </div>
    </div>

    <!-- FLIGHT MODAL -->
    <div id="flight-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-3xl p-6 shadow-2xl relative hand-card">
            <button onclick="closeModal('flight-modal')" class="absolute top-3 right-3 text-gray-400 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center handwritten">ç·¨è¼¯èˆªç­</h3>
            <div class="space-y-4">
                <input type="hidden" id="flight-id"> 
                <div class="flex gap-4 items-center">
                    <input type="text" id="flight-dep" placeholder="TPE" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white">
                    <i class="fa-solid fa-plane text-gray-300"></i>
                    <input type="text" id="flight-arr" placeholder="NRT" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white">
                </div>
                <div class="bg-fuji-light p-4 rounded-xl">
                    <input type="text" id="flight-code" placeholder="èˆªç­ä»£è™Ÿ (ä¾‹: IT202)" class="w-full p-2 border-b border-fuji/20 bg-transparent text-center font-bold text-fuji handwritten text-xl mb-2 focus:outline-none placeholder-fuji/40">
                    <input type="text" id="flight-date" placeholder="æ—¥æœŸ (ä¾‹: 1/10 å»ç¨‹)" class="w-full p-1 bg-transparent text-center text-sm font-hand text-gray-500 mb-1 focus:outline-none">
                    <input type="text" id="flight-time" placeholder="æ™‚é–“ (ä¾‹: 14:00 - 18:00)" class="w-full p-1 bg-transparent text-center text-sm font-hand text-gray-500 focus:outline-none">
                </div>
                <div class="flex gap-2">
                <input type="url" id="flight-url" placeholder="å®˜ç¶²/å ±åˆ°é€£çµ" class="flex-1 p-2 border rounded-xl bg-white text-xs outline-none">
                <div class="relative w-12 h-10 border border-dashed border-fuji/50 rounded-xl flex items-center justify-center bg-white cursor-pointer hover:bg-blue-50 overflow-hidden">
                        <i class="fa-solid fa-camera text-fuji"></i>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="processImage(this, (b64)=>{currentFlightPhoto=b64; document.getElementById('flight-photo-preview').src=b64; document.getElementById('flight-photo-preview').classList.remove('hidden');})">
                        <img id="flight-photo-preview" class="hidden absolute inset-0 w-full h-full object-cover pointer-events-none">
                    </div>
                </div>
                <button onclick="saveFlight()" class="w-full bg-fuji text-white py-3 rounded-xl font-bold mt-2 shadow-lg shadow-fuji/30 hover:bg-fuji/90 transition handwritten tracking-widest">å„² å­˜</button>
            </div>
        </div>
    </div>

    <!-- DAY MODAL -->
    <div id="day-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-lg rounded-2xl p-4 shadow-2xl relative hand-card h-[85vh] overflow-y-auto border-4 border-white">
            <button onclick="closeModal('day-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-2 text-center handwritten">ç·¨è¼¯è¡Œç¨‹</h3>
            <input type="hidden" id="day-id-edit">
            
            <div class="mb-3">
                 <input type="text" id="day-date-edit" class="w-full p-2 border-b-2 border-matcha bg-transparent font-bold font-hand text-2xl focus:outline-none placeholder-gray-300" placeholder="æ—¥æœŸæ¨™é¡Œ (ä¾‹å¦‚: Day 1 æˆç”°)">
            </div>
            
           <div class="flex gap-3 items-center mb-4">
                 <div class="flex-1 relative">
                    <i class="fa-solid fa-temperature-half absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="day-temp-edit" placeholder="æ°£æº«" class="w-full pl-8 p-2 bg-white border rounded-xl text-sm outline-none shadow-sm text-center font-bold text-gray-600 focus:border-matcha transition">
                 </div>
                 
                 <div class="flex-1 relative">
                     <select id="day-weather-edit" class="w-full p-2 bg-white border rounded-xl text-sm outline-none shadow-sm text-center appearance-none focus:border-matcha transition cursor-pointer font-bold text-gray-600">
                         <option value="">â˜ é¸æ“‡å¤©æ°£</option>
                         <option value="sunny">â˜€ æ™´æœ—è±”é™½</option>
                         <option value="partly-cloudy">â›… æ™´æ™‚å¤šé›²</option>
                         <option value="cloudy">â˜ é™°å¤©</option>
                         <option value="rain">â˜‚ å°é›¨/é™£é›¨</option>
                         <option value="heavy-rain">â›ˆï¸ è±ªé›¨/é›·é›¨</option>
                         <option value="snow">â›„ ä¸‹é›ª</option>
                         <option value="fog">ğŸŒ«ï¸ èµ·éœ§</option>
                     </select>
                     <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center px-1 text-gray-400">
                        <i class="fa-solid fa-caret-down text-xs"></i>
                     </div>
                 </div>
            </div>
                        <label class="flex items-center space-x-2 text-sm text-gray-600 mb-4 bg-yellow-50 p-2 rounded"><input type="checkbox" id="day-highlight-edit" class="accent-red-400"><span>æ¨™è¨˜ç‚ºé‡é»å¤©æ•¸ (Highlight)</span></label>
            
            <div class="mb-4 bg-white p-2 rounded border border-gray-200 shadow-inner">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-gray-400">ç•¶æ—¥ç›¸ç‰‡é›†</h4>
                    <div class="relative overflow-hidden inline-block">
                        <button class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs hover:bg-gray-200"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addDayPhoto(this)">
                    </div>
                </div>
                <div id="day-photos-preview" class="grid grid-cols-3 gap-2"></div>
            </div>
            
            <div class="mb-4">
                <label class="text-xs text-gray-400 font-bold mb-1 block">ä½å®¿è³‡è¨Š</label>
                <input type="text" id="day-accommodation-edit" class="w-full p-2 border rounded text-sm mb-2" placeholder="ä½å®¿åœ°é» (å¯ç›´æ¥è²¼ Google Maps é€£çµ)">
                <input type="url" id="day-accommodation-url-edit" class="w-full p-2 border rounded text-sm mb-2" placeholder="Google Maps é€£çµ (é¸å¡«)">    
                <input type="text" id="day-accommodation-note-edit" class="w-full p-2 border rounded text-xs bg-gray-50 text-gray-500" placeholder="ä½å®¿å‚™è¨» (å¦‚: Wifiå¯†ç¢¼, Check-inæ™‚é–“)">
            </div>

            <div class="mb-4 border-t pt-3 bg-gray-50 p-2 rounded-lg border border-gray-100">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-gray-400 flex items-center gap-1">
                        <i class="fa-solid fa-train"></i> äº¤é€šæ–¹å¼
                    </h4>
                    <button onclick="addTransRow()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 font-bold border border-blue-200 transition">
                        <i class="fa-solid fa-plus"></i> æ–°å¢ä¸€ç­†
                    </button>
                </div>
                <div id="day-trans-list" class="space-y-3"></div>
            </div>  
            
            <textarea id="day-content-edit" class="w-full h-32 p-3 border rounded-lg bg-white text-sm mb-4 font-hand leading-relaxed" placeholder="è¡Œç¨‹å…§å®¹... (è«‹ç”¨åæ–œç·š '\' åˆ†éš”æ¯é …æ´»å‹•ï¼Œè‹¥å…§å®¹åŒ…å«'æ·±åº¦å°è¦½'çš„æ¨™é¡Œï¼Œæœƒè‡ªå‹•ç”¢ç”Ÿé€£çµ)"></textarea>
            
            <div class="bg-white p-3 rounded-lg border mb-4 space-y-4 shadow-sm">
                <h4 class="text-xs font-bold text-gray-400 border-b pb-1">ä¸‰é¤å®‰æ’ (è¼¸å…¥é€£çµå¯è·³è½‰)</h4>
                
                <div class="border-b pb-2">
                    <div class="flex gap-2 mb-1 items-center">
                        <i class="fa-solid fa-mug-hot text-orange-300 w-5"></i>
                        <input type="text" id="meal-b-name" placeholder="æ—©é¤åç¨±" class="flex-1 text-sm font-bold bg-transparent border-b border-gray-100">
                    </div>
                    <input type="url" id="meal-b-link" placeholder="æ—©é¤é€£çµ" class="w-full text-xs text-fuji bg-gray-50 p-1 rounded mb-1">
                    <input type="text" id="meal-b-note" placeholder="å‚™è¨» (å¦‚: é£¯ç³°å¥½åƒ)" class="w-full text-xs text-gray-400 border-b border-dashed border-gray-200 p-1 outline-none">
                </div>

                <div class="border-b pb-2">
                    <div class="flex gap-2 mb-1 items-center">
                        <i class="fa-solid fa-utensils text-green-400 w-5"></i>
                        <input type="text" id="meal-l-name" placeholder="åˆé¤åç¨±" class="flex-1 text-sm font-bold bg-transparent border-b border-gray-100">
                    </div>
                    <input type="url" id="meal-l-link" placeholder="åˆé¤é€£çµ" class="w-full text-xs text-fuji bg-gray-50 p-1 rounded mb-1">
                    <input type="text" id="meal-l-note" placeholder="å‚™è¨» (å¦‚: éœ€æ’éšŠ)" class="w-full text-xs text-gray-400 border-b border-dashed border-gray-200 p-1 outline-none">
                </div>

                <div>
                    <div class="flex gap-2 mb-1 items-center">
                        <i class="fa-solid fa-wine-glass text-purple-400 w-5"></i>
                        <input type="text" id="meal-d-name" placeholder="æ™šé¤åç¨±" class="flex-1 text-sm font-bold bg-transparent border-b border-gray-100">
                    </div>
                    <input type="url" id="meal-d-link" placeholder="æ™šé¤é€£çµ" class="w-full text-xs text-fuji bg-gray-50 p-1 rounded mb-1">
                    <input type="text" id="meal-d-note" placeholder="å‚™è¨» (å¦‚: æœ‰é ç´„)" class="w-full text-xs text-gray-400 border-b border-dashed border-gray-200 p-1 outline-none">
                </div>
            </div>
            
            <textarea id="day-note-edit" class="w-full h-20 p-2 border border-yellow-200 bg-yellow-50 rounded text-sm mb-4 handwritten" placeholder="æ¯æ—¥å‚™è¨»..."></textarea>
            
            <div class="flex gap-2"><button onclick="deleteDay()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm">åˆªé™¤</button><button onclick="saveDay()" class="flex-[2] bg-matcha text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div>
        </div>
    </div>
    <!-- GUIDE MODAL -->
    <div id="guide-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('guide-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="font-bold mb-3 handwritten text-lg">æ–°å¢/ç·¨è¼¯æ™¯é»å°è¦½</h3>
            <input type="hidden" id="guide-id">
            <input type="text" id="guide-title" placeholder="æ™¯é»åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold font-hand text-lg focus:border-matcha outline-none">
            <textarea id="guide-desc" placeholder="ä»‹ç´¹å…§å®¹..." class="w-full mb-3 border bg-white p-2 rounded h-24 text-sm"></textarea>
            <div class="flex gap-2 mb-3">
                 <input type="text" id="guide-price" placeholder="é ç®—/é–€ç¥¨ (å¦‚: Â¥2000)" class="w-1/2 border rounded p-2 text-xs bg-white">
                 <input type="text" id="guide-time" placeholder="ç‡Ÿæ¥­/å»ºè­°æ™‚é–“ (10:00-20:00)" class="w-1/2 border rounded p-2 text-xs bg-white">
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative mb-3 hover:bg-white bg-white/50">
                <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentGuidePhoto = base64; document.getElementById('guide-photo-preview').src = base64; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden'); })">
                <div id="guide-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-image mb-1 block"></i> æ›´æ–°ç…§ç‰‡</div>
                <img id="guide-photo-preview" class="hidden h-32 mx-auto object-cover rounded">
            </div>
            <button onclick="saveGuide()" class="w-full bg-matcha text-white py-2 rounded-lg font-bold">å„²å­˜</button>
        </div>
    </div>

    <!-- PUBLIC FUND MODALS -->
    <div id="pf-settings-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg hand-card">
            <h4 class="font-bold mb-3 text-center text-lg handwritten">å…¬è²»è¨­å®š</h4>
            <div class="mb-4">
                <label class="text-xs text-gray-400 block mb-1">å…¬è²»ç¸½é‡‘é¡ (JPY)</label>
                <input type="number" id="pf-total-input" class="w-full border p-2 rounded text-lg font-bold font-mono outline-none focus:border-matcha text-center">
            </div>
            <button onclick="savePublicFundSettings()" class="w-full bg-gray-800 text-white py-2 rounded-lg text-sm font-bold shadow">å„²å­˜</button>
            <button onclick="closeModal('pf-settings-modal')" class="w-full mt-2 bg-gray-100 text-gray-500 py-2 rounded-lg text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- SHOPPING MODAL (FIXED TAGS) -->
    <div id="shopping-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('shopping-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="font-bold mb-3 text-center">è³¼ç‰©é …ç›®</h3>
            <input type="hidden" id="shop-id">
            <input type="text" id="shop-name" placeholder="å•†å“åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold">
            
            <div class="mb-3">
                <label class="text-xs text-gray-400">åˆ†é¡ (å¯ç›´æ¥è¼¸å…¥)</label>
                <input type="text" id="shop-category" placeholder="ä¾‹: è—¥å¦, Outlet, è¶…å•†..." class="w-full border rounded p-2 text-sm bg-white mb-2">
                <div id="shop-cat-chips" class="flex flex-wrap gap-2"></div>            </div>
            </div>
            <div class="flex gap-3 mt-4 h-36">
                <div class="w-5/12 relative border-2 border-dashed border-gray-300 rounded-2xl bg-gray-50 flex flex-col items-center justify-center cursor-pointer group hover:bg-white hover:border-red-300 transition overflow-hidden h-full">
                    
                    <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="processImage(this, (base64) => { currentShopPhoto = base64; document.getElementById('shop-photo-preview').src = base64; document.getElementById('shop-photo-preview').classList.remove('hidden'); document.getElementById('shop-photo-placeholder').classList.add('hidden'); })">
                    
                    <div id="shop-photo-placeholder" class="text-center group-hover:scale-105 transition-transform duration-300 px-1">
                        <div class="w-8 h-8 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-1 text-gray-400 group-hover:text-red-400">
                            <i class="fa-solid fa-camera"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400 group-hover:text-red-400 block leading-tight">æ‹å•†å“</span>
                    </div>
                    
                    <img id="shop-photo-preview" class="hidden absolute inset-0 w-full h-full object-cover bg-white pointer-events-none">
                </div>

                <div class="w-7/12 flex flex-col gap-2 h-full">
                    
                    <div class="flex gap-2 h-1/2">
                        <div class="flex-1 bg-gray-50 p-1 rounded-xl border border-gray-100 flex flex-col justify-center">
                            <label class="text-[9px] text-gray-400 font-bold block text-center mb-0.5">æ•¸é‡</label>
                            <input type="number" id="shop-qty" value="1" class="w-full bg-transparent text-center font-black text-lg text-gray-700 outline-none p-0" onclick="this.select()">
                        </div>
                        <div class="flex-1 bg-gray-50 p-1 rounded-xl border border-gray-100 flex flex-col justify-center">
                            <label class="text-[9px] text-gray-400 font-bold block text-center mb-0.5">å–®åƒ¹ (JPY)</label>
                            <input type="number" id="shop-price" placeholder="0" class="w-full bg-transparent text-center font-black text-lg text-gray-700 outline-none p-0" onclick="this.select()">
                        </div>
                    </div>

                    <div class="flex gap-2 h-1/2">
                        <button onclick="deleteShoppingItem()" class="flex-1 bg-gray-100 text-gray-400 rounded-xl text-xs hover:bg-red-100 hover:text-red-500 transition font-bold flex flex-col items-center justify-center gap-1">
                            <i class="fa-solid fa-trash-can"></i> åˆªé™¤
                        </button>
                        <button onclick="saveShoppingItem()" class="flex-1 bg-red-400 text-white rounded-xl text-xs hover:bg-red-500 transition font-bold shadow-md flex flex-col items-center justify-center gap-1 active:scale-95">
                            <i class="fa-solid fa-check"></i> å„²å­˜
                        </button>
                    </div>
                </div>
            </div>    
                <img id="shop-photo-preview" class="hidden absolute inset-0 w-full h-full object-contain bg-black/5 pointer-events-none">
            </div>
    </div>

    <!-- SHOPPING CONFIRM MODAL -->
    <div id="shop-confirm-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl relative hand-card text-center">
            <div class="text-4xl mb-2">ğŸ›ï¸</div>
            <h3 class="font-bold text-lg mb-2 text-gray-800">è³¼è²·ç¢ºèª</h3>
            <p class="text-gray-500 text-sm mb-6">é€™ç­†æ¶ˆè²»æ˜¯å¦è¦åŠ å…¥è¨˜å¸³ï¼Ÿ</p>
            <input type="hidden" id="confirm-shop-id">
            <div class="space-y-3">
                <button onclick="confirmShopAction('expense')" class="w-full bg-ink text-white py-3 rounded-xl font-bold shadow-lg text-sm">æ˜¯ï¼ŒåŠ å…¥è¨˜å¸³ (ä¸¦æ¨™è¨˜å·²è²·)</button>
                <button onclick="confirmShopAction('cancel')" class="w-full bg-white border border-gray-200 text-gray-500 py-3 rounded-xl font-bold text-sm hover:bg-gray-50">å¦ï¼Œå–æ¶ˆ (ä¿ç•™åœ¨æ¸…å–®)</button>
                <div class="pt-2">
                    <button onclick="confirmShopAction('done_only')" class="text-xs text-gray-400 hover:text-gray-600 underline">ç´”æ¨™è¨˜å·²è²· (ä¸è¨˜å¸³)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Modals -->
    <div id="must-eat-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto"><button onclick="closeModal('must-eat-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center text-matcha">ğŸ½ï¸ ç·¨è¼¯å¿…åƒåœ°é»</h3><input type="hidden" id="eat-loc-id"><div class="mb-4"><label class="text-xs text-gray-400 block mb-1">åœ°é»åç¨±</label><input type="text" id="eat-location" placeholder="ä¾‹å¦‚: è¼•äº•æ¾¤ã€ç¯‰åœ°å¸‚å ´" class="w-full p-2 border-b-2 border-matcha/50 bg-transparent font-bold text-lg focus:outline-none"></div><label class="text-xs text-gray-400 block mb-2">ä¸»é¡Œ/é¤å»³åˆ—è¡¨</label><div id="eat-themes-container" class="space-y-3 mb-4"></div><button onclick="addThemeRow()" class="w-full py-2 border-2 border-dashed border-matcha/30 text-matcha rounded-lg text-sm font-bold mb-4 hover:bg-matcha/10 transition"><i class="fa-solid fa-plus"></i> æ–°å¢ä¸»é¡Œ</button><div class="flex gap-2"><button onclick="deleteMustEatLocation()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hover:bg-red-100">åˆªé™¤æ•´çµ„</button><button onclick="saveMustEatLocation()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow hover:bg-fuji/80">å„²å­˜</button></div></div></div>
    <div id="manage-shop-lists-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg hand-card"><h4 class="font-bold mb-3 text-center text-lg handwritten">ç®¡ç†è³¼ç‰©æ¸…å–®</h4><div id="shop-lists-container" class="space-y-2 mb-3 max-h-60 overflow-y-auto"></div><div class="flex gap-2 border-t pt-3"><input type="text" id="new-shop-list-name" placeholder="è¼¸å…¥åç¨± (å¦‚: åª½åª½)" class="flex-1 border p-2 text-sm rounded bg-gray-50 outline-none focus:border-red-300"><button onclick="addShopList()" class="bg-red-400 text-white px-3 rounded text-sm font-bold shadow-sm">æ–°å¢</button></div><button onclick="closeModal('manage-shop-lists-modal')" class="w-full mt-3 bg-gray-100 text-gray-500 py-2 rounded-lg text-sm hover:bg-gray-200 transition">å®Œæˆ</button></div></div>
    <div id="iou-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto"><button onclick="closeModal('iou-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center text-fuji">ğŸ¤ æ‰‹å‹•æ¬ æ¬¾/å€Ÿæ¬¾</h3><input type="hidden" id="iou-id"><div class="space-y-3 p-3 border rounded-lg bg-white mb-4"><div class="text-xs text-gray-500 mb-1">èª°å€Ÿçµ¦èª°ï¼Ÿ</div><div class="flex gap-2"><div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µæ¬Šäºº</label><select id="iou-creditor" class="w-full bg-white border rounded p-1 text-sm"></select></div><div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µå‹™äºº</label><select id="iou-debtor" class="w-full bg-white border rounded p-1 text-sm"></select></div></div><div class="flex items-center gap-2 bg-gray-50 border rounded p-2"><span class="font-bold text-sm">TWD</span><input type="number" id="iou-amount" placeholder="é‡‘é¡" class="flex-1 text-lg text-right w-full bg-transparent" inputmode="numeric"></div><input type="text" id="iou-note" placeholder="å‚™è¨»" class="w-full p-2 border rounded text-sm"><div class="flex gap-2 mt-3"><button onclick="deleteIOU()" id="btn-delete-iou" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden">åˆªé™¤</button><button onclick="saveIOU()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div></div><h4 class="text-sm font-bold text-gray-600 mb-2">åˆ—è¡¨:</h4><div id="iou-list-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner"></div></div></div>
    <div id="member-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg"><h4 class="font-bold mb-3 text-center">ç®¡ç†æˆå“¡èˆ‡é ­åƒ</h4><div id="member-list" class="space-y-2 mb-3 max-h-60 overflow-y-auto"></div><div class="flex gap-2"><input type="text" id="new-payer-name" placeholder="æ–°æˆå“¡åç¨±" class="flex-1 border p-1 text-sm rounded"><button onclick="addPayer()" class="bg-matcha text-white px-3 rounded text-sm">æ–°å¢</button></div><button onclick="closeModal('member-modal')" class="w-full mt-3 bg-gray-200 py-1 rounded text-sm">é—œé–‰</button></div></div>
    <div id="lightbox-modal" class="modal hidden fixed inset-0 bg-black/90 z-[100] flex flex-col items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300" onclick="if(event.target === this) closeModal('lightbox-modal')">
        
        <button onclick="closeModal('lightbox-modal')" class="absolute top-6 right-6 text-white/80 z-50 bg-white/10 rounded-full w-12 h-12 flex items-center justify-center hover:bg-white/20 transition backdrop-blur-md">
            <i class="fa-solid fa-times text-xl"></i>
        </button>
        
        <div id="lightbox-container" class="zoom-container w-full h-full flex items-center justify-center overflow-hidden" onclick="if(event.target === this) closeModal('lightbox-modal')">
            <img id="lightbox-image" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded transition-transform duration-300" onclick="event.stopPropagation(); toggleZoom(this)">
        </div>
    </div>
    <!-- NAV BAR -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#f9f7f2]/95 border-t border-gray-200 pt-2 pb-safe px-6 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] backdrop-blur-sm" style="padding-bottom: calc(10px + var(--sab));">
        <div class="flex justify-between items-center w-full mx-auto pb-1 max-w-lg">
            <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center text-gray-400 transition flex-1" data-target="plan"><i class="fa-solid fa-map text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è¡Œç¨‹</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="guide"><i class="fa-solid fa-book-open text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">å°è¦½</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="wallet"><i class="fa-solid fa-wallet text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è¨˜å¸³</span></button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="lists"><i class="fa-solid fa-list-check text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">æ¸…å–®</span></button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="info"><i class="fa-solid fa-circle-info text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è³‡è¨Š</span></button>
        </div>
    </nav>

    <script>
        // --- DATA & CONFIG ---
        const PRELOADED_GUIDES = [
            {id: 101, title: "è¼•äº•æ¾¤ç‹å­ Outlet", price: "å…è²»", desc: "å¿…é€›ï¼è»Šç«™å—å£ç›´é”ã€‚\næ¨è–¦å“ç‰Œï¼šBEAMS, Nike, Gucci, Le Creusetã€‚", photo: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Karuizawa_Prince_Shopping_Plaza_East.JPG/1200px-Karuizawa_Prince_Shopping_Plaza_East.JPG", time: "10:00 - 19:00"},
            {id: 102, title: "çŸ³ä¹‹æ•™å ‚", price: "å…è²»", desc: "å…§æ‘é‘‘ä¸‰ç´€å¿µå ‚ã€‚å»ºç¯‰èˆ‡è‡ªç„¶èåˆã€‚\næ³¨æ„ï¼šå©šç¦®é€²è¡Œæ™‚ç„¡æ³•åƒè§€ã€‚", photo: "https://www.stonechurch.jp/images/top/main_01_sp.jpg", time: "09:00 - 18:00"},
            {id: 103, title: "æ·ºè‰é›·é–€", price: "å…è²»", desc: "æ±äº¬æœ€è‘—ååœ°æ¨™ã€‚ä»²è¦‹ä¸–é€šåƒäººå½¢ç‡’ã€ç‚¸è‚‰é¤…ã€‚", photo: "https://live.staticflickr.com/65535/51866385172_9780a42e5d_b.jpg", time: "å…¨å¤©"},
            {id: 104, title: "æ±äº¬éµå¡”", price: "Â¥1200~", desc: "ç´…è‰²ç¶“å…¸ã€‚æ¨è–¦é ç´„ Top Deck Tourã€‚", photo: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/Tokyo_Tower_special_light_up_2020.jpg/800px-Tokyo_Tower_special_light_up_2020.jpg", time: "09:00 - 23:00"}
        ];

        const WEATHER_MAP = {'sunny': 'ğŸŒ','partly-cloudy': 'â›…','cloudy': 'â˜','rain': 'â˜‚','heavy-rain': 'â›ˆï¸','snow': 'â›„','fog': 'ğŸŒ«ï¸','windy': 'ğŸƒ'};
        const expenseCategories = [{ id: 'é¤é£²', icon: 'fa-utensils', color: 'bg-yellow-100 text-yellow-600' }, { id: 'äº¤é€š', icon: 'fa-train-subway', color: 'bg-blue-100 text-blue-600' }, { id: 'è³¼ç‰©', icon: 'fa-bag-shopping', color: 'bg-pink-100 text-pink-600' }, { id: 'é–€ç¥¨', icon: 'fa-ticket', color: 'bg-green-100 text-green-600' }, { id: 'ä½å®¿', icon: 'fa-bed', color: 'bg-purple-100 text-purple-600' }, { id: 'å…¶ä»–', icon: 'fa-asterisk', color: 'bg-gray-100 text-gray-600' }];
        const RECOVERED_PAYERS = ["æˆ‘", "æ—…ä¼´", "å…¬è²»"];
        const DEFAULT_TODOS = ["è¡£æœ", "è¤²å­", "å…§è¡£/è¤²", "è¥ªå­", "(æ¯›)å¸½å­", "å¤–å¥—", "å¢¨é¡", "(æ‹–)é‹", "æ¯›å·¾(?)", "å£ç½©", "åŒ–å¦å“", "ä¿é¤Šå“", "é›¨å‚˜", "ç’°ä¿è¢‹", "è—¥å“", "è¡›ç”Ÿæ£‰", "è€³å¡", "Uå‹æ•", "é¤ç›’", "å……é›»å™¨", "è¡Œå‹•é›»æº", "Gopro", "è‡ªæ‹æ£’", "è¡Œæç§¤", "é˜²æ›¬ä¹³", "é…’ç²¾", "æ—¥å¹£", "éŒ¢åŒ…", "è­·ç…§"];
        
        const PHRASES = {
            'food': [{ ja: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãã ã•ã„', p: 'Menu wo kudasai', zh: 'è«‹çµ¦æˆ‘èœå–®' },{ ja: 'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', p: 'Kore wo onegaishimasu', zh: 'æˆ‘è¦é€™å€‹' },{ ja: 'ãŠæ°´ãã ã•ã„', p: 'Omizu kudasai', zh: 'è«‹çµ¦æˆ‘æ°´' },{ ja: 'ãŠä¼šè¨ˆãŠé¡˜ã„ã—ã¾ã™', p: 'Okaikei onegaishimasu', zh: 'æˆ‘è¦çµå¸³' },{ ja: 'ç¾å‘³ã—ã„ã§ã™', p: 'Oishii desu', zh: 'å¾ˆå¥½åƒ' },{ ja: 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã§', p: 'Teikuauto de', zh: 'æˆ‘è¦å¤–å¸¶' }],
            'shopping': [{ ja: 'è©¦ç€ã—ã¦ã‚‚ã„ã„ã§ã™ã‹', p: 'Shichaku shitemo ii desu ka', zh: 'å¯ä»¥è©¦ç©¿å—ï¼Ÿ' },{ ja: 'ã“ã‚Œã®å¤§ãã„ã‚µã‚¤ã‚ºã¯ã‚ã‚Šã¾ã™ã‹', p: 'Kore no ookii saizu wa arimasu ka', zh: 'æœ‰å¤§ä¸€é»çš„å°ºå¯¸å—ï¼Ÿ' },{ ja: 'ã„ãã‚‰ã§ã™ã‹', p: 'Ikura desu ka', zh: 'å¤šå°‘éŒ¢ï¼Ÿ' },{ ja: 'å…ç¨ã§ãã¾ã™ã‹', p: 'Menzei dekimasu ka', zh: 'å¯ä»¥é€€ç¨…å—ï¼Ÿ' },{ ja: 'è¢‹ã¯ã„ã‚Šã¾ã›ã‚“', p: 'Fukuro wa irimasen', zh: 'ä¸ç”¨è¢‹å­' }],
            'stay': [{ ja: 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãŠé¡˜ã„ã—ã¾ã™', p: 'Chekkuin onegaishimasu', zh: 'æˆ‘è¦è¾¦ç†å…¥ä½' },{ ja: 'è·ç‰©ã‚’é ã‹ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹', p: 'Nimotsu wo azukatte moraemasu ka', zh: 'å¯ä»¥å¯„æ”¾è¡Œæå—ï¼Ÿ' },{ ja: 'Wi-Fiã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½•ã§ã™ã‹', p: 'Wi-Fi no pasuwÄdo wa nan desu ka', zh: 'Wi-Fiå¯†ç¢¼æ˜¯å¤šå°‘ï¼Ÿ' }],
            'transport': [{ ja: 'é§…ã¯ã©ã“ã§ã™ã‹', p: 'Eki wa doko desu ka', zh: 'è»Šç«™åœ¨å“ªè£¡ï¼Ÿ' },{ ja: 'æ–°å®¿ã¾ã§è¡ŒããŸã„ã§ã™', p: 'Shinjuku made ikitai desu', zh: 'æˆ‘æƒ³å»æ–°å®¿' },{ ja: 'ã“ã®é›»è»Šã¯æ¸‹è°·ã«è¡Œãã¾ã™ã‹', p: 'Kono densha wa Shibuya ni ikimasu ka', zh: 'é€™ç­è»Šå»æ¾€è°·å—ï¼Ÿ' },{ ja: 'åˆ‡ç¬¦å£²ã‚Šå ´ã¯ã©ã“ã§ã™ã‹', p: 'Kippu uriba wa doko desu ka', zh: 'å”®ç¥¨è™•åœ¨å“ªè£¡ï¼Ÿ' }],
            'vege': [{ ja: 'ç§ã¯ãƒ™ã‚¸ã‚¿ãƒªã‚¢ãƒ³ã§ã™', p: 'Watashi wa bejitarian desu', zh: 'æˆ‘æ˜¯ç´ é£Ÿè€…' },{ ja: 'è‚‰ã¨é­šã¯é£Ÿã¹ã‚‰ã‚Œã¾ã›ã‚“', p: 'Niku to sakana wa taberaremasen', zh: 'æˆ‘ä¸åƒè‚‰å’Œé­š' },{ ja: 'å‡ºæ±ã«é­šã¯ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã‹', p: 'Dashi ni sakana wa tsukawarete imasu ka', zh: 'é«˜æ¹¯è£¡æœ‰é­šå—ï¼Ÿ' },{ ja: 'åµã¨ä¹³è£½å“ã¯å¤§ä¸ˆå¤«ã§ã™', p: 'Tamago to nyuseihin wa daijoubu desu', zh: 'è›‹å’Œå¥¶è£½å“å¯ä»¥åƒ' },{ ja: 'è‚‰ãŒå…¥ã£ã¦ã„ãªã„æ–™ç†ã¯ã‚ã‚Šã¾ã™ã‹', p: 'Niku ga haitte inai ryouri wa arimasu ka', zh: 'æœ‰ä¸å«è‚‰çš„æ–™ç†å—ï¼Ÿ' }]
        };

        let flights=[], itinerary=[], mustEatList=[], expenses=[], guides=[], shoppingList=[], payers=[], payerProfiles={}, manualDebts=[], memoText="", todos=[], shoppingOwners=["æˆ‘çš„æ¸…å–®"];
        let vjwData={isOpen:true,items:[]}, publicFundConfig={total:0,currency:'JPY'};
        let currentShopOwnerIdx=0, inlineCategoryChart=null, inlineMemberChart=null, settlementChart=null, memberDetailChart=null, gistId="", gistToken="";
        let tempThemes=[], currentPhotoBase64=null, currentGuidePhoto=null, currentShopPhoto=null, currentTransPhoto=null, tempDayPhotos=[], selectedPayers=[], selectedCat='é¤é£²';
        let tempTrans = []; let currentFlightPhoto = null; let currentAccDayId = null; 
        let currentTransPhotos = [];

// --- 2. æ ¸å¿ƒåŠŸèƒ½ (CORE FUNCTIONS) ---
    function getDataCount(dataObj) {
        if (!dataObj) {
            return flights.length + itinerary.length + mustEatList.length + 
                   expenses.length + shoppingList.length + guides.length;
        }
        return (dataObj.flights?.length || 0) + 
               (dataObj.itinerary?.length || 0) + 
               (dataObj.mustEatList?.length || 0) + 
               (dataObj.expenses?.length || 0) + 
               (dataObj.shoppingList?.length || 0) + 
               (dataObj.guides?.length || 0);
    }

    function applyCloudData(c) {
        localStorage.setItem('flights',JSON.stringify(c.flights||[]));
        localStorage.setItem('itinerary_v3',JSON.stringify(c.itinerary||[]));
        localStorage.setItem('mustEatList',JSON.stringify(c.mustEatList||[]));
        localStorage.setItem('expenses',JSON.stringify(c.expenses||[]));
        localStorage.setItem('guides',JSON.stringify(c.guides||[]));
        localStorage.setItem('shoppingList_v3',JSON.stringify(c.shoppingList||[]));
        localStorage.setItem('publicFundConfig_v2',JSON.stringify(c.publicFundConfig||{total:0}));
        localStorage.setItem('memo',c.memo||"");
        localStorage.setItem('vjwData', JSON.stringify(c.vjwData || { isOpen: true, items: [] }));
        
        // âœ¨ ä¿®æ”¹è™•ï¼šä¸‹è¼‰æˆåŠŸå¾Œï¼ŒæŠŠé›²ç«¯çš„æ™‚é–“æˆ³è¨˜ä¹Ÿå­˜å…¥æœ¬åœ°ï¼Œé¿å…é‡è¤‡è·³å‡ºæç¤º
        const cloudTime = c.lastUpdate ? c.lastUpdate : new Date().toISOString();
        localStorage.setItem('lastUpdate', cloudTime);

        updateCloudStatus("åŒæ­¥å®Œæˆ"); 
        window.refreshUI(); 
        // ç§»é™¤ alert æ”¹ç”¨ consoleï¼Œé«”é©—è¼ƒå¥½
        console.log("âœ… åŒæ­¥å®Œæˆ");
    }

    function reloadLocalData() {
        flights = JSON.parse(localStorage.getItem('flights')) || [];
        itinerary = JSON.parse(localStorage.getItem('itinerary_v3')) || [];
        mustEatList = JSON.parse(localStorage.getItem('mustEatList')) || [];
        expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        guides = JSON.parse(localStorage.getItem('guides')) || [];
        if (guides.length === 0) guides = [...PRELOADED_GUIDES];
        shoppingList = JSON.parse(localStorage.getItem('shoppingList_v3')) || [];
        shoppingOwners = JSON.parse(localStorage.getItem('shoppingOwners')) || ["æˆ‘çš„æ¸…å–®"];
        payers = JSON.parse(localStorage.getItem('payers')) || RECOVERED_PAYERS;
        if(!payers.includes("å…¬è²»")) payers.push("å…¬è²»");
        payerProfiles = JSON.parse(localStorage.getItem('payerProfiles')) || {};
        manualDebts = JSON.parse(localStorage.getItem('manualDebts_v1')) || [];
        const savedTodos = JSON.parse(localStorage.getItem('todos'));
        todos = (savedTodos && savedTodos.length > 0) ? savedTodos : DEFAULT_TODOS.map(text => ({text, done: false}));
        memoText = localStorage.getItem('memo') || "";
        publicFundConfig = JSON.parse(localStorage.getItem('publicFundConfig_v2')) || { total: 0, currency: 'JPY' };
        vjwData = JSON.parse(localStorage.getItem('vjwData')) || { isOpen: true, items: [] };
        gistId = localStorage.getItem('gist_id') || ""; gistToken = localStorage.getItem('gist_token') || "";
        mustEatList.forEach(m => { if(!m.themes) m.themes = []; });
        expenses.forEach(e => {
            if (!e.splitBy) {
                e.splitBy = (e.payer || "").split(',').filter(x=>x);
                e.paidBy = e.splitBy[0] || "æˆ‘"; 
            }
        });
    }

    function saveData() {
        try {
            // âœ¨ ä¿®æ”¹è™•ï¼šæ¯æ¬¡å­˜æª”æ™‚ï¼Œç”¢ç”Ÿä¸€å€‹æœ€æ–°çš„æ™‚é–“æˆ³è¨˜
            const now = new Date();
            
            localStorage.setItem('flights', JSON.stringify(flights));
            localStorage.setItem('itinerary_v3', JSON.stringify(itinerary));
            localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('guides', JSON.stringify(guides));
            localStorage.setItem('shoppingList_v3', JSON.stringify(shoppingList));
            localStorage.setItem('shoppingOwners', JSON.stringify(shoppingOwners));
            localStorage.setItem('payers', JSON.stringify(payers));
            localStorage.setItem('payerProfiles', JSON.stringify(payerProfiles));
            localStorage.setItem('manualDebts_v1', JSON.stringify(manualDebts));
            localStorage.setItem('todos', JSON.stringify(todos));
            localStorage.setItem('memo', memoText); 
            localStorage.setItem('publicFundConfig_v2', JSON.stringify(publicFundConfig));
            localStorage.setItem('vjwData', JSON.stringify(vjwData));
            
            // âœ¨ ä¿®æ”¹è™•ï¼šå°‡é€™å€‹æ™‚é–“å¯«å…¥ LocalStorage
            localStorage.setItem('lastUpdate', now.toISOString());

            if (gistId && gistToken) { 
                clearTimeout(window.autoUploadTimer); 
                window.autoUploadTimer = setTimeout(() => forceUpload(false), 2000); 
            }
        } catch (e) {
            alert("å„²å­˜å¤±æ•—ï¼šè³‡æ–™é‡å¯èƒ½å·²è¶…éç€è¦½å™¨é™åˆ¶ã€‚");
            console.error(e);
        }
    }

    // --- GIST SYNC ---
function forceDownload(isAuto = false) {
            if(!gistId) return updateCloudStatus("æœªé€£ç·š");
            if(!isAuto) updateCloudStatus("æª¢æŸ¥ä¸­...");
            
            // åŠ å…¥ timestamp é˜²æ­¢å¿«å–
            fetch(`https://api.github.com/gists/${gistId}?t=${Date.now()}`, {
                headers: {
                    'Authorization': `token ${gistToken}`
                }
            })
            .then(r => r.json())
            .then(async d => {
                let content = d.files["travel_data.json"].content;
                if(d.files["travel_data.json"].truncated) { 
                    const r = await fetch(d.files["travel_data.json"].raw_url + '?t=' + Date.now()); 
                    content = await r.text(); 
                }
                const cloudData = JSON.parse(content);
                
                const cloudTime = new Date(cloudData.lastUpdate || 0).getTime();
                const localLastUpdate = localStorage.getItem('lastUpdate');
                const localTime = localLastUpdate ? new Date(localLastUpdate).getTime() : 0;

                console.log(`é›²ç«¯: ${cloudTime} vs æœ¬æ©Ÿ: ${localTime}`);

                if (cloudTime > localTime) {
                    console.log("è‡ªå‹•åŒæ­¥ï¼šä¸‹è¼‰é›²ç«¯è³‡æ–™");
                    applyCloudData(cloudData); 
                } 
                // æƒ…æ³ 2: æœ¬æ©Ÿæ¯”è¼ƒæ–° -> ç›´æ¥ä¸Šå‚³
                else if (localTime > cloudTime) {
                    console.log("è‡ªå‹•åŒæ­¥ï¼šä¸Šå‚³æœ¬æ©Ÿè³‡æ–™");
                    // é€™è£¡è¨­ç‚º true ä»£è¡¨å¼·åˆ¶ä¸Šå‚³ï¼Œä¸è·³è©¢å•
                    forceUpload(true); 
                } 
                // æƒ…æ³ 3: ä¸€æ¨£æ–°
                else {
                    updateCloudStatus("å·²åŒæ­¥");
                }
            }).catch(e => {
                console.error(e);
                updateCloudStatus("é€£ç·šå¤±æ•—");
            });
        }

    async function forceUpload(isManual = false) {
        if(!gistId) return;
        updateCloudStatus("ä¸Šå‚³ä¸­...");
        
        const payload = { 
            flights, itinerary, mustEatList, expenses, guides, shoppingList, payers, 
            publicFundConfig, memo: memoText, vjwData, 
            lastUpdate: new Date().toISOString() 
        };
        
        try { 
            await fetch(`https://api.github.com/gists/${gistId}`, { 
                method: 'PATCH', 
                headers: { 'Authorization': `token ${gistToken}`, 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ files: { "travel_data.json": { content: JSON.stringify(payload) } } }) 
            }); 
            updateCloudStatus("ä¸Šå‚³æˆåŠŸ"); 
            
            // âŒ åˆªé™¤é€™ä¸€è¡Œï¼Œå°±ä¸æœƒå†è·³è¦–çª—äº†ï¼
            // if(isManual) alert("âœ… ä¸Šå‚³æˆåŠŸï¼"); 
            
            // ğŸ’¡ (é¸ç”¨) å¦‚æœä½ æƒ³åœ¨å¾Œå°çŸ¥é“æœ‰æ²’æœ‰æˆåŠŸï¼Œå¯ä»¥æ”¹æˆé€™æ¨£ï¼š
            if(isManual) console.log("âœ… ä¸Šå‚³æˆåŠŸï¼"); 

        } catch(e){ 
            console.error(e); 
            updateCloudStatus("ä¸Šå‚³å¤±æ•—"); 
            // å¤±æ•—çš„æ™‚å€™å»ºè­°é‚„æ˜¯ç•™è‘—è¦–çª—ï¼Œä¸ç„¶ä½ æœƒä¸çŸ¥é“æ²’å­˜åˆ°
            if(isManual) alert("âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚");
        }
    }
    function updateCloudStatus(msg) { 
        document.getElementById('cloud-status').innerHTML = `<i class="fa-solid fa-code-branch"></i> <span>${msg}</span>`; 
    }

    function saveGistConfig() { 
        gistId = document.getElementById('gist-id-input').value.trim();
        gistToken = document.getElementById('gist-token-input').value.trim();
        
        localStorage.setItem('gist_id', gistId);
        localStorage.setItem('gist_token', gistToken);
        alert("è¨­å®šå·²å„²å­˜ï¼å³å°‡å˜—è©¦é€£ç·š...");
        forceDownload();
    }

        window.refreshUI = function() { reloadLocalData(); renderFlights(); renderItinerary(); renderGuides(); renderExpenses(); renderMustEatList(); renderChecklist(); renderShoppingList(); document.getElementById('memo-pad').value = memoText; renderVJW(); if(gistId){document.getElementById('gist-id-input').value=gistId;document.getElementById('gist-token-input').value=gistToken;} }

        // --- UI UTILS ---
        function openModal(id){ history.pushState({modal: id}, null, ""); document.getElementById(id).classList.remove('hidden'); setTimeout(()=>document.getElementById(id).classList.add('visible'),10); }
        function closeModal(id){ if(history.state && history.state.modal === id) { history.back(); } else { const el=document.getElementById(id); if(el){ el.classList.remove('visible'); setTimeout(()=>el.classList.add('hidden'),200); } } }
        window.onpopstate = function(event) { const activeModalId = event.state ? event.state.modal : null; document.querySelectorAll('.modal.visible').forEach(el => { if (el.id !== activeModalId) { el.classList.remove('visible'); setTimeout(() => el.classList.add('hidden'), 200); } }); };
        function switchTab(t){ document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); document.getElementById('view-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); document.querySelector(`[data-target="${t}"]`).classList.add('active'); if (t !== 'guide') { const backBtn = document.getElementById('btn-back-to-plan'); if(backBtn && !backBtn.classList.contains('hidden')) { backBtn.classList.add('hidden'); } } if (t === 'plan') { const el = document.getElementById('quick-nav-container'); if (window.scrollY < 100 && el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } } else { window.scrollTo(0,0); } }
        
        async function uploadImageToGitHub(base64Content) {
            const username = 'kaiwen926'; const repo = 'tokyo.com'; const folder = 'images'; const token = localStorage.getItem('gist_token'); 
            if (!token) { alert("è«‹å…ˆåœ¨ã€Œè³‡è¨Š > é›²ç«¯åŒæ­¥è¨­å®šã€å¡«å¯« Tokenï¼Œæ‰èƒ½ä¸Šå‚³ç…§ç‰‡ï¼"); return null; }
            updateCloudStatus("åœ–ç‰‡ä¸Šå‚³ä¸­..."); 
            const timestamp = new Date().getTime(); const fileName = `${folder}/img_${timestamp}.jpg`; const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${fileName}`;
            try {
                const response = await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `Upload from App ${new Date().toLocaleDateString()}`, content: base64Content }) });
                if (!response.ok) throw new Error('GitHub API Error');
                const data = await response.json(); updateCloudStatus("ä¸Šå‚³æˆåŠŸ"); return data.content.download_url;
            } catch (error) { console.error(error); alert("ä¸Šå‚³å¤±æ•—ï¼è«‹æª¢æŸ¥ Tokenã€‚"); updateCloudStatus("ä¸Šå‚³å¤±æ•—"); return null; }
        }

        function processImage(input, cb) { 
            if(input.files && input.files.length > 0){ 
                const file = input.files[0];
                const r=new FileReader(); 
                r.onload=e=>{ 
                    const i=new Image(); 
                    i.onload=()=>{ 
                        const c=document.createElement('canvas'); 
                        const x=c.getContext('2d'); 
                        const max=1200; 
                        let w=i.width,h=i.height; 
                        if(w>h&&w>max){h*=max/w;w=max}else if(h>max){w*=max/h;h=max} 
                        c.width=w;c.height=h; 
                        x.drawImage(i,0,0,w,h); 
                        const fullBase64 = c.toDataURL('image/jpeg',0.8); 
                        const cleanBase64 = fullBase64.split(',')[1]; 
                        uploadImageToGitHub(cleanBase64).then(imageUrl => { if (imageUrl) { cb(imageUrl); } }); 
                    }; 
                    i.src=e.target.result 
                }; 
                r.readAsDataURL(file) 
            } 
        }

        function viewPhoto(src) { document.getElementById('lightbox-image').src = src; openModal('lightbox-modal'); }
        function toggleZoom(img) { if(img.classList.contains('zoomed')){img.classList.remove('zoomed');}else{img.classList.add('zoomed');} }
        function addTransPhotos(input, index) { if (!input.files || input.files.length === 0) return; if (!tempTrans[index].photos) tempTrans[index].photos = []; Array.from(input.files).forEach(file => { processImage({ files: [file] }, (base64) => { tempTrans[index].photos.push(base64); renderTransRows(); }); }); input.value = ''; }
        function openTransPhotosModal(dayId, transIdx) { const day = itinerary.find(d => d.id === dayId); if (!day || !day.transportation || !day.transportation[transIdx]) return; const trans = day.transportation[transIdx]; const photos = trans.photos || (trans.photo ? [trans.photo] : []); if (photos.length === 0) return alert("æ²’æœ‰ç…§ç‰‡"); const container = document.getElementById('trans-photos-grid'); container.innerHTML = photos.map(p => `<div class="relative group aspect-[4/3] rounded-lg overflow-hidden shadow-sm border border-gray-200 cursor-zoom-in" onclick="viewPhoto('${p}')"><img src="${p}" class="w-full h-full object-cover hover:scale-105 transition duration-500"></div>`).join(''); openModal('trans-photos-modal'); }

        // --- FUNCTIONS ---
        function openAccModal(dayId) { currentAccDayId = dayId; const day = itinerary.find(d => d.id === dayId); if (!day) return; document.getElementById('acc-modal-title').innerText = day.accommodation || day.date; renderAccPhotos(); openModal('acc-modal'); }
        function renderAccPhotos() { const day = itinerary.find(d => d.id === currentAccDayId); if (!day) return; const photos = day.accPhotos || []; const container = document.getElementById('acc-photos-grid'); if (photos.length === 0) { container.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-8 text-sm">é‚„æ²’æœ‰ç…§ç‰‡<br>é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</div>'; } else { container.innerHTML = photos.map((p, i) => `<div class="relative group aspect-[4/3] rounded-lg overflow-hidden shadow-sm border border-gray-200"><img src="${p}" class="w-full h-full object-cover cursor-pointer hover:scale-105 transition duration-500" onclick="viewPhoto('${p}')"><button onclick="deleteAccPhoto(${i})" class="absolute top-1 right-1 bg-red-500/80 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs shadow hover:bg-red-600 transition z-10"><i class="fa-solid fa-times"></i></button></div>`).join(''); } }
        function addAccPhoto(input) { processImage(input, (base64) => { const dayIdx = itinerary.findIndex(d => d.id === currentAccDayId); if (dayIdx > -1) { if (!itinerary[dayIdx].accPhotos) itinerary[dayIdx].accPhotos = []; itinerary[dayIdx].accPhotos.push(base64); saveData(); renderAccPhotos(); renderItinerary(); } }); input.value = ''; }
        function deleteAccPhoto(index) { if (confirm("ç¢ºå®šåˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ")) { const dayIdx = itinerary.findIndex(d => d.id === currentAccDayId); if (dayIdx > -1 && itinerary[dayIdx].accPhotos) { itinerary[dayIdx].accPhotos.splice(index, 1); saveData(); renderAccPhotos(); renderItinerary(); } } }
        function toggleVoiceInput() { if (!('webkitSpeechRecognition' in window)) return alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³"); const recognition = new webkitSpeechRecognition(); recognition.lang = 'auto'; const btn = document.getElementById('btn-mic'); const icon = btn.querySelector('i'); recognition.onstart = () => { btn.classList.add('bg-red-500', 'text-white', 'animate-pulse'); icon.className = 'fa-solid fa-microphone-lines'; document.getElementById('trans-input').placeholder = "æ­£åœ¨è†è½..."; }; recognition.onend = () => { btn.classList.remove('bg-red-500', 'text-white', 'animate-pulse'); icon.className = 'fa-solid fa-microphone'; document.getElementById('trans-input').placeholder = "è¼¸å…¥æ–‡å­—..."; }; recognition.onresult = (e) => { const text = e.results[0][0].transcript; document.getElementById('trans-input').value = text; openGoogleTranslate(text); }; recognition.start(); }
        function openGoogleTranslate(text = null) { const txt = text || document.getElementById('trans-input').value; if(!txt) return alert("æ²’æœ‰æ–‡å­—"); window.open(`https://translate.google.com/?sl=auto&tl=ja&text=${encodeURIComponent(txt)}&op=translate`, '_blank'); }
        function renderPhrases(cat) { document.querySelectorAll('.phrase-btn').forEach(btn => { if(btn.dataset.cat === cat) btn.classList.add('active'); else btn.classList.remove('active'); }); const list = PHRASES[cat] || []; const container = document.getElementById('phrase-container'); container.innerHTML = list.map(item => `<div class="bg-gray-50 p-3 rounded-xl border border-gray-100 mb-2 hover:shadow-sm transition relative"><div class="flex justify-between items-start gap-2"><div class="flex-1"><div class="font-bold text-gray-800 text-base mb-1">${item.ja}</div><div class="text-[10px] text-gray-400 font-serif italic mb-1">${item.p}</div><div class="text-xs text-fuji font-bold">${item.zh}</div></div><button onclick="speak('${item.ja}')" class="shrink-0 w-8 h-8 rounded-full bg-white border border-fuji/30 text-fuji flex items-center justify-center shadow-sm active:scale-95 transition hover:bg-fuji hover:text-white"><i class="fa-solid fa-volume-high"></i></button></div></div>`).join(''); }
        function speak(text) { if (!window.speechSynthesis) return alert("ä¸æ”¯æ´ç™¼éŸ³"); window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; u.rate = 0.8; window.speechSynthesis.speak(u); }
        function searchDayWeather() { const rawLoc = document.getElementById('day-accommodation-edit').value; let loc = (typeof cleanLocationName === 'function') ? cleanLocationName(rawLoc) : rawLoc; if(!loc) loc = "æ±äº¬"; window.open(`https://tenki.jp/search/?keyword=${encodeURIComponent(loc)}`, '_blank'); }

        function renderTransRows(){
            const icons={'fa-train-subway':'éµè·¯','fa-bus':'å·´å£«','fa-plane':'é£›æ©Ÿ','fa-taxi':'è¨ˆç¨‹è»Š','fa-ship':'èˆ¹','fa-person-walking':'æ­¥è¡Œ','fa-bicycle':'è…³è¸è»Š'};
            document.getElementById('day-trans-list').innerHTML=tempTrans.map((t,i)=>{
                const opts=Object.entries(icons).map(([k,v])=>`<option value="${k}" ${t.icon===k?'selected':''}>${v}</option>`).join('');
                const photos = t.photos || [];
                const hasPhoto = photos.length > 0;
                const lbl= hasPhoto ?`<input type="text" placeholder="æ†‘è­‰å" value="${t.photoLabel||''}" onchange="tempTrans[${i}].photoLabel=this.value" class="w-24 p-1 border rounded text-xs mx-1 outline-none text-fuji font-bold">`:'';
                const thumbnailsHtml = photos.map((p, pIdx) => `<div class="relative w-12 h-12 flex-shrink-0 border rounded-lg overflow-hidden group/thumb bg-gray-100"><img src="${p}" class="w-full h-full object-cover cursor-zoom-in" onclick="viewPhoto('${p}')"><button onclick="tempTrans[${i}].photos.splice(${pIdx},1);renderTransRows()" class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 text-[10px] flex items-center justify-center opacity-80 hover:opacity-100 transition rounded-bl-lg"><i class="fa-solid fa-times"></i></button></div>`).join('');
                return `<div class="bg-white p-2 rounded border border-gray-200 relative group mb-2 shadow-sm"><button onclick="tempTrans.splice(${i},1);renderTransRows()" class="absolute top-1 right-1 text-gray-300 hover:text-red-400 w-5 h-5 rounded-full bg-gray-50 flex items-center justify-center"><i class="fa-solid fa-times"></i></button><div class="flex gap-1 mb-1 items-center"><div class="relative w-20"><i class="fa-solid ${t.icon||'fa-train-subway'} absolute left-1 top-1.5 text-gray-400 text-xs pointer-events-none"></i><select onchange="tempTrans[${i}].icon=this.value;renderTransRows()" class="w-full pl-5 p-1 border rounded text-xs bg-gray-50 outline-none">${opts}</select></div><input type="time" class="w-16 p-1 border rounded text-xs bg-gray-50 text-center outline-none" value="${t.time||''}" onchange="tempTrans[${i}].time=this.value"><input type="text" placeholder="è¡Œç¨‹" class="flex-1 p-1 border-b text-sm font-bold outline-none" value="${t.content||''}" onchange="tempTrans[${i}].content=this.value"></div><div class="flex gap-1 items-center relative"><input type="text" placeholder="å‚™è¨»" class="flex-1 p-1 border rounded text-xs bg-gray-50 outline-none" value="${t.note||''}" onchange="tempTrans[${i}].note=this.value">${lbl}<label class="cursor-pointer flex items-center gap-1 text-xs text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition whitespace-nowrap font-bold border border-blue-100"><i class="fa-solid fa-camera-retro"></i> ${hasPhoto ? 'åŠ åœ–' : 'æ†‘è­‰'}<input type="file" accept="image/*" multiple class="hidden" onchange="addTransPhotos(this, ${i})"></label></div>${hasPhoto ? `<div class="flex gap-2 mt-2 overflow-x-auto pb-1 pl-1">${thumbnailsHtml}</div>` : ''}</div>`;
            }).join('');
        }
        function addTransRow() { tempTrans.push({ time: '', content: '', note: '', photo: null }); renderTransRows(); }
        function checkUrl(str) { if(!str) return null; if(str.startsWith('http') || str.startsWith('www')) return str; return null; }
        function quickExpense(note, cat) { openExpenseModal(null, true);document.getElementById('ex-note').value = note; selectedCat = cat; renderCategoryUI();}
        function jumpToGuide(title) { switchTab('guide'); const backBtn = document.getElementById('btn-back-to-plan'); if(backBtn) backBtn.classList.remove('hidden'); const g = guides.find(i => i.title === title); if(g) { setTimeout(() => { const el = document.getElementById(`guide-${g.id}`); if (el) { el.scrollIntoView({behavior: "smooth", block: "center"}); el.classList.add('animate-highlight'); setTimeout(() => el.classList.remove('animate-highlight'), 2000); } }, 300); } }
        function goBackToPlan() { switchTab('plan'); document.getElementById('btn-back-to-plan').classList.add('hidden'); }
        function linkifyContent(text) { let html = text.replace(/\n/g, '<br>'); guides.forEach(g => { if (g.title.length > 1) { const regex = new RegExp(`(${g.title})`, 'g'); html = html.replace(regex, `<span class="guide-link" onclick="jumpToGuide('$1')">$1</span>`); } }); return html.split('<br>').map(line => `<li class="flex items-start text-base"><span class="mr-2 mt-2 w-2 h-2 bg-sakura rounded-full flex-shrink-0 border border-red-200"></span><span class="flex-1">${line}</span></li>`).join(''); }
function renderItinerary() {
        const c = document.getElementById('itinerary-container');
        const navC = document.getElementById('quick-nav-container');
        if (!c) return;
        c.innerHTML = '';

        // 1. æ¸²æŸ“ä¸Šæ–¹çš„é›²æœµå°èˆª
        if (navC && itinerary.length > 0) {
            const stickersHtml = itinerary.map((day, idx) => {
                const themes = [ { cloud: 'text-pink-200', text: 'text-pink-600' }, { cloud: 'text-yellow-200', text: 'text-yellow-700' }, { cloud: 'text-blue-200', text: 'text-blue-600' }, { cloud: 'text-green-200', text: 'text-green-600' }, { cloud: 'text-purple-200', text: 'text-purple-600' }, { cloud: 'text-orange-200', text: 'text-orange-700' }, { cloud: 'text-cyan-200', text: 'text-cyan-700' } ];
                const theme = themes[idx % 7];
                return `<button onclick="document.getElementById('${day.id}').scrollIntoView({behavior: 'smooth', block: 'center'})" class="relative w-full aspect-square flex items-center justify-center group hover:-translate-y-1 transition-transform duration-300"><i class="fa-solid fa-cloud text-5xl sm:text-6xl ${theme.cloud} drop-shadow-md group-hover:scale-110 transition-transform duration-300"></i><div class="absolute inset-0 flex flex-col items-center justify-center pt-3 pb-1"><span class="text-[8px] font-bold opacity-60 tracking-wider mb-px font-sans ${theme.text}">DAY</span><span class="text-xl font-black font-maru leading-none ${theme.text}">${idx + 1}</span></div></button>`;
            }).join('');
            navC.innerHTML = `<div class="grid grid-cols-7 gap-1 max-w-md mx-auto px-1">${stickersHtml}</div>`;
        }

        // 2. æ¸²æŸ“æ¯ä¸€å¤©çš„è¡Œç¨‹å¡ç‰‡
        itinerary.forEach((day, idx) => {
            let contentHtml = (typeof linkifyContent === 'function') ? linkifyContent(day.content) : day.content;
            const accLink = day.accommodationUrl || (typeof checkUrl === 'function' ? checkUrl(day.accommodation) : null);
            
            // é…è‰²é‚è¼¯
            const stickerThemes = [ { bg: 'bg-pink-50', border: 'border-pink-200', textMain: 'text-pink-700', textSub: 'text-pink-400' }, { bg: 'bg-yellow-50', border: 'border-yellow-200', textMain: 'text-yellow-800', textSub: 'text-yellow-500' }, { bg: 'bg-blue-50', border: 'border-blue-200', textMain: 'text-blue-700', textSub: 'text-blue-400' }, { bg: 'bg-green-50', border: 'border-green-200', textMain: 'text-green-700', textSub: 'text-green-500' }, { bg: 'bg-purple-50', border: 'border-purple-200', textMain: 'text-purple-700', textSub: 'text-purple-400' }, { bg: 'bg-orange-50', border: 'border-orange-200', textMain: 'text-orange-800', textSub: 'text-orange-500' }, { bg: 'bg-cyan-50', border: 'border-cyan-200', textMain: 'text-cyan-700', textSub: 'text-cyan-500' } ];
            const theme = stickerThemes[idx % 7];
            
            const fullText = day.date || "";
            let dateText = fullText.split(' ')[0];
            let titleText = fullText.substring(dateText.length).trim();
            if (!titleText) titleText = fullText;

            // å¤©æ°£é¡¯ç¤º
            const searchUrl = "https://tenki.jp/forecast/3/16/4410/13106/10days.html";
            const wIcon = (typeof WEATHER_MAP !== 'undefined') ? (WEATHER_MAP[day.weather] || '<i class="fa-solid fa-question text-gray-200"></i>') : '';
            let tempBadgeHtml = '';
            if (day.temp) {
                const tempVal = parseInt(day.temp);
                let tempClass = 'temp-warm';
                if (!isNaN(tempVal)) { if (tempVal >= 28) tempClass = 'temp-hot'; else if (tempVal >= 20) tempClass = 'temp-warm'; else if (tempVal >= 10) tempClass = 'temp-cool'; else tempClass = 'temp-cold'; }
                const displayTemp = day.temp.replace(/c/ig, '').trim();
                tempBadgeHtml = `<span class="temp-badge ${tempClass} px-2 min-w-[3rem] text-center inline-block shadow-sm border border-white/50">${displayTemp}Â°C</span>`;
            }
            const weatherGroupHtml = (day.weather || day.temp) ? `<a href="${searchUrl}" target="_blank" class="weather-group group/weather no-underline mt-1 flex flex-col items-center" title="æœå°‹å¤©æ°£">${tempBadgeHtml}<div class="weather-badge group-hover/weather:scale-110 transition-transform text-lg shadow-md border-2 border-white mt-0.5">${wIcon}</div></a>` : '';

            // æ¯æ—¥ç…§ç‰‡é›†
            const photosHtml = day.photos?.length ? `<div class="mt-3 grid grid-cols-3 gap-1 rounded-lg overflow-hidden">${day.photos.map(p=>`<img src="${p}" class="w-full aspect-square object-cover cursor-pointer hover:opacity-90" onclick="viewPhoto('${p}')">`).join('')}</div>` : '';
            
            // ä½å®¿è³‡è¨Š
            const accHtml = day.accommodation ? `<div class="mt-3 text-sm text-gray-600 border-t pt-3 border-dashed border-gray-200"><div class="flex items-start gap-2"><button onclick="openAccModal('${day.id}')" class="w-8 h-8 rounded-full bg-fuji/10 hover:bg-fuji/20 text-fuji flex items-center justify-center transition shadow-sm active:scale-95 group relative flex-shrink-0" title="ç®¡ç†ä½å®¿ç…§ç‰‡"><i class="fa-solid fa-bed"></i>${day.accPhotos && day.accPhotos.length > 0 ? `<span class="absolute -top-1 -right-1 w-3 h-3 bg-red-400 rounded-full border-2 border-white"></span>` : ''}</button><div class="flex-1 min-w-0 pt-1">${accLink ? `<a href="${accLink}" target="_blank" class="underline decoration-dotted hover:text-fuji font-bold block truncate text-base">${day.accommodation}</a>` : `<span class="font-bold block truncate text-base">${day.accommodation}</span>`}${day.accommodationNote ? `<div class="text-xs text-gray-400 mt-1 font-hand"><i class="fa-solid fa-circle-info mr-1 text-[10px]"></i>${day.accommodationNote}</div>` : ''}</div></div></div>` : '';

            // ä¸‰é¤è³‡è¨Š
            const renderMealItem = (type, icon, color) => { const m = day.meals?.[type]; if(!m || !m.name) return ''; const linkPart = m.link ? `<a href="${m.link}" target="_blank" class="hover:text-fuji underline decoration-dotted ml-1 font-bold">${m.name}</a>` : `<span class="ml-1 font-bold">${m.name}</span>`; const notePart = m.note ? `<span class="text-[10px] text-gray-400 ml-2 border-l pl-2 border-gray-300">${m.note}</span>` : ''; return `<div class="flex items-center gap-1 p-1"><i class="fa-solid ${icon} ${color} cursor-pointer hover:scale-125 transition flex-shrink-0" onclick="quickExpense('${m.name}', 'é¤é£²')" title="é»æ“Šè¨˜å¸³"></i><div class="flex-1 min-w-0 truncate">${linkPart}${notePart}</div></div>`; };
            const mealsHtml = (day.meals && (day.meals.b?.name || day.meals.l?.name || day.meals.d?.name)) ? `<div class="mt-3 flex flex-col gap-2 text-xs text-gray-500 border-t border-dashed border-gray-200 pt-2 px-1">${renderMealItem('b', 'fa-mug-hot', 'text-orange-300')}${renderMealItem('l', 'fa-utensils', 'text-green-400')}${renderMealItem('d', 'fa-wine-glass', 'text-purple-400')}</div>` : '';

            // --- äº¤é€šè³‡è¨Š (é€™è£¡æ˜¯ä¿®æ”¹é‡é») ---
            let transData = Array.isArray(day.transportation) ? day.transportation : (day.transportation ? [day.transportation] : []);
            
            const transHtml = transData.map((t) => {
                // 1. å–å¾—è©²ç­†äº¤é€šçš„æ‰€æœ‰ç…§ç‰‡ (ç›¸å®¹èˆŠè³‡æ–™)
                let allPhotos = t.photos || [];
                if (allPhotos.length === 0 && t.photo) {
                    allPhotos = [t.photo]; 
                }

                // 2. ç”¢ç”Ÿç…§ç‰‡ HTML å­—ä¸²
                const imagesHtml = allPhotos.map(p => {
                    // åˆ¤æ–· p æ˜¯å­—ä¸²(èˆŠ)é‚„æ˜¯ç‰©ä»¶(æ–° {url, name})
                    const src = (typeof p === 'object' && p.url) ? p.url : p;
                    // ç”Ÿæˆåœ–ç‰‡æ¨™ç±¤ï¼Œé»æ“Šç›´æ¥æ”¾å¤§ (viewPhoto)
                    return `<img src="${src}" onclick="viewPhoto('${src}')" class="w-10 h-10 rounded-lg object-cover border border-gray-200 shadow-sm cursor-zoom-in hover:scale-110 transition bg-white" title="é»æ“Šæ”¾å¤§">`;
                }).join('');

                // 3. å›å‚³ HTML
                return `
                <div class="mt-2 bg-gray-50 p-3 rounded-lg border border-gray-100 text-sm group/trans hover:bg-gray-100 transition">
                    <div class="font-bold text-gray-500 flex items-center gap-2 mb-1">
                        <i class="fa-solid ${t.icon || 'fa-train-subway'} text-blue-400 w-5 text-center"></i>
                        ${t.time ? `<span class="text-xs font-normal bg-white px-2 py-0.5 rounded border border-gray-200 text-gray-400 font-mono text-fuji">${t.time}</span>` : ''}
                        <span class="text-gray-700">${t.content || 'äº¤é€šç§»å‹•'}</span>
                    </div>
                    ${t.note ? `<div class="ml-9 text-xs text-gray-400 mt-1 border-l-2 border-gray-200 pl-2 mb-1">${t.note}</div>` : ''}
                    
                    ${imagesHtml ? `<div class="mt-1 ml-9 flex flex-wrap gap-2">${imagesHtml}</div>` : ''}
                </div>`;
            }).join('');
            // --- äº¤é€šè³‡è¨Šä¿®æ”¹çµæŸ ---

            // å‚™è¨»
            const noteHtml = day.dayNote ? `<div class="mt-3 p-2 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-100 handwritten leading-relaxed"><i class="fa-solid fa-pencil mr-1"></i> ${day.dayNote}</div>` : '';
            
            // å¡ç‰‡æ¨£å¼è¨­å®š
            const isHighlight = day.highlight;
            const titleStickerBg = isHighlight ? 'bg-[#fff0f5]' : 'bg-[#fff8e1]';
            const titleStickerBorder = isHighlight ? 'border-sakura' : 'border-[#e6dbbf]';
            const titleStickerText = isHighlight ? 'text-sakura' : 'text-[#827355]';

            // çµ„è£æ•´å¼µå¡ç‰‡
            c.innerHTML += `
            <div id="${day.id}" class="relative pl-12 sm:pl-16 border-l-2 ${isHighlight ? 'border-sakura' : 'border-gray-200'} border-dashed pb-10 group">
                <div class="absolute -left-3 sm:-left-4 top-0 flex flex-col items-center z-10 w-12 sm:w-14">
                    <div onclick="document.getElementById('quick-nav-container').scrollIntoView({behavior: 'smooth', block: 'center'})" class="relative w-full aspect-square ${theme.bg} border-2 ${theme.border} rounded-xl shadow-md cursor-pointer flex flex-col items-center justify-center p-1 hover:border-fuji transition-colors z-20" title="å›åˆ°ä¸Šæ–¹é›²æœµ">
                        <span class="text-[9px] font-black font-sans tracking-widest ${theme.textSub} mb-[-2px]">DAY</span>
                        <span class="text-2xl font-black font-maru leading-none ${theme.textMain}">${idx + 1}</span>
                        <span class="text-[10px] font-bold font-hand ${theme.textMain} opacity-80 mt-[-2px] truncate max-w-full">${dateText}</span>
                    </div>
                    <div class="h-4 w-0.5 bg-gray-300 -mt-1 relative z-10"></div>
                    ${weatherGroupHtml || '<div class="w-8 h-8 rounded-full bg-gray-100 border-2 border-white shadow-sm flex items-center justify-center text-xs text-gray-300 relative z-10"><i class="fa-solid fa-cloud"></i></div>'}
                </div>
                
                <div class="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 relative group/card hover:border-fuji/30 transition-colors">
                    <div class="flex justify-between items-start mb-4">
                        <div class="relative transform -rotate-1 hover:rotate-0 transition-transform duration-300 cursor-pointer" onclick="openDayEditor('${day.id}')">
                            <div class="absolute -top-2.5 left-1/2 -translate-x-1/2 w-8 h-4 bg-white/40 backdrop-blur-[1px] border border-white/20 rounded-sm shadow-sm z-20"></div>
                            <div class="relative ${titleStickerBg} border-2 ${titleStickerBorder} px-4 py-2 rounded-lg shadow-md min-w-[5rem] text-center">
                                <h4 class="text-xl font-black font-maru tracking-widest ${titleStickerText} leading-tight">${titleText}</h4>
                            </div>
                        </div>
                        <button onclick="openDayEditor('${day.id}')" class="text-gray-200 hover:text-fuji transition p-2 hover:bg-gray-50 rounded-full">
                            <i class="fa-solid fa-pen text-sm"></i>
                        </button>
                    </div>
                    
                    <ul class="text-sm space-y-3 leading-relaxed text-gray-700 font-maru font-bold text-lg mb-3">
                        ${contentHtml}
                    </ul>
                    
                    ${photosHtml}
                    ${accHtml}
                    ${transHtml}
                    ${mealsHtml}
                    ${noteHtml}
                </div>
            </div>`;
        });
    }
        
        function openDayEditor(id){ 
            const d=itinerary.find(i=>i.id===id); 
            if(!d)return; 
            document.getElementById('day-id-edit').value=d.id; 
            document.getElementById('day-date-edit').value=d.date; 
            document.getElementById('day-temp-edit').value = d.temp || ""; 
            document.getElementById('day-weather-edit').value=d.weather||""; 
            document.getElementById('day-highlight-edit').checked=d.highlight; 
            document.getElementById('day-content-edit').value=d.content; 
            document.getElementById('day-accommodation-edit').value=d.accommodation; 
            document.getElementById('day-accommodation-url-edit').value=d.accommodationUrl; 
            document.getElementById('day-accommodation-note-edit').value = d.accommodationNote || ''; 
            
            tempTrans = []; 
            if (d.transportation) { 
                let rawTrans = Array.isArray(d.transportation) ? d.transportation : [d.transportation];
                tempTrans = JSON.parse(JSON.stringify(rawTrans));
                tempTrans.forEach(t => {
                    if (!t.photos) t.photos = [];
                    if (t.photo) { t.photos.push(t.photo); delete t.photo; }
                });
            } 
            renderTransRows(); 
            
            document.getElementById('day-note-edit').value=d.dayNote||''; 
            tempDayPhotos = d.photos ? [...d.photos] : []; 
            renderDayPhotosPreview(); 
            ['b','l','d'].forEach(t => { 
                document.getElementById('meal-'+t+'-name').value = d.meals?.[t]?.name || ''; 
                document.getElementById('meal-'+t+'-link').value = d.meals?.[t]?.link || ''; 
                document.getElementById('meal-'+t+'-note').value = d.meals?.[t]?.note || ''; 
            }); 
            openModal('day-modal'); 
        }

        function saveDay(){ const idx=itinerary.findIndex(i=>i.id===document.getElementById('day-id-edit').value); if(idx<0)return; const i=itinerary[idx]; i.date=document.getElementById('day-date-edit').value; i.temp = document.getElementById('day-temp-edit').value; i.weather=document.getElementById('day-weather-edit').value; i.highlight=document.getElementById('day-highlight-edit').checked; i.content=document.getElementById('day-content-edit').value; i.accommodation=document.getElementById('day-accommodation-edit').value; i.accommodationUrl=document.getElementById('day-accommodation-url-edit').value; i.accommodationNote = document.getElementById('day-accommodation-note-edit').value; i.transportation = tempTrans.filter(t => t.content || (t.photos && t.photos.length > 0) || t.note);i.dayNote=document.getElementById('day-note-edit').value; i.photos=[...tempDayPhotos]; i.meals = { b: { name: document.getElementById('meal-b-name').value, link: document.getElementById('meal-b-link').value, note: document.getElementById('meal-b-note').value }, l: { name: document.getElementById('meal-l-name').value, link: document.getElementById('meal-l-link').value, note: document.getElementById('meal-l-note').value }, d: { name: document.getElementById('meal-d-name').value, link: document.getElementById('meal-d-link').value, note: document.getElementById('meal-d-note').value } }; saveData(); renderItinerary(); closeModal('day-modal'); }
        function addNewDay(){itinerary.push({id:'day_'+Date.now(),date:"New Day",highlight:false,content:"...",weather:""}); saveData(); renderItinerary();}
        function deleteDay(){if(confirm("Del?")){itinerary=itinerary.filter(d=>d.id!==document.getElementById('day-id-edit').value); saveData(); renderItinerary(); closeModal('day-modal');}}
        function addDayPhoto(input) { processImage(input, (base64) => { tempDayPhotos.push(base64); renderDayPhotosPreview(); }); }
        function renderDayPhotosPreview() { document.getElementById('day-photos-preview').innerHTML = tempDayPhotos.map((p, i) => `<div class="relative"><img src="${p}" class="w-full h-full rounded"><button onclick="tempDayPhotos.splice(${i},1);renderDayPhotosPreview()" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 text-xs">x</button></div>`).join(''); }

        // --- GUIDE ---
        function renderGuides(){ const l=document.getElementById('guide-list'); l.innerHTML=''; if(window.guideSortable) window.guideSortable.destroy(); guides.forEach(g=>{ l.innerHTML+=`<div id="guide-${g.id}" data-id="${g.id}" class="hand-card p-0 overflow-hidden relative group transition-colors duration-500"><div class="drag-handle absolute top-0 left-0 h-full w-10 bg-black/5 flex items-center justify-center z-20 cursor-grab hover:bg-black/10 transition-colors"><i class="fa-solid fa-grip-vertical text-gray-400"></i></div><button onclick="event.stopPropagation(); openGuideModal(${g.id})" class="absolute top-2 right-2 z-50 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center shadow hover:bg-white"><i class="fa-solid fa-pen text-gray-500"></i></button>${g.photo?`<img src="${g.photo}" class="w-full h-40 object-cover ml-10" style="width:calc(100% - 2.5rem)" onclick="viewPhoto('${g.photo}')">`:''} <div class="p-4 pl-14"><h3 class="font-bold text-lg font-hand text-xl">${g.title}</h3><div class="flex gap-2 mb-2 mt-1">${g.price ? `<span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-0.5 rounded"><i class="fa-solid fa-tag"></i> ${g.price}</span>` : ''}${g.time ? `<span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded"><i class="fa-regular fa-clock"></i> ${g.time}</span>` : ''}</div><p class="text-sm whitespace-pre-line text-gray-600 leading-relaxed">${g.desc}</p></div></div>`; }); window.guideSortable = new Sortable(l, { handle: '.drag-handle', animation: 150, onEnd: function (evt) { const item = guides.splice(evt.oldIndex, 1)[0]; guides.splice(evt.newIndex, 0, item); saveData(); } }); }
        function openGuideModal(id=null) { currentGuidePhoto=null; document.getElementById('guide-photo-preview').classList.add('hidden'); document.getElementById('guide-photo-text').classList.remove('hidden'); if(id){const g=guides.find(i=>i.id==id); document.getElementById('guide-id').value=g.id; document.getElementById('guide-title').value=g.title; document.getElementById('guide-desc').value=g.desc; document.getElementById('guide-price').value=g.price||""; document.getElementById('guide-time').value=g.time||""; if(g.photo){currentGuidePhoto=g.photo; document.getElementById('guide-photo-preview').src=g.photo; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden');}} else { ['guide-id','guide-title','guide-desc','guide-price','guide-time'].forEach(k=>document.getElementById(k).value=''); } openModal('guide-modal'); }
        function saveGuide() { const id=document.getElementById('guide-id').value, t=document.getElementById('guide-title').value; if(!t)return; const newItem = {id:id?parseInt(id):Date.now(), title:t, desc:document.getElementById('guide-desc').value, price:document.getElementById('guide-price').value, time:document.getElementById('guide-time').value, photo:currentGuidePhoto||(id?guides.find(i=>i.id==id).photo:null)}; if(id){const idx=guides.findIndex(i=>i.id==id);if(idx>-1)guides[idx]=newItem;}else{guides.push(newItem);} saveData(); renderGuides(); closeModal('guide-modal'); }

        // --- FLIGHTS ---
        function renderFlights() { document.getElementById('flight-list-container').innerHTML = flights.map(f => { const planeIcon = f.url ? `<a href="${f.url}" target="_blank" class="cursor-pointer hover:scale-110 transition-transform inline-block" title="å‰å¾€å®˜ç¶²"><i class="fa-solid fa-plane text-fuji text-2xl rotate-[-45deg]"></i></a>` : `<i class="fa-solid fa-plane text-fuji text-2xl rotate-[-45deg]"></i>`; const codeDisplay = f.photo ? `<div onclick="viewPhoto('${f.photo}')" class="font-bold text-fuji text-xl handwritten cursor-pointer hover:text-blue-600 border-b-2 border-dashed border-fuji/30 inline-block px-2" title="æŸ¥çœ‹æ©Ÿç¥¨æˆªåœ–">${f.code} <i class="fa-solid fa-image text-[10px] align-top opacity-50"></i></div>` : `<div class="font-bold text-fuji text-xl handwritten">${f.code}</div>`; return `<div class="bg-white rounded-[24px] p-5 shadow-soft relative hand-card group"><button onclick="editFlight(${f.id})" class="absolute top-3 right-3 text-gray-300 hover:text-fuji transition"><i class="fa-solid fa-pen"></i></button><div class="flex justify-between items-center mb-4 px-2"><span class="text-4xl font-black handwritten text-pencil">${f.dep}</span>${planeIcon}<span class="text-4xl font-black handwritten text-pencil">${f.arr}</span></div><div class="bg-fuji-light/50 rounded-2xl py-3 px-4 text-center border border-fuji/10">${codeDisplay}<div class="text-lg font-bold text-gray-600 mt-2">${f.date} ${f.time}</div></div></div>`; }).join(''); }
        function saveFlight(){ const id=document.getElementById('flight-id').value; const f={ id:id?parseInt(id):Date.now(), dep:document.getElementById('flight-dep').value, arr:document.getElementById('flight-arr').value, code:document.getElementById('flight-code').value, time:document.getElementById('flight-time').value, date:document.getElementById('flight-date').value, url:document.getElementById('flight-url').value, photo: currentFlightPhoto }; if(id){const idx=flights.findIndex(i=>i.id==id);if(idx>-1)flights[idx]=f;}else{flights.push(f);} saveData(); renderFlights(); closeModal('flight-modal'); }
        function editFlight(id){ const f=flights.find(i=>i.id==id); if(f){ document.getElementById('flight-id').value=f.id; document.getElementById('flight-dep').value=f.dep; document.getElementById('flight-arr').value=f.arr; document.getElementById('flight-code').value=f.code; document.getElementById('flight-date').value=f.date; document.getElementById('flight-time').value=f.time; document.getElementById('flight-url').value=f.url; currentFlightPhoto = f.photo; if(f.photo) { document.getElementById('flight-photo-preview').src = f.photo; document.getElementById('flight-photo-preview').classList.remove('hidden'); } else { document.getElementById('flight-photo-preview').classList.add('hidden'); document.getElementById('flight-photo-preview').src = ""; } openModal('flight-modal'); } }
        function openFlightModal(){ ['flight-id','flight-dep','flight-arr','flight-code','flight-date','flight-time','flight-url'].forEach(k=>document.getElementById(k).value=''); currentFlightPhoto = null; document.getElementById('flight-photo-preview').classList.add('hidden'); document.getElementById('flight-photo-preview').src = ""; openModal('flight-modal'); }

        // --- WALLET & CHARTS ---
        function renderExpenses() {
            const list = document.getElementById('expense-list'); 
            list.innerHTML = '';
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const pfTotal = publicFundConfig.total || 0;
            let pfSpent = 0;

            expenses.sort((a,b) => b.id - a.id).forEach(e => {
                const cat = expenseCategories.find(c => c.id === e.cat) || expenseCategories[5];
                const amt = parseFloat(e.amt);
                const paidBy = e.paidBy || e.payer.split(',')[0]; // fallback
                
                // è¨ˆç®—å…¬è²»æ”¯å‡º
                if (paidBy === 'å…¬è²»') pfSpent += (e.curr === 'JPY' ? amt : amt / rate);

                // åˆ¤æ–·æ˜¯å¦ç‚ºå€‹äººèŠ±éŠ·
                const isPersonal = (paidBy !== 'å…¬è²»') && (!e.splitBy || e.splitBy.length <= 1);
                if (isPersonal) return;

                const splitDisplay = e.splitBy && e.splitBy.length > 0 ? e.splitBy.join(', ') : (e.payer||"");

                // âœ¨ åˆ¤æ–·æœ‰æ²’æœ‰ç…§ç‰‡
                const hasPhoto = e.photo && e.photo.length > 0;
                
                const iconAction = hasPhoto ? `event.stopPropagation(); viewPhoto('${e.photo}')` : `openExpenseModal(${e.id})`;
                const iconStyle = hasPhoto ? `cursor-zoom-in ring-2 ring-offset-1 ring-transparent hover:ring-blue-300 hover:scale-110 transition-all` : ``;
                const badgeHtml = hasPhoto ? `<div class="absolute -bottom-1 -right-1 bg-blue-500 text-white w-4 h-4 rounded-full flex items-center justify-center border-2 border-white text-[8px] shadow-sm"><i class="fa-solid fa-image"></i></div>` : ``;

                list.innerHTML += `
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-50 flex items-center gap-3 relative overflow-hidden group hover:bg-gray-50 transition" onclick="openExpenseModal(${e.id})">
                    <div onclick="${iconAction}" class="w-10 h-10 rounded-full ${cat.color} flex items-center justify-center flex-shrink-0 text-sm relative ${iconStyle}">
                        <i class="fa-solid ${cat.icon}"></i>
                        ${badgeHtml}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-gray-700 text-sm truncate">${e.note || cat.id}</div>
                        <div class="text-[10px] text-gray-400">
                            <span class="font-bold text-fuji">${paidBy}</span> å…ˆä»˜ 
                            <i class="fa-solid fa-caret-right text-gray-300"></i> ${splitDisplay}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold font-mono text-gray-800">${e.curr} ${amt.toLocaleString()}</div>
                        ${e.curr === 'JPY' ? `<div class="text-[10px] text-gray-400">â‰ˆ NT$ ${Math.round(amt * rate).toLocaleString()}</div>` : ''}
                    </div>
                </div>`;
            });
            
            const pfRemaining = pfTotal - pfSpent;
            document.getElementById('pf-total').innerText = `Â¥${pfTotal.toLocaleString()}`;
            document.getElementById('pf-remaining').innerText = `Â¥${Math.round(pfRemaining).toLocaleString()}`;
            document.getElementById('pf-remaining').className = `text-3xl font-mono font-bold tracking-tight ${pfRemaining < 0 ? 'text-red-300' : 'text-white'}`;
            
            const dash = document.getElementById('wallet-dashboard-container'); dash.innerHTML = ''; 
            payers.forEach(p => {
                if (p === 'å…¬è²»') return;
                let totalConsumed = 0;
                expenses.forEach(e => { 
                    if(e.splitBy && e.splitBy.includes(p)) {
                          const amt = (e.curr==='JPY' ? e.amt*rate : e.amt);
                          totalConsumed += amt / e.splitBy.length;
                    }
                });
                dash.innerHTML += `<div class="min-w-[140px] p-4 bg-white rounded-[24px] shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 transition active:scale-95" onclick="openMemberAnalysis('${p}')">
                    <div class="font-bold text-gray-700 text-sm mb-1">${p} æ¶ˆè²» <i class="fa-solid fa-chart-pie text-xs ml-1 text-gray-300"></i></div>
                    <div class="text-lg font-bold font-mono text-gray-800">NT$ ${Math.round(totalConsumed).toLocaleString()}</div>
                </div>`;
            });
            
            updateInlineCharts(rate);
        }

        function openMemberAnalysis(memberName) {
             const rate = parseFloat(document.getElementById('exchange-rate').value);
             const catData = {};
             let total = 0;
             let expenseListHtml = ''; 

             expenses.sort((a,b) => b.id - a.id).forEach(e => {
                 if(e.splitBy && e.splitBy.includes(memberName)) {
                     const amt = (e.curr === 'JPY' ? e.amt * rate : e.amt);
                     const share = amt / e.splitBy.length;
                     catData[e.cat] = (catData[e.cat] || 0) + share;
                     total += share;
                     
                     const cat = expenseCategories.find(c => c.id === e.cat) || expenseCategories[5];
                     const isPersonal = (e.paidBy !== 'å…¬è²»') && (!e.splitBy || e.splitBy.length <= 1);
                     const personalBadge = isPersonal ? `<span class="text-[10px] bg-gray-200 text-gray-500 px-1 rounded ml-1">å€‹äºº</span>` : '';
                     
                     const hasPhoto = e.photo && e.photo.length > 0;
                     const iconAction = hasPhoto ? `event.stopPropagation(); viewPhoto('${e.photo}')` : '';
                     const iconStyle = hasPhoto ? `cursor-zoom-in ring-2 ring-offset-1 ring-transparent hover:ring-blue-300 hover:scale-110 transition-all` : ``;
                     const badgeHtml = hasPhoto ? `<div class="absolute -bottom-1 -right-1 bg-blue-500 text-white w-4 h-4 rounded-full flex items-center justify-center border-2 border-white text-[8px] shadow-sm"><i class="fa-solid fa-image"></i></div>` : ``;

                     expenseListHtml += `
                        <div onclick="openExpenseModal(${e.id})" class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0 cursor-pointer hover:bg-gray-100 transition px-3 rounded-lg group">
                            <div class="flex items-center gap-4 min-w-0">
                                <div onclick="${iconAction}" class="w-10 h-10 rounded-full ${cat.color} flex items-center justify-center flex-shrink-0 text-base relative ${iconStyle}">
                                    <i class="fa-solid ${cat.icon}"></i>
                                    ${badgeHtml}
                                </div>
                                <div class="min-w-0">
                                    <div class="text-base font-bold text-gray-700 truncate">${e.note || cat.id} ${personalBadge}</div>
                                    <div class="text-xs text-gray-500">${e.paidBy} å…ˆä»˜ ${e.curr==='JPY'?'Â¥'+e.amt:''}</div>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-lg font-bold font-mono text-gray-700">NT$${Math.round(share).toLocaleString()}</div>
                                <div class="text-xs text-fuji opacity-0 group-hover:opacity-100 transition">ä¿®æ”¹</div>
                            </div>
                        </div>`;
                 }
             });

             document.getElementById('analysis-title').innerText = `${memberName} çš„æ¶ˆè²»åˆ†æ`;
             document.getElementById('analysis-total').innerText = `NT$${Math.round(total).toLocaleString()}`;
             
             const detailsContainer = document.getElementById('analysis-details');
             const sortedCats = Object.entries(catData).sort((a,b) => b[1] - a[1]);
             const categorySummaryHtml = sortedCats.map(([cat, amount]) => {
                 const percentage = total > 0 ? ((amount / total) * 100).toFixed(1) : 0;
                 return `<div class="flex justify-between border-b border-gray-200 pb-1 mb-1 last:border-0"><span class="text-gray-600">${cat}</span><span class="font-bold text-gray-800">NT$${Math.round(amount).toLocaleString()} <span class="text-[10px] text-gray-400 font-normal">(${percentage}%)</span></span></div>`;
             }).join('');

             detailsContainer.innerHTML = `<div id="analysis-cat-summary" class="mb-4 transition-all duration-300 overflow-hidden">${categorySummaryHtml}</div><div id="analysis-list-wrapper" class="pt-2 border-t-2 border-dashed border-gray-200 flex flex-col flex-1 min-h-0"><h4 onclick="toggleAnalysisExpand()" class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1 cursor-pointer hover:text-fuji transition select-none group py-1"><i class="fa-solid fa-list"></i> è©³ç´°æ”¯å‡ºç´€éŒ„ (é»æ“Šæ”¾å¤§) <i id="analysis-arrow" class="fa-solid fa-chevron-down ml-auto transition-transform duration-300"></i></h4><div id="analysis-list-body" class="space-y-0.5 overflow-y-auto pr-1 custom-scrollbar transition-all duration-300 flex-1 min-h-[150px]">${expenseListHtml || '<div class="text-center text-gray-300 py-4 text-xs">å°šç„¡ç´€éŒ„</div>'}</div></div>`;

             const ctx = document.getElementById('memberDetailChart').getContext('2d');
             if(memberDetailChart) memberDetailChart.destroy();
             memberDetailChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(catData), datasets: [{ data: Object.values(catData), backgroundColor: ['#f8c3cd', '#bccc9a', '#7b90d2', '#b5651d', '#eff6ff', '#e5e7eb'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } } });
             openModal('member-analysis-modal');
        }

        function toggleAnalysisExpand() { const modalContainer = document.querySelector('#member-analysis-modal'); const card = modalContainer.querySelector('.hand-card'); const chartDiv = document.getElementById('memberDetailChart').parentElement; const summaryDiv = document.getElementById('analysis-cat-summary'); const detailsDiv = document.getElementById('analysis-details'); const listWrapper = document.getElementById('analysis-list-wrapper'); const arrow = document.getElementById('analysis-arrow'); const isExpanded = card.classList.contains('!w-[95vw]'); if (isExpanded) { card.classList.remove('!w-[95vw]', '!h-[85vh]', '!max-w-none', 'flex', 'flex-col'); card.classList.add('max-w-sm'); chartDiv.classList.remove('hidden'); summaryDiv.classList.remove('hidden'); detailsDiv.classList.remove('flex-1', 'flex', 'flex-col', 'overflow-hidden', 'h-full'); detailsDiv.classList.add('max-h-40', 'overflow-y-auto'); listWrapper.classList.remove('flex-1', 'h-full', 'overflow-hidden'); arrow.classList.remove('rotate-180'); } else { card.classList.remove('max-w-sm'); card.classList.add('!w-[95vw]', '!h-[85vh]', '!max-w-none', 'flex', 'flex-col'); chartDiv.classList.add('hidden'); summaryDiv.classList.add('hidden'); detailsDiv.classList.remove('max-h-40', 'overflow-y-auto'); detailsDiv.classList.add('flex-1', 'flex', 'flex-col', 'overflow-hidden', 'h-full'); listWrapper.classList.add('flex-1', 'h-full', 'overflow-hidden'); arrow.classList.add('rotate-180'); } }
        function updateInlineCharts(rate) { const catData = {}; expenses.forEach(e => { const amt = e.curr === 'JPY' ? e.amt * rate : e.amt; catData[e.cat] = (catData[e.cat] || 0) + amt; }); const ctxCat = document.getElementById('inlineCategoryChart').getContext('2d'); if(inlineCategoryChart) inlineCategoryChart.destroy(); inlineCategoryChart = new Chart(ctxCat, { type: 'doughnut', data: { labels: Object.keys(catData), datasets: [{ data: Object.values(catData), backgroundColor: ['#f8c3cd', '#bccc9a', '#7b90d2', '#b5651d', '#eff6ff', '#e5e7eb'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } }); const memberData = {}; payers.forEach(p => memberData[p] = 0); expenses.forEach(e => { const amt = (e.curr === 'JPY' ? e.amt * rate : e.amt); if(e.splitBy && e.splitBy.length > 0) { const share = amt / e.splitBy.length; e.splitBy.forEach(p => { if(memberData[p] !== undefined) memberData[p] += share; }); } }); const ctxMem = document.getElementById('inlineMemberChart').getContext('2d'); if(inlineMemberChart) inlineMemberChart.destroy(); inlineMemberChart = new Chart(ctxMem, { type: 'bar', data: { labels: Object.keys(memberData), datasets: [{ label: 'NT$ æ¶ˆè²»', data: Object.values(memberData), backgroundColor: '#7b90d2', borderRadius: 4 }] }, options: { maintainAspectRatio: false, indexAxis: 'y', scales: { x: { display: false }, y: { grid: { display: false }, ticks: { font: { size: 10 } } } }, plugins: { legend: { display: false } } } }); }
        function calculateSettlement() { const rate = parseFloat(document.getElementById('exchange-rate').value); const balances = {}; payers.forEach(p => balances[p] = 0); expenses.forEach(e => { const amt = (e.curr === 'JPY' ? e.amt * rate : e.amt); const payer = e.paidBy || "æˆ‘"; const consumers = e.splitBy || []; if (balances[payer] !== undefined) balances[payer] += amt; if (consumers.length > 0) { const share = amt / consumers.length; consumers.forEach(c => { if (balances[c] !== undefined) balances[c] -= share; }); } }); manualDebts.forEach(d => { if (balances[d.creditor] !== undefined) balances[d.creditor] += parseFloat(d.amount); if (balances[d.debtor] !== undefined) balances[d.debtor] -= parseFloat(d.amount); }); let debtors = []; let creditors = []; Object.keys(balances).forEach(p => { if(p === 'å…¬è²»') return; if (balances[p] < -1) debtors.push({ name: p, amount: balances[p] }); else if (balances[p] > 1) creditors.push({ name: p, amount: balances[p] }); }); debtors.sort((a, b) => a.amount - b.amount); creditors.sort((a, b) => b.amount - a.amount); let planHtml = ''; let i = 0, j = 0; while (i < debtors.length && j < creditors.length) { let debt = Math.abs(debtors[i].amount); let credit = creditors[j].amount; let transfer = Math.min(debt, credit); planHtml += `<div class="flex justify-between border-b border-blue-200 pb-1 mb-1 last:border-0"><span class="font-bold text-gray-700">${debtors[i].name}</span> <span class="text-gray-400 text-xs mx-1">çµ¦</span> <span class="font-bold text-gray-700">${creditors[j].name}</span> <span class="font-mono font-bold text-blue-600">NT$${Math.round(transfer)}</span></div>`; debtors[i].amount += transfer; creditors[j].amount -= transfer; if (Math.abs(debtors[i].amount) < 1) i++; if (creditors[j].amount < 1) j++; } if (!planHtml) planHtml = '<div class="text-center text-gray-400">ç›®å‰å¸³ç›®å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ã€‚</div>'; document.getElementById('settlement-plan').innerHTML = planHtml; document.getElementById('settlement-details').innerHTML = Object.entries(balances).map(([k,v]) => `<div>${k}: ${v>=0?'+':''}${Math.round(v)}</div>`).join(''); const ctxSet = document.getElementById('settlementChart').getContext('2d'); if(settlementChart) settlementChart.destroy(); settlementChart = new Chart(ctxSet, { type: 'bar', data: { labels: Object.keys(balances), datasets: [{ label: 'æ·¨é¤˜é¡ (NT$)', data: Object.values(balances), backgroundColor: Object.values(balances).map(v => v >= 0 ? '#bccc9a' : '#f8c3cd'), borderRadius: 4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } } } } }); openModal('settlement-modal'); }
        function openPublicFundModal() { document.getElementById('pf-total-input').value = publicFundConfig.total || 0; openModal('pf-settings-modal'); }
        function savePublicFundSettings() { publicFundConfig.total = parseFloat(document.getElementById('pf-total-input').value) || 0; saveData(); renderExpenses(); closeModal('pf-settings-modal'); }
        function switchCategory(id) { selectedCat = id; renderCategoryUI(); }
        function renderCategoryUI() { document.getElementById('expense-categories').innerHTML = expenseCategories.map(c => `<div onclick="switchCategory('${c.id}')" class="w-10 h-10 rounded-full flex items-center justify-center cursor-pointer transition-all ${selectedCat===c.id?'ring-2 ring-black scale-110 '+c.color:'bg-gray-50 text-gray-400 hover:bg-gray-100'}"><i class="fa-solid ${c.icon}"></i></div>` ).join(''); }
        
        function removeExpensePhoto() {
            if(confirm("ç¢ºå®šè¦ç§»é™¤é€™å¼µæ”¶æ“šç…§ç‰‡å—ï¼Ÿ")) {
                currentPhotoBase64 = null; 
                document.getElementById('ex-photo-preview-mini').src = "";
                document.getElementById('ex-photo-preview-mini').classList.add('hidden'); 
                document.getElementById('btn-remove-ex-photo').classList.add('hidden');   
                document.getElementById('ex-photo').value = ""; 
            }
        }

        function openExpenseModal(id=null, keepInput=false) { 
            const payerSelect = document.getElementById('ex-paid-by');
            payerSelect.innerHTML = payers.map(p => `<option value="${p}">${p}</option>`).join('');
            
            document.getElementById('btn-delete-expense').classList.add('hidden');
            document.getElementById('btn-remove-ex-photo').classList.add('hidden'); 
            
            if(id) { 
                const ex = expenses.find(e => e.id == id); 
                document.getElementById('ex-id').value = ex.id; 
                document.getElementById('ex-amount').value = ex.amt; 
                document.getElementById('ex-currency').value = ex.curr; 
                document.getElementById('ex-note').value = ex.note; 
                payerSelect.value = ex.paidBy || "æˆ‘"; 
                selectedCat = ex.cat; 
                selectedPayers = ex.splitBy || []; 
                document.getElementById('btn-delete-expense').classList.remove('hidden'); 
                
                currentPhotoBase64 = ex.photo; 
                if(ex.photo){
                    document.getElementById('ex-photo-preview-mini').src = ex.photo;
                    document.getElementById('ex-photo-preview-mini').classList.remove('hidden');
                    document.getElementById('btn-remove-ex-photo').classList.remove('hidden'); 
                } else {
                    document.getElementById('ex-photo-preview-mini').classList.add('hidden');
                }
            } else { 
                document.getElementById('ex-id').value = ''; 
                
                // ğŸ”¥ é—œéµä¿®æ”¹ï¼šå¦‚æœä¸æ˜¯å¾æ·å¾‘ä¾†çš„(keepInput=false)ï¼Œå°±å¼·åˆ¶æ¸…ç©ºï¼
                if (!keepInput) {
                    document.getElementById('ex-amount').value = ''; 
                    document.getElementById('ex-note').value = ''; 
                    selectedCat = 'é¤é£²'; // æ¢å¾©é è¨­åˆ†é¡
                    selectedPayers = payers.filter(p => p !== 'å…¬è²»'); // æ¢å¾©é è¨­åˆ†æ”¤äºº
                }

                document.getElementById('ex-currency').value = 'JPY'; 
                payerSelect.value = "æˆ‘"; 
                if (!payers.includes("æˆ‘") && payers.length > 0) payerSelect.value = payers[0]; 
                
                if (!keepInput) selectedPayers = payers.filter(p => p !== 'å…¬è²»'); 
                
                currentPhotoBase64 = null; 
                document.getElementById('ex-photo-preview-mini').src = ""; 
                document.getElementById('ex-photo-preview-mini').classList.add('hidden'); 
            } 
            renderCategoryUI(); 
            renderSplitButtons(); 
            openModal('expense-modal'); 
        }

        function renderSplitButtons() { document.getElementById('ex-split-container').innerHTML = payers.map(p => `<button onclick="togglePayer('${p}')" class="px-3 py-1.5 rounded-full text-xs border font-bold transition-all ${selectedPayers.includes(p) ? 'bg-ink text-white border-ink' : 'bg-white text-gray-500'}">${p}</button>`).join(''); }
        function togglePayer(p) { if(selectedPayers.includes(p)) selectedPayers=selectedPayers.filter(x=>x!==p); else selectedPayers.push(p); renderSplitButtons(); }
        function toggleAllPayers() { const allHumanPayers = payers.filter(p => p !== 'å…¬è²»'); if (selectedPayers.length === allHumanPayers.length) selectedPayers = []; else selectedPayers = [...allHumanPayers]; renderSplitButtons(); }
        function saveExpense() { const id=document.getElementById('ex-id').value, amt=parseFloat(document.getElementById('ex-amount').value); if(!amt) return; let paidBy = document.getElementById('ex-paid-by').value; const ex = { id:id?parseInt(id):Date.now(), cat:selectedCat, note:document.getElementById('ex-note').value, curr:document.getElementById('ex-currency').value, amt, paidBy: paidBy, splitBy: selectedPayers.length > 0 ? selectedPayers : [paidBy], payer: selectedPayers.join(','), photo: currentPhotoBase64 }; if(id){const idx=expenses.findIndex(e=>e.id==id);expenses[idx]=ex;}else{expenses.push(ex);} saveData(); renderExpenses(); closeModal('expense-modal'); }
        function deleteExpense(){ if(confirm("Del?")){ expenses=expenses.filter(e=>e.id!=document.getElementById('ex-id').value); saveData(); renderExpenses(); closeModal('expense-modal'); } }
        
        // --- SHOPPING ---
        window.expandedCategories = window.expandedCategories || new Set();
        function renderShoppingList() { const owner = shoppingOwners[currentShopOwnerIdx] || "æˆ‘çš„æ¸…å–®"; const items = shoppingList.filter(s => (s.owner || shoppingOwners[0]) === owner); const container = document.getElementById('shopping-list-container'); container.innerHTML = ''; const grouped = {}; items.forEach(item => { const cat = item.category || 'æœªåˆ†é¡'; if(!grouped[cat]) grouped[cat] = []; grouped[cat].push(item); }); const catStyles = { 'è—¥å¦': 'border-pink-400 bg-pink-50 text-pink-600', 'Outlet': 'border-sky-400 bg-sky-50 text-sky-600', '7-11': 'border-orange-400 bg-orange-50 text-orange-600', 'å…¨å®¶': 'border-green-500 bg-green-50 text-green-700', 'Lawson': 'border-blue-400 bg-blue-50 text-blue-600', 'ä¼´æ‰‹ç¦®': 'border-red-400 bg-red-50 text-red-600', 'é›»å™¨': 'border-gray-500 bg-gray-100 text-gray-600', 'æœé£¾': 'border-purple-400 bg-purple-50 text-purple-600', 'AEON': 'border-fuchsia-400 bg-fuchsia-50 text-fuchsia-600', 'è¶…å¸‚': 'border-emerald-400 bg-emerald-50 text-emerald-600', 'å”å‰è»»å¾·': 'border-yellow-400 bg-yellow-50 text-yellow-700', 'æœªåˆ†é¡': 'border-gray-300 bg-gray-50 text-gray-500' }; const autoPalettes = [ 'border-teal-400 bg-teal-50 text-teal-600', 'border-indigo-400 bg-indigo-50 text-indigo-600', 'border-lime-400 bg-lime-50 text-lime-700', 'border-cyan-400 bg-cyan-50 text-cyan-600', 'border-rose-400 bg-rose-50 text-rose-600', 'border-amber-400 bg-amber-50 text-amber-700', 'border-violet-400 bg-violet-50 text-violet-600' ]; Object.keys(grouped).sort().forEach(cat => { const catItems = grouped[cat]; const doneCount = catItems.filter(i => i.done).length; const isExpanded = expandedCategories.has(cat); let styleClass = catStyles[cat]; if (!styleClass) { let hash = 0; for (let i = 0; i < cat.length; i++) hash = cat.charCodeAt(i) + ((hash << 5) - hash); const colorIdx = Math.abs(hash) % autoPalettes.length; styleClass = autoPalettes[colorIdx]; } const itemsHtml = catItems.map(s => renderShopItem(s)).join(''); let html = `<div class="mb-3 transition-all duration-300 w-full max-w-full"><div class="relative pl-4 pr-3 py-3 rounded-r-xl border-l-4 shadow-sm cursor-pointer flex justify-between items-center hover:brightness-95 transition-all ${styleClass} bg-white border-opacity-80" onclick="toggleShopCat('${cat}')" style="background-color: white;"><div class="absolute left-[-6px] top-1/2 -translate-y-1/2 w-3 h-3 bg-[#f9f7f2] rounded-full shadow-inner border border-gray-200"></div><div class="flex items-center gap-2"><i class="fa-solid fa-tag text-sm opacity-70"></i><h5 class="font-bold text-sm tracking-wide">${cat}</h5><span class="text-[10px] bg-gray-100 text-gray-400 px-2 py-0.5 rounded-full ml-1">${doneCount} / ${catItems.length}</span></div><i class="fa-solid fa-chevron-down text-gray-300 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}"></i></div><div class="${isExpanded ? 'block' : 'hidden'} pl-2 pr-1 py-2 space-y-2 animate-slide-in">${itemsHtml}</div></div>`; container.innerHTML += html; }); document.getElementById('shop-owner-name').innerText = owner; }
        function renderShopItem(s) { const isDone = s.done; return `<div class="relative p-3 border border-gray-100 shadow-sm rounded-xl bg-white flex items-center justify-between gap-3 ${isDone ? 'opacity-60 grayscale bg-gray-50' : ''}" onclick="openShoppingModal(${s.id})"><div class="flex items-center gap-3 flex-1 min-w-0"><div class="w-6 h-6 rounded-full border-2 flex-shrink-0 cursor-pointer flex items-center justify-center transition-colors ${isDone?'bg-red-400 border-red-400 text-white':'border-gray-300 text-transparent hover:border-red-300'}" onclick="event.stopPropagation();triggerShopAction(${s.id}, ${isDone})"><i class="fa-solid fa-check text-xs"></i></div><div class="min-w-0"><div class="font-bold truncate text-gray-700 text-sm leading-tight">${s.name}</div><div class="text-[11px] text-gray-400 mt-0.5 font-mono">${s.price ? `Â¥${s.price} ` : ''}${s.qty && s.qty > 1 ? `<span class="text-gray-300">x</span> ${s.qty}` : ''}</div></div></div>${s.photo ? `<div class="w-10 h-10 flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 cursor-zoom-in group relative shadow-sm" onclick="event.stopPropagation();viewPhoto('${s.photo}')"><img src="${s.photo}" class="w-full h-full object-cover"></div>` : ''}</div>`; }
        function toggleShopCat(cat) { if (expandedCategories.has(cat)) expandedCategories.delete(cat); else expandedCategories.add(cat); renderShoppingList(); }
        function openShoppingModal(id=null){ ['shop-id','shop-name','shop-qty','shop-price','shop-category'].forEach(k=>document.getElementById(k).value=''); document.getElementById('shop-qty').value=1; currentShopPhoto=null; document.getElementById('shop-photo-preview').classList.add('hidden'); renderShopCatButtons();if(id){ const s=shoppingList.find(i=>i.id===id); document.getElementById('shop-id').value=s.id; document.getElementById('shop-name').value=s.name; document.getElementById('shop-qty').value=s.qty; document.getElementById('shop-price').value=s.price; document.getElementById('shop-category').value=s.category||''; if(s.photo){ currentShopPhoto=s.photo; document.getElementById('shop-photo-preview').src=s.photo; document.getElementById('shop-photo-preview').classList.remove('hidden') } } openModal('shopping-modal'); }
        function saveShoppingItem(){ const id=document.getElementById('shop-id').value, name=document.getElementById('shop-name').value; if(!name)return; const item={ id:id?parseInt(id):Date.now(), name, qty:document.getElementById('shop-qty').value, price:document.getElementById('shop-price').value, category:document.getElementById('shop-category').value, photo:currentShopPhoto, done:false, owner: shoppingOwners[currentShopOwnerIdx] }; if(id){ const idx=shoppingList.findIndex(i=>i.id==id); item.done=shoppingList[idx].done; shoppingList[idx]=item; } else { shoppingList.push(item); } saveData(); renderShoppingList(); closeModal('shopping-modal'); }
        function deleteShoppingItem(){ if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ")){ shoppingList=shoppingList.filter(s=>s.id!=document.getElementById('shop-id').value); saveData(); renderShoppingList(); closeModal('shopping-modal'); } }
        function triggerShopAction(id, isDone) { if(isDone) { const s = shoppingList.find(i=>i.id===id); s.done = false; saveData(); renderShoppingList(); } else { document.getElementById('confirm-shop-id').value = id; openModal('shop-confirm-modal'); } }
  // âœ¨ æ–°å¢ï¼šè‡ªå‹•ç”¢ç”Ÿåˆ†é¡æŒ‰éˆ• (åŒ…å«ä½ è‡ªå·±è¼¸å…¥éçš„)
    function renderShopCatButtons() {
        const container = document.getElementById('shop-cat-chips');
        if (!container) return;

        // 1. å®šç¾©å…§å»ºåˆ†é¡
        const defaultCats = ['è—¥å¦', 'Outlet', '7-11', 'å…¨å®¶', 'Lawson', 'ä¼´æ‰‹ç¦®', 'é›»å™¨', 'æœé£¾', 'AEON', 'è¶…å¸‚', 'å”å‰è»»å¾·'];
        
        // 2. å¾ç›®å‰çš„è³¼ç‰©æ¸…å–®ä¸­ï¼Œæ‰¾å‡ºä½ è‡ªå·±æ–°å¢çš„åˆ†é¡ (å»é™¤é‡è¤‡ã€å»é™¤ç©ºç™½ã€å»é™¤å·²åœ¨å…§å»ºæ¸…å–®çš„)
        const customCats = [...new Set(shoppingList.map(i => i.category).filter(c => c && c.trim() !== '' && !defaultCats.includes(c)))];
        
        // 3. åˆä½µæ¸…å–®
        const allCats = [...defaultCats, ...customCats];

        // 4. å®šç¾©é¡è‰²æ¨£å¼ (ç‚ºäº†è®“æŒ‰éˆ•æ¼‚äº®ä¸€é»)
        const styleMap = {
            'è—¥å¦': 'bg-pink-50 text-pink-500 border-pink-100',
            'Outlet': 'bg-sky-50 text-sky-500 border-sky-100',
            '7-11': 'bg-orange-50 text-orange-500 border-orange-100',
            'å…¨å®¶': 'bg-green-50 text-green-600 border-green-200',
            'Lawson': 'bg-blue-50 text-blue-500 border-blue-100',
            'ä¼´æ‰‹ç¦®': 'bg-red-50 text-red-500 border-red-100',
            'é›»å™¨': 'bg-gray-50 text-gray-500 border-gray-100',
            'æœé£¾': 'bg-purple-50 text-purple-500 border-purple-100',
            'AEON': 'bg-fuchsia-50 text-fuchsia-600 border-fuchsia-200',
            'è¶…å¸‚': 'bg-emerald-50 text-emerald-600 border-emerald-200',
            'å”å‰è»»å¾·': 'bg-yellow-50 text-yellow-600 border-yellow-200'
        };

        // 5. ç”¢ç”Ÿ HTML
        container.innerHTML = allCats.map(cat => {
            // å¦‚æœæ˜¯è‡ªè¨‚åˆ†é¡ï¼Œçµ¦ä¸€å€‹é€šç”¨çš„è—ç¶ è‰²æ¨£å¼
            const style = styleMap[cat] || 'bg-teal-50 text-teal-600 border-teal-200';
            return `<button onclick="setShopCat('${cat}')" class="text-xs px-2 py-1 rounded-full border transition hover:scale-105 active:scale-95 ${style}">${cat}</button>`;
        }).join('');
    }      
        function confirmShopAction(action) { 
            const id = parseInt(document.getElementById('confirm-shop-id').value); 
            const s = shoppingList.find(i=>i.id===id); 
            if(!s) return; 
            
            if (action === 'expense') { 
                closeModal('shop-confirm-modal'); 
                const categoryNote = s.category ? ` (${s.category})` : ''; 
                
                openExpenseModal(null, true); // true = ä¿ç•™è¼¸å…¥ï¼Œä¸æ¸…ç©º
                document.getElementById('ex-note').value = s.name + categoryNote; 
                document.getElementById('ex-amount').value = s.price * s.qty; 
                selectedCat = 'è³¼ç‰©'; 
                selectedPayers = ['æˆ‘']; 
                
                renderCategoryUI(); 
                renderSplitButtons();

                s.done = true; 
                saveData(); 
                renderShoppingList(); 
            } 
            else if (action === 'done_only') { s.done = true; saveData(); renderShoppingList(); closeModal('shop-confirm-modal'); } 
            else if (action === 'cancel') { closeModal('shop-confirm-modal'); } 
        }
        function toggleFoodGroup(id) {
        const list = document.getElementById(id);
        const arrow = document.getElementById('arrow-' + id);
        if (list.classList.contains('hidden')) {
            list.classList.remove('hidden');
            if(arrow) arrow.classList.add('rotate-180');
            } else {
            list.classList.add('hidden');
            if(arrow) arrow.classList.remove('rotate-180');
            }
        }    
        function nextShopList(){ currentShopOwnerIdx=(currentShopOwnerIdx+1)%shoppingOwners.length; renderShoppingList(); }
        function prevShopList(){ currentShopOwnerIdx=(currentShopOwnerIdx-1+shoppingOwners.length)%shoppingOwners.length; renderShoppingList(); }
        function setShopCat(val) { document.getElementById('shop-category').value = val; }
        function openShopOwnerModal(){ document.getElementById('shop-lists-container').innerHTML = shoppingOwners.map((n, i) => `<div class="bg-gray-50 p-2 border rounded text-sm flex justify-between items-center mb-2"><span class="font-bold text-gray-700">${n}</span><button onclick="deleteShopList(${i})" class="text-red-400 hover:text-red-600 px-2 transition"><i class="fa-solid fa-trash-can"></i></button></div>` ).join(''); openModal('manage-shop-lists-modal'); }
        function deleteShopList(index) { if(confirm("ç¢ºå®šåˆªé™¤é€™å€‹æ¸…å–®å—ï¼Ÿ")) { if (currentShopOwnerIdx === index) currentShopOwnerIdx = 0; else if (index < currentShopOwnerIdx) currentShopOwnerIdx--; shoppingOwners.splice(index, 1); if(shoppingOwners.length === 0) shoppingOwners.push("æˆ‘çš„æ¸…å–®"); saveData(); openShopOwnerModal(); renderShoppingList(); } }
        function addShopList(){ const n=document.getElementById('new-shop-list-name').value; if(n){ shoppingOwners.push(n); saveData(); openShopOwnerModal(); renderShoppingList(); document.getElementById('new-shop-list-name').value=''; } }
function renderMustEatList() { 
        const c = document.getElementById('must-eat-list'); 
        c.innerHTML = ''; 
        
        const colors = [
            { bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-200' },
            { bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-200' },
            { bg: 'bg-pink-50', text: 'text-pink-600', border: 'border-pink-200' },
            { bg: 'bg-green-50', text: 'text-green-600', border: 'border-green-200' },
            { bg: 'bg-purple-50', text: 'text-purple-600', border: 'border-purple-200' },
            { bg: 'bg-yellow-50', text: 'text-yellow-600', border: 'border-yellow-200' },
        ];

        mustEatList.forEach(locItem => { 
            const groups = {};
            const themes = locItem.themes || [];
            
            themes.forEach(t => {
                const cat = t.category || 'æœªåˆ†é¡';
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(t);
            });

            let groupsHtml = '';
            Object.keys(groups).sort().forEach((cat, idx) => {
                const items = groups[cat];
                const groupId = `group-${locItem.id}-${idx}`;
                const color = colors[idx % colors.length];
                
                const itemsHtml = items.map(t => `
                    <div class="bg-white p-2 pl-3 rounded-lg border-l-4 ${color.border} shadow-sm mb-2 flex justify-between items-start ml-2 group hover:bg-gray-50 transition">
                        <div class="flex-1">
                            <div class="${t.isVeg?'text-green-600 font-bold':''} text-gray-700 text-sm leading-tight break-all">
                                ${t.isVeg?'<i class="fa-solid fa-leaf mr-1"></i>':''}${t.name}
                            </div>
                            ${t.note ? `<div class="text-[10px] text-gray-400 mt-1">${t.note}</div>` : ''}
                        </div>
                        ${t.url ? `<a href="${t.url}" target="_blank" class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:bg-matcha hover:text-white transition shrink-0 ml-2"><i class="fa-solid fa-link text-[10px]"></i></a>` : ''}
                    </div>`
                ).join('');

                groupsHtml += `
                    <div class="mb-2">
                        <div onclick="toggleFoodGroup('${groupId}')" class="flex items-center justify-between p-2 rounded-lg cursor-pointer ${color.bg} border ${color.border} hover:brightness-95 transition select-none">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm ${color.text}">${cat}</span>
                                <span class="bg-white/60 px-1.5 rounded text-[10px] ${color.text} font-mono">${items.length}</span>
                            </div>
                            <i id="arrow-${groupId}" class="fa-solid fa-chevron-down text-xs ${color.text} opacity-50 transition-transform duration-300"></i>
                        </div>
                        <div id="${groupId}" class="hidden mt-2 space-y-1 animate-slide-in border-l-2 border-dashed border-gray-200 ml-3 pl-1">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            });

            c.innerHTML += `
                <div class="mb-3 bg-[#fffdf5] rounded-xl border-l-4 border-matcha shadow-sm overflow-hidden group/card">
                    <div class="flex justify-between items-center p-4 cursor-pointer hover:bg-[#fcfcf0] transition relative" onclick="toggleMustEat('${locItem.id}')">
                        <h4 class="text-lg font-black handwritten text-gray-700 flex items-center gap-2">
                            <i class="fa-solid fa-location-dot text-matcha"></i> ${locItem.location}
                        </h4>
                        
                        <div class="flex items-center gap-3">
                            <button onclick="event.stopPropagation(); openMustEatModal('${locItem.id}')" class="w-7 h-7 rounded-full bg-white border border-matcha/30 text-matcha/70 flex items-center justify-center hover:bg-matcha hover:text-white hover:border-matcha transition shadow-sm" title="ç·¨è¼¯å…¨éƒ¨">
                                <i class="fa-solid fa-pen text-xs"></i>
                            </button>
                            
                            <span class="text-[10px] text-matcha font-bold bg-matcha/10 px-2 py-1 rounded-full border border-matcha/20">${themes.length} é–“</span>
                            <i id="icon-${locItem.id}" class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                        </div>
                    </div>
                    
                    <div id="details-${locItem.id}" class="hidden bg-white p-4 border-t border-matcha/10 animate-slide-in relative">
                        <div class="space-y-1">
                            ${groupsHtml || '<div class="text-center text-xs text-gray-300 py-2">å°šç„¡é¤å»³è³‡æ–™</div>'}
                        </div>
                    </div>
                </div>`; 
        }); 
    }
        function toggleMustEat(id) { const el = document.getElementById(`details-${id}`); const icon = document.getElementById(`icon-${id}`); if (el.classList.contains('hidden')) { el.classList.remove('hidden'); icon.classList.add('rotate-180'); } else { el.classList.add('hidden'); icon.classList.remove('rotate-180'); } }
        function openMustEatModal(id=null) { document.getElementById('eat-location').value = ''; tempThemes = []; document.getElementById('eat-loc-id').value = ''; if(id) { const item = mustEatList.find(i => i.id === id); if(item) { document.getElementById('eat-loc-id').value = item.id; document.getElementById('eat-location').value = item.location; tempThemes = JSON.parse(JSON.stringify(item.themes)); } } else { tempThemes = [{id: Date.now(), name: '', url: '', isVeg: false, note: ''}]; } renderThemeRows(); openModal('must-eat-modal'); }
        function renderThemeRows() { 
        const allCats = new Set(['æ‹‰éºµ','å£½å¸','ç‡’è‚‰','å±…é…’å±‹','ç”œé»','å’–å•¡å»³']); // é è¨­å€¼
        mustEatList.forEach(loc => {
            if(loc.themes) loc.themes.forEach(t => { if(t.category) allCats.add(t.category); });
        });

        // âœ¨ 3. [æ–°å¢] å¾ã€Œç›®å‰ç·¨è¼¯ä¸­ã€çš„æ¸…å–®æ‰¾åˆ†é¡ (é€™æ¨£ä½ å‰›æ‰“çš„å­—ï¼Œä¸‹ä¸€è¡Œå°±èƒ½é¸ï¼)
        tempThemes.forEach(t => { if(t.category) allCats.add(t.category); });
        
        // 4. ç”¢ç”Ÿä¸‹æ‹‰é¸å–® (DataList)
        const dataListHtml = `<datalist id="food-cat-list">${[...allCats].map(c=>`<option value="${c}">`).join('')}</datalist>`;

        // 5. ç”¢ç”Ÿç•«é¢
        document.getElementById('eat-themes-container').innerHTML = dataListHtml + tempThemes.map((t, idx) => `
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 relative group mb-2">
                <button onclick="tempThemes.splice(${idx},1);renderThemeRows()" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                
                <div class="flex items-center gap-2 mb-2 pr-6">
                    <input type="text" placeholder="é¤å»³åç¨±" class="flex-1 bg-transparent border-b border-gray-300 text-sm font-bold" value="${t.name}" oninput="tempThemes[${idx}].name=this.value">
                    <label class="text-xs text-green-600 whitespace-nowrap"><input type="checkbox" ${t.isVeg ? 'checked' : ''} onchange="tempThemes[${idx}].isVeg=this.checked"> ç´ é£Ÿ</label>
                </div>
                
                <div class="flex gap-2 mb-1">
                    <input type="text" list="food-cat-list" placeholder="åˆ†é¡ (å¯é¸/å¯æ‰“)" class="w-1/3 bg-white border rounded text-xs p-1 text-fuji font-bold" value="${t.category||''}" onchange="tempThemes[${idx}].category=this.value" onfocus="this.value=''">
                    <input type="url" placeholder="Google Maps / ç¶²å€" class="flex-1 bg-white border rounded text-xs p-1" value="${t.url||''}" oninput="tempThemes[${idx}].url=this.value">
                </div>
                
                <input type="text" placeholder="å‚™è¨» (å¦‚: å¿…é»å¸ƒä¸)" class="w-full bg-white border rounded text-xs p-1" value="${t.note||''}" oninput="tempThemes[${idx}].note=this.value">
            </div>`
        ).join(''); 
    }
        function addThemeRow() { tempThemes.push({id: Date.now(), name: '', url: '', isVeg: false, note: ''}); renderThemeRows(); }
        function saveMustEatLocation() { const id = document.getElementById('eat-loc-id').value, location = document.getElementById('eat-location').value; if(!location) return alert("è«‹è¼¸å…¥åœ°é»åç¨±"); const data = { id: id || 'loc_'+Date.now(), location, themes: tempThemes.filter(t => t.name) }; if(id) { const idx = mustEatList.findIndex(i => i.id === id); if(idx > -1) mustEatList[idx] = data; } else { mustEatList.push(data); } saveData(); renderMustEatList(); closeModal('must-eat-modal'); }
        function deleteMustEatLocation() { const id = document.getElementById('eat-loc-id').value; if(id && confirm("Del?")) { mustEatList = mustEatList.filter(i => i.id !== id); saveData(); renderMustEatList(); closeModal('must-eat-modal'); } }
        function renderChecklist(){document.getElementById('checklist-container').innerHTML=todos.map((t,i)=>`<li class="flex items-center gap-2 p-2 border rounded-lg bg-white shadow-sm transition-opacity duration-300 ${t.done ? 'opacity-60' : ''}"><input type="checkbox" onchange="toggleTodo(${i})" ${t.done?'checked':''} class="accent-fuji flex-shrink-0 w-4 h-4 cursor-pointer"><input class="flex-1 w-0 bg-transparent font-hand text-sm ${t.done?'text-gray-300':''}" value="${t.text}" onchange="updateTodo(${i},this.value)"><button onclick="deleteTodo(${i})" class="text-gray-300 hover:text-red-400 px-1"><i class="fa-solid fa-times"></i></button></li>`).join('');}
        function uncheckAllTodos() {if(confirm("ç¢ºå®šè¦å–æ¶ˆæ‰€æœ‰å‹¾é¸ç‹€æ…‹å—ï¼Ÿ")) {todos.forEach(t => t.done = false);saveData();renderChecklist();}}
        function addTodo(){const v=document.getElementById('new-todo').value;if(v){todos.push({text:v,done:false}); saveData(); renderChecklist();document.getElementById('new-todo').value='';}}
        function toggleTodo(i){todos[i].done=!todos[i].done; saveData(); renderChecklist();}
        function updateTodo(i,v){todos[i].text=v; saveData();}
        function deleteTodo(i){todos.splice(i,1); saveData(); renderChecklist();}
        function openMemberModal(){ document.getElementById('member-list').innerHTML=payers.map((p,i)=>`<div class="flex justify-between p-2 bg-gray-50 rounded items-center"><span class="font-bold text-sm">${p}</span>${p!=='å…¬è²»'&&payers.length>2?`<button onclick="removePayer(${i})" class="text-red-400 text-xs px-2">åˆªé™¤</button>`:''}</div>`).join(''); openModal('member-modal'); }
        function addPayer(){const n=document.getElementById('new-payer-name').value;if(n&&!payers.includes(n)){payers.push(n); saveData(); openMemberModal(); renderExpenses();}}
        function removePayer(i){if(confirm("Del?")){payers.splice(i,1); saveData(); openMemberModal(); renderExpenses();}}
        function openIOUModal(){ const h=payers.filter(p=>p!=='å…¬è²»').map(p=>`<option value="${p}">${p}</option>`).join(''); document.getElementById('iou-creditor').innerHTML=h; document.getElementById('iou-debtor').innerHTML=h; document.getElementById('iou-list-container').innerHTML=manualDebts.map(i=>`<div class="flex justify-between p-2 border-b"><span class="text-sm">${i.debtor} æ¬  ${i.creditor}</span><span class="font-bold">NT$${i.amount}</span><button onclick="deleteIOU('${i.id}')" class="text-xs text-red-400">x</button></div>`).join(''); openModal('iou-modal'); }
        function saveIOU(){ const c=document.getElementById('iou-creditor').value, d=document.getElementById('iou-debtor').value, a=parseFloat(document.getElementById('iou-amount').value), n=document.getElementById('iou-note').value; if(!a||c===d)return; manualDebts.push({id:'iou'+Date.now(),creditor:c,debtor:d,amount:a,note:n}); saveData(); openIOUModal(); }
        function deleteIOU(id){ if(confirm("Del?")){manualDebts=manualDebts.filter(i=>i.id!=id);saveData();openIOUModal();}}
        function toggleVJW() { vjwData.isOpen = !vjwData.isOpen; renderVJW(); saveData(); }
        function updateVJWName(id, val) { const item = vjwData.items.find(i => i.id === id); if (item) { item.name = val; saveData(); } }
        function renderVJW() { const c = document.getElementById('vjw-content'); if(vjwData.isOpen) { c.classList.remove('max-h-0'); c.classList.add('max-h-[500px]'); } else { c.classList.add('max-h-0'); c.classList.remove('max-h-[500px]'); } document.getElementById('vjw-container').innerHTML = vjwData.items.map(i => `<div class="flex-shrink-0 w-48 bg-white p-2 border rounded relative group"><button onclick="deleteVJW(${i.id})" class="absolute top-1 right-1 text-gray-300 hover:text-red-400 w-6 h-6 flex items-center justify-center rounded-full bg-gray-50 z-10"><i class="fa-solid fa-times"></i></button><input type="text" value="${i.name}" onfocus="this.select()" onchange="updateVJWName(${i.id}, this.value)" class="w-full bg-transparent text-center font-bold mb-1 outline-none border-b border-transparent focus:border-blue-300 text-gray-700 placeholder-gray-300 transition" placeholder="è¼¸å…¥åå­—"><img src="${i.image}" class="w-full h-40 object-contain cursor-zoom-in" onclick="viewPhoto('${i.image}')"></div>`).join('') + `<div class="flex-shrink-0 w-48 h-48 border-2 border-dashed border-blue-200/50 rounded-lg flex flex-col items-center justify-center cursor-pointer relative hover:bg-blue-50 transition group"><i class="fa-solid fa-qrcode text-3xl text-blue-200 mb-2 group-hover:scale-110 transition"></i><span class="text-xs text-blue-300 font-bold">+ æ–°å¢ QR Code</span><input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="processImage(this, b=>{vjwData.items.push({id:Date.now(),name:'è¼¸å…¥åå­—',image:b});saveData();renderVJW()})"></div>`; }
        function deleteVJW(id){ if(confirm("Del?")){vjwData.items=vjwData.items.filter(i=>i.id!==id);saveData();renderVJW()} }
        function restoreDefaultTodos() { if(confirm("ç¢ºå®šè¦æ¢å¾©æˆå…§å»ºçš„é è¨­æ¸…å–®å—ï¼Ÿç›®å‰çš„è‡ªè¨‚é …ç›®æœƒæ¶ˆå¤±å–”ï¼")) {todos = DEFAULT_TODOS.map(text => ({text, done: false}));saveData();renderChecklist();}}
        
        // --- é»æ“Šç©ºç™½è™•è‡ªå‹•å­˜æª” ---
        function enableAutoSaveOnOutsideClick() {
            const modalMap = [
                { id: 'day-modal',      save: saveDay },          // è¡Œç¨‹ç·¨è¼¯
                { id: 'expense-modal',  save: saveExpense },      // è¨˜å¸³
                { id: 'shopping-modal', save: saveShoppingItem }, // è³¼ç‰©
                { id: 'flight-modal',   save: saveFlight },       // èˆªç­
                { id: 'guide-modal',    save: saveGuide },        // å°è¦½
                { id: 'iou-modal',      save: saveIOU },          // å€Ÿæ¬¾
                { id: 'must-eat-modal', save: saveMustEatLocation }, // å¿…åƒæ¸…å–®
                { id: 'pf-settings-modal', save: savePublicFundSettings }, // å…¬è²»è¨­å®š
                
                // åƒ…é—œé–‰ä¸å­˜æª”
                { id: 'acc-modal',             save: () => closeModal('acc-modal') },
                { id: 'trans-photos-modal',    save: () => closeModal('trans-photos-modal') },
                { id: 'member-analysis-modal', save: () => closeModal('member-analysis-modal') },
                { id: 'settlement-modal',      save: () => closeModal('settlement-modal') },
                { id: 'member-modal',          save: () => closeModal('member-modal') },
                { id: 'manage-shop-lists-modal', save: () => closeModal('manage-shop-lists-modal') },
                { id: 'shop-confirm-modal',    save: () => closeModal('shop-confirm-modal') }
            ];

            modalMap.forEach(item => {
                const el = document.getElementById(item.id);
                if (el) {
                    const newEl = el.cloneNode(true);
                    el.parentNode.replaceChild(newEl, el);
                    
                    newEl.addEventListener('mousedown', function(e) {
                        if (e.target === this) {
                            console.log(`é»æ“Šç©ºç™½è™•ï¼Œé—œé–‰: ${item.id}`);
                            item.save(); 
                        }
                    });
                }
            });
        }
        
        window.onload = function() {
        reloadLocalData();
        window.refreshUI(); 
        if(gistId) { 
            document.getElementById('gist-id-input').value = gistId; 
            document.getElementById('gist-token-input').value = gistToken; 
            updateCloudStatus("é€£ç·šä¸­..."); 
            setTimeout(() => forceDownload(true), 500); 
            setInterval(() => forceDownload(true), 10000);
        }
        switchTab('plan');
        enableAutoSaveOnOutsideClick();
    }
    </script>
</body>
</html>
