<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—…ã®è¨˜">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f9f7f2">

    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">

    <title>ä¸€èµ·æ—…è¡Œå§</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@400;500;700;900&family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'paper': '#f9f7f2', 
                        'sakura': '#f8c3cd', 
                        'matcha': '#bccc9a', 
                        'fuji': '#7b90d2', 
                        'fuji-light': '#eff6ff', 
                        'pencil': '#595857', 
                        'ink': '#2c2c2c',
                        'clay': '#b5651d',
                        'cream': '#fffdf5'
                    },
                    fontFamily: { 
                        'maru': ['"Zen Maru Gothic"', 'sans-serif'], 
                        'hand': ['"Yomogi"', '"Zen Maru Gothic"', 'cursive'],
                        'serif': ['"Noto Serif TC"', 'serif']
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0,0,0,0.03)',
                        'float': '0 8px 30px rgba(0,0,0,0.08)'
                    },
                    animation: {
                        'flash': 'flash 1.5s infinite',
                        'highlight': 'highlight 2s ease-out forwards'
                    },
                    keyframes: {
                        flash: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: 0.5 },
                        },
                        highlight: {
                            '0%': { backgroundColor: 'rgba(252, 211, 77, 0.5)' },
                            '100%': { backgroundColor: 'transparent' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body {
            font-family: 'Zen Maru Gothic', 'Noto Serif TC', sans-serif; 
            background-color: #f9f7f2; 
            color: #595857;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 24px 24px;
            background-position: center top;
            -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none;
            min-height: 100vh; padding-bottom: calc(80px + var(--sab));
        }
        .handwritten { font-family: 'Yomogi', cursive; }
        .modal { transition: opacity 0.2s ease-in-out; } .modal.hidden { opacity: 0; pointer-events: none; } .modal.visible { opacity: 1; pointer-events: auto; }
        .hand-card { background: #fff; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); position: relative; transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.02); }
        .btn-action { border-radius: 16px; transition: all 0.2s; }
        .btn-action:active { transform: scale(0.95); }
        .nav-item.active i, .nav-item.active span { color: #7b90d2; font-weight: 900; } 
        .zoom-container { overflow: auto; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .zoom-container img { transition: transform 0.2s; cursor: zoom-in; }
        .zoom-container img.zoomed { max-width: none !important; max-height: none !important; cursor: zoom-out; cursor: grab; }
        .zoom-container.zoomed-mode { align-items: flex-start; justify-content: flex-start; }
        
        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Deco Elements */
        .deco-icon { position: absolute; pointer-events: none; opacity: 0.15; z-index: 0; font-size: 2rem; transform: rotate(10deg); }
        
        /* Interactive Links */
        .itinerary-link { color: #7b90d2; text-decoration: underline; text-decoration-style: dotted; cursor: pointer; transition: all 0.2s; }
        .itinerary-link:hover { color: #5c7cce; background-color: rgba(123, 144, 210, 0.1); border-radius: 4px; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="pb-2 px-4 text-center sticky top-0 bg-[#f9f7f2]/95 z-40 backdrop-blur-sm transition-all duration-300 relative border-b border-gray-100/50" style="padding-top: max(1.5rem, var(--sat));">
        <h1 class="text-4xl font-black tracking-widest text-ink handwritten relative inline-block mt-2" style="font-weight: 900;">
            <span class="absolute -top-5 -left-8 text-3xl rotate-[-15deg] opacity-80">âœˆï¸</span>
            æ—…ã®è¨˜
            <div class="absolute bottom-1 left-0 w-full h-3 bg-sakura/40 -z-10 rounded-full transform -rotate-1"></div>
        </h1>
        <div class="flex justify-center items-center gap-3 mt-2">
            <p class="text-[10px] text-fuji font-bold tracking-[0.2em] font-serif uppercase handwritten">My Travel Logbook</p>
            
            <!-- Cloud Status Badge -->
            <div id="cloud-status" class="text-[10px] bg-gray-200/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 cursor-default">
                <i class="fa-solid fa-code-branch"></i> <span>æœªé€£ç·š</span>
            </div>
            
            <!-- Sync Button -->
            <button onclick="forceDownload()" class="text-[10px] bg-white text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 hover:bg-fuji-light hover:text-fuji hover:border-fuji-light shadow-sm" title="ç«‹å³åŒæ­¥">
                <i class="fa-solid fa-rotate-right"></i> <span>åŒæ­¥</span>
            </button>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <main id="app" class="px-4 w-full mx-auto min-h-screen max-w-5xl relative pb-24">
        
        <!-- Deco -->
        <div class="deco-icon top-4 left-4 text-4xl">ğŸŒ¸</div>
        <div class="deco-icon top-20 right-10 text-3xl text-blue-200 rotate-[-20deg]">ğŸ™</div>
        <div class="deco-icon bottom-32 left-8 text-3xl text-green-200">ğŸ¡</div>
        <div class="deco-icon top-1/3 right-4 text-5xl text-red-100 rotate-[15deg]">â›©ï¸</div>

        <!-- PLAN VIEW -->
        <section id="view-plan" class="view-section animate-fade relative z-10">
            <div class="flex justify-between items-center mb-6 mt-6">
                <h3 class="text-pencil font-bold handwritten text-xl flex items-center"><i class="fa-solid fa-plane-departure mr-2 text-xl text-fuji"></i>èˆªç­è³‡è¨Š</h3>
                <button onclick="openFlightModal()" class="text-xs bg-white border border-fuji/30 text-fuji px-4 py-2 rounded-xl shadow-sm active:scale-95 font-bold hover:bg-fuji hover:text-white transition flex items-center gap-1"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
            </div>
            
            <div id="flight-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10"></div>
            
            <div class="flex justify-between items-center mb-4 border-t-2 border-dashed border-gray-200 pt-8 mt-6">
                 <h3 class="text-pencil font-bold handwritten text-xl flex items-center"><i class="fa-solid fa-map-location-dot mr-2 text-xl text-matcha"></i>æ¯æ—¥è¡Œç¨‹</h3>
            </div>
            <p class="text-xs text-gray-400 mb-6 text-center handwritten flex justify-center items-center gap-4 bg-white/60 py-2 rounded-full mx-auto max-w-xs backdrop-blur-sm shadow-sm">
                <span><i class="fa-solid fa-mug-hot text-orange-400"></i> é»æ“Šè¨˜å¸³</span>
                <span><i class="fa-solid fa-book-open text-fuji"></i> é»æ“Šæ–‡å­—çœ‹å°è¦½</span>
            </p>
            
            <!-- Itinerary Container -->
            <div id="itinerary-container" class="space-y-6 md:grid md:grid-cols-2 md:space-y-0 md:gap-6 items-start"></div>
            
            <button onclick="addNewDay()" class="w-full mt-8 mb-8 border-2 border-dashed border-gray-300 text-gray-400 rounded-2xl py-4 hover:bg-white hover:border-matcha hover:text-matcha transition font-bold text-sm bg-white/50 handwritten flex items-center justify-center gap-2 group">
                <i class="fa-solid fa-plus-circle group-hover:scale-110 transition"></i> å¯«ä¸‹ä¸€é å›æ†¶
            </button>
        </section>

        <!-- GUIDE VIEW -->
        <section id="view-guide" class="view-section hidden relative z-10">
            <div class="flex justify-between items-end mb-6 mt-6">
                <h2 class="text-2xl font-bold text-pencil handwritten flex items-center gap-2"><span class="text-3xl">ğŸ</span> æ·±åº¦å°è¦½</h2>
                <button onclick="openGuideModal()" class="text-sm bg-matcha/20 text-green-800 px-4 py-1.5 rounded-full border border-matcha/50 hover:bg-matcha hover:text-white transition font-bold shadow-sm"><i class="fa-solid fa-plus mr-1"></i>æ–°å¢æ™¯é»</button>
            </div>
            <div id="guide-list" class="space-y-6 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-6"></div>
        </section>

        <!-- WALLET VIEW -->
        <section id="view-wallet" class="view-section hidden relative z-10">
            <div class="flex justify-between items-center mt-6 mb-6">
                <h2 class="text-2xl font-bold text-pencil handwritten flex items-center gap-2"><span class="text-3xl">ğŸ‘›</span> æ—…è²»</h2>
                <div class="flex items-center gap-1 bg-white px-2 py-1.5 rounded-xl shadow-sm border border-gray-100">
                    <span class="text-[10px] text-gray-400 font-mono font-bold mr-1">åŒ¯ç‡</span>
                    <span class="text-xs text-fuji font-mono font-bold">1 JPY â‰ˆ</span>
                    <input type="number" id="exchange-rate" value="0.215" step="0.001" onchange="renderExpenses()" class="w-14 text-center rounded text-sm outline-none border-b border-gray-200 py-1 text-fuji font-bold bg-transparent focus:border-fuji transition">
                    <button onclick="updateExchangeRate()" id="btn-rate-update" class="w-6 h-6 rounded-full bg-gray-50 text-gray-400 hover:text-fuji hover:bg-fuji-light transition flex items-center justify-center ml-1">
                        <i class="fa-solid fa-arrows-rotate text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Dashboard -->
            <div class="flex overflow-x-auto gap-4 pb-4 no-scrollbar mb-4 md:grid md:grid-cols-4 md:overflow-visible" id="wallet-dashboard-container"></div>

            <div class="flex justify-between items-center mb-4 mt-4 px-1">
                <h4 class="text-sm font-bold text-gray-400 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> æœ€è¿‘æ”¯å‡º</h4>
                <div class="flex gap-2">
                    <button onclick="openMemberModal()" class="text-xs text-gray-500 bg-white border border-gray-200 rounded-lg px-3 py-1.5 hover:bg-gray-50 shadow-sm transition"><i class="fa-solid fa-users-gear mr-1"></i>æˆå“¡èˆ‡é ­åƒ</button>
                    <button onclick="openIOUModal()" class="text-xs text-fuji bg-fuji/5 border border-fuji/20 rounded-lg px-3 py-1.5 hover:bg-fuji/10 shadow-sm transition"><i class="fa-solid fa-hand-holding-dollar mr-1"></i>å€Ÿæ¬¾</button>
                </div>
            </div>

            <div id="expense-list" class="space-y-3 pb-24 md:grid md:grid-cols-2 md:gap-3 md:space-y-0"></div>

            <!-- FAB -->
            <div class="fixed bottom-24 right-6 md:right-10 z-30">
                <button onclick="openExpenseModal()" class="bg-ink text-white rounded-full h-14 px-6 shadow-float flex items-center gap-2 hover:scale-105 transition active:scale-95 group border-2 border-white/20">
                    <i class="fa-solid fa-pen-nib text-xl group-hover:rotate-12 transition"></i> <span class="font-bold handwritten tracking-widest text-lg">è¨˜ä¸€ç­†</span>
                </button>
            </div>
        </section>

        <!-- LISTS VIEW -->
        <section id="view-lists" class="view-section hidden relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- Must Eat -->
                <div class="hand-card p-6 bg-[#fffdf0] relative border-l-8 border-[#fffdf0]">
                     <div class="absolute -right-2 -top-2 text-4xl opacity-20 rotate-12">ğŸœ</div>
                     <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-300 pb-2">
                        <h3 class="text-xl font-bold text-pencil handwritten flex items-center gap-2"><i class="fa-solid fa-utensils text-matcha"></i> å¿…åƒæ¸…å–®</h3>
                        <button onclick="openMustEatModal()" class="text-xs bg-matcha/10 text-green-700 px-3 py-1.5 rounded-lg border border-matcha/30 shadow-sm hover:bg-matcha hover:text-white transition font-bold">æ–°å¢/ç·¨è¼¯</button>
                     </div>
                     <div id="must-eat-list" class="space-y-3"></div>
                </div>
                
                <!-- Shopping -->
                <div class="hand-card p-6 bg-white relative border-l-8 border-white">
                     <div class="absolute -right-2 -top-2 text-4xl opacity-20 rotate-[-10]">ğŸ›ï¸</div>
                     <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-200 pb-2">
                        <h3 class="text-xl font-bold text-pencil handwritten flex items-center gap-2"><i class="fa-solid fa-bag-shopping text-red-400"></i> è³¼ç‰©æ¸…å–®</h3>
                        <button onclick="openShoppingModal()" class="text-xs bg-red-50 text-red-500 px-3 py-1.5 rounded-lg border border-red-100 hover:bg-red-400 hover:text-white transition font-bold">æ–°å¢</button>
                     </div>
                     <div id="shopping-list-pending" class="grid grid-cols-2 gap-3 mb-4"></div>
                     <div class="flex items-center gap-2 mb-2 opacity-60">
                         <div class="h-px bg-gray-200 flex-1"></div>
                         <span class="text-[10px] text-gray-400">å·²è³¼è²·</span>
                         <div class="h-px bg-gray-200 flex-1"></div>
                     </div>
                     <div id="shopping-list-done" class="grid grid-cols-2 gap-3 opacity-60 grayscale filter"></div>
                </div>

                <!-- Checklist -->
                <div class="hand-card p-6 bg-[#f0f4f8] border-l-8 border-[#f0f4f8]">
                    <h3 class="text-lg font-bold text-center mb-4 text-fuji handwritten"><i class="fa-solid fa-suitcase mr-2"></i>è¡Œæç¢ºèª</h3>
                    <ul id="checklist-container" class="space-y-2"></ul>
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="new-todo" placeholder="æ–°å¢é …ç›®..." class="flex-1 bg-transparent border-b border-gray-300 text-sm outline-none font-hand focus:border-fuji transition px-1">
                        <button onclick="addTodo()" class="text-fuji hover:scale-110 transition"><i class="fa-solid fa-circle-plus fa-lg"></i></button>
                    </div>
                </div>
                
                 <div class="hand-card p-6 bg-[#fffff0] rotate-1 shadow-md border-t-8 border-[#e6e6d8]/30">
                    <div class="absolute top-0 left-0 w-full h-4 bg-yellow-400/10"></div>
                    <h3 class="text-lg font-bold mb-2 handwritten text-yellow-800 flex items-center gap-2"><i class="fa-solid fa-note-sticky"></i> éš¨æ‰‹è¨˜ (MEMO)</h3>
                    <textarea id="memo-pad" class="w-full h-48 p-3 bg-transparent border-none resize-none text-sm leading-8 outline-none text-gray-700 handwritten" style="background-image: repeating-linear-gradient(transparent, transparent 31px, #e5e5e5 32px); line-height: 32px;" placeholder="åœ¨é€™è£¡éš¨æ‰‹è¨˜ä¸‹æƒ³æ³•... (è¼¸å…¥å¾Œè‡ªå‹•åŒæ­¥)"></textarea>
                </div>
            </div>
        </section>

        <!-- INFO VIEW -->
        <section id="view-info" class="view-section hidden relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <!-- VJW Card -->
                <div class="hand-card p-0 overflow-hidden bg-blue-50/30 border border-blue-100 group hover:shadow-lg transition">
                    <div class="p-4 bg-gradient-to-r from-blue-500/10 to-transparent flex justify-between items-center">
                        <h3 class="font-bold text-blue-800 handwritten text-lg"><i class="fa-solid fa-passport mr-2"></i>Visit Japan Web</h3>
                        <a href="https://www.vjw.digital.go.jp/" target="_blank" class="text-xs bg-white text-blue-500 px-3 py-1.5 rounded-full shadow-sm hover:bg-blue-500 hover:text-white transition font-bold">å‰å¾€ç¶²ç«™ <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i></a>
                    </div>
                    <div class="p-6 flex flex-col items-center">
                        <div class="border-2 border-dashed border-blue-200 rounded-2xl p-2 text-center bg-white cursor-pointer hover:bg-blue-50 transition relative group w-48 h-48 flex items-center justify-center shadow-inner">
                            <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="processImage(this, (base64) => { saveVJWImage(base64); })">
                            <div id="vjw-placeholder" class="text-blue-300">
                                <i class="fa-solid fa-qrcode text-4xl mb-3"></i>
                                <p class="text-xs font-bold">é»æ“Šä¸Šå‚³ QR Code</p>
                            </div>
                            <img id="vjw-image" src="" class="hidden w-full h-full object-contain rounded-xl relative z-20 pointer-events-none">
                            <div id="vjw-overlay" class="absolute inset-0 bg-black/40 hidden items-center justify-center z-30 pointer-events-none group-hover:flex rounded-xl transition">
                                 <span class="text-white text-xs font-bold"><i class="fa-solid fa-camera mr-1"></i>æ›´æ›åœ–ç‰‡</span>
                            </div>
                        </div>
                        <button id="vjw-view-btn" onclick="viewVJW()" class="hidden mt-4 bg-blue-500 text-white px-6 py-2 rounded-full shadow-lg shadow-blue-500/30 font-bold text-sm hover:bg-blue-600 transition transform active:scale-95"><i class="fa-solid fa-magnifying-glass-plus mr-2"></i>æ”¾å¤§æª¢è¦–</button>
                    </div>
                </div>

                <!-- Tools & GitHub -->
                <div class="space-y-6">
                    <!-- Tools -->
                    <div class="hand-card p-6 flex justify-around items-center">
                        <a href="https://translate.google.com/?sl=ja&tl=zh-TW&op=images" target="_blank" class="flex flex-col items-center text-gray-500 hover:text-fuji transition group">
                            <div class="w-14 h-14 bg-gray-50 group-hover:bg-fuji/10 rounded-2xl flex items-center justify-center mb-2 text-2xl transition"><i class="fa-solid fa-camera"></i></div>
                            <span class="text-xs font-bold">æ‹ç…§ç¿»è­¯</span>
                        </a>
                        <div class="w-px h-12 bg-gray-200"></div>
                        <a href="https://translate.google.com/?sl=ja&tl=zh-TW&op=translate" target="_blank" class="flex flex-col items-center text-gray-500 hover:text-matcha transition group">
                            <div class="w-14 h-14 bg-gray-50 group-hover:bg-matcha/10 rounded-2xl flex items-center justify-center mb-2 text-2xl transition"><i class="fa-solid fa-language"></i></div>
                            <span class="text-xs font-bold">æ–‡å­—ç¿»è­¯</span>
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-blue-50 transition group">
                            <i class="fa-solid fa-cloud-sun-rain text-3xl text-fuji mb-2 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-sm text-gray-600">å¤©æ°£é å ±</span>
                        </a>
                        <a href="https://www.google.com/maps/search/drugstore" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-pink-50 transition group">
                            <i class="fa-solid fa-store text-3xl text-sakura mb-2 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-sm text-gray-600">é™„è¿‘è—¥å¦</span>
                        </a>
                    </div>

                    <!-- GitHub Sync -->
                    <details class="group hand-card overflow-hidden border border-gray-200">
                        <summary class="flex justify-between items-center p-4 cursor-pointer bg-gray-50 hover:bg-gray-100 transition list-none">
                            <span class="text-xs font-bold text-gray-500 flex items-center gap-2"><i class="fa-brands fa-github text-lg"></i> é›²ç«¯åŒæ­¥è¨­å®š</span>
                            <span class="text-gray-400 group-open:rotate-180 transition text-xs"><i class="fa-solid fa-chevron-down"></i></span>
                        </summary>
                        <div class="p-4 bg-white space-y-3 border-t border-gray-100">
                            <div class="text-[10px] text-gray-400 mb-2">è¨­å®š Gist ID å¾Œï¼Œè³‡æ–™è®Šå‹•å°‡è‡ªå‹•ä¸Šå‚³ã€‚</div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 block mb-1">Gist ID</label>
                                <input type="text" id="gist-id-input" placeholder="Gist ID" class="w-full border p-2 rounded text-xs font-mono bg-gray-50 outline-none focus:border-matcha">
                            </div>
                            <div>
                                 <label class="text-[10px] font-bold text-gray-400 block mb-1">Token</label>
                                 <input type="password" id="gist-token-input" placeholder="Token" class="w-full border p-2 rounded text-xs font-mono bg-gray-50 outline-none focus:border-matcha">
                            </div>
                            <button onclick="saveGistConfig()" class="w-full bg-ink text-white px-3 py-2 rounded text-xs font-bold hover:bg-gray-800 transition">å„²å­˜è¨­å®š</button>
                        </div>
                    </details>
                </div>
            </div>
        </section>
    </main>

    <!-- MODALS -->
    <!-- Flight Modal -->
    <div id="flight-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-3xl p-6 shadow-2xl relative hand-card">
            <button onclick="closeModal('flight-modal')" class="absolute top-3 right-3 text-gray-400 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center handwritten">ç·¨è¼¯èˆªç­</h3>
            <div class="space-y-4">
                <input type="hidden" id="flight-id"> 
                <div class="flex gap-4 items-center">
                    <input type="text" id="flight-dep" placeholder="TPE" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white">
                    <i class="fa-solid fa-plane text-gray-300"></i>
                    <input type="text" id="flight-arr" placeholder="NRT" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white">
                </div>
                <div class="bg-fuji-light p-4 rounded-xl">
                    <input type="text" id="flight-code" placeholder="èˆªç­ä»£è™Ÿ (ä¾‹: IT202)" class="w-full p-2 border-b border-fuji/20 bg-transparent text-center font-bold text-fuji handwritten text-xl mb-2 focus:outline-none placeholder-fuji/40">
                    <input type="text" id="flight-date" placeholder="æ—¥æœŸ (ä¾‹: 1/10 å»ç¨‹)" class="w-full p-1 bg-transparent text-center text-sm font-hand text-gray-500 mb-1 focus:outline-none">
                    <input type="text" id="flight-time" placeholder="æ™‚é–“ (ä¾‹: 14:00 - 18:00)" class="w-full p-1 bg-transparent text-center text-sm font-hand text-gray-500 focus:outline-none">
                </div>
                <input type="url" id="flight-url" placeholder="é€£çµ (e-ticket)" class="w-full p-2 border rounded-lg bg-white text-xs text-center outline-none">
                <button onclick="saveFlight()" class="w-full bg-fuji text-white py-3 rounded-xl font-bold mt-2 shadow-lg shadow-fuji/30 hover:bg-fuji/90 transition handwritten tracking-widest">å„² å­˜</button>
            </div>
        </div>
    </div>

    <!-- Day Modal -->
    <div id="day-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-lg rounded-2xl p-4 shadow-2xl relative hand-card h-[85vh] overflow-y-auto border-4 border-white">
            <button onclick="closeModal('day-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-2 text-center handwritten">ç·¨è¼¯è¡Œç¨‹</h3>
            <input type="hidden" id="day-id-edit">
            <input type="text" id="day-date-edit" class="w-full p-2 border-b-2 border-matcha bg-transparent font-bold mb-4 font-hand text-xl focus:outline-none" placeholder="æ—¥æœŸæ¨™é¡Œ">
            <label class="flex items-center space-x-2 text-sm text-gray-600 mb-4 bg-yellow-50 p-2 rounded"><input type="checkbox" id="day-highlight-edit" class="accent-red-400"><span>æ¨™è¨˜ç‚ºé‡é»å¤©æ•¸ (Highlight)</span></label>
            <div class="mb-4 bg-white p-2 rounded border border-gray-200 shadow-inner"><div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-gray-400">ç•¶æ—¥ç›¸ç‰‡é›†</h4><div class="relative overflow-hidden inline-block"><button class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs hover:bg-gray-200"><i class="fa-solid fa-plus"></i> æ–°å¢</button><input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addDayPhoto(this)"></div></div><div id="day-photos-preview" class="grid grid-cols-3 gap-2"></div></div>
            <div class="mb-4">
                <input type="text" id="day-accommodation-edit" class="w-full p-2 border rounded text-sm mb-2" placeholder="ä½å®¿åœ°é»">
                <input type="url" id="day-accommodation-url-edit" class="w-full p-2 border rounded text-sm" placeholder="Google Maps é€£çµ">
            </div>
            <div class="mb-4 border-t pt-3 bg-gray-50 p-2 rounded-lg border border-gray-100"><h4 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1"><i class="fa-solid fa-train"></i> äº¤é€šæ–¹å¼</h4><div class="flex gap-2 mb-2"><input type="time" id="day-trans-time" class="w-1/3 p-2 border border-gray-300 rounded text-sm"><input type="text" id="day-trans-content" placeholder="å…§å®¹ (å¦‚: æ­æ–°å¹¹ç·š)" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div><div class="flex gap-2 mb-2"><input type="text" id="day-trans-note" placeholder="å‚™è¨» (å¦‚: è²·ç¥¨)" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative hover:bg-white bg-white"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentTransPhoto = base64; document.getElementById('trans-photo-preview').src = base64; document.getElementById('trans-photo-preview').classList.remove('hidden'); document.getElementById('trans-photo-text').classList.add('hidden'); })"><div id="trans-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-ticket mb-1 block"></i> ä¸Šå‚³è»Šç¥¨/æ™‚åˆ»è¡¨</div><img id="trans-photo-preview" class="hidden h-20 mx-auto object-contain rounded"><button onclick="clearTransPhoto()" class="absolute top-1 right-1 bg-gray-200 rounded-full w-5 h-5 text-[10px] text-gray-500 z-10"><i class="fa-solid fa-times"></i></button></div></div>
            <textarea id="day-content-edit" class="w-full h-32 p-3 border rounded-lg bg-white text-sm mb-4 font-hand leading-relaxed" placeholder="è¡Œç¨‹å…§å®¹... (è«‹ç”¨åæ–œç·š '\' åˆ†éš”æ¯é …æ´»å‹•)"></textarea>
            <div class="bg-white p-3 rounded-lg border mb-4 space-y-4 shadow-sm"><h4 class="text-xs font-bold text-gray-400 border-b pb-1">ä¸‰é¤å®‰æ’</h4>
                <div class="border-b pb-2"><div class="flex gap-2 mb-1"><i class="fa-solid fa-mug-hot text-orange-300 w-5"></i><input type="text" id="meal-b-name" placeholder="æ—©é¤" class="flex-1 text-sm font-bold bg-transparent"></div>
                    <div class="flex gap-2 pl-7"><input type="url" id="meal-b-url" placeholder="ç¶²å€ (ç•™ç©ºå‰‡æœå°‹åœ°é»)" class="w-1/2 text-xs border rounded px-1"><input type="text" id="meal-b-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1"></div>
                </div>
                <div class="border-b pb-2"><div class="flex gap-2 mb-1"><i class="fa-solid fa-utensils text-green-400 w-5"></i><input type="text" id="meal-l-name" placeholder="åˆé¤" class="flex-1 text-sm font-bold bg-transparent"></div>
                    <div class="flex gap-2 pl-7"><input type="url" id="meal-l-url" placeholder="ç¶²å€ (ç•™ç©ºå‰‡æœå°‹åœ°é»)" class="w-1/2 text-xs border rounded px-1"><input type="text" id="meal-l-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1"></div>
                </div>
                <div><div class="flex gap-2 mb-1"><i class="fa-solid fa-wine-glass text-purple-400 w-5"></i><input type="text" id="meal-d-name" placeholder="æ™šé¤" class="flex-1 text-sm font-bold bg-transparent"></div>
                    <div class="flex gap-2 pl-7"><input type="url" id="meal-d-url" placeholder="ç¶²å€ (ç•™ç©ºå‰‡æœå°‹åœ°é»)" class="w-1/2 text-xs border rounded px-1"><input type="text" id="meal-d-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1"></div>
                </div>
            </div>
            <textarea id="day-note-edit" class="w-full h-20 p-2 border border-yellow-200 bg-yellow-50 rounded text-sm mb-4 handwritten" placeholder="æ¯æ—¥å‚™è¨»..."></textarea>
            <div class="flex gap-2"><button onclick="deleteDay()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm">åˆªé™¤</button><button onclick="saveDay()" class="flex-[2] bg-matcha text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div>
        </div>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox-modal" class="modal hidden fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal('lightbox-modal')">
        <div class="absolute top-4 right-4 text-white/80 z-50 cursor-pointer bg-white/10 rounded-full w-10 h-10 flex items-center justify-center hover:bg-white/20 transition"><i class="fa-solid fa-times"></i></div>
        <div id="lightbox-container" class="zoom-container w-full h-full flex items-center justify-center" onclick="event.stopPropagation()">
            <img id="lightbox-image" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded" onclick="toggleZoom(this)">
        </div>
    </div>

    <!-- Guide Modal (Updated) -->
    <div id="guide-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('guide-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="font-bold mb-3 handwritten text-lg">æ–°å¢/ç·¨è¼¯æ™¯é»å°è¦½</h3>
            <input type="hidden" id="guide-id">
            <input type="text" id="guide-title" placeholder="æ™¯é»åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold font-hand text-lg focus:border-matcha outline-none">
            <textarea id="guide-desc" placeholder="ä»‹ç´¹å…§å®¹..." class="w-full mb-3 border bg-white p-2 rounded h-24 text-sm"></textarea>
            
            <div class="flex gap-2 mb-3">
                 <input type="text" id="guide-coords" placeholder="åº§æ¨™ (36.34,138.61)" class="w-1/2 border-b bg-transparent p-2 text-xs">
                 <input type="text" id="guide-time" placeholder="ç‡Ÿæ¥­/å»ºè­°æ™‚é–“ (10:00-20:00)" class="w-1/2 border-b bg-transparent p-2 text-xs">
            </div>

            <div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative mb-3 hover:bg-white bg-white/50">
                <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentGuidePhoto = base64; document.getElementById('guide-photo-preview').src = base64; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden'); })">
                <div id="guide-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-image mb-1 block"></i> æ›´æ–°ç…§ç‰‡</div>
                <img id="guide-photo-preview" class="hidden h-32 mx-auto object-cover rounded">
            </div>
            <button onclick="saveGuide()" class="w-full bg-matcha text-white py-2 rounded-lg font-bold">å„²å­˜</button>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expense-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#fffdf9] w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative hand-card border border-white">
            <button onclick="closeModal('expense-modal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-bold mb-6 text-center text-gray-700 tracking-wide">æ–°å¢ç´€éŒ„</h3>
            <input type="hidden" id="ex-id">
            
            <div class="flex justify-between mb-6 overflow-x-auto pb-2 no-scrollbar gap-2" id="expense-categories"></div>

            <div class="flex items-center justify-center gap-2 mb-6">
                <select id="ex-currency" class="bg-gray-100 text-gray-600 font-bold rounded-lg px-2 py-1 outline-none text-sm border-none"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
                <input type="number" id="ex-amount" placeholder="0" class="text-4xl font-bold text-center w-40 outline-none bg-transparent border-b-2 border-gray-100 focus:border-sakura text-gray-700" inputmode="numeric">
            </div>

            <div class="mb-6">
                <label class="block text-xs text-gray-400 mb-2 font-bold ml-1">ä»˜æ¬¾äºº (å¯å¤šé¸)</label>
                <div id="ex-payer-container" class="flex flex-wrap gap-2"></div>
                <input type="hidden" id="ex-payers-json" value="[]">
            </div>

            <div class="mb-4">
                 <input type="text" id="ex-note" placeholder="å‚™è¨»èªªæ˜..." class="w-full bg-gray-50 rounded-xl p-3 text-sm outline-none border border-gray-100 focus:bg-white focus:border-sakura transition">
            </div>

            <div class="flex gap-3 items-center mb-6">
                 <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 relative overflow-hidden cursor-pointer hover:bg-gray-200 transition flex-shrink-0">
                     <i class="fa-solid fa-camera"></i>
                     <input type="file" id="ex-photo" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentPhotoBase64 = base64; document.getElementById('ex-photo-preview-mini').src = base64; document.getElementById('ex-photo-preview-mini').classList.remove('hidden'); })">
                     <img id="ex-photo-preview-mini" class="hidden absolute inset-0 w-full h-full object-cover">
                 </div>
                 <span class="text-xs text-gray-400">ä¸Šå‚³æ”¶æ“š (é¸å¡«)</span>
            </div>

            <div class="flex gap-3">
                <button onclick="deleteExpense()" id="btn-delete-expense" class="w-12 h-12 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center hover:bg-red-100 hover:text-red-400 transition hidden"><i class="fa-solid fa-trash-can"></i></button>
                <button onclick="saveExpense()" class="flex-1 bg-ink text-white py-3 rounded-full font-bold shadow-lg hover:bg-gray-800 transition transform active:scale-95">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- Wallet Detail Modal -->
    <div id="wallet-detail-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#fffdf9] w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative hand-card">
            <button onclick="closeModal('wallet-detail-modal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <div id="wallet-detail-content"></div>
            <div class="mt-4 relative h-48 w-full flex justify-center items-center">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Shopping Modal -->
    <div id="shopping-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card"><button onclick="closeModal('shopping-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-bold mb-3 text-center">è³¼ç‰©é …ç›®</h3><input type="hidden" id="shop-id"><input type="text" id="shop-name" placeholder="å•†å“åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold"><div class="flex gap-2 mb-3"><div class="flex-1"><label class="text-xs text-gray-400">æ•¸é‡</label><input type="number" id="shop-qty" value="1" class="w-full border rounded p-2 text-sm"></div><div class="flex-[2]"><label class="text-xs text-gray-400">å–®åƒ¹ (JPY)</label><input type="number" id="shop-price" placeholder="0" class="w-full border rounded p-2 text-sm"></div></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center relative mb-4 bg-white"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentShopPhoto = base64; document.getElementById('shop-photo-preview').src = base64; document.getElementById('shop-photo-preview').classList.remove('hidden'); document.getElementById('shop-photo-text').classList.add('hidden'); })"><div id="shop-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-camera mb-1 block"></i> ç…§ç‰‡</div><img id="shop-photo-preview" class="hidden h-32 mx-auto object-contain rounded"></div><div class="flex gap-2"><button onclick="deleteShoppingItem()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg">åˆªé™¤</button><button onclick="saveShoppingItem()" class="flex-[2] bg-red-400 text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div></div></div>
    
    <!-- Must Eat Modal -->
    <div id="must-eat-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('must-eat-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center text-matcha">ğŸ½ï¸ ç·¨è¼¯å¿…åƒåœ°é»</h3>
            <input type="hidden" id="eat-loc-id">
            <div class="mb-4">
                <label class="text-xs text-gray-400 block mb-1">åœ°é»åç¨±</label>
                <input type="text" id="eat-location" placeholder="ä¾‹å¦‚: è¼•äº•æ¾¤ã€ç¯‰åœ°å¸‚å ´" class="w-full p-2 border-b-2 border-matcha/50 bg-transparent font-bold text-lg focus:outline-none">
            </div>
            
            <label class="text-xs text-gray-400 block mb-2">ä¸»é¡Œ/é¤å»³åˆ—è¡¨</label>
            <div id="eat-themes-container" class="space-y-3 mb-4">
                <!-- Injected JS -->
            </div>
            
            <button onclick="addThemeRow()" class="w-full py-2 border-2 border-dashed border-matcha/30 text-matcha rounded-lg text-sm font-bold mb-4 hover:bg-matcha/10 transition"><i class="fa-solid fa-plus"></i> æ–°å¢ä¸»é¡Œ</button>

            <div class="flex gap-2">
                <button onclick="deleteMustEatLocation()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hover:bg-red-100">åˆªé™¤æ•´çµ„</button>
                <button onclick="saveMustEatLocation()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow hover:bg-fuji/80">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- IOU Modal -->
    <div id="iou-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto"><button onclick="closeModal('iou-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center text-fuji">ğŸ¤ æ‰‹å‹•æ¬ æ¬¾/å€Ÿæ¬¾</h3><input type="hidden" id="iou-id"><div class="space-y-3 p-3 border rounded-lg bg-white mb-4"><div class="text-xs text-gray-500 mb-1">èª°å€Ÿçµ¦èª°ï¼Ÿ</div><div class="flex gap-2"><div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µæ¬Šäºº</label><select id="iou-creditor" class="w-full bg-white border rounded p-1 text-sm"></select></div><div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µå‹™äºº</label><select id="iou-debtor" class="w-full bg-white border rounded p-1 text-sm"></select></div></div><div class="flex items-center gap-2 bg-gray-50 border rounded p-2"><span class="font-bold text-sm">TWD</span><input type="number" id="iou-amount" placeholder="é‡‘é¡" class="flex-1 text-lg text-right w-full bg-transparent" inputmode="numeric"></div><input type="text" id="iou-note" placeholder="å‚™è¨»" class="w-full p-2 border rounded text-sm"><div class="flex gap-2 mt-3"><button onclick="deleteIOU()" id="btn-delete-iou" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden">åˆªé™¤</button><button onclick="saveIOU()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div></div><h4 class="text-sm font-bold text-gray-600 mb-2">åˆ—è¡¨:</h4><div id="iou-list-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner"></div></div></div>
    
    <!-- Member Modal -->
    <div id="member-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg"><h4 class="font-bold mb-3 text-center">ç®¡ç†æˆå“¡èˆ‡é ­åƒ</h4><div id="member-list" class="space-y-2 mb-3 max-h-60 overflow-y-auto"></div><div class="flex gap-2"><input type="text" id="new-payer-name" placeholder="æ–°æˆå“¡åç¨±" class="flex-1 border p-1 text-sm rounded"><button onclick="addPayer()" class="bg-matcha text-white px-3 rounded text-sm">æ–°å¢</button></div><button onclick="closeModal('member-modal')" class="w-full mt-3 bg-gray-200 py-1 rounded text-sm">é—œé–‰</button></div></div>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#f9f7f2]/95 border-t border-gray-200 pt-2 pb-safe px-6 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] backdrop-blur-sm" style="padding-bottom: calc(10px + var(--sab));">
        <div class="flex justify-between items-center w-full mx-auto pb-1 max-w-lg">
            <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center text-gray-400 transition flex-1" data-target="plan"><i class="fa-solid fa-map text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è¡Œç¨‹</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="guide"><i class="fa-solid fa-book-open text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">å°è¦½</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="wallet"><i class="fa-solid fa-wallet text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è¨˜å¸³</span></button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="lists"><i class="fa-solid fa-list-check text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">æ¸…å–®</span></button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="info"><i class="fa-solid fa-circle-info text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è³‡è¨Š</span></button>
        </div>
    </nav>

    <!-- JAVASCRIPT -->
    <script>
        // --- PRELOADED GUIDES ---
        const PRELOADED_GUIDES = [
            {id: 101, title: "è¼•äº•æ¾¤ç‹å­è³¼ç‰©å»£å ´", desc: "å¿…é€›ï¼è¶…å¤§ Outletï¼Œå°±åœ¨è¼•äº•æ¾¤è»Šç«™å—å£ã€‚\n\næ¨è–¦å“ç‰Œï¼š\n- BEAMS\n- Nike / Adidas\n- Gucci\n- Le Creuset (é‹å…·)\n\nç¾é£Ÿè¡— (Food Court) åœ¨ä¸­é–“å€åŸŸï¼Œæœ‰ä¿¡å·çŸ¥åçš„é†¬æ±è±¬æ’ä¸¼ã€‚", photo: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Karuizawa_Prince_Shopping_Plaza_East.JPG/1200px-Karuizawa_Prince_Shopping_Plaza_East.JPG", coords: "36.3418, 138.6366", time: "10:00 - 19:00"},
            {id: 102, title: "çŸ³ä¹‹æ•™å ‚", desc: "å…§æ‘é‘‘ä¸‰ç´€å¿µå ‚ï¼Œç”±çŸ³é ­èˆ‡ç»ç’ƒå»ºæˆçš„æœ‰æ©Ÿå»ºç¯‰ã€‚\n\näº¤é€šï¼š\nå¾è¼•äº•æ¾¤ç«™æ­ä¹˜æ˜Ÿé‡æ¥é§è»Šï¼Œæˆ–å¾ä¸­è¼•äº•æ¾¤ç«™æ­¥è¡Œ 20 åˆ†é˜ã€‚\n\næ³¨æ„ï¼š\nå¦‚æœæ­£å¥½æœ‰å©šç¦®èˆ‰è¡Œï¼Œå¯èƒ½ç„¡æ³•é€²å…¥åƒè§€ï¼Œåªèƒ½åœ¨å¤–é¢æ‹ç…§ã€‚", photo: "https://www.stonechurch.jp/images/top/main_01_sp.jpg", coords: "36.3605, 138.5985", time: "09:00 - 18:00"},
            {id: 103, title: "æ˜Ÿé‡æ¦†æ¨¹è¡—å°é®", desc: "Harunire Terraceã€‚\nç”±æœ¨æ£§é“é€£æ¥çš„ 9 é–“åº—é‹ªï¼Œéå¸¸æœ‰æ°›åœã€‚\n\næ¨è–¦ï¼š\n- ä¸¸å±±å’–å•¡ (Maruyama Coffee)\n- å·ä¸Šåºµ (è•éº¥éºµ)\n- æ²¢æ‘ (SAWAMURA) éºµåŒ…åº—", photo: "https://www.hoshino-area.jp/wp/wp-content/uploads/2021/04/0002.jpg", coords: "36.3592, 138.5960", time: "08:00 - 22:00"},
            {id: 104, title: "æ·ºè‰é›·é–€", desc: "æ±äº¬æœ€è‘—åçš„åœ°æ¨™ã€‚\n\nå¿…åƒï¼š\n- ä»²è¦‹ä¸–é€šçš„äººå½¢ç‡’\n- ç‚¸è‚‰é¤…\n- æŠ¹èŒ¶å†°æ·‡æ·‹\n\nå»ºè­°ä¸€æ—©å°±å»ï¼Œé¿é–‹äººæ½®ã€‚", photo: "https://live.staticflickr.com/65535/51866385172_9780a42e5d_b.jpg", coords: "35.7111, 139.7963", time: "å…¨å¤©é–‹æ”¾"},
            {id: 105, title: "ç¯‰åœ°å¸‚å ´", desc: "é›–ç„¶å ´å…§å¸‚å ´å·²æ¬åˆ°è±æ´²ï¼Œä½†ã€Œå ´å¤–å¸‚å ´ã€ä¾ç„¶ç†±é¬§ï¼Œæ˜¯åƒæµ·é®®çš„å¥½å»è™•ã€‚\n\nå¿…åƒï¼š\n- ç‰å­ç‡’ (å±±é•·/ä¸¸æ­¦)\n- æµ·é®®ä¸¼\n- çƒ¤å’Œç‰›ä¸²\n- é£¯ç³°", photo: "https://a3.cdn.japantravel.com/photo/43679/178556/japantravel-jpg-178556.jpg", coords: "35.6654, 139.7706", time: "05:00 - 14:00"},
            {id: 106, title: "æ–°å®¿", desc: "è³¼ç‰©èˆ‡ç¾é£Ÿçš„ä¸€ç´šæˆ°å€ã€‚\n\næ™¯é»ï¼š\n- å“¥å‰æ‹‰é ­ (æ ¼æ‹‰æ–¯éº—æ–°å®¿é…’åº—)\n- 3D è²“ (æ–°å®¿æ±å£)\n- æ±äº¬éƒ½å»³ (å…è²»å¤œæ™¯)\n- æ­Œèˆä¼ç”º", photo: "https://rimage.gnst.jp/livejapan.com/public/article/detail/a/00/01/a0001007/img/basic/a0001007_main.jpg", coords: "35.6909, 139.7005", time: "å…¨å¤©é–‹æ”¾"},
             {id: 107, title: "æ±äº¬ç«™", desc: "ç´…ç£šå»ºç¯‰ä¸¸ä¹‹å…§å£è¶…å¥½æ‹ã€‚\n\nè³¼ç‰©ï¼š\n- æ±äº¬ä¸€ç•ªè¡— (æ‹‰éºµè¡—ã€å‹•æ¼«è¡—)\n- å¤§ä¸¸ç™¾è²¨ (ç”œé»ä¼´æ‰‹ç¦®)\n\nå¿…è²·ä¼´æ‰‹ç¦®ï¼š\n- NY Perfect Cheese\n- Press Butter Sand", photo: "https://upload.wikimedia.org/wikipedia/commons/b/b3/Tokyo_Station_Marunouchi_Building_201802.jpg", coords: "35.6812, 139.7671", time: "å…¨å¤©é–‹æ”¾"}
        ];

        let flights = [], itinerary = [], mustEatList = [], expenses = [], guides = [], todos = [], shoppingList = [], payers = [], manualDebts = [], memoText = "";
        let payerProfiles = {}; // Name -> Base64
        let publicFundConfig = { initial: 0, currency: 'JPY' };
        let vjwImage = "";
        let myChart = null; 

        let gistToken = localStorage.getItem('gist_token') || "";
        let gistId = localStorage.getItem('gist_id') || "";
        const GIST_FILE_NAME = "travel_data.json";
        window.autoUploadTimer = null;

        const expenseCategories = [
            { id: 'é¤é£²', icon: 'fa-utensils', color: 'bg-yellow-100 text-yellow-600', hex: '#fcd34d' },
            { id: 'äº¤é€š', icon: 'fa-train-subway', color: 'bg-blue-100 text-blue-600', hex: '#60a5fa' },
            { id: 'è³¼ç‰©', icon: 'fa-bag-shopping', color: 'bg-pink-100 text-pink-600', hex: '#f472b6' },
            { id: 'é–€ç¥¨', icon: 'fa-ticket', color: 'bg-green-100 text-green-600', hex: '#4ade80' },
            { id: 'ä½å®¿', icon: 'fa-bed', color: 'bg-purple-100 text-purple-600', hex: '#a78bfa' },
            { id: 'å…¶ä»–', icon: 'fa-asterisk', color: 'bg-gray-100 text-gray-600', hex: '#9ca3af' }
        ];

        // RECOVERY DATA
        const RECOVERED_ITINERARY = [{"id":"day_1","date":"1/10 Day 1 æˆç”°","highlight":false,"content":"18:00 æŠµé”æˆç”°æ©Ÿå ´\nAeon Mall è¶…å¸‚åƒé€›","accommodation":"æˆç”°æ©Ÿå ´å‘¨é‚Š","accommodationUrl":"","transportation":{"content":"æ­ä¹˜ Skyliner","note":"äº‹å…ˆè²·ç¥¨","time":"18:40"},"meals":{"b":{"name":""},"l":{"name":""},"d":{"name":"è¶…å¸‚ä¾¿ç•¶"}},"photos":[],"dayNote":""},{"id":"day_2","date":"Day 2 æ–°å®¿","highlight":false,"content":"æ·ºè‰é›·é–€\næ–°å®¿ (æ–°å®¿ç´ é£Ÿæ‹‰éºµ / 3Dè²“ / å“¥å‰æ‹‰)\næ±äº¬éƒ½å»³å…è²»å¤œæ™¯","accommodation":"æ±äº¬å¸‚å€","accommodationUrl":"","transportation":{"content":"","note":"","time":""},"meals":{"b":{"name":"è¶…å•†"},"l":{"name":"æ–°å®¿ç´ é£Ÿæ‹‰éºµ"},"d":{"name":"è‡ªç†"}},"photos":[],"dayNote":""},{"id":"day_3","date":"Day 3 ç¯‰åœ°","highlight":false,"content":"ç¯‰åœ°å¸‚å ´ (ç¯‰åœ°é£¯ç³°)\nåƒå®¢è¬ä¾†ï¼ˆè¶³æµ´ï¼‰æˆ–è±æ´²å¸‚å ´\nteamLab è±æ´²\né˜¿ç¾æ©«ä¸","accommodation":"æ±äº¬å¸‚å€","accommodationUrl":"","transportation":{"content":"","note":"","time":""},"meals":{"b":{"name":"ç¯‰åœ°é£¯ç³°"},"l":{"name":"è±æ´²å¸‚å ´"},"d":{"name":"é˜¿ç¾æ©«ä¸å±…é…’å±‹"}},"photos":[],"dayNote":""},{"id":"day_4","date":"Day 4 è¼•äº•æ¾¤","highlight":true,"content":"è»Šç«™å¯„è¡Œæ\nè¼•äº•æ¾¤ Outlet çˆ†è²·\nç©é›ª (Snow Park)\nCheck-in","accommodation":"Cypress è¼•äº•æ¾¤","accommodationUrl":"","transportation":{"content":"æ–°å¹¹ç·šå¾€è¼•äº•æ¾¤","note":"æŒ‡å®šå¸­","time":"09:00"},"meals":{"b":{"name":"æ–°å¹¹ç·šä¾¿ç•¶"},"l":{"name":"Outletç¾é£Ÿè¡—"},"d":{"name":"é£¯åº—è‡ªåŠ©é¤"}},"dayNote":"è¨˜å¾—æˆ´æ‰‹å¥—","photos":[]},{"id":"day_5","date":"Day 5 è¼•äº•æ¾¤","highlight":false,"content":"å–®è»Šæ¼«éŠæ˜Ÿé‡æ¦†æ¨¹è¡—\nåˆé¤\nèœ»èœ“ä¹‹æ¹¯\nçŸ³ä¹‹æ•™å ‚ / é«˜åŸæ•™æœƒ\nå›é£¯åº—","accommodation":"Cypress è¼•äº•æ¾¤","accommodationUrl":"","transportation":{"content":"","note":"","time":""},"meals":{"b":{"name":"é£¯åº—"},"l":{"name":"æ‘æ°‘é£Ÿå ‚"},"d":{"name":"è‡ªç†"}},"photos":[],"dayNote":""},{"id":"day_6","date":"Day 6 æ±äº¬ç«™","highlight":false,"content":"èµ°å»é›²å ´æ± \n10:00 é€€æˆ¿\næ–°å¹¹ç·šå›æ±äº¬\næ±äº¬ç«™é£¯åº—æ”¾è¡Œæ\n17:00 æ±äº¬éµå¡” RED TOKYO TOWER (æ˜Ÿå…‰ç¥¨)","accommodation":"æ±äº¬ç«™é£¯åº—","accommodationUrl":"","transportation":{"content":"NEX æˆç”°ç‰¹å¿«","note":"æ”¾è¡Œæå¾Œå†æ­ä¹˜","time":"15:30"},"meals":{"b":{"name":"éºµåŒ…"},"l":{"name":"è•éº¥éºµ"},"d":{"name":"æ±äº¬éµå¡”å‘¨é‚Š"}},"photos":[],"dayNote":""},{"id":"day_7","date":"Day 7 æˆç”°æ©Ÿå ´","highlight":false,"content":"æ±äº¬ç«™æœ€å¾Œè£œè²¨\n18:25 é£›æ©Ÿ (è¿”å°)","accommodation":"","accommodationUrl":"","transportation":{"content":"NEX æˆç”°ç‰¹å¿«å¾€æ©Ÿå ´","note":"","time":"15:30"},"meals":{"b":{"name":""},"l":{"name":""},"d":{"name":"æ©Ÿä¸Šé¤"}},"photos":[],"dayNote":""}];
        const RECOVERED_FLIGHTS = [{"id":1764787819658,"dep":"TPE","arr":"NRT","code":"IT202","time":"14:00 - 18:00","date":"1/10 å»ç¨‹","url":""},{"id":1764787837787,"dep":"NRT","arr":"TPE","code":"IT203","time":"18:20 - 19:55","date":"1/16 è¿”ç¨‹","url":""}];
        const RECOVERED_PAYERS = ["æˆ‘", "æ—…ä¼´", "å…¬è²»"];
        const RECOVERED_TODOS = [{"text":"è­·ç…§","done":false}];

        // Data Migration Logic (V36 -> V37)
        function migrateMustEatList(oldList) {
            if (!oldList.length) return [];
            if (oldList[0].themes) return oldList;

            console.log("Migrating Must Eat List...");
            const grouped = {};
            oldList.forEach(item => {
                const loc = item.location || "æœªåˆ†é¡";
                if (!grouped[loc]) grouped[loc] = [];
                let noteText = item.note || "";
                if (item.items && item.items.length) {
                    noteText += "\n" + item.items.map(i => `- ${i.foodName}`).join("\n");
                }
                grouped[loc].push({
                    id: 'theme_' + Date.now() + Math.random(),
                    name: item.name,
                    url: "", 
                    note: noteText.trim()
                });
            });

            const newList = [];
            for (const [loc, themes] of Object.entries(grouped)) {
                newList.push({
                    id: 'loc_' + Date.now() + Math.random(),
                    location: loc,
                    themes: themes
                });
            }
            return newList;
        }

        // Core Functions
        function reloadLocalData() {
            flights = JSON.parse(localStorage.getItem('flights')) || RECOVERED_FLIGHTS;
            itinerary = JSON.parse(localStorage.getItem('itinerary_v2')) || RECOVERED_ITINERARY;
            let rawMustEat = JSON.parse(localStorage.getItem('mustEatList')) || [];
            mustEatList = migrateMustEatList(rawMustEat);
            expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            guides = JSON.parse(localStorage.getItem('guides')) || [];
            if (guides.length === 0) guides = [...PRELOADED_GUIDES];
            todos = JSON.parse(localStorage.getItem('todos')) || RECOVERED_TODOS;
            shoppingList = JSON.parse(localStorage.getItem('shoppingList_v2')) || [];
            payers = JSON.parse(localStorage.getItem('payers')) || RECOVERED_PAYERS;
            if(!payers.includes("å…¬è²»")) payers.push("å…¬è²»");
            payerProfiles = JSON.parse(localStorage.getItem('payerProfiles')) || {};
            manualDebts = JSON.parse(localStorage.getItem('manualDebts_v1')) || [];
            memoText = localStorage.getItem('memo') || "";
            publicFundConfig = JSON.parse(localStorage.getItem('publicFundConfig')) || { initial: 0, currency: 'JPY' };
            vjwImage = localStorage.getItem('vjwImage') || "";
        }

        function saveData() {
            localStorage.setItem('flights', JSON.stringify(flights));
            localStorage.setItem('itinerary_v2', JSON.stringify(itinerary));
            localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('guides', JSON.stringify(guides));
            localStorage.setItem('todos', JSON.stringify(todos));
            localStorage.setItem('shoppingList_v2', JSON.stringify(shoppingList));
            localStorage.setItem('payers', JSON.stringify(payers));
            localStorage.setItem('payerProfiles', JSON.stringify(payerProfiles));
            localStorage.setItem('manualDebts_v1', JSON.stringify(manualDebts));
            localStorage.setItem('memo', memoText); 
            localStorage.setItem('publicFundConfig', JSON.stringify(publicFundConfig));
            localStorage.setItem('vjwImage', vjwImage);
            if (gistId && gistToken) { clearTimeout(window.autoUploadTimer); window.autoUploadTimer = setTimeout(forceUpload, 2000); }
        }

        function forceDownload() {
            if(!gistId || !gistToken) { updateCloudStatus("æœªé€£ç·š"); return; }
            updateCloudStatus("ä¸‹è¼‰ä¸­...");
            fetch(`https://api.github.com/gists/${gistId}`, { method: 'GET', headers: { 'Authorization': `token ${gistToken}` } })
            .then(res => res.json())
            .then(data => {
                const cloud = JSON.parse(data.files[GIST_FILE_NAME].content);
                let cloudGuides = cloud.guides || [];
                if (cloudGuides.length === 0) cloudGuides = [...PRELOADED_GUIDES];
                localStorage.setItem('flights',JSON.stringify(cloud.flights || []));
                localStorage.setItem('itinerary_v2',JSON.stringify(cloud.itinerary || []));
                const migratedMustEat = migrateMustEatList(cloud.mustEatList || []);
                localStorage.setItem('mustEatList',JSON.stringify(migratedMustEat));
                localStorage.setItem('expenses',JSON.stringify(cloud.expenses || []));
                localStorage.setItem('guides',JSON.stringify(cloudGuides));
                localStorage.setItem('todos',JSON.stringify(cloud.todos || []));
                localStorage.setItem('shoppingList_v2',JSON.stringify(cloud.shoppingList || []));
                localStorage.setItem('payers',JSON.stringify(cloud.payers || []));
                localStorage.setItem('payerProfiles',JSON.stringify(cloud.payerProfiles || {}));
                localStorage.setItem('manualDebts_v1',JSON.stringify(cloud.manualDebts || []));
                localStorage.setItem('memo',cloud.memo || "");
                localStorage.setItem('publicFundConfig', JSON.stringify(cloud.publicFundConfig || {initial: 0, currency: 'JPY'}));
                localStorage.setItem('vjwImage', cloud.vjwImage || "");
                updateCloudStatus("åŒæ­¥æˆåŠŸ");
                window.refreshUI();
            }).catch(e => { console.error(e); updateCloudStatus("ä¸‹è¼‰å¤±æ•—"); });
        }
        
        async function forceUpload() {
            if(!gistId || !gistToken) return;
            updateCloudStatus("ä¸Šå‚³ä¸­...");
            const payload = { flights, itinerary, mustEatList, expenses, guides, todos, shoppingList, payers, payerProfiles, manualDebts, memo: memoText, publicFundConfig, vjwImage, lastUpdate: new Date().toISOString() };
            try {
                await fetch(`https://api.github.com/gists/${gistId}`, { method: 'PATCH', headers: { 'Authorization': `token ${gistToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ files: { [GIST_FILE_NAME]: { content: JSON.stringify(payload) } } }) });
                updateCloudStatus("ä¸Šå‚³æˆåŠŸ");
            } catch (e) { updateCloudStatus("ä¸Šå‚³å¤±æ•—"); }
        }
        function updateCloudStatus(msg) {
            const s = document.getElementById('cloud-status');
            s.innerHTML = `<i class="fa-brands fa-github"></i> <span>${msg}</span>`;
            if (msg.includes("æˆåŠŸ") || msg.includes("åŒæ­¥")) s.className = "text-[10px] bg-matcha/50 text-green-800 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-green-200 cursor-default";
            else if (msg.includes("å¤±æ•—")) s.className = "text-[10px] bg-red-100 text-red-500 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-red-200 cursor-default";
            else s.className = "text-[10px] bg-gray-100 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 cursor-default";
            setTimeout(() => { if(s.innerText.includes("æˆåŠŸ")) s.className = "text-[10px] bg-gray-100 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 cursor-default"; }, 3000);
        }
        function saveGistConfig() {
            const id = document.getElementById('gist-id-input').value.trim();
            const token = document.getElementById('gist-token-input').value.trim();
            if(!id || !token) { alert("å¿…å¡«"); return; }
            localStorage.setItem('gist_id', id); localStorage.setItem('gist_token', token);
            gistId = id; gistToken = token;
            alert("è¨­å®šå·²å„²å­˜"); forceDownload(); 
        }

        window.refreshUI = function() { reloadLocalData(); renderFlights(); renderItinerary(); renderGuides(); renderExpenses(); renderMustEatList(); renderChecklist(); renderShoppingList(); document.getElementById('memo-pad').value = memoText; renderVJW(); if(gistId){document.getElementById('gist-id-input').value=gistId;document.getElementById('gist-token-input').value=gistToken;} }

        // Common UI
        function openModal(id){document.getElementById(id).classList.remove('hidden');setTimeout(()=>document.getElementById(id).classList.add('visible'),10);}
        function closeModal(id){const el=document.getElementById(id);el.classList.remove('visible');setTimeout(()=>el.classList.add('hidden'),200);}
        function switchTab(t){
            document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden'));
            document.getElementById('view-'+t).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            document.querySelector(`[data-target="${t}"]`).classList.add('active');
            window.scrollTo(0,0);
        }
        let currentPhotoBase64 = null; let currentGuidePhoto = null; let currentShopPhoto = null; let currentTransPhoto = null; let tempDayPhotos = [];
        function processImage(input, cb) { if(input.files && input.files[0]){ const r=new FileReader(); r.onload=function(e){const i=new Image();i.onload=function(){const c=document.createElement('canvas'),x=c.getContext('2d'),w=1000;let wd=i.width,ht=i.height;if(wd>w){ht*=w/wd;wd=w;}c.width=wd;c.height=ht;x.drawImage(i,0,0,wd,ht);cb(c.toDataURL('image/jpeg',0.8));};i.src=e.target.result;};r.readAsDataURL(input.files[0]); } }
        function viewPhoto(src) { document.getElementById('lightbox-image').src = src; document.getElementById('lightbox-image').classList.remove('zoomed'); document.getElementById('lightbox-container').classList.remove('zoomed-mode'); openModal('lightbox-modal'); }
        function toggleZoom(img) { if(img.classList.contains('zoomed')){img.classList.remove('zoomed');img.classList.add('max-w-full','max-h-full');img.parentElement.classList.remove('zoomed-mode');}else{img.classList.add('zoomed');img.classList.remove('max-w-full','max-h-full');img.parentElement.classList.add('zoomed-mode');} }

        /* ITINERARY */
        function renderItinerary() {
            const c=document.getElementById('itinerary-container'); c.innerHTML='';
            itinerary.forEach((day)=>{
                let content=day.content.split('\n').map(line => {
                    const trimmed = line.trim(); if(!trimmed) return '';
                    let linkedLine = trimmed;
                    // Auto-link guides
                    guides.forEach(g => {
                        if(trimmed.includes(g.title)) {
                            linkedLine = trimmed.replace(g.title, `<span class="itinerary-link" onclick="jumpToGuide(${g.id})">${g.title}</span>`);
                        }
                    });
                    return `<li class="flex items-start text-base"><span class="mr-2 mt-2 w-2 h-2 bg-sakura rounded-full flex-shrink-0 border border-red-200"></span><span class="flex-1">${linkedLine}</span></li>`;
                }).join('');

                const mealButtons = ['b', 'l', 'd'].map(type => {
                    const meal = day.meals[type]; if (!meal || !meal.name) return '';
                    const conf = { b: {icon:'fa-mug-hot',c:'orange'}, l: {icon:'fa-utensils',c:'green'}, d: {icon:'fa-wine-glass',c:'purple'} }[type];
                    return `<div class="inline-flex items-center text-xs rounded-full border shadow-sm overflow-hidden bg-${conf.c}-50 border-${conf.c}-100 mr-2 mb-2">
                        <button onclick="switchTab('wallet'); openExpenseModal(null, {note: '${meal.name}', cat: 'é¤é£²'})" class="px-2 py-1.5 hover:bg-${conf.c}-200 text-${conf.c}-600 border-r border-${conf.c}-200"><i class="fa-solid ${conf.icon}"></i></button>
                        <a href="${meal.url || 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(meal.name)}" target="_blank" class="px-3 py-1.5 text-${conf.c}-700 hover:bg-${conf.c}-100 font-maru font-medium tracking-wide">${meal.name}</a>
                    </div>`;
                }).join('');
                
                const photosHtml = day.photos?.length ? `<div class="mt-3 grid grid-cols-3 gap-1 rounded-lg overflow-hidden">${day.photos.map(p=>`<img src="${p}" class="w-full aspect-square object-cover cursor-pointer hover:opacity-90" onclick="viewPhoto('${p}')">`).join('')}</div>` : '';
                const trans = day.transportation.content ? `<div class="mt-3 bg-[#f8f9fa] border-l-4 border-gray-300 p-2 pl-3 rounded-r text-sm flex gap-3 shadow-sm items-start"><i class="fa-solid fa-train text-gray-400 mt-1"></i><div><div class="font-bold text-gray-700 font-hand text-base">${day.transportation.time||''} ${day.transportation.content}</div><div class="text-xs text-gray-400">${day.transportation.note||''}</div>${day.transportation.photo?`<img src="${day.transportation.photo}" class="mt-2 h-16 w-auto rounded border" onclick="viewPhoto('${day.transportation.photo}')">`:''}</div></div>` : '';
                let accLink = day.accommodation ? `<a href="${day.accommodationUrl || 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(day.accommodation)}" target="_blank" class="text-indigo-500 font-bold hover:underline flex items-center gap-1"><i class="fa-solid fa-location-dot"></i> ${day.accommodation} <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a>` : '';

                c.innerHTML+=`<div class="relative pl-8 border-l-2 ${day.highlight?'border-sakura':'border-gray-200'} pb-8 group">
                    <div class="absolute -left-2.5 top-0 w-5 h-5 rounded-full ${day.highlight?'bg-sakura':'bg-gray-300'} border-4 border-paper shadow-sm"></div>
                    <div class="flex justify-between mb-2 items-end">
                        <h3 class="font-black text-2xl handwritten ${day.highlight?'text-red-400':'text-pencil'}">${day.date}</h3>
                        <button onclick="openDayEditor('${day.id}')" class="text-gray-300 hover:text-fuji transition"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 relative">
                        ${day.highlight?`<div class="absolute -top-2 -right-2 text-2xl opacity-50 rotate-12">ğŸŒ¸</div>`:''}
                        <ul class="text-sm space-y-3 leading-relaxed text-gray-700 font-maru font-bold text-lg">${content}</ul>
                        ${photosHtml}${trans}
                        ${accLink ? `<div class="mt-3 pt-2 border-t border-dashed border-gray-200 text-xs">${accLink}</div>` : ''}
                        ${mealButtons ? `<div class="mt-2 flex flex-wrap">${mealButtons}</div>` : ''}
                    </div>
                </div>`;
            });
        }
        function jumpToGuide(id) {
            switchTab('guide');
            setTimeout(() => {
                const el = document.getElementById(`guide-${id}`);
                if(el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('animate-highlight');
                    setTimeout(() => el.classList.remove('animate-highlight'), 2000);
                }
            }, 300);
        }
        function openDayEditor(id){ const d=itinerary.find(i=>i.id===id); if(!d)return; document.getElementById('day-id-edit').value=d.id; document.getElementById('day-date-edit').value=d.date; document.getElementById('day-highlight-edit').checked=d.highlight; document.getElementById('day-content-edit').value=d.content; document.getElementById('day-accommodation-edit').value=d.accommodation; document.getElementById('day-accommodation-url-edit').value=d.accommodationUrl; document.getElementById('day-trans-content').value=d.transportation?.content||''; document.getElementById('day-trans-note').value=d.transportation?.note||''; document.getElementById('day-trans-time').value=d.transportation?.time||''; currentTransPhoto=d.transportation?.photo; document.getElementById('day-note-edit').value=d.dayNote||''; tempDayPhotos = d.photos ? [...d.photos] : []; renderDayPhotosPreview(); ['b','l','d'].forEach(t=>{document.getElementById('meal-'+t+'-name').value=d.meals[t].name;document.getElementById('meal-'+t+'-url').value=d.meals[t].url;document.getElementById('meal-'+t+'-note').value=d.meals[t].note;}); openModal('day-modal'); }
        function saveDay(){ const idx=itinerary.findIndex(i=>i.id===document.getElementById('day-id-edit').value); if(idx<0)return; const i=itinerary[idx]; i.date=document.getElementById('day-date-edit').value; i.highlight=document.getElementById('day-highlight-edit').checked; i.content=document.getElementById('day-content-edit').value; i.accommodation=document.getElementById('day-accommodation-edit').value; i.accommodationUrl=document.getElementById('day-accommodation-url-edit').value; i.transportation={content:document.getElementById('day-trans-content').value, note:document.getElementById('day-trans-note').value, time:document.getElementById('day-trans-time').value, photo:currentTransPhoto}; i.dayNote=document.getElementById('day-note-edit').value; i.photos=[...tempDayPhotos]; i.meals={b:{name:document.getElementById('meal-b-name').value,url:document.getElementById('meal-b-url').value,note:document.getElementById('meal-b-note').value},l:{name:document.getElementById('meal-l-name').value,url:document.getElementById('meal-l-url').value,note:document.getElementById('meal-l-note').value},d:{name:document.getElementById('meal-d-name').value,url:document.getElementById('meal-d-url').value,note:document.getElementById('meal-d-note').value}}; saveData(); renderItinerary(); closeModal('day-modal'); }
        function addNewDay(){itinerary.push({id:'day_'+Date.now(),date:"New Day",highlight:false,content:"...",accommodation:"",transportation:{},meals:{b:{},l:{},d:{}}}); saveData(); renderItinerary();}
        function deleteDay(){if(confirm("Del?")){itinerary=itinerary.filter(d=>d.id!==document.getElementById('day-id-edit').value); saveData(); renderItinerary(); closeModal('day-modal');}}
        function addDayPhoto(input) { processImage(input, (base64) => { tempDayPhotos.push(base64); renderDayPhotosPreview(); }); }
        function renderDayPhotosPreview() { document.getElementById('day-photos-preview').innerHTML = tempDayPhotos.map((p, i) => `<div class="relative"><img src="${p}" class="w-full h-full rounded"><button onclick="removeDayPhoto(${i})" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 text-xs">x</button></div>`).join(''); }
        function removeDayPhoto(i) { tempDayPhotos.splice(i,1); renderDayPhotosPreview(); }

        /* FLIGHTS (Existing) */
        function renderFlights() { document.getElementById('flight-list-container').innerHTML = flights.map(f=>`<div class="bg-white rounded-[24px] p-5 shadow-soft relative group transition-transform hover:-translate-y-1 hand-card" onclick="${f.url?`window.open('${f.url}')`:''}"><div class="absolute top-3 right-4 flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="event.stopPropagation(); editFlight(${f.id})" class="text-gray-300 hover:text-fuji"><i class="fa-solid fa-pen"></i></button><button onclick="event.stopPropagation(); deleteFlight(${f.id})" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button></div><div class="flex justify-between items-center mb-5 px-4 mt-2"><span class="text-4xl font-black handwritten text-pencil tracking-wider">${f.dep}</span><i class="fa-solid fa-plane text-2xl text-fuji transform rotate-[-45deg] mb-2"></i><span class="text-4xl font-black handwritten text-pencil tracking-wider">${f.arr}</span></div><div class="bg-fuji-light rounded-2xl py-3 px-4 text-center"><div class="text-xl font-bold text-fuji handwritten mb-1 tracking-wider">${f.code}</div><div class="text-xs text-gray-400 font-hand font-bold tracking-wide">${f.date} | ${f.time}</div></div></div>`).join(''); }
        function saveFlight(){ const id=document.getElementById('flight-id').value; const f={id:id?parseInt(id):Date.now(), dep:document.getElementById('flight-dep').value, arr:document.getElementById('flight-arr').value, code:document.getElementById('flight-code').value, time:document.getElementById('flight-time').value, date:document.getElementById('flight-date').value, url:document.getElementById('flight-url').value}; if(id){const idx=flights.findIndex(i=>i.id==id);if(idx>-1)flights[idx]=f;}else{flights.push(f);} saveData(); renderFlights(); closeModal('flight-modal'); }
        function deleteFlight(id){if(confirm("Del?")){flights=flights.filter(f=>f.id!==id); saveData(); renderFlights();}}
        function openFlightModal(f){ if(f){document.getElementById('flight-id').value=f.id;document.getElementById('flight-dep').value=f.dep;document.getElementById('flight-arr').value=f.arr;document.getElementById('flight-code').value=f.code;document.getElementById('flight-time').value=f.time;document.getElementById('flight-date').value=f.date;document.getElementById('flight-url').value=f.url;}else{['flight-id','flight-dep','flight-arr','flight-code','flight-time','flight-date','flight-url'].forEach(k=>document.getElementById(k).value='');} openModal('flight-modal'); }
        function editFlight(id){ openFlightModal(flights.find(f=>f.id===id)); }

        /* WALLET */
        function renderExpenses() {
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            
            let payerTotals = {}; payers.forEach(p => payerTotals[p] = { JPY: 0, TWD: 0 });
            expenses.sort((a,b) => b.id - a.id).forEach(e => {
                const amt = parseFloat(e.amt);
                const exPayers = (e.payer || "").split(',');
                const splitAmt = amt / (exPayers.length || 1);
                exPayers.forEach(p => {
                    if (payerTotals[p]) payerTotals[p][e.curr] += splitAmt;
                });

                const catInfo = expenseCategories.find(c => c.id === e.cat) || expenseCategories[5];
                const payerDisplay = exPayers.map(p => {
                    const pic = payerProfiles[p];
                    return pic ? `<img src="${pic}" class="w-4 h-4 rounded-full inline-block border border-white">` : `<span>${p}</span>`;
                }).join(' ');

                list.innerHTML += `<div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-50 flex items-center gap-3 relative overflow-hidden active:scale-95 transition cursor-pointer hover:bg-gray-50" onclick="openExpenseModal(${e.id})"><div class="w-10 h-10 rounded-full ${catInfo.color} flex items-center justify-center flex-shrink-0 text-sm"><i class="fa-solid ${catInfo.icon}"></i></div><div class="flex-1 min-w-0"><div class="font-bold text-gray-700 text-sm truncate">${e.note || catInfo.id}</div><div class="text-[10px] text-gray-400 mt-0.5 flex items-center gap-1">ä»˜æ¬¾: ${payerDisplay}</div></div><div class="text-right"><div class="font-bold font-mono text-gray-800">${e.curr} ${amt.toLocaleString()}</div>${e.curr === 'JPY' ? `<div class="text-[10px] text-gray-400">â‰ˆ NT$ ${Math.round(amt * rate).toLocaleString()}</div>` : ''}</div></div>`;
            });

            const dashboard = document.getElementById('wallet-dashboard-container');
            dashboard.innerHTML = '';
            
            const pfUsedJPY = payerTotals['å…¬è²»']?.JPY || 0;
            const pfUsedTWD = payerTotals['å…¬è²»']?.TWD || 0;
            const pfRemaining = publicFundConfig.currency === 'JPY' ? (publicFundConfig.initial - pfUsedJPY - (pfUsedTWD / rate)) : (publicFundConfig.initial - pfUsedTWD - (pfUsedJPY * rate));
            const pfImg = payerProfiles['å…¬è²»'] ? `<img src="${payerProfiles['å…¬è²»']}" class="w-full h-full object-cover">` : '<div class="w-full h-full bg-matcha/10"></div>';

            dashboard.innerHTML += `<div class="min-w-[160px] p-4 bg-white rounded-[24px] shadow-sm border border-matcha/20 relative overflow-hidden flex-shrink-0 cursor-pointer hover:shadow-md transition" onclick="openWalletDetail('å…¬è²»')"><div class="absolute -right-2 -top-2 w-16 h-16 rounded-full overflow-hidden opacity-50 border-4 border-white">${pfImg}</div><div class="relative z-10"><div class="text-xs text-gray-400 mb-1 font-bold tracking-widest">PUBLIC</div><div class="text-lg font-bold text-gray-700 mb-2">å…¬è²»</div><div class="text-xs text-gray-400 mb-1">å‰©é¤˜ (${publicFundConfig.currency})</div><div class="text-xl font-bold font-mono ${pfRemaining < 0 ? 'text-red-500' : 'text-matcha'}">${Math.floor(pfRemaining).toLocaleString()}</div></div></div>`;

            payers.filter(p => p !== 'å…¬è²»').forEach(p => {
                const paidJPY = payerTotals[p]?.JPY || 0;
                const paidTWD = payerTotals[p]?.TWD || 0;
                const totalPaidNT = Math.round(paidTWD + (paidJPY * rate));
                const pImg = payerProfiles[p] ? `<img src="${payerProfiles[p]}" class="w-8 h-8 rounded-full object-cover border border-white shadow-sm">` : `<div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">${p[0]}</div>`;
                
                dashboard.innerHTML += `<div class="min-w-[140px] p-4 bg-white rounded-[24px] shadow-sm border border-gray-100 relative overflow-hidden flex-shrink-0 cursor-pointer hover:shadow-md transition" onclick="openWalletDetail('${p}')"><div class="flex items-center gap-2 mb-3">${pImg}<span class="font-bold text-gray-700 text-sm truncate">${p}</span></div><div class="text-xs text-gray-400 mb-1">å·²ä»£å¢Šç¸½é¡</div><div class="text-lg font-bold font-mono text-gray-800">NT$ ${totalPaidNT.toLocaleString()}</div></div>`;
            });
        }
        
        async function updateExchangeRate() {
            const btn = document.getElementById('btn-rate-update');
            const icon = btn.querySelector('i');
            icon.classList.remove('fa-arrows-rotate'); icon.classList.add('fa-spinner', 'fa-spin');
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                if(data && data.rates && data.rates.TWD) {
                    const rate = data.rates.TWD;
                    document.getElementById('exchange-rate').value = rate.toFixed(3);
                    renderExpenses();
                    alert(`åŒ¯ç‡å·²æ›´æ–°ï¼š1 JPY â‰ˆ ${rate} TWD`);
                }
            } catch(e) { alert("æ›´æ–°å¤±æ•—"); } finally {
                icon.classList.remove('fa-spinner', 'fa-spin'); icon.classList.add('fa-arrows-rotate');
            }
        }

        function openWalletDetail(target) {
            const content = document.getElementById('wallet-detail-content');
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const ctx = document.getElementById('expenseChart');
            if (myChart) { myChart.destroy(); myChart = null; }

            const paidJPY = getExpenseSum(target, 'JPY');
            const paidTWD = getExpenseSum(target, 'TWD');
            const totalPaidNT = Math.round(paidTWD + (paidJPY * rate));
            const pImg = payerProfiles[target] ? `<img src="${payerProfiles[target]}" class="w-16 h-16 rounded-full mx-auto object-cover border-4 border-white shadow mb-2">` : `<div class="w-16 h-16 bg-gray-100 rounded-full mx-auto flex items-center justify-center text-2xl font-bold text-gray-500 mb-2">${target[0]}</div>`;

            if (target === 'å…¬è²»') {
                content.innerHTML = `<div class="text-center mb-4">${pImg}<h3 class="font-bold text-lg text-matcha">å…¬è²»ç®¡ç†</h3></div><div class="bg-gray-50 rounded-xl p-4 mb-4 text-center"><div class="text-xs text-gray-400 mb-1">åˆå§‹ç¸½é¡</div><div class="flex items-center justify-center gap-2"><input type="number" id="pf-initial" value="${publicFundConfig.initial}" class="bg-white border rounded w-24 text-center font-mono text-lg font-bold" onchange="updatePublicFundConfig()"><select id="pf-currency" class="bg-white border rounded text-xs p-1" onchange="updatePublicFundConfig()"><option value="JPY" ${publicFundConfig.currency === 'JPY' ? 'selected' : ''}>JPY</option><option value="TWD" ${publicFundConfig.currency === 'TWD' ? 'selected' : ''}>TWD</option></select></div></div><div class="space-y-2 mb-4 text-sm text-center"><p>å·²æ”¯å‡º JPY: <span class="font-mono">${paidJPY.toLocaleString()}</span></p><p>å·²æ”¯å‡º TWD: <span class="font-mono">${paidTWD.toLocaleString()}</span></p></div>`;
                ctx.style.display = 'none';
            } else {
                ctx.style.display = 'block';
                let catData = {};
                expenses.filter(e => (e.payer||"").includes(target)).forEach(e => {
                    const exPayers = e.payer.split(',');
                    const myShare = (e.curr === 'JPY' ? e.amt * rate : e.amt) / exPayers.length;
                    catData[e.cat] = (catData[e.cat] || 0) + myShare;
                });
                const labels = Object.keys(catData);
                const data = Object.values(catData);
                const bgColors = labels.map(l => expenseCategories.find(c => c.id === l)?.hex || '#ccc');

                content.innerHTML = `<div class="text-center mb-2">${pImg}<h3 class="font-bold text-lg text-gray-800">${target} æ¶ˆè²»åˆ†æ</h3></div><div class="bg-fuji/10 rounded-xl p-4 mb-2"><div class="text-xs text-fuji mb-1 font-bold text-center">å€‹äººä»£å¢Šç¸½é¡</div><div class="text-2xl font-bold font-mono text-center text-fuji">NT$ ${totalPaidNT.toLocaleString()}</div></div>`;
                
                if (data.length > 0) {
                     myChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: bgColors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } } });
                } else {
                    ctx.style.display = 'none';
                    content.innerHTML += '<p class="text-center text-gray-300 text-xs mt-4">å°šç„¡æ¶ˆè²»è¨˜éŒ„</p>';
                }
            }
            openModal('wallet-detail-modal');
        }

        function getExpenseSum(payer, curr) {
            return expenses.reduce((sum, e) => {
                const ps = (e.payer||"").split(',');
                if (ps.includes(payer) && e.curr === curr) {
                    return sum + (parseFloat(e.amt) / ps.length);
                }
                return sum;
            }, 0);
        }
        function updatePublicFundConfig() {
            publicFundConfig.initial = parseFloat(document.getElementById('pf-initial').value) || 0;
            publicFundConfig.currency = document.getElementById('pf-currency').value;
            saveData(); renderExpenses();
        }

        let selectedPayers = [];
        function openExpenseModal(id=null, pre={}) {
            currentPhotoBase64=null; selectedPayers=[];
            document.getElementById('ex-photo-preview-mini').classList.add('hidden');
            document.getElementById('btn-delete-expense').classList.add('hidden');
            document.getElementById('expense-categories').innerHTML = expenseCategories.map(c => `<div class="flex flex-col items-center gap-1 cursor-pointer min-w-[50px]" onclick="selectCategory('${c.id}')"><div id="cat-btn-${c.id}" class="w-12 h-12 rounded-full flex items-center justify-center text-lg transition-all border border-transparent ${c.id === (pre.cat || 'é¤é£²') ? `ring-2 ring-offset-1 ring-black ${c.color}` : 'bg-gray-50 text-gray-400'}"><i class="fa-solid ${c.icon}"></i></div><span class="text-[10px] text-gray-500 font-bold">${c.id}</span></div>`).join('');
            
            if(id) {
                const ex = expenses.find(e => e.id == id);
                document.getElementById('ex-id').value = ex.id; document.getElementById('ex-amount').value = ex.amt; document.getElementById('ex-currency').value = ex.curr; document.getElementById('ex-note').value = ex.note;
                selectCategory(ex.cat); selectedPayers = (ex.payer || "").split(',');
                if(ex.photo) { currentPhotoBase64 = ex.photo; document.getElementById('ex-photo-preview-mini').src = ex.photo; document.getElementById('ex-photo-preview-mini').classList.remove('hidden'); }
                document.getElementById('btn-delete-expense').classList.remove('hidden');
            } else {
                document.getElementById('ex-id').value = ''; 
                document.getElementById('ex-amount').value = pre.amt || ''; 
                document.getElementById('ex-currency').value = pre.curr || 'JPY';
                document.getElementById('ex-note').value = pre.note || '';
                selectCategory(pre.cat || 'é¤é£²'); selectedPayers = ['æˆ‘'];
                if(pre.photo) { currentPhotoBase64 = pre.photo; document.getElementById('ex-photo-preview-mini').src = pre.photo; document.getElementById('ex-photo-preview-mini').classList.remove('hidden'); }
            }
            renderPayerButtons();
            openModal('expense-modal');
        }
        function selectCategory(id) { expenseCategories.forEach(c => { const el = document.getElementById(`cat-btn-${c.id}`); if(c.id === id) { el.className = `w-12 h-12 rounded-full flex items-center justify-center text-lg transition-all border border-transparent ring-2 ring-offset-1 ring-black ${c.color}`; } else { el.className = 'w-12 h-12 rounded-full flex items-center justify-center text-lg transition-all border border-transparent bg-gray-50 text-gray-400'; } }); window.selectedCat = id; }
        function togglePayer(name) {
            if(selectedPayers.includes(name)) {
                if(selectedPayers.length > 1) selectedPayers = selectedPayers.filter(p => p !== name);
            } else {
                selectedPayers.push(name);
            }
            renderPayerButtons();
        }
        function renderPayerButtons() {
            document.getElementById('ex-payer-container').innerHTML = payers.map(p => {
                const isSel = selectedPayers.includes(p);
                return `<button type="button" onclick="togglePayer('${p}')" class="px-3 py-1.5 rounded-full text-xs border font-bold transition-all ${isSel ? 'bg-ink text-white border-ink shadow-md scale-105' : 'border-gray-200 text-gray-500 bg-white hover:bg-gray-50'}">${p}</button>`;
            }).join('');
        }
        function saveExpense() { const id=document.getElementById('ex-id').value, amt=parseFloat(document.getElementById('ex-amount').value); if(!amt) { alert("è«‹è¼¸å…¥é‡‘é¡"); return; } const ex={id:id?parseInt(id):Date.now(), cat:window.selectedCat, note:document.getElementById('ex-note').value, curr:document.getElementById('ex-currency').value, amt, payer:selectedPayers.join(','), photo:currentPhotoBase64, ppl:1}; if(id){const idx=expenses.findIndex(e=>e.id==id);if(idx>-1)expenses[idx]=ex;}else{expenses.push(ex);} saveData(); renderExpenses(); closeModal('expense-modal'); }
        function deleteExpense(){const id=document.getElementById('ex-id').value;if(id&&confirm("Del?")){expenses=expenses.filter(e=>e.id!=id); saveData(); renderExpenses(); closeModal('expense-modal');}}
        
        function openMemberModal(){
            document.getElementById('member-list').innerHTML=payers.map((p,i)=>`<div class="flex justify-between p-2 bg-gray-50 rounded items-center group">
                <div class="flex items-center gap-2">
                    <div class="relative w-10 h-10 rounded-full overflow-hidden bg-gray-200 cursor-pointer hover:opacity-80 group/avatar">
                        <img src="${payerProfiles[p] || ''}" class="w-full h-full object-cover relative z-0 ${payerProfiles[p]?'':'hidden'}" id="avatar-img-${i}">
                        <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs z-10 pointer-events-none ${payerProfiles[p]?'hidden':''}"><i class="fa-solid fa-camera"></i></div>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20" onchange="updateMemberAvatar(this, '${p}', ${i})">
                    </div>
                    <span class="font-bold text-sm">${p}</span>
                </div>
                ${p!=='å…¬è²»'&&payers.length>2?`<button onclick="removePayer(${i})" class="text-red-400 text-xs px-2">åˆªé™¤</button>`:''}
            </div>`).join(''); 
            openModal('member-modal');
        }
        function updateMemberAvatar(input, name, idx) {
            processImage(input, (base64) => {
                payerProfiles[name] = base64;
                document.getElementById(`avatar-img-${idx}`).src = base64;
                document.getElementById(`avatar-img-${idx}`).classList.remove('hidden');
                // Hide icon by finding sibling
                const iconDiv = input.previousElementSibling;
                if(iconDiv) iconDiv.classList.add('hidden');
                saveData(); renderExpenses();
            });
        }
        function addPayer(){const n=document.getElementById('new-payer-name').value;if(n&&!payers.includes(n)){payers.push(n); saveData(); openMemberModal(); renderExpenses();}}
        function removePayer(i){if(confirm("Del?")){payers.splice(i,1); saveData(); openMemberModal(); renderExpenses();}}

        /* OTHER LISTS */
        function renderGuides(){const l=document.getElementById('guide-list');l.innerHTML='';if(window.gs)window.gs.destroy();guides.forEach(g=>{l.innerHTML+=`<div id="guide-${g.id}" data-id="${g.id}" class="hand-card p-0 overflow-hidden relative group"><div class="drag-handle absolute top-0 left-0 h-full w-8 bg-black/5 flex items-center justify-center z-10 cursor-grab hover:bg-black/10"><i class="fa-solid fa-ellipsis-vertical text-gray-400"></i></div><button onclick="openGuideModal(${g.id})" class="absolute top-2 right-2 z-20 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center shadow"><i class="fa-solid fa-pen text-gray-500"></i></button>${g.photo?`<img src="${g.photo}" class="w-full h-40 object-cover" onclick="viewPhoto('${g.photo}')">`:''} <div class="p-4 pl-10"><h3 class="font-bold text-lg font-hand">${g.title}</h3>${g.time ? `<div class="mt-2 text-xs text-fuji font-bold bg-fuji/10 inline-block px-2 py-1 rounded"><i class="fa-regular fa-clock mr-1"></i>${g.time}</div>` : ''}<p class="text-sm whitespace-pre-line text-gray-600 mt-2 leading-relaxed">${g.desc}</p></div></div>`;});window.gs=new Sortable(l,{handle:'.drag-handle',onEnd:e=>{const i=guides.splice(e.oldIndex,1)[0];guides.splice(e.newIndex,0,i);saveData();renderItinerary();}});}
        function openGuideModal(id=null) { currentGuidePhoto=null; document.getElementById('guide-photo-preview').classList.add('hidden'); document.getElementById('guide-photo-text').classList.remove('hidden'); if(id){const g=guides.find(i=>i.id==id); document.getElementById('guide-id').value=g.id; document.getElementById('guide-title').value=g.title; document.getElementById('guide-desc').value=g.desc; document.getElementById('guide-time').value=g.time||''; document.getElementById('guide-coords').value=g.coords||''; if(g.photo){currentGuidePhoto=g.photo; document.getElementById('guide-photo-preview').src=g.photo; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden');}} else { ['guide-id','guide-title','guide-desc','guide-coords','guide-time'].forEach(k=>document.getElementById(k).value=''); } openModal('guide-modal'); }
        function saveGuide() { const id=document.getElementById('guide-id').value, t=document.getElementById('guide-title').value, d=document.getElementById('guide-desc').value; if(!t)return; const newItem = {id:id?parseInt(id):Date.now(), title:t, desc:d, time:document.getElementById('guide-time').value, coords:document.getElementById('guide-coords').value, photo:currentGuidePhoto||(id?guides.find(i=>i.id==id).photo:null)}; if(id){const idx=guides.findIndex(i=>i.id==id);if(idx>-1)guides[idx]=newItem;}else{guides.push(newItem);} saveData(); renderGuides(); closeModal('guide-modal'); }
        
        // --- NEW MUST EAT LOGIC (Group by Location -> Multiple Themes) ---
        function renderMustEatList() {
            const c = document.getElementById('must-eat-list'); 
            c.innerHTML = ''; 
            
            mustEatList.forEach(locItem => {
                const themesHtml = locItem.themes.map(t => {
                    const nameHtml = t.url 
                        ? `<a href="${t.url}" target="_blank" class="font-bold text-gray-700 font-hand text-lg hover:text-blue-500 hover:underline"><i class="fa-solid fa-link text-xs mr-1 opacity-50"></i>${t.name}</a>`
                        : `<span class="font-bold text-gray-700 font-hand text-lg">${t.name}</span>`;
                    
                    return `<div class="bg-white p-3 rounded shadow-sm border border-gray-100 mb-2">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">${nameHtml}</div>
                        </div>
                        ${t.note ? `<div class="text-xs text-gray-400 mt-1 whitespace-pre-line">${t.note}</div>` : ''}
                    </div>`;
                }).join('');

                c.innerHTML += `<div class="mb-6 group relative">
                    <button onclick="openMustEatModal('${locItem.id}')" class="absolute top-0 right-0 text-gray-300 hover:text-fuji px-2"><i class="fa-solid fa-pen"></i></button>
                    <h4 class="text-lg font-black handwritten text-matcha border-b-2 border-matcha/30 inline-block px-2 mb-3">${locItem.location}</h4>
                    <div class="pl-2 border-l-2 border-matcha/10">
                        ${themesHtml}
                    </div>
                </div>`;
            });
        }

        let tempThemes = [];
        function openMustEatModal(id=null) {
            document.getElementById('eat-location').value = '';
            tempThemes = [];
            document.getElementById('eat-loc-id').value = '';
            
            if(id) {
                const item = mustEatList.find(i => i.id === id);
                if(item) {
                    document.getElementById('eat-loc-id').value = item.id;
                    document.getElementById('eat-location').value = item.location;
                    tempThemes = JSON.parse(JSON.stringify(item.themes));
                }
            } else {
                tempThemes = [{id: 't'+Date.now(), name: '', url: '', note: ''}];
            }
            renderThemeRows();
            openModal('must-eat-modal');
        }

        function renderThemeRows() {
            const container = document.getElementById('eat-themes-container');
            container.innerHTML = tempThemes.map((t, idx) => `
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 relative group">
                    <button onclick="removeThemeRow(${idx})" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                    <input type="text" placeholder="é¤å»³/ä¸»é¡Œåç¨±" class="w-full bg-transparent border-b border-gray-300 text-sm font-bold mb-2 focus:border-matcha outline-none" value="${t.name}" onchange="updateTheme(${idx}, 'name', this.value)">
                    <input type="url" placeholder="ç¶²å€ (é€£çµ)" class="w-full bg-white border border-gray-200 rounded text-xs p-1 mb-2 text-blue-500" value="${t.url}" onchange="updateTheme(${idx}, 'url', this.value)">
                    <textarea placeholder="å‚™è¨» (å¿…åƒé¤é»...)" class="w-full bg-white border border-gray-200 rounded text-xs p-1 h-12" onchange="updateTheme(${idx}, 'note', this.value)">${t.note}</textarea>
                </div>
            `).join('');
        }

        function addThemeRow() {
            tempThemes.push({id: 't'+Date.now(), name: '', url: '', note: ''});
            renderThemeRows();
        }
        
        function removeThemeRow(idx) {
            tempThemes.splice(idx, 1);
            renderThemeRows();
        }

        function updateTheme(idx, field, val) {
            tempThemes[idx][field] = val;
        }

        function saveMustEatLocation() {
            const id = document.getElementById('eat-loc-id').value;
            const location = document.getElementById('eat-location').value;
            if(!location) return alert("è«‹è¼¸å…¥åœ°é»åç¨±");
            
            const finalThemes = tempThemes.filter(t => t.name.trim() !== '');

            if(id) {
                const idx = mustEatList.findIndex(i => i.id === id);
                if(idx > -1) mustEatList[idx] = { id, location, themes: finalThemes };
            } else {
                mustEatList.push({ id: 'loc_'+Date.now(), location, themes: finalThemes });
            }
            saveData();
            renderMustEatList();
            closeModal('must-eat-modal');
        }

        function deleteMustEatLocation() {
            const id = document.getElementById('eat-loc-id').value;
            if(id && confirm("ç¢ºå®šåˆªé™¤æ­¤åœ°é»åŠæ‰€æœ‰ä¸»é¡Œï¼Ÿ")) {
                mustEatList = mustEatList.filter(i => i.id !== id);
                saveData();
                renderMustEatList();
                closeModal('must-eat-modal');
            }
        }

        // Checklist
        function renderChecklist(){document.getElementById('checklist-container').innerHTML=todos.map((t,i)=>`<li class="flex items-center gap-2 p-2 border-b border-gray-100"><input type="checkbox" onchange="toggleTodo(${i})" ${t.done?'checked':''} class="accent-fuji"><input class="flex-1 bg-transparent font-hand text-lg ${t.done?'line-through text-gray-300':''}" value="${t.text}" onchange="updateTodo(${i},this.value)"><button onclick="deleteTodo(${i})" class="text-gray-300">x</button></li>`).join('');}
        function addTodo(){const v=document.getElementById('new-todo').value;if(v){todos.push({text:v,done:false}); saveData(); renderChecklist();document.getElementById('new-todo').value='';}}
        function toggleTodo(i){todos[i].done=!todos[i].done; saveData(); renderChecklist();}
        function updateTodo(i,v){todos[i].text=v; saveData();}
        function deleteTodo(i){todos.splice(i,1); saveData(); renderChecklist();}
        
        // Shopping
        function renderShoppingList() { const p=document.getElementById('shopping-list-pending'), d=document.getElementById('shopping-list-done'); p.innerHTML=''; d.innerHTML=''; shoppingList.forEach(s=>{ 
            const hasPrice = s.price && s.price > 0;
            const h=`<div class="relative p-2 border shadow-sm rounded bg-white ${s.done?'opacity-50':''}" onclick="openShoppingModal(${s.id})"><div class="absolute top-2 left-2 z-20 w-5 h-5 border-2 ${s.done ? 'bg-red-400 border-red-400' : 'bg-white border-gray-300'} rounded shadow-sm cursor-pointer flex items-center justify-center" onclick="toggleShoppingItem(event, ${s.id})">${s.done ? '<i class="fa-solid fa-check text-white text-xs"></i>' : ''}</div><div class="pl-8">${s.photo?`<img src="${s.photo}" class="w-full h-24 object-cover mb-2 rounded-sm">`:''}<b>${s.name}</b><br><span class="text-xs text-gray-500">${hasPrice ? `Qty:${s.qty} Â¥${s.price}` : ''}</span></div></div>`; 
            if(s.done)d.innerHTML+=h; else p.innerHTML+=h; }); }
        
        function toggleShoppingItem(e, id) {
            e.stopPropagation();
            const item = shoppingList.find(i => i.id === id);
            if (!item) return;

            if(item.done) {
                item.done = false;
                saveData(); renderShoppingList();
            } else {
                item.done = true;
                saveData(); renderShoppingList();
                
                if(confirm(`å·²å°‡ã€Œ${item.name}ã€æ¨™è¨˜è³¼è²·ã€‚\n\næ˜¯å¦è¨˜å¸³ï¼Ÿ`)) {
                    const total = (parseFloat(item.price) || 0) * (parseFloat(item.qty) || 1);
                    switchTab('wallet');
                    openExpenseModal(null, {
                        note: item.name,
                        cat: 'è³¼ç‰©',
                        curr: 'JPY',
                        amt: total,
                        photo: item.photo
                    });
                }
            }
        }
        function openShoppingModal(id=null){ ['shop-id','shop-name','shop-qty','shop-price'].forEach(k=>document.getElementById(k).value=''); currentShopPhoto=null; document.getElementById('shop-photo-preview').classList.add('hidden'); document.getElementById('shop-photo-text').classList.remove('hidden'); if(id){const s=shoppingList.find(i=>i.id===id); document.getElementById('shop-id').value=s.id; document.getElementById('shop-name').value=s.name; document.getElementById('shop-qty').value=s.qty; document.getElementById('shop-price').value=s.price; if(s.photo){currentShopPhoto=s.photo; document.getElementById('shop-photo-preview').src=s.photo; document.getElementById('shop-photo-preview').classList.remove('hidden'); document.getElementById('shop-photo-text').classList.add('hidden');}} openModal('shopping-modal'); }
        function saveShoppingItem(){ const id=document.getElementById('shop-id').value, name=document.getElementById('shop-name').value; if(!name)return; const item={id:id?parseInt(id):Date.now(), name, qty:document.getElementById('shop-qty').value, price:document.getElementById('shop-price').value, photo:currentShopPhoto, done:false}; if(id){const idx=shoppingList.findIndex(i=>i.id==id);if(idx>-1)shoppingList[idx]=item;}else{shoppingList.push(item);} saveData(); renderShoppingList(); closeModal('shopping-modal'); }
        function deleteShoppingItem(){const id=document.getElementById('shop-id').value;if(id&&confirm("Del?")){shoppingList=shoppingList.filter(i=>i.id!=id); saveData(); renderShoppingList(); closeModal('shopping-modal');}}

        // IOU
        function openIOUModal(id = null) { const delBtn = document.getElementById('btn-delete-iou'); const h = payers.filter(p=>p!=='å…¬è²»').map(p => `<option value="${p}">${p}</option>`).join(''); document.getElementById('iou-creditor').innerHTML = h; document.getElementById('iou-debtor').innerHTML = h; document.getElementById('iou-list-container').innerHTML = manualDebts.map(iou => `<div class="flex justify-between items-center p-2 border-b bg-gray-50 rounded-sm cursor-pointer hover:bg-gray-100" onclick="openIOUModal('${iou.id}')"><div class="flex-1 mr-2"><span class="text-xs text-gray-500 block">${iou.note || 'èª¿æ•´'}</span><span class="text-sm font-bold text-gray-700">${iou.debtor} æ¬  ${iou.creditor}</span></div><span class="text-sm font-mono text-fuji font-bold">NT$ ${Math.round(iou.amount).toLocaleString()}</span></div>`).join(''); delBtn.classList.add('hidden'); ['iou-id','iou-amount','iou-note'].forEach(k=>document.getElementById(k).value=''); if (id) { const iou = manualDebts.find(i => i.id == id); document.getElementById('iou-id').value = iou.id; document.getElementById('iou-creditor').value = iou.creditor; document.getElementById('iou-debtor').value = iou.debtor; document.getElementById('iou-amount').value = iou.amount; document.getElementById('iou-note').value = iou.note || ''; delBtn.classList.remove('hidden'); } openModal('iou-modal'); }
        function saveIOU() { const id = document.getElementById('iou-id').value, creditor = document.getElementById('iou-creditor').value, debtor = document.getElementById('iou-debtor').value, amount = parseFloat(document.getElementById('iou-amount').value), note = document.getElementById('iou-note').value; if (!amount || creditor === debtor) return; const newIOU = { id: id || 'iou' + Date.now(), creditor, debtor, amount, note }; if (id) { const idx = manualDebts.findIndex(i => i.id == id); if (idx > -1) manualDebts[idx] = newIOU; } else { manualDebts.push(newIOU); } saveData(); openIOUModal(); }
        function deleteIOU() { const id = document.getElementById('iou-id').value; if (id && confirm("Del?")) { manualDebts = manualDebts.filter(i => i.id != id); saveData(); openIOUModal(); } }

        // VJW
        function saveVJWImage(base64) { vjwImage = base64; saveData(); renderVJW(); }
        function renderVJW() { const img = document.getElementById('vjw-image'); const ph = document.getElementById('vjw-placeholder'); const btn = document.getElementById('vjw-view-btn'); if (vjwImage) { img.src = vjwImage; img.classList.remove('hidden'); ph.classList.add('hidden'); btn.classList.remove('hidden'); } else { img.classList.add('hidden'); ph.classList.remove('hidden'); btn.classList.add('hidden'); } }
        function viewVJW() { if(vjwImage) viewPhoto(vjwImage); }

        document.getElementById('memo-pad').addEventListener('input',(e)=>{ memoText = e.target.value; saveData(); });
        document.getElementById('gist-id-input').addEventListener('input', saveData);
        document.getElementById('gist-token-input').addEventListener('input', saveData);
        
        window.onload = function() {
            reloadLocalData();
            if(gistId) {
                document.getElementById('gist-id-input').value = gistId;
                document.getElementById('gist-token-input').value = gistToken;
                updateCloudStatus("é€£ç·šä¸­...");
                forceDownload().then(() => { window.refreshUI(); }).catch(() => { window.refreshUI(); });
            } else {
                window.refreshUI();
            }
            switchTab('plan');
        }
    </script>
</body>
</html>
