<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—…ã®è¨˜">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f9f7f2">

    <title>æ—…ã®è¨˜ V8</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'paper': '#f9f7f2', 'sakura': '#f8c3cd', 'matcha': '#bccc9a', 'fuji': '#7b90d2', 'fuji-light': '#eff6ff', 'pencil': '#595857', 'ink': '#2c2c2c', 'clay': '#b5651d' },
                    fontFamily: { 'maru': ['"Zen Maru Gothic"', 'sans-serif'], 'hand': ['"Yomogi"', 'cursive'] },
                    animation: { 'highlight': 'highlight 2s ease-out forwards', 'slide-in': 'slideIn 0.3s ease-out', 'pulse-slow': 'pulse 3s infinite' },
                    keyframes: { highlight: { '0%': { backgroundColor: 'rgba(252, 211, 77, 0.5)' }, '100%': { backgroundColor: 'transparent' } }, slideIn: { '0%': { opacity: 0, transform: 'translateX(10px)' }, '100%': { opacity: 1, transform: 'translateX(0)' } } }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #f9f7f2; color: #595857; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; padding-bottom: calc(80px + var(--sab)); -webkit-tap-highlight-color: transparent; }
        .handwritten { font-family: 'Yomogi', cursive; }
        .modal { transition: opacity 0.2s; } .modal.hidden { opacity: 0; pointer-events: none; } .modal.visible { opacity: 1; pointer-events: auto; }
        .hand-card { background: #fff; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); }
        .nav-item.active i, .nav-item.active span { color: #7b90d2; font-weight: 900; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .zoom-container img.zoomed { max-width: none !important; max-height: none !important; cursor: grab; }
        .weather-icon { font-family: "Segoe UI Emoji", "Apple Color Emoji", sans-serif; }
    </style>
</head>
<body>

    <header class="pb-2 px-4 text-center sticky top-0 bg-[#f9f7f2]/95 z-40 backdrop-blur-sm border-b border-gray-100/50 pt-safe">
        <h1 class="text-3xl font-black tracking-widest text-ink handwritten mt-4 relative inline-block">
            <span class="absolute -top-3 -left-6 text-2xl rotate-[-15deg] opacity-80">âœˆï¸</span> æ—…ã®è¨˜
        </h1>
        <div class="flex justify-center items-center gap-3 mt-1">
            <div id="cloud-status" class="text-[10px] bg-gray-100 text-gray-400 px-2 py-0.5 rounded-full"><i class="fa-solid fa-code-branch"></i> æœªé€£ç·š</div>
            <button onclick="forceDownload()" class="text-[10px] bg-white border px-2 py-0.5 rounded-full shadow-sm"><i class="fa-solid fa-rotate-right"></i> åŒæ­¥</button>
        </div>
    </header>

    <main id="app" class="px-4 w-full mx-auto max-w-lg pb-24 relative">
        
        <section id="view-plan" class="view-section animate-slide-in">
            <div class="flex justify-between items-center my-6">
                <h3 class="text-pencil font-bold handwritten text-xl"><i class="fa-solid fa-plane text-fuji mr-2"></i>èˆªç­</h3>
                <button onclick="openFlightModal()" class="text-xs bg-white border px-3 py-1 rounded-full shadow-sm font-bold text-fuji">+ æ–°å¢</button>
            </div>
            <div id="flight-list-container" class="grid grid-cols-1 gap-3 mb-8"></div>
            
            <div class="flex justify-between items-center mb-4 pt-4 border-t border-dashed border-gray-300">
                 <h3 class="text-pencil font-bold handwritten text-xl"><i class="fa-solid fa-map-location-dot text-matcha mr-2"></i>è¡Œç¨‹</h3>
            </div>
            <div id="itinerary-container" class="space-y-6"></div>
            <button onclick="addNewDay()" class="w-full mt-8 py-3 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl hover:bg-white hover:border-matcha hover:text-matcha transition font-bold text-sm bg-white/50 handwritten"><i class="fa-solid fa-plus-circle"></i> å¯«ä¸‹ä¸€é å›æ†¶</button>
        </section>

        <section id="view-guide" class="view-section hidden animate-slide-in">
            <div class="flex justify-between items-end my-6">
                <h2 class="text-2xl font-bold text-pencil handwritten">ğŸ æ·±åº¦å°è¦½</h2>
                <button onclick="openGuideModal()" class="text-sm bg-matcha/20 text-green-800 px-3 py-1 rounded-full font-bold">+ æ™¯é»</button>
            </div>
            <div id="guide-list" class="grid grid-cols-1 gap-6"></div>
        </section>

        <section id="view-wallet" class="view-section hidden animate-slide-in">
            <div class="flex justify-between items-center my-6">
                <h2 class="text-2xl font-bold text-pencil handwritten">ğŸ‘› æ—…è²»</h2>
                <div class="flex items-center gap-1 bg-white px-2 py-1 rounded-lg border">
                    <span class="text-[10px] text-gray-400 font-bold">åŒ¯ç‡ 0.215</span>
                    <button onclick="updateExchangeRate()" class="text-fuji"><i class="fa-solid fa-rotate"></i></button>
                </div>
            </div>
            <div class="flex overflow-x-auto gap-3 pb-2 no-scrollbar mb-4" id="wallet-dashboard-container"></div>
            <div class="flex justify-between items-center mb-2 px-1">
                <h4 class="text-sm font-bold text-gray-400">æœ€è¿‘æ”¯å‡º</h4>
                <div class="flex gap-2">
                    <button onclick="openMemberModal()" class="text-xs bg-white border px-2 py-1 rounded shadow-sm">æˆå“¡</button>
                    <button onclick="openIOUModal()" class="text-xs bg-white border px-2 py-1 rounded shadow-sm text-fuji">å€Ÿæ¬¾</button>
                </div>
            </div>
            <div id="expense-list" class="space-y-3 pb-24"></div>
            <button onclick="openExpenseModal()" class="fixed bottom-24 right-6 bg-ink text-white rounded-full h-14 px-6 shadow-lg flex items-center gap-2 z-30 font-bold handwritten"><i class="fa-solid fa-pen-nib"></i> è¨˜ä¸€ç­†</button>
        </section>

        <section id="view-lists" class="view-section hidden animate-slide-in">
            <div class="grid grid-cols-1 gap-6 mt-6">
                <div class="hand-card p-5 bg-[#fffdf0] border-l-4 border-[#fffdf0]">
                     <div class="flex justify-between items-center mb-3 pb-2 border-b border-dashed border-gray-300">
                        <h3 class="text-lg font-bold text-pencil handwritten"><i class="fa-solid fa-utensils text-matcha mr-1"></i> å¿…åƒæ¸…å–®</h3>
                        <button onclick="openMustEatModal()" class="text-xs bg-white border px-2 py-1 rounded shadow-sm text-matcha font-bold">ç·¨è¼¯</button>
                     </div>
                     <div id="must-eat-list" class="space-y-3"></div>
                </div>
                <div class="hand-card p-0 bg-white border-l-4 border-white overflow-hidden flex flex-col" id="shopping-card">
                     <div class="p-5 pb-2">
                         <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold text-pencil handwritten"><i class="fa-solid fa-bag-shopping text-red-400 mr-1"></i> è³¼ç‰©æ¸…å–®</h3>
                            <button onclick="openShoppingModal()" class="text-xs bg-red-50 text-red-500 px-2 py-1 rounded border border-red-100 font-bold">æ–°å¢</button>
                         </div>
                         <div class="flex justify-between items-center bg-gray-50 rounded-lg p-1 mb-2">
                             <button onclick="prevShopList()" class="w-6 h-6 bg-white rounded-full shadow text-gray-400"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                             <span id="shop-owner-name" class="font-bold text-gray-700 text-sm">æˆ‘çš„æ¸…å–®</span>
                             <button onclick="nextShopList()" class="w-6 h-6 bg-white rounded-full shadow text-gray-400"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                         </div>
                     </div>
                     <div id="shopping-swipe-area" class="flex-1 p-5 pt-0 min-h-[200px]">
                         <div id="shopping-list-pending" class="grid grid-cols-2 gap-2 mb-4"></div>
                         <div class="border-t pt-2 opacity-60"><div id="shopping-list-done" class="grid grid-cols-2 gap-2 grayscale"></div></div>
                     </div>
                </div>
                <div class="hand-card p-5 bg-[#f0f4f8]">
                    <h3 class="text-lg font-bold mb-3 text-fuji handwritten"><i class="fa-solid fa-suitcase mr-1"></i> è¡Œæç¢ºèª</h3>
                    <ul id="checklist-container" class="space-y-2 mb-2"></ul>
                    <div class="flex gap-2"><input type="text" id="new-todo" placeholder="æ–°å¢..." class="flex-1 border-b bg-transparent text-sm outline-none"><button onclick="addTodo()" class="text-fuji"><i class="fa-solid fa-plus"></i></button></div>
                </div>
            </div>
        </section>

        <section id="view-info" class="view-section hidden animate-slide-in">
            <div class="mt-8 space-y-6">
                <div class="hand-card p-6 border-l-4 border-fuji/30">
                    <h3 class="font-bold text-fuji handwritten text-lg mb-4">ğŸ™ï¸ AI éš¨èº«ç¿»è­¯</h3>
                    <textarea id="trans-input" class="w-full h-24 p-3 bg-fuji-light/50 border border-fuji/20 rounded-xl text-sm outline-none font-hand mb-3" placeholder="é»éº¥å…‹é¢¨èªªè©±ï¼Œæˆ–è¼¸å…¥..."></textarea>
                    <div class="flex gap-2 relative">
                        <button onclick="toggleVoiceInput()" id="btn-mic" class="bg-white border text-fuji w-10 h-10 rounded-full flex items-center justify-center shadow-sm"><i class="fa-solid fa-microphone"></i></button>
                        <button onclick="openGoogleTranslate()" class="flex-1 bg-fuji text-white rounded-xl font-bold shadow-sm text-sm"><i class="fa-brands fa-google mr-1"></i> ç¿»è­¯æ–‡å­—</button>
                        <a href="https://translate.google.com/?op=images" target="_blank" class="flex-1 bg-white text-gray-600 border rounded-xl font-bold shadow-sm flex items-center justify-center text-sm"><i class="fa-solid fa-camera mr-1"></i> ç›¸æ©Ÿç¿»è­¯</a>
                    </div>
                </div>

                <a href="https://tenki.jp/forecast/3/16/4410/13101/" target="_blank" class="hand-card p-4 flex items-center justify-between hover:bg-blue-50 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 text-xl"><i class="fa-solid fa-cloud-sun-rain"></i></div>
                        <div><div class="font-bold text-gray-700">Tenki.jp å¤©æ°£é å ±</div><div class="text-xs text-gray-400">é»æ“ŠæŸ¥çœ‹è©³ç´°æ°£è±¡</div></div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300"></i>
                </a>

                <div class="hand-card p-4">
                    <h4 class="text-sm font-bold text-gray-500 mb-2">é›²ç«¯è¨­å®š (Gist)</h4>
                    <input type="text" id="gist-id-input" placeholder="Gist ID" class="w-full border p-2 rounded text-xs mb-2 bg-gray-50">
                    <input type="password" id="gist-token-input" placeholder="Token" class="w-full border p-2 rounded text-xs mb-2 bg-gray-50">
                    <button onclick="saveGistConfig()" class="w-full bg-ink text-white py-2 rounded text-xs font-bold">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </section>
    </main>

    <div id="flight-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-3xl p-6 shadow-2xl relative hand-card"><button onclick="closeModal('flight-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-bold mb-4 text-center">èˆªç­</h3><input type="hidden" id="flight-id"><div class="flex gap-2 mb-2"><input type="text" id="flight-dep" placeholder="TPE" class="w-1/2 p-2 text-center border rounded-xl"><input type="text" id="flight-arr" placeholder="NRT" class="w-1/2 p-2 text-center border rounded-xl"></div><input type="text" id="flight-code" placeholder="èˆªç­ä»£è™Ÿ" class="w-full p-2 border-b bg-transparent mb-2 text-center"><input type="text" id="flight-date" placeholder="æ—¥æœŸæ™‚é–“" class="w-full p-2 border-b bg-transparent mb-4 text-center text-sm"><button onclick="saveFlight()" class="w-full bg-fuji text-white py-2 rounded-xl font-bold">å„²å­˜</button></div></div>

    <div id="day-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-lg rounded-2xl p-4 shadow-2xl relative hand-card h-[85vh] overflow-y-auto"><button onclick="closeModal('day-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-bold mb-2 text-center">è¡Œç¨‹ç·¨è¼¯</h3><input type="hidden" id="day-id-edit"><div class="flex gap-2 items-center mb-3"><input type="text" id="day-date-edit" class="flex-1 p-2 border-b-2 border-matcha bg-transparent font-bold text-lg" placeholder="æ—¥æœŸ"><select id="day-weather-edit" class="bg-white border rounded p-1 text-lg"><option value="">â˜ï¸</option><option value="sunny">â˜€</option><option value="cloudy">â˜</option><option value="rain">â˜‚</option><option value="snow">â›„</option></select></div><label class="flex items-center space-x-2 text-sm text-gray-600 mb-4 bg-yellow-50 p-2 rounded"><input type="checkbox" id="day-highlight-edit" class="accent-red-400"><span>æ¨™è¨˜ç‚ºé‡é»å¤©æ•¸</span></label><div class="mb-4 bg-white p-2 rounded border"><h4 class="text-xs font-bold text-gray-400 mb-2">ç…§ç‰‡é›†</h4><div id="day-photos-preview" class="grid grid-cols-3 gap-2 mb-2"></div><input type="file" accept="image/*" class="text-xs" onchange="addDayPhoto(this)"></div><textarea id="day-content-edit" class="w-full h-32 p-3 border rounded-lg bg-white text-sm mb-4 font-hand" placeholder="è¡Œç¨‹å…§å®¹..."></textarea><div class="bg-white p-3 rounded-lg border mb-4 space-y-2"><h4 class="text-xs font-bold text-gray-400">äº¤é€š</h4><input type="text" id="day-trans-content" placeholder="äº¤é€šå…§å®¹" class="w-full border rounded p-1 text-sm"><div class="relative h-10 border-2 border-dashed rounded flex items-center justify-center text-gray-400 text-xs"><span id="trans-photo-text">ä¸Šå‚³è»Šç¥¨</span><input type="file" accept="image/*" class="absolute inset-0 opacity-0" onchange="processImage(this, b=>{currentTransPhoto=b; document.getElementById('trans-photo-text').innerText='å·²é¸å–'})"></div></div><div class="flex gap-2"><button onclick="deleteDay()" class="flex-1 bg-gray-200 py-2 rounded-lg text-sm">åˆªé™¤</button><button onclick="saveDay()" class="flex-[2] bg-matcha text-white py-2 rounded-lg font-bold">å„²å­˜</button></div></div></div>

    <div id="guide-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card"><button onclick="closeModal('guide-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-bold mb-3">æ™¯é»ç·¨è¼¯</h3><input type="hidden" id="guide-id"><input type="text" id="guide-title" placeholder="åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold"><textarea id="guide-desc" placeholder="ä»‹ç´¹..." class="w-full mb-3 border bg-white p-2 rounded h-24 text-sm"></textarea><div class="flex gap-2 mb-3"><input type="text" id="guide-price" placeholder="åƒ¹æ ¼ (å¦‚: Â¥2000)" class="w-1/2 border rounded p-2 text-xs bg-white"><input type="text" id="guide-time" placeholder="æ™‚é–“" class="w-1/2 border rounded p-2 text-xs bg-white"></div><div class="border-2 border-dashed p-2 text-center relative mb-3"><input type="file" accept="image/*" class="absolute inset-0 opacity-0" onchange="processImage(this, b=>{currentGuidePhoto=b;document.getElementById('guide-photo-preview').src=b;document.getElementById('guide-photo-preview').classList.remove('hidden')})"><img id="guide-photo-preview" class="hidden h-24 mx-auto object-cover rounded"><span class="text-xs text-gray-400">æ›´æ–°ç…§ç‰‡</span></div><button onclick="saveGuide()" class="w-full bg-matcha text-white py-2 rounded-lg font-bold">å„²å­˜</button></div></div>

    <div id="must-eat-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto"><button onclick="closeModal('must-eat-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-bold mb-4 text-center text-matcha">å¿…åƒåœ°é»ç·¨è¼¯</h3><input type="hidden" id="eat-loc-id"><input type="text" id="eat-location" placeholder="åœ°é»åç¨± (å¦‚: ç¯‰åœ°)" class="w-full p-2 border-b-2 border-matcha/50 bg-transparent font-bold text-lg mb-4"><div id="eat-themes-container" class="space-y-3 mb-4"></div><button onclick="addThemeRow()" class="w-full py-2 border-2 border-dashed border-matcha/30 text-matcha rounded-lg text-sm font-bold mb-4">+ æ–°å¢ä¸»é¡Œ</button><div class="flex gap-2"><button onclick="deleteMustEatLocation()" class="flex-1 bg-gray-200 py-2 rounded-lg text-sm">åˆªé™¤</button><button onclick="saveMustEatLocation()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold">å„²å­˜</button></div></div></div>

    <div id="expense-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#fffdf9] w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative hand-card"><button onclick="closeModal('expense-modal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-xl font-bold mb-6 text-center">è¨˜å¸³</h3><input type="hidden" id="ex-id"><div class="flex justify-between mb-4 gap-2" id="expense-categories"></div><div class="flex items-center justify-center gap-2 mb-4"><select id="ex-currency" class="bg-gray-100 rounded px-2 py-1"><option value="JPY">JPY</option><option value="TWD">TWD</option></select><input type="number" id="ex-amount" placeholder="0" class="text-4xl font-bold text-center w-40 outline-none border-b-2"></div><div id="ex-payer-container" class="flex flex-wrap gap-2 mb-4"></div><input type="text" id="ex-note" placeholder="å‚™è¨»..." class="w-full bg-gray-50 rounded p-2 mb-4 border"><div class="flex gap-2"><button onclick="deleteExpense()" id="btn-delete-expense" class="w-12 h-12 rounded-full bg-gray-100 hidden"><i class="fa-solid fa-trash"></i></button><button onclick="saveExpense()" class="flex-1 bg-ink text-white py-3 rounded-full font-bold">å„²å­˜</button></div></div></div>

    <div id="lightbox-modal" class="modal hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-2" onclick="closeModal('lightbox-modal')"><img id="lightbox-image" class="max-w-full max-h-full object-contain rounded"></div>

    <nav class="fixed bottom-0 left-0 w-full bg-[#f9f7f2]/95 border-t border-gray-200 pt-2 pb-safe px-6 z-50 backdrop-blur-sm pb-4">
        <div class="flex justify-between max-w-lg mx-auto">
            <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center text-gray-400 flex-1" data-target="plan"><i class="fa-solid fa-map text-lg"></i><span class="text-[10px]">è¡Œç¨‹</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center text-gray-400 flex-1" data-target="guide"><i class="fa-solid fa-book-open text-lg"></i><span class="text-[10px]">å°è¦½</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-gray-400 flex-1" data-target="wallet"><i class="fa-solid fa-wallet text-lg"></i><span class="text-[10px]">è¨˜å¸³</span></button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center text-gray-400 flex-1" data-target="lists"><i class="fa-solid fa-list-check text-lg"></i><span class="text-[10px]">æ¸…å–®</span></button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center text-gray-400 flex-1" data-target="info"><i class="fa-solid fa-circle-info text-lg"></i><span class="text-[10px]">è³‡è¨Š</span></button>
        </div>
    </nav>

    <script>
        // --- DATA ---
        const PRELOADED_GUIDES = [
            {id: 101, title: "è¼•äº•æ¾¤ç‹å­ Outlet", price: "å…è²»", desc: "å¿…é€›ï¼è»Šç«™å—å£ç›´é”ã€‚\næ¨è–¦ï¼šBEAMS, Nike, Gucci, Le Creusetã€‚\nç¾é£Ÿè¡—æœ‰çŸ¥åé†¬æ±è±¬æ’ä¸¼ã€‚", photo: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Karuizawa_Prince_Shopping_Plaza_East.JPG/1200px-Karuizawa_Prince_Shopping_Plaza_East.JPG", coords: "", time: "10:00 - 19:00"},
            {id: 102, title: "çŸ³ä¹‹æ•™å ‚", price: "å…è²»", desc: "å…§æ‘é‘‘ä¸‰ç´€å¿µå ‚ã€‚çŸ³é ­èˆ‡ç»ç’ƒçš„æœ‰æ©Ÿå»ºç¯‰ã€‚\nè‹¥æœ‰å©šç¦®å‰‡ç„¡æ³•é€²å…¥åƒè§€ã€‚", photo: "https://www.stonechurch.jp/images/top/main_01_sp.jpg", coords: "", time: "09:00 - 18:00"},
            {id: 104, title: "æ·ºè‰é›·é–€", price: "å…è²»", desc: "æ±äº¬åœ°æ¨™ã€‚ä»²è¦‹ä¸–é€šå¿…åƒï¼šäººå½¢ç‡’ã€ç‚¸è‚‰é¤…ã€æŠ¹èŒ¶å†°æ·‡æ·‹ã€‚", photo: "https://live.staticflickr.com/65535/51866385172_9780a42e5d_b.jpg", coords: "", time: "å…¨å¤©"},
            {id: 106, title: "æ±äº¬éµå¡”", price: "Â¥1200èµ·", desc: "ç¶“å…¸åœ°æ¨™ã€‚æ¨è–¦å» Top Deck Tour (éœ€é ç´„)ã€‚\næ¨“ä¸‹æœ‰ RED Tokyo é›»ç«¶æ¨‚åœ’ã€‚", photo: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/37/Tokyo_Tower_special_light_up_2020.jpg/800px-Tokyo_Tower_special_light_up_2020.jpg", coords: "", time: "09:00 - 23:00"},
            {id: 107, title: "æ±äº¬è¿ªå£«å°¼", price: "Â¥8400èµ·", desc: "é™¸åœ° (Land) ç¶“å…¸å¤¢å¹»ï¼›æµ·æ´‹ (Sea) é”è²ç†Šé™å®šã€‚\nå»ºè­°ææ—© 1 å°æ™‚æ’éšŠå…¥åœ’ã€‚", photo: "https://media1.tokyodisneyresort.jp/images/adventure/events/2645/main.jpg", coords: "", time: "09:00 - 21:00"}
        ];
        const WEATHER_MAP = {'sunny': 'â˜€', 'cloudy': 'â˜', 'rain': 'â˜‚', 'snow': 'â›„'};
        const CATEGORIES = [{id:'é¤é£²',i:'fa-utensils',c:'text-yellow-600 bg-yellow-100'},{id:'äº¤é€š',i:'fa-train',c:'text-blue-600 bg-blue-100'},{id:'è³¼ç‰©',i:'fa-bag-shopping',c:'text-pink-600 bg-pink-100'},{id:'é–€ç¥¨',i:'fa-ticket',c:'text-green-600 bg-green-100'},{id:'ä½å®¿',i:'fa-bed',c:'text-purple-600 bg-purple-100'},{id:'å…¶ä»–',i:'fa-asterisk',c:'text-gray-600 bg-gray-100'}];
        
        let flights=[], itinerary=[], mustEatList=[], expenses=[], guides=[], shoppingList=[], payers=["æˆ‘","æ—…ä¼´","å…¬è²»"], payerProfiles={}, manualDebts=[], memoText="", gistId="", gistToken="";
        let tempThemes = [], currentPhotoBase64 = null, currentGuidePhoto = null, currentTransPhoto = null, tempDayPhotos = [], currentShopPhoto = null;
        let shoppingOwners = ["æˆ‘çš„æ¸…å–®"], currentShopOwnerIdx = 0;

        // --- CORE ---
        function reloadData() {
            flights = JSON.parse(localStorage.getItem('flights')) || [];
            itinerary = JSON.parse(localStorage.getItem('itinerary_v2')) || [];
            mustEatList = JSON.parse(localStorage.getItem('mustEatList')) || [];
            expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            guides = JSON.parse(localStorage.getItem('guides')) || PRELOADED_GUIDES;
            shoppingList = JSON.parse(localStorage.getItem('shoppingList_v2')) || [];
            shoppingOwners = JSON.parse(localStorage.getItem('shoppingOwners')) || ["æˆ‘çš„æ¸…å–®"];
            payers = JSON.parse(localStorage.getItem('payers')) || ["æˆ‘","æ—…ä¼´","å…¬è²»"];
            gistId = localStorage.getItem('gist_id') || ""; gistToken = localStorage.getItem('gist_token') || "";
        }
        function saveData() {
            localStorage.setItem('flights', JSON.stringify(flights));
            localStorage.setItem('itinerary_v2', JSON.stringify(itinerary));
            localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('guides', JSON.stringify(guides));
            localStorage.setItem('shoppingList_v2', JSON.stringify(shoppingList));
            if(gistId && gistToken) setTimeout(forceUpload, 1000);
        }

        // --- UI ---
        function switchTab(t) { document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); document.getElementById('view-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); document.querySelector(`[data-target="${t}"]`).classList.add('active'); window.scrollTo(0,0); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); setTimeout(()=>document.getElementById(id).classList.add('visible'),10); }
        function closeModal(id) { document.getElementById(id).classList.remove('visible'); setTimeout(()=>document.getElementById(id).classList.add('hidden'),200); }
        
        // --- FEATURES ---
        function renderItinerary() {
            const c = document.getElementById('itinerary-container'); c.innerHTML = '';
            itinerary.forEach(d => {
                const wIcon = WEATHER_MAP[d.weather] || '';
                c.innerHTML += `<div class="relative pl-6 border-l-2 ${d.highlight?'border-sakura':'border-gray-200'} pb-6">
                    <div class="absolute -left-2 top-0 w-4 h-4 rounded-full ${d.highlight?'bg-sakura':'bg-gray-300'} border-2 border-white"></div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg ${d.highlight?'text-red-400':'text-gray-700'}">
                            ${d.date} <a href="https://tenki.jp/" target="_blank" class="weather-icon no-underline ml-2 text-xl hover:scale-110 transition inline-block">${wIcon}</a>
                        </h3>
                        <button onclick="openDayEditor('${d.id}')" class="text-gray-300"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 whitespace-pre-line text-sm leading-relaxed">${d.content}</div>
                </div>`;
            });
        }
        function openDayEditor(id) {
            const d = itinerary.find(i=>i.id===id); if(!d) return;
            document.getElementById('day-id-edit').value = d.id;
            document.getElementById('day-date-edit').value = d.date;
            document.getElementById('day-weather-edit').value = d.weather || "";
            document.getElementById('day-content-edit').value = d.content;
            document.getElementById('day-highlight-edit').checked = d.highlight;
            tempDayPhotos = d.photos || []; renderDayPhotosPreview();
            openModal('day-modal');
        }
        function saveDay() {
            const id = document.getElementById('day-id-edit').value;
            const idx = itinerary.findIndex(i=>i.id===id);
            if(idx > -1) {
                itinerary[idx].date = document.getElementById('day-date-edit').value;
                itinerary[idx].weather = document.getElementById('day-weather-edit').value;
                itinerary[idx].content = document.getElementById('day-content-edit').value;
                itinerary[idx].highlight = document.getElementById('day-highlight-edit').checked;
                itinerary[idx].photos = tempDayPhotos;
                saveData(); renderItinerary(); closeModal('day-modal');
            }
        }

        // --- GUIDE WITH PRICE ---
        function renderGuides() {
            const c = document.getElementById('guide-list'); c.innerHTML = '';
            guides.forEach(g => {
                c.innerHTML += `<div class="hand-card overflow-hidden">
                    ${g.photo ? `<img src="${g.photo}" class="w-full h-40 object-cover" onclick="viewPhoto('${g.photo}')">` : ''}
                    <div class="p-4 relative">
                        <button onclick="openGuideModal(${g.id})" class="absolute top-2 right-2 text-gray-400"><i class="fa-solid fa-pen"></i></button>
                        <h3 class="font-bold text-lg mb-1">${g.title}</h3>
                        ${g.price ? `<div class="text-clay font-bold text-sm mb-2"><i class="fa-solid fa-tag mr-1"></i>${g.price}</div>` : ''}
                        <p class="text-sm text-gray-600 whitespace-pre-line">${g.desc}</p>
                    </div>
                </div>`;
            });
        }
        function openGuideModal(id=null) {
            currentGuidePhoto=null; document.getElementById('guide-photo-preview').classList.add('hidden');
            if(id) {
                const g = guides.find(i=>i.id==id);
                document.getElementById('guide-id').value = g.id;
                document.getElementById('guide-title').value = g.title;
                document.getElementById('guide-desc').value = g.desc;
                document.getElementById('guide-price').value = g.price || "";
                document.getElementById('guide-time').value = g.time || "";
                if(g.photo) { currentGuidePhoto=g.photo; document.getElementById('guide-photo-preview').src=g.photo; document.getElementById('guide-photo-preview').classList.remove('hidden'); }
            } else {
                ['guide-id','guide-title','guide-desc','guide-price','guide-time'].forEach(k=>document.getElementById(k).value='');
            }
            openModal('guide-modal');
        }
        function saveGuide() {
            const id = document.getElementById('guide-id').value;
            const g = {
                id: id ? parseInt(id) : Date.now(),
                title: document.getElementById('guide-title').value,
                desc: document.getElementById('guide-desc').value,
                price: document.getElementById('guide-price').value,
                time: document.getElementById('guide-time').value,
                photo: currentGuidePhoto || (id ? guides.find(i=>i.id==id)?.photo : null)
            };
            if(id) guides[guides.findIndex(i=>i.id==id)] = g; else guides.push(g);
            saveData(); renderGuides(); closeModal('guide-modal');
        }

        // --- MUST EAT (FIXED) ---
        function renderMustEatList() {
            const c = document.getElementById('must-eat-list'); c.innerHTML = '';
            mustEatList.forEach(l => {
                const themes = l.themes.map(t => `<div class="bg-white border rounded p-2 mb-1 text-sm flex justify-between">
                    <span class="${t.isVeg?'text-green-600 font-bold':''}">${t.isVeg?'ğŸ¥— ':''}${t.name}</span>
                    ${t.url ? `<a href="${t.url}" target="_blank" class="text-fuji"><i class="fa-solid fa-link"></i></a>` : ''}
                </div>`).join('');
                c.innerHTML += `<div class="mb-4 relative group">
                    <button onclick="openMustEatModal('${l.id}')" class="absolute top-0 right-0 text-gray-300"><i class="fa-solid fa-pen"></i></button>
                    <h4 class="font-bold text-matcha border-b-2 border-matcha/30 inline-block mb-2">${l.location}</h4>
                    <div class="pl-2 border-l-2 border-matcha/10">${themes}</div>
                </div>`;
            });
        }
        function openMustEatModal(id=null) {
            document.getElementById('eat-location').value = ''; tempThemes = [];
            document.getElementById('eat-loc-id').value = '';
            if(id) {
                const item = mustEatList.find(i => i.id === id);
                if(item) {
                    document.getElementById('eat-loc-id').value = item.id;
                    document.getElementById('eat-location').value = item.location;
                    tempThemes = JSON.parse(JSON.stringify(item.themes));
                }
            } else {
                tempThemes = [{id: Date.now(), name: '', url: '', isVeg: false}];
            }
            renderThemeRows(); openModal('must-eat-modal');
        }
        function renderThemeRows() {
            document.getElementById('eat-themes-container').innerHTML = tempThemes.map((t, i) => `
                <div class="bg-gray-50 p-2 rounded border relative">
                    <button onclick="removeTheme(${i})" class="absolute top-1 right-1 text-gray-300">x</button>
                    <div class="flex gap-2 mb-1">
                        <input type="text" value="${t.name}" onchange="updateTheme(${i},'name',this.value)" placeholder="åº—å" class="flex-1 bg-transparent border-b outline-none text-sm font-bold">
                        <label class="text-xs text-green-600"><input type="checkbox" ${t.isVeg?'checked':''} onchange="updateTheme(${i},'isVeg',this.checked)"> ç´ é£Ÿ</label>
                    </div>
                    <input type="text" value="${t.url||''}" onchange="updateTheme(${i},'url',this.value)" placeholder="ç¶²å€" class="w-full bg-white border rounded text-xs p-1">
                </div>
            `).join('');
        }
        function updateTheme(i, k, v) { tempThemes[i][k] = v; }
        function removeTheme(i) { tempThemes.splice(i, 1); renderThemeRows(); }
        function addThemeRow() { tempThemes.push({id: Date.now(), name: '', url: '', isVeg: false}); renderThemeRows(); }
        function saveMustEatLocation() {
            const id = document.getElementById('eat-loc-id').value;
            const loc = document.getElementById('eat-location').value;
            if(!loc) return alert("è«‹è¼¸å…¥åœ°é»");
            const data = { id: id || 'loc_'+Date.now(), location: loc, themes: tempThemes.filter(t => t.name) };
            if(id) mustEatList[mustEatList.findIndex(i=>i.id===id)] = data; else mustEatList.push(data);
            saveData(); renderMustEatList(); closeModal('must-eat-modal');
        }
        function deleteMustEatLocation() {
            const id = document.getElementById('eat-loc-id').value;
            if(id && confirm("åˆªé™¤?")) { mustEatList = mustEatList.filter(i=>i.id!==id); saveData(); renderMustEatList(); closeModal('must-eat-modal'); }
        }

        // --- GIST SYNC ---
        function forceDownload() {
            if(!gistId) return alert("è«‹å…ˆè¨­å®š Gist ID");
            document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä¸‹è¼‰ä¸­...';
            fetch(`https://api.github.com/gists/${gistId}?t=${Date.now()}`, {headers: {'Authorization': `token ${gistToken}`}})
            .then(r=>r.json()).then(d=>{
                const content = JSON.parse(d.files["travel_data.json"].content);
                localStorage.setItem('flights', JSON.stringify(content.flights||[]));
                localStorage.setItem('itinerary_v2', JSON.stringify(content.itinerary||[]));
                localStorage.setItem('mustEatList', JSON.stringify(content.mustEatList||[]));
                localStorage.setItem('guides', JSON.stringify(content.guides||[]));
                localStorage.setItem('expenses', JSON.stringify(content.expenses||[]));
                alert("åŒæ­¥æˆåŠŸï¼"); location.reload();
            }).catch(()=>alert("åŒæ­¥å¤±æ•—"));
        }
        async function forceUpload() {
            if(!gistId) return;
            document.getElementById('cloud-status').innerHTML = 'ä¸Šå‚³ä¸­...';
            const payload = { flights, itinerary, mustEatList, expenses, guides, shoppingList, payers, lastUpdate: new Date() };
            await fetch(`https://api.github.com/gists/${gistId}`, {
                method: 'PATCH', headers: {'Authorization': `token ${gistToken}`, 'Content-Type': 'application/json'},
                body: JSON.stringify({ files: { "travel_data.json": { content: JSON.stringify(payload) } } })
            });
            document.getElementById('cloud-status').innerHTML = 'å·²åŒæ­¥';
        }
        function saveGistConfig() {
            gistId = document.getElementById('gist-id-input').value;
            gistToken = document.getElementById('gist-token-input').value;
            localStorage.setItem('gist_id', gistId); localStorage.setItem('gist_token', gistToken);
            alert("è¨­å®šå·²å„²å­˜");
        }

        // --- UTILS ---
        function processImage(input, cb) {
            if(input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    const i = new Image();
                    i.onload = () => {
                        const c = document.createElement('canvas'), ctx = c.getContext('2d');
                        let w=i.width, h=i.height, max=800;
                        if(w>h && w>max){h*=max/w;w=max;} else if(h>max){w*=max/h;h=max;}
                        c.width=w; c.height=h; ctx.drawImage(i,0,0,w,h);
                        cb(c.toDataURL('image/jpeg', 0.6));
                    };
                    i.src = e.target.result;
                };
                r.readAsDataURL(input.files[0]);
            }
        }
        function viewPhoto(src) { document.getElementById('lightbox-image').src = src; openModal('lightbox-modal'); }
        
        // --- TRANSLATE ---
        function toggleVoiceInput() {
            if(!('webkitSpeechRecognition' in window)) return alert("ä¸æ”¯æ´èªéŸ³");
            const r = new webkitSpeechRecognition(); r.lang = 'zh-TW';
            r.onstart = () => document.getElementById('btn-mic').classList.add('text-red-500','animate-pulse');
            r.onend = () => document.getElementById('btn-mic').classList.remove('text-red-500','animate-pulse');
            r.onresult = e => document.getElementById('trans-input').value += e.results[0][0].transcript;
            r.start();
        }
        function openGoogleTranslate() {
            const txt = document.getElementById('trans-input').value;
            window.open(`https://translate.google.com/?sl=zh-TW&tl=ja&text=${encodeURIComponent(txt)}&op=translate`, '_blank');
        }

        // --- INIT ---
        window.onload = function() {
            reloadData(); renderItinerary(); renderGuides(); renderMustEatList();
            if(gistId) { document.getElementById('gist-id-input').value=gistId; document.getElementById('gist-token-input').value=gistToken; }
            switchTab('plan');
        }
    </script>
</body>
</html>
