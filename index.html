<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—…ã®è¨˜">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f9f7f2">

    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/2200/2200326.png">

    <title>ä¸€èµ·æ—…è¡Œå§</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- å¼•å…¥æ—¥ç³»å­—é«”ï¼šZen Maru Gothic (åœ“é«”) ç‚ºä¸»ï¼ŒYomogi ç‚ºè¼” -->
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'paper': '#f9f7f2', 
                        'sakura': '#f8c3cd', 
                        'matcha': '#bccc9a', 
                        'fuji': '#7b90d2', 
                        'fuji-light': '#eff6ff', 
                        'pencil': '#595857', 
                        'ink': '#2c2c2c',
                        'clay': '#b5651d'
                    },
                    fontFamily: { 
                        /* [V35.11] çµ±ä¸€ä½¿ç”¨ Zen Maru Gothic ä½œç‚ºä¸»è¦æ‰‹å¯«æ„Ÿå­—é«”ï¼Œç¢ºä¿æ¸…æ¥šä¸”ç²—é«” */
                        'hand': ['"Zen Maru Gothic"', 'sans-serif'], 
                        'yomogi': ['"Yomogi"', 'cursive']
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0,0,0,0.03)'
                    }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body {
            /* [V35.11] é è¨­å­—é«”æ”¹ç‚º Zen Maru Gothicï¼Œç¢ºä¿æ‰€æœ‰æ–‡å­—éƒ½ä¸€è‡´åœ“æ½¤ */
            font-family: 'Zen Maru Gothic', sans-serif; 
            font-weight: 700; /* å…¨å±€é è¨­è¼ƒç²—ï¼Œæ¸…æ¥šæ˜ç­ */
            background-color: #f9f7f2; 
            color: #595857;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: center top;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none;
            min-height: 100vh; padding-bottom: calc(80px + var(--sab));
        }
        
        /* [V35.11] é‡å°éœ€è¦æ›´åƒæ‰‹å¯«çš„åœ°æ–¹ (å¦‚æ¨™é¡Œ)ï¼ŒåŠ å¼·å­—é‡ */
        .handwritten { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            font-weight: 900; 
        }
        
        .modal { transition: opacity 0.3s ease-in-out; } .modal.hidden { opacity: 0; pointer-events: none; } .modal.visible { opacity: 1; pointer-events: auto; }
        .hand-card { border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); position: relative; transition: transform 0.2s; background: #fff; }
        .btn-action { border: 2px solid #595857; border-radius: 999px; transition: all 0.2s; }
        .btn-action:active { transform: scale(0.95); }
        .nav-item.active i, .nav-item.active span { color: #7b90d2; font-weight: 900; } 
        .zoom-container { overflow: auto; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .zoom-container img { transition: transform 0.2s; cursor: zoom-in; }
        .zoom-container img.zoomed { max-width: none !important; max-height: none !important; cursor: zoom-out; cursor: grab; }
        .zoom-container.zoomed-mode { align-items: flex-start; justify-content: flex-start; }
        
        /* AI Chat Bubble Styles */
        .chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.5; margin-bottom: 10px; position: relative; word-wrap: break-word; font-weight: 500; }
        .chat-bubble.ai { background-color: #eff6ff; color: #4b5563; border-bottom-left-radius: 4px; align-self: flex-start; border: 1px solid #dbeafe; margin-right: auto; }
        .chat-bubble.user { background-color: #7b90d2; color: white; border-bottom-right-radius: 4px; align-self: flex-end; margin-left: auto; }
        
        /* Checkbox Style for Payers */
        .payer-checkbox:checked + div {
            background-color: #7b90d2; color: white; border-color: #7b90d2;
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="pb-2 px-4 text-center sticky top-0 bg-[#f9f7f2]/95 z-40 backdrop-blur-sm transition-all duration-300 relative" style="padding-top: max(1.5rem, var(--sat));">
        <h1 class="text-4xl font-black tracking-widest text-ink handwritten relative inline-block mt-2">
            <span class="absolute -top-4 -left-6 text-3xl rotate-[-15deg] opacity-60">âœˆï¸</span>
            æ—…ã®è¨˜
            <div class="absolute bottom-1 left-0 w-full h-3 bg-sakura/40 -z-10 rounded-full transform -rotate-1"></div>
        </h1>
        <div class="flex justify-center items-center gap-2 mt-2">
            <p class="text-[10px] text-fuji font-bold tracking-[0.2em] uppercase handwritten">My Travel Logbook</p>
            <div id="cloud-status" class="text-[10px] bg-gray-200/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 cursor-pointer" onclick="switchTab('info'); alert('è«‹åœ¨è³‡è¨Šé é¢æª¢æŸ¥ Gist è¨­å®š');">
                <i class="fa-solid fa-code-branch"></i> <span>æœªé€£ç·š</span>
            </div>
            <button onclick="forceDownload()" class="text-[10px] bg-gray-100/50 text-gray-400 px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors border border-gray-200 hover:bg-fuji-light hover:text-fuji" title="ç«‹å³åŒæ­¥">
                <i class="fa-solid fa-rotate-right"></i> <span>åŒæ­¥</span>
            </button>
        </div>
        
        <!-- AI æŒ‰éˆ• -->
        <button onclick="openAIModal()" class="absolute top-0 left-5 text-fuji hover:text-fuji-dark active:scale-95 transition-all text-xl p-2" style="padding-top: max(1.8rem, calc(0.3rem + var(--sat)));" title="AI æ—…éŠåŠ©æ‰‹">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
        </button>

        <button id="quick-expense-btn" onclick="switchTab('wallet'); openExpenseModal();" class="absolute top-0 right-5 text-matcha hover:text-green-700 active:scale-95 transition-all text-2xl p-1" style="padding-top: max(1.8rem, calc(0.3rem + var(--sat))); display: none;" title="å¿«é€Ÿè¨˜å¸³">
            <i class="fa-solid fa-circle-dollar-to-slot"></i>
        </button>
    </header>

    <!-- MAIN CONTAINER -->
    <main id="app" class="px-5 w-full mx-auto min-h-screen max-w-md relative pb-24">
        <div class="absolute top-0 left-0 -ml-4 mt-6 text-2xl opacity-50 rotate-[-10deg] pointer-events-none z-0">ğŸŒ¸</div>
        <div class="absolute top-1/4 right-0 -mr-4 text-3xl text-fuji/30 rotate-[20deg] pointer-events-none z-0">ğŸ—»</div>
        <div class="absolute bottom-1/3 left-0 -ml-8 text-xl text-matcha/40 pointer-events-none z-0">ğŸµ</div>

        <!-- PLAN VIEW -->
        <section id="view-plan" class="view-section animate-fade relative z-10">
            <div class="flex justify-between items-center mb-4 mt-6">
                <h3 class="text-pencil font-black handwritten text-xl flex items-center"><i class="fa-solid fa-plane-departure mr-2 text-xl"></i>èˆªç­è³‡è¨Š</h3>
                <button onclick="openFlightModal()" class="text-xs bg-white border border-fuji/30 text-fuji px-3 py-1.5 rounded-lg shadow-sm active:scale-95 font-bold hover:bg-fuji hover:text-white transition"><i class="fa-solid fa-plus mr-1"></i>æ–°å¢</button>
            </div>
            <div id="flight-list-container" class="space-y-4 mb-10"></div>
            
            <div class="flex justify-between items-center mb-4 border-t-2 border-dashed border-gray-200 pt-8 mt-6">
                 <h3 class="text-pencil font-black handwritten text-xl flex items-center"><i class="fa-solid fa-map-location-dot mr-2 text-xl"></i>æ¯æ—¥è¡Œç¨‹</h3>
            </div>
            <p class="text-xs text-gray-400 mb-4 text-center handwritten font-bold"><i class="fa-solid fa-circle-info mr-1"></i> é»æ“Šå‰æ–¹åœ–ç¤ºè¨˜å¸³ / é»æ“Šé¤é»æˆ–ä½å®¿å°èˆª</p>
            <div id="itinerary-container" class="space-y-6"></div>
            <button onclick="addNewDay()" class="w-full mt-6 mb-8 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl py-3 hover:bg-white hover:border-matcha hover:text-matcha transition font-black text-sm bg-white/50 handwritten"><i class="fa-solid fa-plus-circle mr-1"></i> å¯«ä¸‹ä¸€é å›æ†¶</button>
        </section>

        <!-- GUIDE VIEW -->
        <section id="view-guide" class="view-section hidden relative z-10">
            <div class="flex justify-between items-end mb-4 mt-4">
                <h2 class="text-2xl font-black text-pencil handwritten">æ·±åº¦å°è¦½</h2>
                <button onclick="openGuideModal()" class="text-sm bg-matcha/30 text-green-800 px-3 py-1 rounded-full border border-matcha hover:bg-matcha hover:text-white transition"><i class="fa-solid fa-plus mr-1"></i>æ–°å¢</button>
            </div>
            <div id="guide-list" class="space-y-6"></div>
        </section>

        <!-- WALLET VIEW -->
        <section id="view-wallet" class="view-section hidden relative z-10">
            
            <!-- å…¬è²»è³‡é‡‘æ± è¨­å®š -->
            <div class="bg-matcha/10 rounded-2xl p-4 shadow-sm border border-matcha/30 mb-4 relative mt-4">
                <h4 class="text-sm font-black text-green-800 mb-2 handwritten text-lg flex items-center gap-2">
                    <i class="fa-solid fa-sack-dollar"></i> å…¬è²»è³‡é‡‘æ±  (JPY)
                </h4>
                <div class="flex justify-between items-end">
                    <div>
                        <div class="text-xs text-gray-500 mb-1 font-bold">å…¬è²»ç¸½é ç®—</div>
                        <div class="flex items-center gap-1">
                            <span class="text-matcha font-black">Â¥</span>
                            <input type="number" id="public-fund-total" value="0" onchange="savePublicFundTotal(); renderExpenses();" class="w-24 bg-white/50 border-b border-matcha text-green-800 font-mono text-lg font-black outline-none rounded px-1" placeholder="è¼¸å…¥é‡‘é¡">
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500 mb-1 font-bold">å‰©é¤˜é‡‘é¡</div>
                        <div id="public-fund-remaining" class="text-2xl font-black font-mono text-gray-700">Â¥ 0</div>
                    </div>
                </div>
            </div>

            <div class="bg-[#2c3e50]/95 rounded-2xl p-4 shadow-soft text-white mb-6 relative overflow-hidden backdrop-blur-xl">
                <div class="absolute top-0 right-0 w-20 h-20 bg-white/5 rounded-full -mr-10 -mt-10"></div>
                <h4 class="text-sm text-gray-300 font-bold mb-3 flex justify-between items-center relative z-10">
                    <span class="flex items-center tracking-wider handwritten"><i class="fa-solid fa-chart-simple mr-2"></i>è²¡å‹™ç¸½è¦½ (TWD)</span>
                    <button onclick="renderExpenses()" class="text-xs text-blue-300 hover:text-white"><i class="fa-solid fa-rotate-right"></i></button>
                </h4>
                <div id="individual-stats-dashboard" class="grid grid-cols-2 gap-3 text-xs relative z-10"></div>
                <div class="mt-4 flex justify-between items-end relative z-10 border-t border-gray-600 pt-2">
                    <div class="text-right">
                        <span class="text-xs text-gray-400 font-bold">åŒ¯ç‡ (1 JPY â‰ˆ)</span>
                        <input type="number" id="exchange-rate" value="0.215" step="0.001" onchange="renderExpenses()" class="w-16 bg-gray-600 text-center rounded text-sm outline-none ml-1 text-white border-b border-gray-500 font-bold">
                    </div>
                    <div>
                        <span class="text-xs text-gray-400 block mb-1 font-bold">è¡Œç¨‹ç¸½æ”¯å‡º (å°å¹£)</span>
                        <div class="text-xl font-black font-mono text-yellow-300" id="wallet-total-display">NT$ 0</div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-4">
                <button onclick="openIOUModal()" class="text-xs bg-fuji/10 text-fuji font-bold px-3 py-2 rounded border border-fuji/30 hover:bg-fuji/30 transition flex items-center gap-1"><i class="fa-solid fa-money-bill-transfer"></i> æ‰‹å‹•æ¬ æ¬¾/å€Ÿæ¬¾</button>
                 <button onclick="openPayerModal()" class="text-xs text-gray-400 border border-gray-300 rounded px-2 py-1 hover:bg-white font-bold"><i class="fa-solid fa-gear mr-1"></i>ç®¡ç†æˆå“¡</button>
            </div>
            <div id="settlement-summary-container" class="mb-6"><div class="bg-matcha/10 rounded-lg p-4 shadow-sm border border-matcha/30"><h4 class="text-sm font-black text-green-800 mb-2 handwritten text-lg"><i class="fa-solid fa-handshake mr-1"></i> çµç®—å°å¹«æ‰‹ (ç§äººåˆ†å¸³)</h4><div id="settlement-summary" class="text-sm space-y-2 font-mono text-gray-600 font-bold"></div></div></div>
            <div class="flex items-center gap-2 mb-3"><span class="text-xs font-bold text-gray-500">ä»˜æ¬¾äºº:</span><select id="wallet-filter" onchange="renderExpenses()" class="bg-white border border-gray-300 rounded text-sm p-1 outline-none font-bold"><option value="ALL">å…¨éƒ¨</option></select></div>
            <button onclick="openExpenseModal()" class="w-full btn-action bg-sakura/10 text-red-800 font-black py-3 mb-6 flex items-center justify-center gap-2 border-sakura"><i class="fa-solid fa-pen-nib"></i> è¨˜ä¸€ç­†</button>
            <div id="expense-list" class="space-y-3 pb-20"></div>
        </section>

        <!-- LISTS VIEW -->
        <section id="view-lists" class="view-section hidden relative z-10">
            <div class="hand-card p-5 mb-6 bg-[#fffdf0] relative mt-4">
                 <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-300 pb-2 mt-2">
                    <h3 class="text-xl font-black text-pencil handwritten">å¿…åƒæ¸…å–®</h3>
                    <button onclick="openMustEatModal()" class="text-xs bg-matcha/20 text-green-700 px-2 py-1 rounded border border-matcha/50 shadow-sm hover:bg-matcha hover:text-white transition font-bold">+ æ–°å¢</button>
                 </div>
                 <div id="must-eat-list" class="space-y-3"></div>
            </div>
            <div class="hand-card p-5 mb-6 bg-white relative">
                 <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-200 pb-2 mt-2">
                    <h3 class="text-xl font-black text-pencil handwritten">è³¼ç‰©æ¸…å–®</h3>
                    <button onclick="openShoppingModal()" class="text-xs bg-red-50 text-red-500 px-2 py-1 rounded border border-red-100 hover:bg-red-400 hover:text-white transition font-bold">+ æ–°å¢</button>
                 </div>
                 <div id="shopping-list-pending" class="grid grid-cols-2 gap-3 mb-4"></div>
                 <div id="shopping-list-done" class="grid grid-cols-2 gap-3 opacity-60 grayscale"></div>
            </div>
            <div class="hand-card p-5 mb-6 bg-[#f0f4f8]">
                <h3 class="text-lg font-black text-center mb-4 text-fuji handwritten"><i class="fa-solid fa-suitcase mr-2"></i>è¡Œæç¢ºèª</h3>
                <ul id="checklist-container" class="space-y-2"></ul>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="new-todo" placeholder="æ–°å¢é …ç›®..." class="flex-1 bg-transparent border-b border-gray-300 text-sm outline-none font-bold">
                    <button onclick="addTodo()" class="text-fuji hover:scale-110 transition"><i class="fa-solid fa-circle-plus fa-lg"></i></button>
                </div>
            </div>
             <div class="hand-card p-5 bg-[#fffff0] rotate-1 shadow-md">
                <div class="absolute top-0 left-0 w-full h-2 bg-yellow-400/20"></div>
                <h3 class="text-lg font-black mb-2 handwritten text-yellow-800"><i class="fa-solid fa-note-sticky mr-2"></i>éš¨æ‰‹è¨˜ (MEMO)</h3>
                <textarea id="memo-pad" class="w-full h-48 p-3 bg-transparent border-none resize-none text-sm leading-8 outline-none text-gray-700 handwritten font-bold" style="background-image: repeating-linear-gradient(transparent, transparent 31px, #e5e5e5 32px); line-height: 32px;" placeholder="åœ¨é€™è£¡éš¨æ‰‹è¨˜ä¸‹æƒ³æ³•..."></textarea>
            </div>
        </section>

        <!-- INFO VIEW -->
        <section id="view-info" class="view-section hidden relative z-10">
            <div class="flex justify-between items-center mb-6 mt-4 px-2">
                <div class="w-8"></div> 
                <h2 class="text-2xl font-black handwritten text-center">æ—…é€”æƒ…å ±</h2>
                <button onclick="resetToDefaults()" class="w-8 h-8 rounded-full bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100 transition shadow-sm" title="å¼·åˆ¶é‡ç½®è³‡æ–™">
                    <i class="fa-solid fa-rotate-right text-xs"></i>
                </button>
            </div>

            <!-- [V35.11] å¼·åŒ–æç¤ºèˆ‡è¼¸å…¥æ¡† -->
            <div class="hand-card p-4 mb-6 border-l-4 border-matcha bg-matcha/5">
                <h3 class="font-black text-green-800 mb-2 handwritten text-lg"><i class="fa-brands fa-github mr-2"></i>GitHub Gist åŒæ­¥</h3>
                <div class="text-xs text-gray-500 mb-4 bg-yellow-100 p-2 rounded font-bold leading-relaxed">
                    è«‹è¼¸å…¥ Token èˆ‡ Gist IDã€‚<br>
                    <span class="text-red-500">* è‹¥è²¼ä¸Šå®Œæ•´ç¶²å€ï¼Œç³»çµ±æœƒè‡ªå‹•æ“·å– IDã€‚</span>
                </div>
                <div class="space-y-3">
                    <input type="text" id="gist-id-input" placeholder="Gist ID æˆ– å®Œæ•´ç¶²å€" class="w-full border p-2 rounded text-sm font-mono bg-white font-bold text-gray-600">
                    <input type="password" id="gist-token-input" placeholder="Token (ghp_...)" class="w-full border p-2 rounded text-sm font-mono bg-white font-bold text-gray-600">
                    <button onclick="saveGistConfig()" class="w-full bg-matcha text-white px-3 py-2 rounded text-sm font-black shadow hover:bg-matcha/80"><i class="fa-solid fa-floppy-disk mr-1"></i> å„²å­˜è¨­å®šä¸¦é€£ç·š</button>
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-dashed border-matcha/30">
                     <button onclick="forceDownload()" class="flex-1 bg-white border border-green-200 text-green-800 px-2 py-2 rounded text-xs hover:bg-green-50 shadow-sm font-bold"><i class="fa-solid fa-cloud-arrow-down mr-1"></i> ä¸‹è¼‰</button>
                     <button onclick="forceUpload()" class="flex-1 bg-white border border-green-200 text-green-800 px-2 py-2 rounded text-xs hover:bg-green-50 shadow-sm font-bold"><i class="fa-solid fa-cloud-arrow-up mr-1"></i> ä¸Šå‚³</button>
                </div>
            </div>

             <div class="grid grid-cols-2 gap-4 mb-6">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-blue-50 transition"><i class="fa-solid fa-cloud-sun-rain text-3xl text-fuji mb-2"></i><span class="font-black text-sm mt-2">å¤©æ°£é å ±</span></a>
                <a href="https://www.google.com/maps/search/drugstore" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-pink-50 transition"><i class="fa-solid fa-store text-3xl text-sakura mb-2"></i><span class="font-black text-sm mt-2">é™„è¿‘è—¥å¦</span></a>
            </div>
        </section>
    </main>

    <!-- MODALS (Hidden by default) -->
    <!-- AI Modal -->
    <div id="ai-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-3xl p-5 shadow-2xl relative hand-card h-[60vh] flex flex-col">
            <button onclick="closeModal('ai-modal')" class="absolute top-3 right-3 text-gray-400 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-black mb-4 text-center handwritten text-fuji"><i class="fa-solid fa-robot mr-2"></i>AI æ—…éŠåŠ©æ‰‹</h3>
            <div id="ai-chat-history" class="flex-1 overflow-y-auto p-2 bg-white/50 rounded-lg border border-gray-100 mb-3 flex flex-col gap-2 font-bold text-sm">
                <div class="chat-bubble ai">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ—…éŠå°å¹«æ‰‹ã€‚<br>æ‚¨å¯ä»¥å•æˆ‘ï¼šã€Œä»Šå¤©è¡Œç¨‹ã€ã€ã€Œé‚„æœ‰å¤šå°‘éŒ¢ã€æˆ–ã€Œæ¨è–¦åƒä»€éº¼ã€ã€‚</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="ai-input" placeholder="è¼¸å…¥å•é¡Œ..." class="flex-1 border rounded-full px-3 py-2 text-sm outline-none focus:border-fuji font-bold" onkeypress="if(event.key==='Enter') sendAIQuery()">
                <button onclick="sendAIQuery()" class="bg-fuji text-white w-10 h-10 rounded-full flex items-center justify-center shadow hover:bg-fuji/80"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Flight Modal -->
    <div id="flight-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-3xl p-6 shadow-2xl relative hand-card">
            <button onclick="closeModal('flight-modal')" class="absolute top-3 right-3 text-gray-400 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-black mb-4 text-center handwritten">ç·¨è¼¯èˆªç­</h3>
            <div class="space-y-4">
                <input type="hidden" id="flight-id"> 
                <div class="flex gap-4 items-center">
                    <input type="text" id="flight-dep" placeholder="TPE" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white">
                    <i class="fa-solid fa-plane text-gray-300"></i>
                    <input type="text" id="flight-arr" placeholder="NRT" class="w-1/2 p-3 text-center font-black handwritten text-3xl border-2 border-gray-100 rounded-xl focus:border-fuji outline-none bg-white">
                </div>
                <div class="bg-fuji-light p-4 rounded-xl">
                    <input type="text" id="flight-code" placeholder="èˆªç­ä»£è™Ÿ (ä¾‹: IT202)" class="w-full p-2 border-b border-fuji/20 bg-transparent text-center font-black text-fuji handwritten text-xl mb-2 focus:outline-none placeholder-fuji/40">
                    <input type="text" id="flight-date" placeholder="æ—¥æœŸ (ä¾‹: 1/10 å»ç¨‹)" class="w-full p-1 bg-transparent text-center text-sm font-bold text-gray-500 mb-1 focus:outline-none">
                    <input type="text" id="flight-time" placeholder="æ™‚é–“ (ä¾‹: 14:00 - 18:00)" class="w-full p-1 bg-transparent text-center text-sm font-bold text-gray-500 focus:outline-none">
                </div>
                <input type="url" id="flight-url" placeholder="é€£çµ (e-ticket)" class="w-full p-2 border rounded-lg bg-white text-xs text-center font-bold">
                <button onclick="saveFlight()" class="w-full bg-fuji text-white py-3 rounded-xl font-black mt-2 shadow-lg shadow-fuji/30 hover:bg-fuji/90 transition handwritten tracking-widest">å„² å­˜</button>
            </div>
        </div>
    </div>

    <!-- Day Modal -->
    <div id="day-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-4 shadow-2xl relative hand-card h-[85vh] overflow-y-auto border-4 border-white">
            <button onclick="closeModal('day-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-black mb-2 text-center handwritten">ç·¨è¼¯è¡Œç¨‹</h3>
            <input type="hidden" id="day-id-edit">
            <input type="text" id="day-date-edit" class="w-full p-2 border-b-2 border-matcha bg-transparent font-black mb-4 font-hand text-xl focus:outline-none" placeholder="æ—¥æœŸæ¨™é¡Œ">
            <label class="flex items-center space-x-2 text-sm text-gray-600 mb-4 bg-yellow-50 p-2 rounded font-bold"><input type="checkbox" id="day-highlight-edit" class="accent-red-400"><span>æ¨™è¨˜ç‚ºé‡é»å¤©æ•¸ (Highlight)</span></label>
            <div class="mb-4 bg-white p-2 rounded border border-gray-200 shadow-inner"><div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-gray-400">ç•¶æ—¥ç›¸ç‰‡é›†</h4><div class="relative overflow-hidden inline-block"><button class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs hover:bg-gray-200 font-bold"><i class="fa-solid fa-plus"></i> æ–°å¢</button><input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addDayPhoto(this)"></div></div><div id="day-photos-preview" class="grid grid-cols-3 gap-2"></div></div>
            <div class="mb-4"><input type="text" id="day-accommodation-edit" class="w-full p-2 border rounded text-sm mb-2 font-bold" placeholder="ä½å®¿åœ°é»"><input type="url" id="day-accommodation-url-edit" class="w-full p-2 border rounded text-sm font-bold" placeholder="Google Maps é€£çµ"></div>
            <div class="mb-4 border-t pt-3 bg-gray-50 p-2 rounded-lg border border-gray-100"><h4 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1"><i class="fa-solid fa-train"></i> äº¤é€šæ–¹å¼</h4><div class="flex gap-2 mb-2"><input type="time" id="day-trans-time" class="w-1/3 p-2 border border-gray-300 rounded text-sm font-bold"><input type="text" id="day-trans-content" placeholder="å…§å®¹ (å¦‚: æ­æ–°å¹¹ç·š)" class="flex-1 p-2 border border-gray-300 rounded text-sm font-bold"></div><div class="flex gap-2 mb-2"><input type="text" id="day-trans-note" placeholder="å‚™è¨» (å¦‚: è²·ç¥¨)" class="flex-1 p-2 border border-gray-300 rounded text-sm font-bold"></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative hover:bg-white bg-white"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentTransPhoto = base64; document.getElementById('trans-photo-preview').src = base64; document.getElementById('trans-photo-preview').classList.remove('hidden'); document.getElementById('trans-photo-text').classList.add('hidden'); })"><div id="trans-photo-text" class="text-xs text-gray-400 font-bold"><i class="fa-solid fa-ticket mb-1 block"></i> ä¸Šå‚³è»Šç¥¨/æ™‚åˆ»è¡¨</div><img id="trans-photo-preview" class="hidden h-20 mx-auto object-contain rounded"><button onclick="clearTransPhoto()" class="absolute top-1 right-1 bg-gray-200 rounded-full w-5 h-5 text-[10px] text-gray-500 z-10"><i class="fa-solid fa-times"></i></button></div></div>
            <textarea id="day-content-edit" class="w-full h-32 p-3 border rounded-lg bg-white text-sm mb-4 font-hand font-bold leading-relaxed" placeholder="è¡Œç¨‹å…§å®¹... (è«‹ç”¨åæ–œç·š '\' åˆ†éš”æ¯é …æ´»å‹•)"></textarea>
            <div class="bg-white p-3 rounded-lg border mb-4 space-y-4 shadow-sm"><h4 class="text-xs font-bold text-gray-400 border-b pb-1">ä¸‰é¤å®‰æ’</h4>
                <div class="border-b pb-2"><div class="flex gap-2 mb-1"><i class="fa-solid fa-mug-hot text-orange-300 w-5"></i><input type="text" id="meal-b-name" placeholder="æ—©é¤" class="flex-1 text-sm font-black bg-transparent"></div>
                    <div class="flex gap-2 pl-7"><input type="url" id="meal-b-url" placeholder="ç¶²å€" class="w-1/2 text-xs border rounded px-1 font-bold"><input type="text" id="meal-b-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1 font-bold"></div>
                </div>
                <div class="border-b pb-2"><div class="flex gap-2 mb-1"><i class="fa-solid fa-utensils text-green-400 w-5"></i><input type="text" id="meal-l-name" placeholder="åˆé¤" class="flex-1 text-sm font-black bg-transparent"></div>
                    <div class="flex gap-2 pl-7"><input type="url" id="meal-l-url" placeholder="ç¶²å€" class="w-1/2 text-xs border rounded px-1 font-bold"><input type="text" id="meal-l-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1 font-bold"></div>
                </div>
                <div><div class="flex gap-2 mb-1"><i class="fa-solid fa-wine-glass text-purple-400 w-5"></i><input type="text" id="meal-d-name" placeholder="æ™šé¤" class="flex-1 text-sm font-black bg-transparent"></div>
                    <div class="flex gap-2 pl-7"><input type="url" id="meal-d-url" placeholder="ç¶²å€" class="w-1/2 text-xs border rounded px-1 font-bold"><input type="text" id="meal-d-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1 font-bold"></div>
                </div>
            </div>
            <textarea id="day-note-edit" class="w-full h-20 p-2 border border-yellow-200 bg-yellow-50 rounded text-sm mb-4 handwritten font-bold" placeholder="æ¯æ—¥å‚™è¨»..."></textarea>
            <div class="flex gap-2"><button onclick="deleteDay()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm font-bold">åˆªé™¤</button><button onclick="saveDay()" class="flex-[2] bg-matcha text-white py-2 rounded-lg font-black shadow">å„²å­˜</button></div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expense-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('expense-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-black mb-4 text-center">è¨˜ä¸‹ä¸€ç­†</h3>
            <input type="hidden" id="ex-id">
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2"><select id="ex-category" class="w-full bg-white border rounded p-2 text-sm font-bold"><option value="é£²é£Ÿ">ğŸœ é£²é£Ÿ</option><option value="äº¤é€š">ğŸšƒ äº¤é€š</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="å…¶ä»–">âœ¨ å…¶ä»–</option></select><input type="text" id="ex-note" placeholder="å‚™è¨»" class="w-full bg-white border-b p-2 text-sm font-bold"></div>
                <div class="flex items-center gap-2 bg-white border rounded p-2"><select id="ex-currency" class="bg-transparent text-sm font-bold"><option value="JPY">JPY</option><option value="TWD">TWD</option></select><input type="number" id="ex-amount" placeholder="é‡‘é¡" class="flex-1 text-lg text-right w-full font-black" inputmode="numeric"></div>
                
                <!-- ä»˜æ¬¾äººå¤šé¸å€ -->
                <div class="bg-gray-50 p-2 rounded border border-gray-100">
                    <label class="block text-xs text-gray-400 mb-2 font-bold">ä»˜æ¬¾äºº (å¯å¤šé¸ï¼Œé‡‘é¡å‡åˆ†)</label>
                    <div id="payer-selection-container" class="flex flex-wrap gap-2"></div>
                </div>
                
                <div class="w-full"><label class="block text-xs text-gray-400 mb-1 font-bold">åˆ†å¸³äººæ•¸ (é™¤ä»¥)</label><input type="number" id="ex-people" value="1" min="1" class="w-full bg-white border rounded p-1 text-center font-bold"></div>
                
                <div class="border-2 border-dashed rounded-lg p-2 text-center relative"><input type="file" id="ex-photo" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentPhotoBase64 = base64; document.getElementById('photo-preview').src = base64; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); })"><div id="photo-placeholder" class="text-xs text-gray-400 font-bold"><i class="fa-solid fa-camera mb-1 block"></i> ä¸Šå‚³ç…§ç‰‡</div><img id="photo-preview" class="hidden h-24 mx-auto object-contain"></div>
            </div>
            <div class="flex gap-2 mt-4"><button onclick="deleteExpense()" id="btn-delete-expense" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden font-bold">åˆªé™¤</button><button onclick="saveExpense()" class="flex-[2] bg-clay text-white py-2 rounded-lg font-black shadow">å„²å­˜</button></div>
        </div>
    </div>

    <!-- Other Modals (Same as before, styles updated) -->
    <div id="lightbox-modal" class="modal hidden fixed inset-0 bg-black/50 z-[100] flex flex-col" onclick="closeModal('lightbox-modal')"><div class="absolute top-4 right-4 text-white/80 z-50 cursor-pointer bg-black/50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-white/20 transition"><i class="fa-solid fa-times"></i></div><div id="lightbox-container" class="zoom-container p-2" onclick="event.stopPropagation()"><img id="lightbox-image" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded-sm" onclick="toggleZoom(this)"></div></div>
    <div id="guide-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card"><button onclick="closeModal('guide-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-black mb-3 handwritten text-lg">æ–°å¢/ç·¨è¼¯æ™¯é»å°è¦½</h3><input type="hidden" id="guide-id"><input type="text" id="guide-title" placeholder="æ™¯é»åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-black font-hand text-lg focus:border-matcha outline-none"><textarea id="guide-desc" placeholder="ä»‹ç´¹å…§å®¹..." class="w-full mb-3 border bg-white p-2 rounded h-24 text-sm font-bold"></textarea><input type="text" id="guide-coords" placeholder="åº§æ¨™ (36.34,138.61)" class="w-full mb-3 border-b bg-transparent p-2 text-xs font-bold"><div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative mb-3 hover:bg-white bg-white/50"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentGuidePhoto = base64; document.getElementById('guide-photo-preview').src = base64; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden'); })"><div id="guide-photo-text" class="text-xs text-gray-400 font-bold"><i class="fa-solid fa-image mb-1 block"></i> æ›´æ–°ç…§ç‰‡</div><img id="guide-photo-preview" class="hidden h-32 mx-auto object-cover rounded"></div><button onclick="saveGuide()" class="w-full bg-matcha text-white py-2 rounded-lg font-black">å„²å­˜</button></div></div>
    <div id="shopping-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card"><button onclick="closeModal('shopping-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="font-black mb-3 text-center">è³¼ç‰©é …ç›®</h3><input type="hidden" id="shop-id"><input type="text" id="shop-name" placeholder="å•†å“åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-black"><div class="flex gap-2 mb-3"><div class="flex-1"><label class="text-xs text-gray-400 font-bold">æ•¸é‡</label><input type="number" id="shop-qty" value="1" class="w-full border rounded p-2 text-sm font-bold"></div><div class="flex-[2]"><label class="text-xs text-gray-400 font-bold">å–®åƒ¹ (JPY)</label><input type="number" id="shop-price" placeholder="0" class="w-full border rounded p-2 text-sm font-bold"></div></div><div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center relative mb-4 bg-white"><input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentShopPhoto = base64; document.getElementById('shop-photo-preview').src = base64; document.getElementById('shop-photo-preview').classList.remove('hidden'); document.getElementById('shop-photo-text').classList.add('hidden'); })"><div id="shop-photo-text" class="text-xs text-gray-400 font-bold"><i class="fa-solid fa-camera mb-1 block"></i> ç…§ç‰‡</div><img id="shop-photo-preview" class="hidden h-32 mx-auto object-contain rounded"></div><div class="flex gap-2"><button onclick="deleteShoppingItem()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg font-bold">åˆªé™¤</button><button onclick="saveShoppingItem()" class="flex-[2] bg-red-400 text-white py-2 rounded-lg font-black shadow">å„²å­˜</button></div></div></div>
    <div id="must-eat-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto"><button onclick="closeModal('must-eat-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-black mb-4 text-center text-matcha">ğŸ½ï¸ ç·¨è¼¯å¿…åƒ</h3><input type="hidden" id="eat-id"><div class="space-y-3 p-3 border rounded-lg bg-white mb-4"><input type="text" id="eat-location" placeholder="åœ°é»åç¨± (ä¾‹å¦‚: è¼•äº•æ¾¤)" class="w-full p-2 border-b-2 border-matcha/50 bg-transparent text-center font-black"><input type="text" id="eat-name" placeholder="ä¸»é¡Œåç¨± (å¯é¸)" class="w-full p-2 border rounded bg-gray-50 text-sm font-bold"><textarea id="eat-note" placeholder="å‚™è¨»/äº¤é€š" class="w-full h-16 p-2 border rounded bg-gray-50 text-sm font-bold"></textarea></div><h4 class="text-sm font-black text-gray-600 mb-2">èœå–®/é …ç›®:</h4><div id="must-eat-items-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner font-bold"></div><div class="flex flex-col gap-2 mt-4 p-3 bg-gray-100 rounded-lg border border-gray-200"><div class="flex gap-2"><input type="text" id="new-food-name" placeholder="æ–°å¢åç¨±" class="flex-1 p-2 border rounded text-sm outline-matcha font-bold"><input type="number" id="new-food-price" placeholder="åƒ¹æ ¼" class="w-20 p-2 border rounded text-sm text-right outline-matcha font-bold"></div><div class="flex gap-2 items-center"><input type="url" id="new-food-url" placeholder="ç¶²å€ (å¯é¸)" class="flex-1 p-2 border rounded text-xs outline-matcha font-bold"><button onclick="addNewFoodItem()" class="bg-matcha text-white px-3 py-2 rounded-lg hover:bg-green-600 active:scale-95 transition text-sm font-bold"><i class="fa-solid fa-plus"></i></button></div></div><div class="flex gap-2 mt-4"><button onclick="deleteMustEatItem()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hover:bg-red-100 font-bold">åˆªé™¤</button><button onclick="saveMustEatItem()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-black shadow hover:bg-fuji/80">å„²å­˜</button></div></div></div>
    <div id="iou-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto"><button onclick="closeModal('iou-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button><h3 class="text-lg font-black mb-4 text-center text-fuji">ğŸ¤ æ‰‹å‹•æ¬ æ¬¾/å€Ÿæ¬¾</h3><input type="hidden" id="iou-id"><div class="space-y-3 p-3 border rounded-lg bg-white mb-4"><div class="text-xs text-gray-500 mb-1 font-bold">èª°å€Ÿçµ¦èª°ï¼Ÿ</div><div class="flex gap-2"><div class="flex-1"><label class="block text-xs text-gray-400 mb-1 font-bold">å‚µæ¬Šäºº</label><select id="iou-creditor" class="w-full bg-white border rounded p-1 text-sm font-bold"></select></div><div class="flex-1"><label class="block text-xs text-gray-400 mb-1 font-bold">å‚µå‹™äºº</label><select id="iou-debtor" class="w-full bg-white border rounded p-1 text-sm font-bold"></select></div></div><div class="flex items-center gap-2 bg-gray-50 border rounded p-2"><span class="font-black text-sm">TWD</span><input type="number" id="iou-amount" placeholder="é‡‘é¡" class="flex-1 text-lg text-right w-full bg-transparent font-black" inputmode="numeric"></div><input type="text" id="iou-note" placeholder="å‚™è¨»" class="w-full p-2 border rounded text-sm font-bold"><div class="flex gap-2 mt-3"><button onclick="deleteIOU()" id="btn-delete-iou" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden font-bold">åˆªé™¤</button><button onclick="saveIOU()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-black shadow">å„²å­˜</button></div></div><h4 class="text-sm font-black text-gray-600 mb-2">åˆ—è¡¨:</h4><div id="iou-list-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner font-bold"></div></div></div>
    <div id="payer-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4"><div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg"><h4 class="font-black mb-3 text-center">ç®¡ç†ä»˜æ¬¾äºº</h4><div id="payer-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto font-bold"></div><div class="flex gap-2"><input type="text" id="new-payer-name" placeholder="æ–°æˆå“¡åç¨±" class="flex-1 border p-1 text-sm rounded font-bold"><button onclick="addPayer()" class="bg-matcha text-white px-3 rounded text-sm font-bold">æ–°å¢</button></div><button onclick="closeModal('payer-modal')" class="w-full mt-3 bg-gray-200 py-1 rounded text-sm font-bold">é—œé–‰</button></div></div>


    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#f9f7f2] border-t border-gray-200 pt-2 pb-safe px-6 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.03)]" style="padding-bottom: calc(10px + var(--sab));">
        <div class="flex justify-between items-center w-full mx-auto pb-1 max-w-md">
            <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center text-gray-400 transition flex-1" data-target="plan"><i class="fa-solid fa-map text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è¡Œç¨‹</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="guide"><i class="fa-solid fa-book-open text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">å°è¦½</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="wallet"><i class="fa-solid fa-wallet text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è¨˜å¸³</span></button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="lists"><i class="fa-solid fa-list-check text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">æ¸…å–®</span></button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="info"><i class="fa-solid fa-circle-info text-lg mb-1"></i><span class="text-[10px] handwritten font-bold">è³‡è¨Š</span></button>
        </div>
    </nav>

    <!-- JAVASCRIPT -->
    <script>
        let flights = [], itinerary = [], mustEatList = [], expenses = [], guides = [], todos = [], shoppingList = [], payers = [], manualDebts = [], memoText = "";
        let publicFundBudget = 0; 

        let gistToken = localStorage.getItem('gist_token') || "";
        let gistId = localStorage.getItem('gist_id') || "";
        const GIST_FILE_NAME = "travel_data.json";
        window.autoUploadTimer = null;

        const RECOVERED_ITINERARY = [
            {
                "id": "day_1",
                "date": "1/10 Day 1 æˆç”°",
                "highlight": false,
                "content": "18:00 æŠµé”æˆç”°æ©Ÿå ´\nAeon Mall è¶…å¸‚åƒé€›",
                "accommodation": "æˆç”°æ©Ÿå ´å‘¨é‚Š",
                "accommodationUrl": "",
                "transportation": { "content": "æ­ä¹˜ Skyliner", "note": "äº‹å…ˆè²·ç¥¨", "time": "18:40" },
                "meals": { "b": { "name": "" }, "l": { "name": "" }, "d": { "name": "è¶…å¸‚ä¾¿ç•¶" } },
                "photos": [],
                "dayNote": ""
            }
        ];
        const RECOVERED_FLIGHTS = [];
        const RECOVERED_PAYERS = ["æˆ‘", "æ—…ä¼´", "å…¬è²»"];
        const RECOVERED_TODOS = [{"text": "è­·ç…§", "done": false}];

        // --- AI Logic ---
        function openAIModal() { openModal('ai-modal'); }
        function sendAIQuery() {
            const input = document.getElementById('ai-input');
            const history = document.getElementById('ai-chat-history');
            const q = input.value.trim();
            if(!q) return;
            history.innerHTML += `<div class="chat-bubble user">${q}</div>`;
            input.value = ''; history.scrollTop = history.scrollHeight;
            setTimeout(() => {
                let reply = "æŠ±æ­‰ï¼Œæˆ‘é‚„åœ¨å­¸ç¿’ä¸­ï¼Œä¸å¤ªç†è§£æ‚¨çš„å•é¡Œã€‚";
                if(q.includes("è¡Œç¨‹") || q.includes("å»å“ª")) reply = "æ ¹æ“šæ‚¨çš„è¡Œç¨‹ï¼Œä»Šå¤©å»ºè­°æ‚¨æ”¾æ…¢è…³æ­¥ï¼Œäº«å—æ—…ç¨‹ï¼è©³ç´°å®‰æ’è«‹æŸ¥çœ‹ã€Œè¡Œç¨‹ã€é é¢ã€‚";
                else if(q.includes("éŒ¢") || q.includes("é ç®—")) { const total = expenses.reduce((a,c) => a + c.amt, 0); reply = `ç›®å‰è¨˜éŒ„äº† ${expenses.length} ç­†æ¶ˆè²»ã€‚ç¸½é¡ç´„ ${Math.round(total).toLocaleString()}ã€‚`; }
                else if(q.includes("åƒ")) reply = "è‚šå­é¤“äº†å—ï¼Ÿæ¨è–¦æ‚¨å¯ä»¥å»æŸ¥çœ‹å¿…åƒæ¸…å–®ï¼";
                else if(q.includes("å¤©æ°£")) reply = "å»ºè­°æŸ¥çœ‹è³‡è¨Šé é¢çš„å¤©æ°£é å ±é€£çµå–”ï¼";
                history.innerHTML += `<div class="chat-bubble ai">${reply}</div>`;
                history.scrollTop = history.scrollHeight;
            }, 1000);
        }

        // --- Gist Sync Enhanced [V35.11] ---
        function updateCloudStatus(msg) {
            const s = document.getElementById('cloud-status');
            s.classList.remove('bg-matcha/50', 'bg-red-500/50', 'bg-blue-500/50', 'bg-gray-200/50');
            s.innerHTML = `<i class="fa-brands fa-github"></i> <span>${msg}</span>`;
            if (msg.includes("æˆåŠŸ") || msg.includes("åŒæ­¥")) s.classList.add('bg-matcha/50');
            else if (msg.includes("å¤±æ•—") || msg.includes("éŒ¯èª¤")) s.classList.add('bg-red-500/50');
            else if (msg.includes("è¼‰å…¥") || msg.includes("è¨­å®š")) s.classList.add('bg-blue-500/50');
            else s.classList.add('bg-gray-200/50');
            setTimeout(() => { if(s) s.classList.remove('bg-matcha/50', 'bg-red-500/50', 'bg-blue-500/50'); s.classList.add('bg-gray-200/50'); }, 3000);
        }

        function extractGistId(str) {
            // è‡ªå‹•ä¿®å‰ª URLï¼Œåªä¿ç•™æœ€å¾Œä¸€éƒ¨åˆ†
            if (!str) return "";
            const parts = str.trim().split('/');
            return parts[parts.length - 1];
        }

        function saveGistConfig() {
            let id = document.getElementById('gist-id-input').value.trim();
            const token = document.getElementById('gist-token-input').value.trim();
            
            // [V35.11] è‡ªå‹•è™•ç† ID
            id = extractGistId(id);
            document.getElementById('gist-id-input').value = id; // å›å¡«ä¿®æ­£å¾Œçš„ ID

            if(!id || !token) { alert("å¿…å¡«ï¼šGist ID å’Œ Token"); return; }
            
            localStorage.setItem('gist_id', id); localStorage.setItem('gist_token', token);
            gistId = id; gistToken = token;
            updateCloudStatus("å·²è¨­å®š"); 
            forceDownload();
        }

        window.forceUpload = async function() {
            if(!gistId || !gistToken) { 
                if(!window.uploadWarned) { updateCloudStatus("è«‹å…ˆè¨­å®šé€£ç·š"); window.uploadWarned=true; }
                return; 
            }
            updateCloudStatus("ä¸Šå‚³ä¸­...");
            const payload = { flights, itinerary, mustEatList, expenses, guides, todos, shoppingList, payers, manualDebts, memo: memoText, publicFundBudget, lastUpdate: new Date().toISOString() };
            try { 
                const response = await fetch(`https://api.github.com/gists/${gistId}`, { 
                    method: 'PATCH', 
                    headers: { 'Authorization': `token ${gistToken}`, 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ files: { [GIST_FILE_NAME]: { content: JSON.stringify(payload) } } }) 
                }); 
                if(!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || response.status);
                }
                updateCloudStatus("ä¸Šå‚³æˆåŠŸ"); 
            } catch (e) { 
                console.error(e);
                updateCloudStatus("ä¸Šå‚³å¤±æ•—"); 
                // åªæœ‰æ‰‹å‹•è§¸ç™¼æ™‚æ‰ alertï¼Œè‡ªå‹•åŒæ­¥ä¸å¹²æ“¾
            }
        };

        window.forceDownload = async function() {
            if(!gistId || !gistToken) return;
            updateCloudStatus("ä¸‹è¼‰ä¸­...");
            try {
                const r = await fetch(`https://api.github.com/gists/${gistId}`, { method: 'GET', headers: { 'Authorization': `token ${gistToken}` } });
                
                if(!r.ok) {
                    if(r.status === 404) { alert(`é€£ç·šå¤±æ•—ï¼šæ‰¾ä¸åˆ°æ­¤ Gist ID (${gistId})ã€‚\nè«‹æª¢æŸ¥ ID æ˜¯å¦æ­£ç¢ºã€‚`); updateCloudStatus("ID éŒ¯èª¤"); return; }
                    if(r.status === 401 || r.status === 403) { alert("é€£ç·šå¤±æ•—ï¼šToken æ¬Šé™ä¸è¶³æˆ–ç„¡æ•ˆã€‚\nè«‹ç¢ºèª Token æ˜¯å¦æœ‰ 'gist' æ¬Šé™ã€‚"); updateCloudStatus("Token éŒ¯èª¤"); return; }
                    throw new Error(`Error ${r.status}`);
                }

                const d = await r.json();
                const f = d.files[GIST_FILE_NAME];
                if (!f) { updateCloudStatus("ç„¡è³‡æ–™"); return; }
                const c = JSON.parse(f.content);
                if(c.flights) {
                    localStorage.setItem('flights',JSON.stringify(c.flights));
                    localStorage.setItem('itinerary_v2',JSON.stringify(c.itinerary));
                    localStorage.setItem('mustEatList',JSON.stringify(c.mustEatList));
                    localStorage.setItem('expenses',JSON.stringify(c.expenses));
                    localStorage.setItem('guides',JSON.stringify(c.guides));
                    localStorage.setItem('todos',JSON.stringify(c.todos));
                    localStorage.setItem('shoppingList_v2',JSON.stringify(c.shoppingList));
                    localStorage.setItem('payers',JSON.stringify(c.payers));
                    localStorage.setItem('manualDebts_v1',JSON.stringify(c.manualDebts));
                    if(c.memo!==undefined) localStorage.setItem('memo',c.memo);
                    if(c.publicFundBudget!==undefined) localStorage.setItem('publicFundBudget', c.publicFundBudget);
                    updateCloudStatus("å·²åŒæ­¥"); window.refreshUI();
                }
            } catch (e) { 
                console.error(e);
                alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
                updateCloudStatus("é€£ç·šå¤±æ•—"); 
            }
        };

        // --- Core Logic ---
        function savePublicFundTotal() {
            publicFundBudget = parseFloat(document.getElementById('public-fund-total').value) || 0;
            saveData();
        }

        function resetToDefaults() {
            if(confirm("é‡ç½®?")) {
                localStorage.clear();
                localStorage.setItem('itinerary_v2', JSON.stringify(RECOVERED_ITINERARY));
                localStorage.setItem('flights', JSON.stringify(RECOVERED_FLIGHTS));
                localStorage.setItem('payers', JSON.stringify(RECOVERED_PAYERS));
                localStorage.setItem('todos', JSON.stringify(RECOVERED_TODOS));
                location.reload();
            }
        }
        function reloadLocalData() {
            flights = JSON.parse(localStorage.getItem('flights')) || RECOVERED_FLIGHTS;
            itinerary = JSON.parse(localStorage.getItem('itinerary_v2')) || RECOVERED_ITINERARY;
            mustEatList = JSON.parse(localStorage.getItem('mustEatList')) || [];
            expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            guides = JSON.parse(localStorage.getItem('guides')) || [];
            todos = JSON.parse(localStorage.getItem('todos')) || RECOVERED_TODOS;
            shoppingList = JSON.parse(localStorage.getItem('shoppingList_v2')) || [];
            payers = JSON.parse(localStorage.getItem('payers')) || RECOVERED_PAYERS;
            if (!payers.includes("å…¬è²»")) payers.push("å…¬è²»");
            manualDebts = JSON.parse(localStorage.getItem('manualDebts_v1')) || [];
            memoText = localStorage.getItem('memo') || "";
            publicFundBudget = parseFloat(localStorage.getItem('publicFundBudget')) || 0;

            itinerary = itinerary.map(d => ({ ...d, meals: { b: d.meals?.b||{}, l: d.meals?.l||{}, d: d.meals?.d||{} } }));
            expenses = expenses.map(e => { if (e.payer && !e.payers) return { ...e, payers: [e.payer] }; return e; });
        }
        window.refreshUI = function() { 
            reloadLocalData(); 
            renderFlights(); renderItinerary(); renderGuides(); renderExpenses(); renderMustEatList(); renderChecklist(); renderShoppingList(); 
            document.getElementById('memo-pad').value = memoText; 
            document.getElementById('public-fund-total').value = publicFundBudget; 
            renderPayerOptions(); 
            if(gistId) document.getElementById('gist-id-input').value = gistId;
            if(gistToken) document.getElementById('gist-token-input').value = gistToken;
        }
        function saveData() {
            localStorage.setItem('flights', JSON.stringify(flights));
            localStorage.setItem('itinerary_v2', JSON.stringify(itinerary));
            localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('guides', JSON.stringify(guides));
            localStorage.setItem('todos', JSON.stringify(todos));
            localStorage.setItem('shoppingList_v2', JSON.stringify(shoppingList));
            localStorage.setItem('payers', JSON.stringify(payers));
            localStorage.setItem('manualDebts_v1', JSON.stringify(manualDebts));
            localStorage.setItem('memo', memoText);
            localStorage.setItem('publicFundBudget', publicFundBudget);
            if (gistId && gistToken) { clearTimeout(window.autoUploadTimer); window.autoUploadTimer = setTimeout(() => { forceUpload(); }, 1000); }
        }

        // --- Renderers ---
        function renderItinerary() {
            const c=document.getElementById('itinerary-container'); c.innerHTML='';
            itinerary.forEach((day)=>{
                // [V35.11] ä½¿ç”¨ font-bold æ­é… Zen Maru Gothic
                let content=day.content.split('\n').map(l => l.trim()?`<li class="flex items-start text-base font-bold text-gray-700"><span class="mr-2 mt-2 w-2 h-2 bg-sakura rounded-full flex-shrink-0 border border-red-200"></span><span class="flex-1 tracking-wide leading-relaxed">${l}</span></li>`:'').join('');
                
                const photosHtml = day.photos?.length ? `<div class="mt-3 grid grid-cols-3 gap-1 rounded-lg overflow-hidden">${day.photos.map(p=>`<img src="${p}" class="w-full aspect-square object-cover cursor-pointer hover:opacity-90" onclick="viewPhoto('${p}')">`).join('')}</div>` : '';
                const transPhoto = day.transportation.photo ? `<div class="mt-2 cursor-pointer relative group inline-block" onclick="viewPhoto('${day.transportation.photo}')"><img src="${day.transportation.photo}" class="h-16 w-auto object-contain rounded border border-gray-200 bg-white"><div class="absolute inset-0 flex items-center justify-center bg-black/10 opacity-0 group-hover:opacity-100 rounded transition"><i class="fa-solid fa-magnifying-glass-plus text-white text-xs drop-shadow-md"></i></div></div>` : '';
                const trans = day.transportation.content ? `<div class="mt-3 bg-[#f8f9fa] border-l-4 border-gray-300 p-2 pl-3 rounded-r text-sm flex gap-3 shadow-sm items-start"><i class="fa-solid fa-train text-gray-400 mt-1"></i><div><div class="font-black text-gray-700 handwritten text-base">${day.transportation.time||''} ${day.transportation.content}</div><div class="text-xs text-gray-400 font-bold">${day.transportation.note||''}</div>${transPhoto}</div></div>` : '';
                
                const mealButtons = ['b', 'l', 'd'].map(type => {
                    const meal = day.meals[type];
                    if (!meal || !meal.name) return '';
                    const conf = {b:{icon:'fa-mug-hot',color:'orange',label:'æ—©é¤'},l:{icon:'fa-utensils',color:'green',label:'åˆé¤'},d:{icon:'fa-wine-glass',color:'purple',label:'æ™šé¤'}}[type];
                    const url = meal.url ? meal.url : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(meal.name)}`;
                    return `<div class="inline-flex items-center text-xs rounded-full border shadow-sm overflow-hidden bg-${conf.color}-50 border-${conf.color}-100 mr-2 mb-2"><button onclick="switchTab('wallet'); openExpenseModal(null, {note: '${conf.label}: ${meal.name}', cat: 'é£²é£Ÿ'})" class="px-2 py-1.5 hover:bg-${conf.color}-200 text-${conf.color}-600 border-r border-${conf.color}-200"><i class="fa-solid ${conf.icon}"></i></button><a href="${url}" target="_blank" class="px-3 py-1.5 text-${conf.color}-700 hover:bg-${conf.color}-100 hover:underline handwritten font-black block flex items-center">${meal.name}</a></div>`;
                }).join('');

                const accLink = day.accommodationUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(day.accommodation)}`;
                const accHtml = day.accommodation ? `<div class="mt-3 pt-2 border-t border-dashed border-gray-200 text-xs text-indigo-500 font-black group/acc"><i class="fa-solid fa-bed mr-1"></i> <a href="${accLink}" target="_blank" class="hover:underline hover:text-indigo-700 handwritten text-sm">${day.accommodation} <i class="fa-solid fa-arrow-up-right-from-square text-[10px] opacity-50 group-hover/acc:opacity-100 ml-1"></i></a></div>` : '';

                c.innerHTML+=`
                <div class="relative pl-8 border-l-2 ${day.highlight?'border-sakura':'border-gray-200'} pb-8 group">
                    <div class="absolute -left-2.5 top-0 w-5 h-5 rounded-full ${day.highlight?'bg-sakura':'bg-gray-300'} border-4 border-paper shadow-sm"></div>
                    <div class="flex justify-between mb-2 items-end">
                        <h3 class="font-black text-2xl handwritten ${day.highlight?'text-red-400':'text-pencil'}">${day.date}</h3>
                        <button onclick="openDayEditor('${day.id}')" class="text-gray-300 hover:text-fuji transition"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 relative">
                        <!-- [V35.11] ä½¿ç”¨ font-bold ç¢ºä¿æ‰‹å¯«é«”æ¸…æ¥šä¸”ç²— -->
                        <ul class="space-y-3 leading-relaxed text-gray-700 font-bold text-lg">${content}</ul>
                        ${photosHtml}${trans}${accHtml}
                        ${mealButtons ? `<div class="mt-2 flex flex-wrap">${mealButtons
