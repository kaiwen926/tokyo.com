<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—…ã®è¨˜">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f9f7f2">

    <title>æ—…ã®è¨˜ V18.0 (åœ°é»å¿…åƒåˆ†çµ„+æ¬¡èœå–®URL)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- SortableJS for Guide Blocks Drag & Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'paper': '#f9f7f2', 'sakura': '#f8c3cd', 'matcha': '#bccc9a', 'fuji': '#7b90d2', 'pencil': '#595857', 'clay': '#e5a37f' },
                    fontFamily: { 'maru': ['"Zen Maru Gothic"', 'sans-serif'], 'hand': ['"Yomogi"', 'cursive'] }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body {
            font-family: 'Zen Maru Gothic', sans-serif; background-color: #f9f7f2; color: #595857;
            background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%), radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 50px 50px, 20px 20px; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none;
            min-height: 100vh; padding-bottom: calc(80px + var(--sab));
        }
        .handwritten { font-family: 'Yomogi', cursive; }
        .washi-tape { position: relative; background-color: rgba(248, 195, 205, 0.7); mask-image: url("data:image/svg+xml,%3Csvg width='200' height='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0 L200 0 L200 18 Q190 20 180 18 Q170 16 160 18 Q150 20 140 18 Q130 16 120 18 Q110 20 100 18 Q90 16 80 18 Q70 20 60 18 Q50 16 40 18 Q30 20 20 18 Q10 16 0 18 Z' fill='black'/%3E%3C/svg%3E"); -webkit-mask-image: url("data:image/svg+xml,%3Csvg width='200' height='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0 L200 0 L200 18 Q190 20 180 18 Q170 16 160 18 Q150 20 140 18 Q130 16 120 18 Q110 20 100 18 Q90 16 80 18 Q70 20 60 18 Q50 16 40 18 Q30 20 20 18 Q10 16 0 18 Z' fill='black'/%3E%3Csvg%3E"); mask-size: cover; -webkit-mask-size: cover; }
        .tape-blue { background-color: rgba(123, 144, 210, 0.7); } .tape-green { background-color: rgba(188, 204, 154, 0.7); }
        .hand-card { background: white; border-radius: 2px 20px 5px 25px / 20px 5px 25px 2px; box-shadow: 3px 3px 0 rgba(0,0,0,0.1); position: relative; transition: transform 0.2s; }
        .btn-action { border: 2px solid #595857; border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; transition: all 0.2s; }
        .btn-action:active { transform: scale(0.95); }
        .nav-item.active i, .nav-item.active span { color: #e5a37f; font-weight: 700; } .nav-item.active i { transform: translateY(-5px); }
        .modal { transition: opacity 0.3s ease-in-out; } .modal.hidden { opacity: 0; pointer-events: none; } .modal.visible { opacity: 1; pointer-events: auto; }
        .highlight-target { animation: highlight-pulse 1s ease-out; border: 2px solid #e5a37f; }
        @keyframes highlight-pulse { 0% { box-shadow: 0 0 0 0 rgba(229, 163, 127, 0.7); transform: scale(1); } 50% { box-shadow: 0 0 0 10px rgba(229, 163, 127, 0); transform: scale(1.02); } 100% { box-shadow: 0 0 0 0 rgba(229, 163, 127, 0); transform: scale(1); } }
        /* SortableJS Styles */
        .sortable-drag { opacity: 0.9; transform: scale(1.02); }
        .sortable-ghost { opacity: 0.4; background-color: #f3f4f6; border: 2px dashed #cbd5e1; }
        .drag-handle { cursor: grab; }
        .guide-card-content { padding-left: 1.5rem !important; }
        .negative-balance { color: #f87171; } /* Red for negative (Owe) */
        .positive-balance { color: #4ade80; } /* Green for positive (Owed) */
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="pb-2 px-4 text-center sticky top-0 bg-[#f9f7f2]/95 z-40 backdrop-blur-sm transition-all duration-300" style="padding-top: max(1.5rem, var(--sat));">
        <h1 class="text-3xl font-black tracking-widest text-pencil handwritten relative inline-block">
            <span class="absolute -top-3 -left-4 text-2xl rotate-[-15deg] opacity-50">âœˆï¸</span>
            æ—…ã®è¨˜
            <div class="w-full h-3 bg-sakura/40 absolute bottom-1 left-0 -z-10 rounded-sm transform -rotate-1"></div>
        </h1>
        <p class="text-xs text-fuji mt-1 font-bold tracking-wide">MY TRAVEL LOGBOOK</p>
    </header>

    <!-- MAIN CONTAINER -->
    <main id="app" class="px-4 w-full mx-auto min-h-screen">
        
        <!-- ================= PLAN VIEW ================= -->
        <section id="view-plan" class="view-section animate-fade">
            <div class="flex justify-between items-center mb-2 mt-2 px-1">
                <h3 class="text-pencil font-bold handwritten text-lg"><i class="fa-solid fa-plane-departure mr-2"></i>èˆªç­è³‡è¨Š</h3>
                <button onclick="openFlightModal()" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded-lg shadow-sm active:scale-95 text-fuji font-bold">+ æ–°å¢</button>
            </div>
            <div id="flight-list-container" class="space-y-4 mb-8"></div>
            <div class="flex justify-between items-center mb-4 px-1 border-t border-dashed border-gray-300 pt-6">
                <h3 class="text-pencil font-bold handwritten text-lg"><i class="fa-solid fa-map-location-dot mr-2"></i>æ¯æ—¥è¡Œç¨‹</h3>
            </div>
            <p class="text-xs text-gray-400 mb-2 px-2"><i class="fa-solid fa-circle-info mr-1"></i> é»æ“Šé¤å…·åœ–ç¤ºå¯ç›´æ¥è¨˜å¸³ / é»æ“Šå¿…åƒåç¨±æˆ–åœ°é»å¯è·³è½‰æ¸…å–®</p>
            <div id="itinerary-container" class="space-y-6 pl-2"></div>
            <button onclick="addNewDay()" class="w-full mt-6 mb-8 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl py-3 hover:bg-white hover:border-matcha hover:text-matcha transition font-bold text-sm"><i class="fa-solid fa-plus-circle mr-1"></i> æ–°å¢ä¸€å¤©è¡Œç¨‹</button>
        </section>

        <!-- ================= GUIDE VIEW ================= -->
        <section id="view-guide" class="view-section hidden">
            <div class="flex justify-between items-end mb-4 px-2">
                <h2 class="text-2xl font-bold text-pencil handwritten">æ·±åº¦å°è¦½</h2>
                <button onclick="openGuideModal()" class="text-sm bg-matcha/30 text-green-800 px-3 py-1 rounded-full border border-matcha hover:bg-matcha hover:text-white transition"><i class="fa-solid fa-plus mr-1"></i>æ–°å¢</button>
            </div>
            <p class="text-xs text-gray-400 mb-2 px-2"><i class="fa-solid fa-hand-grab-o mr-1"></i> é»æ“Šå¡ç‰‡å·¦å´å‚ç›´ç·šå¯æ‹–æ›³æ’åº</p>
            <div id="guide-list" class="space-y-6"></div>
        </section>

        <!-- ================= WALLET VIEW ================= -->
        <section id="view-wallet" class="view-section hidden">
            
            <!-- Individual Stats Dashboard (NEW V17) -->
            <div class="bg-gray-800 rounded-2xl p-4 shadow-lg text-white mb-6 mx-1">
                <h4 class="text-sm text-gray-400 font-bold mb-3 flex justify-between items-center">
                    <span class="flex items-center"><i class="fa-solid fa-chart-simple mr-2"></i>å€‹äººè²¡å‹™ç¸½è¦½ (TWD)</span>
                    <button onclick="renderExpenses()" class="text-xs text-blue-400 hover:text-blue-200"><i class="fa-solid fa-rotate-right"></i> æ›´æ–°</button>
                </h4>
                <div id="individual-stats-dashboard" class="grid grid-cols-2 gap-4 text-xs">
                    <!-- Stats cards rendered here -->
                </div>
                <div class="mt-4 flex justify-between items-end">
                    <div class="text-right">
                        <span class="text-xs text-gray-400">åŒ¯ç‡è¨­å®š (1 JPY â‰ˆ ?)</span>
                        <input type="number" id="exchange-rate" value="0.215" step="0.001" onchange="renderExpenses()" class="w-16 bg-gray-700 text-center rounded text-sm outline-none ml-1 text-white">
                    </div>
                    <div>
                        <span class="text-xs text-gray-400 block mb-1">ç¸½æ”¯å‡º (ç¯©é¸å¤–)</span>
                        <div class="text-xl font-bold font-mono text-yellow-300" id="wallet-total-display">NT$ 0</div>
                    </div>
                </div>
            </div>

            <!-- Manual Debt Button (NEW V17) -->
             <div class="flex justify-between items-center mb-4 px-1">
                <button onclick="openIOUModal()" class="text-xs bg-fuji/20 text-fuji font-bold px-3 py-2 rounded-lg hover:bg-fuji/30 transition flex items-center gap-1">
                    <i class="fa-solid fa-money-bill-transfer"></i> æ‰‹å‹•æ¬ æ¬¾/å€Ÿæ¬¾
                </button>
                 <button onclick="openPayerModal()" class="text-xs text-gray-400 border border-gray-300 rounded px-2 py-1 hover:bg-white"><i class="fa-solid fa-gear mr-1"></i>ç®¡ç†æˆå“¡</button>
            </div>


            <!-- Debt Settlement Summary (V17: Simplified settlement based on final balance) -->
            <div id="settlement-summary-container" class="mb-6 mx-1">
                <div class="bg-matcha/20 rounded-xl p-4 shadow-sm border border-matcha/50">
                    <h4 class="text-sm font-bold text-green-800 mb-2"><i class="fa-solid fa-handshake mr-1"></i> æœ€çµ‚å¸³å‹™çµç®—å»ºè­° (TWD)</h4>
                    <div id="settlement-summary" class="text-sm space-y-2">
                        <!-- JS content here -->
                    </div>
                </div>
            </div>

            <!-- Expense List Filter -->
            <div class="flex items-center gap-2 mb-3 px-1">
                <span class="text-xs font-bold text-gray-500">ç¯©é¸ä»˜æ¬¾äºº:</span>
                <select id="wallet-filter" onchange="renderExpenses()" class="bg-white border border-gray-300 rounded text-sm p-1 outline-none">
                    <option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>
                </select>
            </div>
            
            <button onclick="openExpenseModal()" class="w-full btn-action bg-sakura/20 text-red-800 font-bold py-3 mb-6 flex items-center justify-center gap-2"><i class="fa-solid fa-pen-nib"></i> è¨˜ä¸€ç­†å…¬è²»</button>
            <div id="expense-list" class="space-y-3 pb-20"></div>
        </section>

        <!-- ================= LISTS VIEW ================= -->
        <section id="view-lists" class="view-section hidden">
            
            <!-- Must-Eat List -->
            <div class="hand-card p-5 mb-6 bg-yellow-50 relative">
                 <div class="absolute -top-3 -right-3 bg-matcha text-green-800 w-10 h-10 rounded-full flex items-center justify-center shadow font-bold text-xs rotate-6">Yum!</div>
                 <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-300 pb-2">
                    <h3 class="text-lg font-bold text-pencil"><i class="fa-solid fa-utensils mr-2 text-matcha"></i>æ¨è–¦å¿…åƒæ¸…å–®</h3>
                    <button onclick="openMustEatModal()" class="text-xs bg-matcha/20 text-green-700 px-2 py-1 rounded border border-matcha/50 shadow-sm">+ æ–°å¢åœ°é»/ä¸»é¡Œ</button>
                 </div>
                 <div id="must-eat-list" class="space-y-3"></div>
            </div>

            <!-- Shopping List -->
            <div class="hand-card p-5 mb-6 bg-white relative">
                 <div class="absolute -top-3 -right-3 bg-red-400 text-white w-10 h-10 rounded-full flex items-center justify-center shadow font-bold text-xs rotate-12">Buy!</div>
                 <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-200 pb-2">
                    <h3 class="text-lg font-bold text-pencil"><i class="fa-solid fa-bag-shopping mr-2"></i>è³¼ç‰©æ¸…å–®</h3>
                    <button onclick="openShoppingModal()" class="text-xs bg-red-50 text-red-500 px-2 py-1 rounded border border-red-100">+ æ–°å¢</button>
                 </div>
                 <div id="shopping-list-pending" class="grid grid-cols-2 gap-3 mb-4"></div>
                 <div id="shopping-list-done" class="grid grid-cols-2 gap-3 opacity-80"></div>
            </div>

            <!-- Checklist -->
            <div class="hand-card p-5 mb-6 bg-[#fffdf5]">
                <div class="washi-tape tape-green h-4 w-24 mx-auto mb-4 opacity-80"></div>
                <h3 class="text-lg font-bold text-center mb-4 text-pencil"><i class="fa-solid fa-suitcase mr-2"></i>è¡Œå‰æº–å‚™</h3>
                <ul id="checklist-container" class="space-y-2"></ul>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="new-todo" placeholder="æ–°å¢é …ç›®..." class="flex-1 bg-transparent border-b border-gray-300 text-sm outline-none">
                    <button onclick="addTodo()" class="text-matcha"><i class="fa-solid fa-circle-plus fa-lg"></i></button>
                </div>
            </div>
            
             <!-- Memo -->
             <div class="hand-card p-5 bg-yellow-50 rotate-1">
                <h3 class="text-lg font-bold mb-2 handwritten text-yellow-800"><i class="fa-solid fa-note-sticky mr-2"></i>MEMO</h3>
                <textarea id="memo-pad" class="w-full h-48 bg-transparent border-none resize-none text-sm leading-7 outline-none text-gray-700 handwritten" placeholder="åœ¨é€™è£¡éš¨æ‰‹è¨˜ä¸‹æƒ³æ³•æˆ–è²¼ä¸Šç¶²å€..."></textarea>
                <div id="memo-links" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </section>

        <!-- ================= INFO VIEW ================= -->
        <section id="view-info" class="view-section hidden">
            <h2 class="text-2xl font-bold text-center handwritten mb-6">æ—…é€”æƒ…å ±</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-blue-50 transition"><i class="fa-solid fa-cloud-sun-rain text-3xl text-fuji mb-2"></i><span class="font-bold text-sm">å¤©æ°£é å ±</span></a>
                <a href="https://www.google.com/maps/search/drugstore" target="_blank" class="hand-card p-4 flex flex-col items-center justify-center hover:bg-pink-50 transition"><i class="fa-solid fa-store text-3xl text-sakura mb-2"></i><span class="font-bold text-sm">é™„è¿‘è—¥å¦</span></a>
            </div>
            <div class="hand-card p-5 border-l-4 border-red-400 mb-6">
                <h3 class="font-bold text-red-500 mb-3"><i class="fa-solid fa-phone-volume mr-2"></i>ç·Šæ€¥è¯çµ¡</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center border-b border-dashed pb-1"><span>è­¦å¯Ÿå±€</span><a href="tel:110" class="font-bold text-lg">110</a></div>
                    <div class="flex justify-between items-center border-b border-dashed pb-1"><span>æ•‘è­·è»Š</span><a href="tel:119" class="font-bold text-lg">119</a></div>
                </div>
            </div>
        </section>
    </main>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#f9f7f2] border-t border-gray-200 pt-2 pb-safe px-6 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.03)]" style="padding-bottom: calc(10px + var(--sab));">
        <div class="flex justify-between items-center w-full mx-auto pb-1">
            <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center text-gray-400 transition flex-1" data-target="plan"><i class="fa-solid fa-map text-xl mb-1"></i><span class="text-[10px]">è¡Œç¨‹</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="guide"><i class="fa-solid fa-book-open text-xl mb-1"></i><span class="text-[10px]">å°è¦½</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="wallet"><i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px]">è¨˜å¸³</span></button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="lists"><i class="fa-solid fa-list-check text-xl mb-1"></i><span class="text-[10px]">æ¸…å–®</span></button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center text-gray-400 transition flex-1" data-target="info"><i class="fa-solid fa-circle-info text-xl mb-1"></i><span class="text-[10px]">è³‡è¨Š</span></button>
        </div>
    </nav>

    <!-- MODALS -->
    
    <!-- 1. Flight Modal -->
    <div id="flight-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('flight-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center">èˆªç­è³‡è¨Š</h3>
            <div class="space-y-3">
                <input type="hidden" id="flight-id"> 
                <div class="flex gap-2"><input type="text" id="flight-dep" placeholder="å‡ºç™¼" class="w-1/2 p-2 border-b bg-transparent text-center font-bold"><input type="text" id="flight-arr" placeholder="æŠµé”" class="w-1/2 p-2 border-b bg-transparent text-center font-bold"></div>
                <input type="text" id="flight-code" placeholder="èˆªç­ä»£è™Ÿ" class="w-full p-2 border rounded bg-white text-sm">
                <input type="text" id="flight-time" placeholder="æ™‚é–“" class="w-full p-2 border rounded bg-white text-sm">
                <input type="text" id="flight-date" placeholder="æ—¥æœŸèªªæ˜" class="w-full p-2 border rounded bg-white text-sm">
                <input type="url" id="flight-url" placeholder="é€£çµ (e-ticket/Check-in)" class="w-full p-2 border rounded bg-white text-sm">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative hover:bg-white">
                    <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentFlightPhoto = base64; document.getElementById('flight-photo-preview').src = base64; document.getElementById('flight-photo-preview').classList.remove('hidden'); document.getElementById('flight-photo-text').classList.add('hidden'); })">
                    <div id="flight-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-image mb-1 block"></i> èƒŒæ™¯åœ–ç‰‡</div>
                    <img id="flight-photo-preview" class="hidden h-28 mx-auto object-cover rounded">
                </div>
                <button onclick="saveFlight()" class="w-full bg-fuji text-white py-2 rounded-lg font-bold mt-2 shadow">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- 2. Day Editor Modal -->
    <div id="day-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-4 shadow-2xl relative hand-card h-[85vh] overflow-y-auto">
            <button onclick="closeModal('day-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-2 text-center">ç·¨è¼¯è¡Œç¨‹</h3>
            <input type="hidden" id="day-id-edit">
            <input type="text" id="day-date-edit" class="w-full p-2 border-b-2 border-matcha bg-transparent font-bold mb-4" placeholder="æ—¥æœŸæ¨™é¡Œ (ä¾‹å¦‚: 1/10 Day 1 æ±äº¬)">
            <label class="flex items-center space-x-2 text-sm text-gray-600 mb-4 bg-yellow-50 p-2 rounded"><input type="checkbox" id="day-highlight-edit" class="accent-red-400"><span>æ¨™è¨˜ç‚ºé‡é»å¤©æ•¸</span></label>
            
            <!-- Photo Upload Area -->
            <div class="mb-4 bg-white p-2 rounded border border-gray-200">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-gray-400">ç•¶æ—¥ç›¸ç‰‡é›†</h4>
                    <div class="relative overflow-hidden inline-block">
                        <button class="bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs hover:bg-gray-200"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addDayPhoto(this)">
                    </div>
                </div>
                <div id="day-photos-preview" class="grid grid-cols-3 gap-2"></div>
            </div>

            <div class="mb-4">
                <input type="text" id="day-accommodation-edit" class="w-full p-2 border rounded text-sm mb-2" placeholder="ä½å®¿åœ°é»">
                <input type="url" id="day-accommodation-url-edit" class="w-full p-2 border rounded text-sm" placeholder="Google Maps é€£çµ">
            </div>
            
            <!-- V8.1 Enhanced Transportation -->
            <div class="mb-4 border-t pt-3 bg-gray-50 p-2 rounded-lg border border-gray-100">
                <h4 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1"><i class="fa-solid fa-train"></i> äº¤é€šæ–¹å¼ (å¢å¼·ç‰ˆ)</h4>
                <div class="flex gap-2 mb-2">
                    <input type="time" id="day-trans-time" class="w-1/3 p-2 border border-gray-300 rounded text-sm">
                    <input type="text" id="day-trans-content" placeholder="å…§å®¹ (å¦‚: æ­æ–°å¹¹ç·š)" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                </div>
                <div class="flex gap-2 mb-2">
                     <input type="text" id="day-trans-note" placeholder="å‚™è¨» (å¦‚: è²·ç¥¨)" class="flex-1 p-2 border border-gray-300 rounded text-sm">
                </div>
                <!-- Transport Photo -->
                 <div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative hover:bg-white bg-white">
                    <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentTransPhoto = base64; document.getElementById('trans-photo-preview').src = base64; document.getElementById('trans-photo-preview').classList.remove('hidden'); document.getElementById('trans-photo-text').classList.add('hidden'); })">
                    <div id="trans-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-ticket mb-1 block"></i> ä¸Šå‚³è»Šç¥¨/æ™‚åˆ»è¡¨</div>
                    <img id="trans-photo-preview" class="hidden h-20 mx-auto object-contain rounded">
                    <button onclick="clearTransPhoto()" class="absolute top-1 right-1 bg-gray-200 rounded-full w-5 h-5 text-[10px] text-gray-500 z-10"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>

            <!-- Gemini AI Draft Feature (V16) -->
            <div class="mb-4 pt-3 border-t border-dashed border-gray-300">
                <h4 class="text-xs font-bold text-matcha mb-2 flex items-center gap-1"><i class="fa-solid fa-wand-magic-sparkles"></i> AI è¡Œç¨‹è‰ç¨¿ç”Ÿæˆ</h4>
                <p class="text-[10px] text-gray-500 mb-2">åŸºæ–¼æ—¥æœŸå’Œåœ°é»ï¼Œè®“ AI å¹«æ‚¨ç”¢ç”Ÿæˆ–æ½¤é£¾è¡Œç¨‹å…§å®¹ã€‚</p>
                <div class="flex items-center gap-2">
                    <button id="ai-draft-button" onclick="draftItineraryWithAI()" class="flex-1 bg-matcha/90 text-white py-2 rounded-lg font-bold text-sm shadow hover:bg-matcha transition flex items-center justify-center gap-2">
                        âœ¨ è‡ªå‹•ç”¢ç”Ÿ/å„ªåŒ–è¡Œç¨‹
                    </button>
                    <div id="ai-draft-loading" class="hidden text-sm text-matcha flex items-center">
                        <i class="fa-solid fa-spinner fa-spin mr-2"></i>ç”Ÿæˆä¸­...
                    </div>
                </div>
            </div>
            
            <textarea id="day-content-edit" class="w-full h-32 p-3 border rounded-lg bg-white text-sm mb-4 font-hand" placeholder="è¡Œç¨‹å…§å®¹... (è«‹ç”¨åæ–œç·š '\' åˆ†éš”æ¯é …æ´»å‹•)"></textarea>

            <div class="bg-white p-3 rounded-lg border mb-4 space-y-4">
                <h4 class="text-xs font-bold text-gray-400 border-b pb-1">ä¸‰é¤å®‰æ’</h4>
                <div class="border-b pb-2"><div class="flex gap-2 mb-1"><i class="fa-solid fa-mug-hot text-orange-300 w-5"></i><input type="text" id="meal-b-name" placeholder="æ—©é¤" class="flex-1 text-sm font-bold bg-transparent"></div><div class="flex gap-2 pl-7"><input type="url" id="meal-b-url" placeholder="ç¶²å€" class="w-1/2 text-xs border rounded px-1"><input type="text" id="meal-b-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1"></div></div>
                <div class="border-b pb-2"><div class="flex gap-2 mb-1"><i class="fa-solid fa-utensils text-green-400 w-5"></i><input type="text" id="meal-l-name" placeholder="åˆé¤" class="flex-1 text-sm font-bold bg-transparent"></div><div class="flex gap-2 pl-7"><input type="url" id="meal-l-url" placeholder="ç¶²å€" class="w-1/2 text-xs border rounded px-1"><input type="text" id="meal-l-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1"></div></div>
                <div><div class="flex gap-2 mb-1"><i class="fa-solid fa-wine-glass text-purple-400 w-5"></i><input type="text" id="meal-d-name" placeholder="æ™šé¤" class="flex-1 text-sm font-bold bg-transparent"></div><div class="flex gap-2 pl-7"><input type="url" id="meal-d-url" placeholder="ç¶²å€" class="w-1/2 text-xs border rounded px-1"><input type="text" id="meal-d-note" placeholder="å‚™è¨»" class="w-1/2 text-xs border rounded px-1"></div></div>
            </div>
            <textarea id="day-note-edit" class="w-full h-20 p-2 border border-yellow-200 bg-yellow-50 rounded text-sm mb-4" placeholder="æ¯æ—¥å‚™è¨»..."></textarea>
            <div class="flex gap-2"><button onclick="deleteDay()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm">åˆªé™¤</button><button onclick="saveDay()" class="flex-[2] bg-matcha text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button></div>
        </div>
    </div>

    <!-- 3. Guide Modal -->
    <div id="guide-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('guide-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="font-bold mb-3">æ–°å¢/ç·¨è¼¯æ™¯é»å°è¦½</h3>
            <input type="hidden" id="guide-id">
            <input type="text" id="guide-title" placeholder="æ™¯é»åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold">
            <textarea id="guide-desc" placeholder="ä»‹ç´¹å…§å®¹..." class="w-full mb-3 border bg-white p-2 rounded h-24 text-sm"></textarea>
            <input type="text" id="guide-coords" placeholder="åº§æ¨™ (36.34,138.61)" class="w-full mb-3 border-b bg-transparent p-2 text-xs">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center relative mb-3 hover:bg-white">
                <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentGuidePhoto = base64; document.getElementById('guide-photo-preview').src = base64; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden'); })">
                <div id="guide-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-image mb-1 block"></i> æ›´æ–°ç…§ç‰‡</div>
                <img id="guide-photo-preview" class="hidden h-32 mx-auto object-cover rounded">
            </div>
            <button onclick="saveGuide()" class="w-full bg-matcha text-white py-2 rounded-lg font-bold">å„²å­˜</button>
        </div>
    </div>
    
    <!-- 4. Expense Modal -->
    <div id="expense-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('expense-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center">è¨˜ä¸‹ä¸€ç­†å…¬è²»èŠ±è²»</h3>
            <input type="hidden" id="ex-id">
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="ex-category" class="w-full bg-white border rounded p-2 text-sm"><option value="é£²é£Ÿ">ğŸœ é£²é£Ÿ</option><option value="äº¤é€š">ğŸšƒ äº¤é€š</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="å…¶ä»–">âœ¨ å…¶ä»–</option></select>
                    <input type="text" id="ex-note" placeholder="å‚™è¨»" class="w-full bg-white border-b p-2 text-sm">
                </div>
                <div class="flex items-center gap-2 bg-white border rounded p-2">
                    <select id="ex-currency" class="bg-transparent text-sm font-bold"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
                    <input type="number" id="ex-amount" placeholder="é‡‘é¡" class="flex-1 text-lg text-right w-full" inputmode="numeric">
                </div>
                <div class="flex gap-2 text-sm">
                    <div class="flex-1"><label class="block text-xs text-gray-400 mb-1">ä»˜æ¬¾äºº</label><select id="ex-payer" class="w-full bg-white border rounded p-1"></select></div>
                    <div class="w-16"><label class="block text-xs text-gray-400 mb-1">äººæ•¸</label><input type="number" id="ex-people" value="1" min="1" class="w-full bg-white border rounded p-1 text-center"></div>
                </div>
                <div class="border-2 border-dashed rounded-lg p-2 text-center relative">
                    <input type="file" id="ex-photo" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentPhotoBase64 = base64; document.getElementById('photo-preview').src = base64; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); })">
                    <div id="photo-placeholder" class="text-xs text-gray-400"><i class="fa-solid fa-camera mb-1 block"></i> ä¸Šå‚³ç…§ç‰‡</div>
                    <img id="photo-preview" class="hidden h-24 mx-auto object-contain">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="deleteExpense()" id="btn-delete-expense" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden">åˆªé™¤</button>
                <button onclick="saveExpense()" class="flex-[2] bg-clay text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- 5. Payer Manager Modal -->
    <div id="payer-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg">
            <h4 class="font-bold mb-3 text-center">ç®¡ç†ä»˜æ¬¾äºº</h4>
            <div id="payer-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto"></div>
            <div class="flex gap-2">
                <input type="text" id="new-payer-name" placeholder="æ–°æˆå“¡åç¨±" class="flex-1 border p-1 text-sm rounded">
                <button onclick="addPayer()" class="bg-matcha text-white px-3 rounded text-sm">æ–°å¢</button>
            </div>
            <button onclick="closeModal('payer-modal')" class="w-full mt-3 bg-gray-200 py-1 rounded text-sm">é—œé–‰</button>
        </div>
    </div>

    <!-- 6. Shopping Modal -->
    <div id="shopping-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card">
            <button onclick="closeModal('shopping-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="font-bold mb-3 text-center">è³¼ç‰©é …ç›®</h3>
            <input type="hidden" id="shop-id">
            <input type="text" id="shop-name" placeholder="å•†å“åç¨±" class="w-full mb-3 border-b bg-transparent p-2 font-bold">
            <div class="flex gap-2 mb-3">
                <div class="flex-1"><label class="text-xs text-gray-400">æ•¸é‡</label><input type="number" id="shop-qty" value="1" class="w-full border rounded p-2 text-sm"></div>
                <div class="flex-[2]"><label class="text-xs text-gray-400">é ä¼°å–®åƒ¹ (JPY)</label><input type="number" id="shop-price" placeholder="0" class="w-full border rounded p-2 text-sm"></div>
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center relative mb-4 bg-white">
                <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processImage(this, (base64) => { currentShopPhoto = base64; document.getElementById('shop-photo-preview').src = base64; document.getElementById('shop-photo-preview').classList.remove('hidden'); document.getElementById('shop-photo-text').classList.add('hidden'); })">
                <div id="shop-photo-text" class="text-xs text-gray-400"><i class="fa-solid fa-camera mb-1 block"></i> ç…§ç‰‡</div>
                <img id="shop-photo-preview" class="hidden h-32 mx-auto object-contain rounded">
            </div>
            <div class="flex gap-2">
                <button onclick="deleteShoppingItem()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg">åˆªé™¤</button>
                <button onclick="saveShoppingItem()" class="flex-[2] bg-red-400 text-white py-2 rounded-lg font-bold shadow">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- 7. Link Modal -->
    <div id="link-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-xs rounded-xl p-4 shadow-lg">
            <h4 class="font-bold mb-2 text-center">é€£çµæŒ‰éˆ•</h4>
            <input type="hidden" id="link-day-id">
            <input type="text" id="link-name" placeholder="åç¨±" class="w-full mb-2 border p-2 rounded text-sm">
            <input type="url" id="link-url" placeholder="ç¶²å€" class="w-full mb-3 border p-2 rounded text-sm">
            <div class="flex gap-2"><button onclick="closeModal('link-modal')" class="flex-1 bg-gray-200 py-1 rounded text-sm">å–æ¶ˆ</button><button onclick="saveLink()" class="flex-1 bg-fuji text-white py-1 rounded text-sm">ç¢ºå®š</button></div>
        </div>
    </div>
    
    <!-- 8. Must Eat Modal (RESTRUCTURED V14.1) -->
    <div id="must-eat-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('must-eat-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center text-matcha">ğŸ½ï¸ ç·¨è¼¯å¿…åƒä¸»é¡Œ (åœ°é»ç‚ºæº–)</h3>
            <input type="hidden" id="eat-id">
            
            <!-- Main Info -->
            <div class="space-y-3 p-3 border rounded-lg bg-white mb-4">
                <input type="text" id="eat-location" placeholder="åœ°é»åç¨± (ä¾‹å¦‚: è¼•äº•æ¾¤ã€ç¯‰åœ°å¸‚å ´)" class="w-full p-2 border-b-2 border-matcha/50 bg-transparent text-center font-bold">
                <input type="text" id="eat-name" placeholder="ä¸»é¡Œåç¨± (å¯é¸ï¼Œä¾‹å¦‚: æ—©é¤é¸é …)" class="w-full p-2 border rounded bg-gray-50 text-sm">
                <textarea id="eat-note" placeholder="åœ°é»å‚™è¨»/äº¤é€šè³‡è¨Š" class="w-full h-16 p-2 border rounded bg-gray-50 text-sm"></textarea>
            </div>
            
            <!-- Food Items List -->
            <h4 class="text-sm font-bold text-gray-600 mb-2">å¿…åšèœå–®/æ¬¡é¸é …ç›® (é¤å»³/å°åƒ):</h4>
            <div id="must-eat-items-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner">
                <!-- Food Items rendered here -->
            </div>
            
            <!-- Add New Food Item Interface (UPDATED V18) -->
            <div class="flex flex-col gap-2 mt-4 p-3 bg-gray-100 rounded-lg border border-gray-200">
                <div class="flex gap-2">
                    <input type="text" id="new-food-name" placeholder="æ–°å¢é¤å»³/èœè‰²åç¨±" class="flex-1 p-2 border rounded text-sm outline-matcha">
                    <input type="number" id="new-food-price" placeholder="åƒ¹æ ¼(Â¥)" class="w-20 p-2 border rounded text-sm text-right outline-matcha">
                </div>
                <div class="flex gap-2 items-center">
                    <input type="url" id="new-food-url" placeholder="åœ°é»/é¤å»³ç¶²å€ (å¯é¸)" class="flex-1 p-2 border rounded text-xs outline-matcha">
                    <button onclick="addNewFoodItem()" class="bg-matcha text-white px-3 py-2 rounded-lg hover:bg-green-600 active:scale-95 transition text-sm"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="flex gap-2 mt-4">
                 <button onclick="deleteMustEatItem()" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hover:bg-red-100">åˆªé™¤ä¸»é …ç›®</button>
                <button onclick="saveMustEatItem()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow hover:bg-fuji/80">å„²å­˜ä¸»é …ç›®</button>
            </div>
        </div>
    </div>

    <!-- 9. IOU Modal (Manual Debt) (NEW V17) -->
    <div id="iou-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center px-4">
        <div class="bg-[#f9f7f2] w-full max-w-sm rounded-2xl p-5 shadow-2xl relative hand-card max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('iou-modal')" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-center text-fuji">ğŸ¤ æ‰‹å‹•æ¬ æ¬¾/å€Ÿæ¬¾</h3>
            <input type="hidden" id="iou-id">
            
            <!-- IOU Input Form -->
            <div class="space-y-3 p-3 border rounded-lg bg-white mb-4">
                <div class="text-xs text-gray-500 mb-1">èª°å€Ÿçµ¦èª°ï¼Ÿ (å‚µæ¬Šäºº = å€ŸéŒ¢çµ¦åˆ¥äººçš„äºº)</div>
                <div class="flex gap-2">
                    <div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µæ¬Šäºº (Creditor)</label><select id="iou-creditor" class="w-full bg-white border rounded p-1 text-sm"></select></div>
                    <div class="flex-1"><label class="block text-xs text-gray-400 mb-1">å‚µå‹™äºº (Debtor)</label><select id="iou-debtor" class="w-full bg-white border rounded p-1 text-sm"></select></div>
                </div>
                
                <div class="flex items-center gap-2 bg-gray-50 border rounded p-2">
                    <span class="font-bold text-sm">TWD</span>
                    <input type="number" id="iou-amount" placeholder="é‡‘é¡ (TWD)" class="flex-1 text-lg text-right w-full bg-transparent" inputmode="numeric">
                </div>
                 <input type="text" id="iou-note" placeholder="å‚™è¨» (ä¾‹å¦‚: æ©Ÿå ´æ¥é§è²»)" class="w-full p-2 border rounded text-sm">
                
                <div class="flex gap-2 mt-3">
                    <button onclick="deleteIOU()" id="btn-delete-iou" class="flex-1 bg-gray-200 text-gray-500 py-2 rounded-lg text-sm hidden">åˆªé™¤</button>
                    <button onclick="saveIOU()" class="flex-[2] bg-fuji text-white py-2 rounded-lg font-bold shadow">å„²å­˜å€Ÿè²¸ç´€éŒ„</button>
                </div>
            </div>

            <h4 class="text-sm font-bold text-gray-600 mb-2">ç¾æœ‰æ‰‹å‹•æ¬ æ¬¾åˆ—è¡¨:</h4>
            <div id="iou-list-container" class="space-y-2 border rounded-lg bg-white p-3 shadow-inner">
                <!-- IOU Items rendered here -->
            </div>
            
        </div>
    </div>
    
    <!-- 10. Lightbox Modal (Full Screen Photo Preview) (NEW V17) -->
    <div id="lightbox-modal" class="modal hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4" onclick="closeModal('lightbox-modal')">
        <div class="absolute top-0 right-0 p-4 text-white text-3xl opacity-80 cursor-pointer">
            <i class="fa-solid fa-times"></i>
        </div>
        <img id="lightbox-image" src="" class="max-w-full max-h-full object-contain" onclick="event.stopPropagation()">
    </div>

    <!-- JAVASCRIPT -->
    <script>
        /* --- GEMINI API INTEGRATION --- */
        const apiKey = ""; // Canvas will provide this
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Function to call Gemini API with exponential backoff
        async function callGeminiApi(payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) { // Rate limit
                            const delay = Math.pow(2, i) * 1000;
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'æœªèƒ½ç”Ÿæˆå…§å®¹ã€‚';
                    return text;

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        console.warn(`Error. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        return `[AI ç”Ÿæˆå¤±æ•—: ${error.message}]`;
                    }
                }
            }
        }

        async function draftItineraryWithAI() {
            const dayDate = document.getElementById('day-date-edit').value;
            const accommodation = document.getElementById('day-accommodation-edit').value;
            const currentContent = document.getElementById('day-content-edit').value;
            
            if (!dayDate) {
                alert("è«‹å…ˆå¡«å¯«æ—¥æœŸæ¨™é¡Œ (åŒ…å«åœ°é»)ï¼Œä»¥ä¾¿ AI ç²å¾—è¶³å¤ è³‡è¨Šä¾†è¦åŠƒè¡Œç¨‹ã€‚");
                return;
            }
            
            const loadingEl = document.getElementById('ai-draft-loading');
            loadingEl.classList.remove('hidden');
            document.getElementById('ai-draft-button').disabled = true;

            // Simple heuristic to extract a location from the date field if not explicitly in accommodation
            let location = dayDate.split(' ').filter(p => !p.match(/Day \d+|æ—¥|å¤©|æ˜ŸæœŸ|é€±|å‘¨/i))[0] || "æ±äº¬";
            if (accommodation && accommodation.length > 3) {
                location = accommodation;
            }

            const systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸–ç•Œç´šçš„æ—…éŠè¦åŠƒå°ˆå®¶ï¼Œå°ˆé–€ç‚ºæ—¥æœ¬æ±äº¬çš„è‡ªç”±è¡Œæ—…å®¢è¨­è¨ˆè¡Œç¨‹ã€‚è«‹æ ¹æ“šç”¨æˆ¶æä¾›çš„æ—¥æœŸã€åœ°é»å’Œç¾æœ‰è¡Œç¨‹ï¼Œç”Ÿæˆä¸€å€‹é€£è²«ã€è©³ç´°ã€ä¸”å¸å¼•äººçš„ç•¶æ—¥è¡Œç¨‹å»ºè­°ã€‚
            è«‹éµå®ˆä»¥ä¸‹è¦å‰‡ï¼š
            1. ä¿æŒç¹é«”ä¸­æ–‡ï¼Œä¸¦ä½¿ç”¨æ—…éŠç­†è¨˜çš„è¼•é¬†èªæ°£ã€‚
            2. å°‡æ¯å€‹è¡Œç¨‹é»æˆ–æ´»å‹•ä½¿ç”¨å–®ä¸€åæ–œç·šç¬¦è™Ÿ (\\) éš”é–‹ï¼Œä»¥ä¾¿æ–¼æ‡‰ç”¨ç¨‹å¼è§£ææˆæ¸…å–®ã€‚
            3. å»ºè­°å…§å®¹æ‡‰åŒ…å«æ™‚é–“ã€åœ°é»å’Œç°¡çŸ­èªªæ˜ã€‚
            4. è¼¸å‡ºå¿…é ˆåªåŒ…å«è¡Œç¨‹å…§å®¹ï¼Œä¸è¦æœ‰ä»»ä½•æ¨™é¡Œæˆ–é¡å¤–çš„èªªæ˜æ–‡å­—ã€‚
            5. å…§å®¹æ‡‰ç›¡é‡èˆ‡æœ€æ–°çš„æ—…éŠè³‡è¨Šä¿æŒä¸€è‡´ã€‚`;
            
            const userQuery = `åœ°é»/æ—¥æœŸ: ${dayDate} (å‡è¨­ä¸»è¦éŠç©åœ°é»ç‚º ${location})ã€‚ä½å®¿: ${accommodation || 'æœªçŸ¥'}ã€‚
            ç¾æœ‰è¡Œç¨‹: ${currentContent || 'ç„¡ã€‚'}
            è«‹é‡å°é€™ä¸€å¤©ï¼Œæä¾› 5 åˆ° 7 å€‹é€£è²«çš„è¡Œç¨‹é»ï¼Œä¸¦ä½¿ç”¨å–®ä¸€åæ–œç·šç¬¦è™Ÿ (\\) åˆ†éš”ã€‚
            å¦‚æœç¾æœ‰è¡Œç¨‹å·²æœ‰å…§å®¹ï¼Œè«‹åœ¨å…¶åŸºç¤ä¸Šé€²è¡Œæ“´å……æˆ–æ½¤é£¾ã€‚`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const generatedText = await callGeminiApi(payload);
            
            // Inject the generated text back
            document.getElementById('day-content-edit').value = generatedText;

            loadingEl.classList.add('hidden');
            document.getElementById('ai-draft-button').disabled = false;
        }


        /* --- DEFAULT DATA & INITIALIZATION --- */
        const defaultFlights = [{ id: 1, dep: 'TPE', arr: 'NRT', code: 'IT202', time: '14:00 - 18:00', date: '1/10 å»ç¨‹' }, { id: 2, dep: 'NRT', arr: 'TPE', code: 'IT203', time: '18:20 - 19:55', date: '1/16 è¿”ç¨‹' }];
        
        const defaultItinerary = [
            { id: 'day1', date: "1/10 Day 1 æˆç”°", highlight: false, links: [], photos: [], content: "18:00 æŠµé”æˆç”°æ©Ÿå ´ \\ Aeon Mall è¶…å¸‚åƒé€›", transportation: {content: "æ­ä¹˜ Skyliner", note: "äº‹å…ˆè²·ç¥¨", time: "18:40", photo: ""}, dayNote: "", accommodation: "æˆç”°æ©Ÿå ´å‘¨é‚Š", accommodationUrl: "", meals: { b: '', l: '', d: 'è¶…å¸‚ä¾¿ç•¶' } },
            { id: 'day2', date: "Day 2 æ–°å®¿", highlight: false, links: [], photos: [], content: "æ·ºè‰é›·é–€ \\ æ–°å®¿ (æ–°å®¿ç´ é£Ÿæ‹‰éºµ / 3Dè²“ / å“¥å‰æ‹‰) \\ æ±äº¬éƒ½å»³å…è²»å¤œæ™¯", transportation: {content: "", note: "", time: "", photo: ""}, dayNote: "", accommodation: "æ±äº¬å¸‚å€", accommodationUrl: "", meals: { b: 'è¶…å•†', l: 'æ–°å®¿ç´ é£Ÿ', d: '' } },
            { id: 'day3', date: "Day 3 ç¯‰åœ°", highlight: false, links: [], photos: [], content: "ç¯‰åœ°å¸‚å ´ (ç¯‰åœ°é£¯ç³°) \\ åƒå®¢è¬ä¾†ï¼ˆè¶³æµ´ï¼‰æˆ–è±æ´²å¸‚å ´ \\ teamLab è±æ´² \\ é˜¿ç¾æ©«ä¸", transportation: {content: "", note: "", time: "", photo: ""}, dayNote: "", accommodation: "æ±äº¬å¸‚å€", accommodationUrl: "", meals: { b: 'ç¯‰åœ°é£¯ç³°', l: 'è±æ´²å¸‚å ´', d: 'é˜¿ç¾æ©«ä¸å±…é…’å±‹' } },
            { id: 'day4', date: "Day 4 è¼•äº•æ¾¤", highlight: true, links: [], photos: [], content: "09:00 æ–°å¹¹ç·šå¾€è¼•äº•æ¾¤ \\ è»Šç«™å¯„è¡Œæ \\ è¼•äº•æ¾¤ Outlet çˆ†è²· / ç©é›ª (Snow Park) \\ Check-in", transportation: {content: "åŒ—é™¸æ–°å¹¹ç·š", note: "æŒ‡å®šå¸­", time: "09:00", photo: ""}, dayNote: "è¨˜å¾—æˆ´æ‰‹å¥—", accommodation: "Cypress è¼•äº•æ¾¤", accommodationUrl: "https://maps.app.goo.gl/dummy", meals: { b: 'æ–°å¹¹ç·šä¾¿ç•¶', l: 'Outletç¾é£Ÿè¡—', d: 'é£¯åº—è‡ªåŠ©é¤' } },
            { id: 'day5', date: "Day 5 è¼•äº•æ¾¤", highlight: false, links: [], photos: [], content: "å–®è»Šæ¼«éŠæ˜Ÿé‡æ¦†æ¨¹è¡— \\ åˆé¤ \\ èœ»èœ“ä¹‹æ¹¯ \\ çŸ³ä¹‹æ•™å ‚ / é«˜åŸæ•™æœƒ \\ å›é£¯åº—", transportation: {content: "", note: "", time: "", photo: ""}, dayNote: "", accommodation: "Cypress è¼•äº•æ¾¤", accommodationUrl: "", meals: { b: 'é£¯åº—', l: 'æ‘æ°‘é£Ÿå ‚', d: 'è‡ªç†' } },
            { id: 'day6', date: "Day 6 æ±äº¬ç«™", highlight: true, links: [], photos: [], content: "èµ°å»é›²å ´æ±  \\ 10:00 é€€æˆ¿ \\ æ–°å¹¹ç·šå›æ±äº¬ \\ æ±äº¬ç«™é£¯åº—æ”¾è¡Œæ \\ 17:00 æ±äº¬éµå¡” RED TOKYO TOWER (æ˜Ÿå…‰ç¥¨)", transportation: {content: "NEX æˆç”°ç‰¹å¿«", note: "", time: "15:30", photo: ""}, dayNote: "", accommodation: "æ±äº¬ç«™é£¯åº—", accommodationUrl: "", meals: { b: 'éºµåŒ…', l: 'è•éº¥éºµ', d: 'æ±äº¬éµå¡”' } },
            { id: 'day7', date: "Day 7 æˆç”°æ©Ÿå ´", highlight: true, links: [], photos: [], content: "æ±äº¬ç«™æœ€å¾Œè£œè²¨ \\ 15:30 æ­è»Šå¾€æ©Ÿå ´ \\ 18:25 é£›æ©Ÿ (è¿”å°)", transportation: {content: "NEX æˆç”°ç‰¹å¿«", note: "", time: "15:30", photo: ""}, dayNote: "", accommodation: "", accommodationUrl: "", meals: { b: '', l: '', d: 'æ©Ÿä¸Šé¤' } }
        ];

        const defaultMustEatList = [
            { id: 'eat1', name: 'ç´ é£Ÿæ‹‰éºµ', location: 'æ–°å®¿', note: 'æ¥µå‘³ç´ é£Ÿï¼Œè¦æ—©é»å»', items: [{ id: 'f1', foodName: 'æ‹›ç‰Œé†¬æ²¹æ‹‰éºµ', price: 1200, done: false, url: 'https://maps.app.goo.gl/Shinjuku' }, { id: 'f2', foodName: 'ç‰¹è£½ç…é¤ƒ', price: 450, done: false, url: '' }] },
            { id: 'eat2', name: 'æµ·é®®/é£¯ç³°', location: 'ç¯‰åœ°å¸‚å ´', note: 'æµ·è‹”è¶…è®šï¼Œé£¯ç³°æ’éšŠé•·', items: [{ id: 'f3', foodName: 'é®­é­šé£¯ç³°', price: 300, done: false, url: 'https://maps.app.goo.gl/Tsukiji' }, { id: 'f4', foodName: 'ç‰å­ç‡’é£¯ç³°', price: 250, done: true, url: '' }] },
            { id: 'eat3', name: 'ç‡’è‚‰åº—', location: 'æ–°å®¿', note: 'å®µå¤œå ´å¿…å‚™', items: [{ id: 'f5', foodName: 'å’Œç‰›å¥—é¤', price: 6000, done: false, url: 'https://maps.app.goo.gl/yakiniku' }] } // New item for grouping test
        ];

        let flights = JSON.parse(localStorage.getItem('flights')) || defaultFlights;
        let itinerary = JSON.parse(localStorage.getItem('itinerary_v2')) || defaultItinerary;
        let mustEatList = JSON.parse(localStorage.getItem('mustEatList')) || defaultMustEatList;
        
        let currentMustEatItems = []; 
        let currentEditingMustEatId = null;

        // Data Migration (Ensuring compatibility)
        itinerary = itinerary.map(d => ({
            ...d, 
            accommodation: d.accommodation||'', accommodationUrl: d.accommodationUrl||'', 
            transportation: d.transportation||{content:'',note:'',time:'',photo:''}, 
            dayNote: d.dayNote||'',
            photos: d.photos || [],
            links: d.links ? d.links.map(l => ({ id: l.id || Date.now() + Math.random().toString(36).substring(2, 9), ...l })) : [],
            meals: { b: (d.meals?.b?.name===undefined?{name:d.meals?.b||'',url:'',note:''}:d.meals.b), l: (d.meals?.l?.name===undefined?{name:d.meals?.l||'',url:'',note:''}:d.meals.l), d: (d.meals?.d?.name===undefined?{name:d.meals?.d||'',url:'',note:''}:d.meals.d) }
        }));
        
        flights = flights.map(f => ({...f, id: f.id || Date.now() + Math.random(), url: f.url||'', photo: f.photo||''}));
        
        // V18 MustEat Sub-item migration (add 'url' if missing)
        mustEatList = mustEatList.map(e => ({
            ...e,
            items: e.items.map(f => ({
                ...f,
                url: f.url || '' 
            }))
        }));
        
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let guides = JSON.parse(localStorage.getItem('guides')) || []; 
        guides = guides.map(g => ({...g, id: g.id || Date.now() + Math.random()}));
        
        let todos = JSON.parse(localStorage.getItem('todos')) || [{text: "è­·ç…§", done: false}];
        let shoppingList = JSON.parse(localStorage.getItem('shoppingList_v2')) || [];
        
        let payers = JSON.parse(localStorage.getItem('payers')) || ["æˆ‘", "æ—…ä¼´", "å…¬è²»"];
        let memoText = localStorage.getItem('memo') || "";

        // V17: New Manual Debts
        let manualDebts = JSON.parse(localStorage.getItem('manualDebts_v1')) || [];
        
        let currentPhotoBase64 = null; let currentGuidePhoto = null; let currentShopPhoto = null; let currentFlightPhoto = null; let currentTransPhoto = null;
        let tempDayPhotos = [];
        let guideSortable = null;

        // V17: Photo Clarity Improvement - Max 1200px width, 95% quality
        function processImage(input, cb) {
            if(input.files && input.files[0]){
                const r=new FileReader(); r.onload=function(e){const i=new Image();i.onload=function(){const c=document.createElement('canvas'),x=c.getContext('2d'),w=1200;let wd=i.width,ht=i.height;if(wd>w){ht*=w/wd;wd=w;}c.width=wd;c.height=ht;x.drawImage(i,0,0,wd,ht);cb(c.toDataURL('image/jpeg',0.95));};i.src=e.target.result;};r.readAsDataURL(input.files[0]);
            }
        }
        function openModal(id){document.getElementById(id).classList.remove('hidden');setTimeout(()=>document.getElementById(id).classList.add('visible'),10);}
        function closeModal(id){const el=document.getElementById(id);el.classList.remove('visible');setTimeout(()=>el.classList.add('hidden'),300);}
        
        // V17: Lightbox function
        function viewPhoto(src) { 
            document.getElementById('lightbox-image').src = src;
            openModal('lightbox-modal');
        }

        /* --- MANUAL DEBT (IOU) FUNCTIONS (NEW V17) --- */
        function renderIOUOptions() {
            const payerOpts = payers.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('iou-creditor').innerHTML = payerOpts;
            document.getElementById('iou-debtor').innerHTML = payerOpts;
        }

        function renderIOUList() {
            const container = document.getElementById('iou-list-container');
            container.innerHTML = '';
            
            if (manualDebts.length === 0) {
                container.innerHTML = '<p class="text-xs text-center text-gray-400 p-2">ç›®å‰æ²’æœ‰æ‰‹å‹•æ¬ æ¬¾ç´€éŒ„ã€‚</p>';
                return;
            }

            manualDebts.forEach(iou => {
                const html = `
                <div class="flex justify-between items-center p-2 border-b last:border-b-0 bg-gray-50 rounded-sm cursor-pointer hover:bg-gray-100" onclick="openIOUModal('${iou.id}')">
                    <div class="flex-1 min-w-0 mr-2">
                        <span class="text-xs text-gray-500 block">${iou.note || 'æ‰‹å‹•èª¿æ•´'}</span>
                        <span class="text-sm font-bold text-gray-700">${iou.debtor} æ¬  ${iou.creditor}</span>
                    </div>
                    <span class="text-sm font-mono text-fuji font-bold">NT$ ${Math.round(iou.amount).toLocaleString()}</span>
                </div>`;
                container.innerHTML += html;
            });
        }
        
        function openIOUModal(id = null) {
            const delBtn = document.getElementById('btn-delete-iou');
            renderIOUOptions(); // Re-render payers in case of changes
            renderIOUList();
            delBtn.classList.add('hidden');
            document.getElementById('iou-id').value = '';
            document.getElementById('iou-amount').value = '';
            document.getElementById('iou-note').value = '';
            
            if (id) {
                const iou = manualDebts.find(i => i.id == id);
                document.getElementById('iou-id').value = iou.id;
                document.getElementById('iou-creditor').value = iou.creditor;
                document.getElementById('iou-debtor').value = iou.debtor;
                document.getElementById('iou-amount').value = iou.amount;
                document.getElementById('iou-note').value = iou.note || '';
                delBtn.classList.remove('hidden');
            }
            openModal('iou-modal');
        }

        function saveIOU() {
            const id = document.getElementById('iou-id').value;
            const creditor = document.getElementById('iou-creditor').value;
            const debtor = document.getElementById('iou-debtor').value;
            const amount = parseFloat(document.getElementById('iou-amount').value);
            const note = document.getElementById('iou-note').value;

            if (!amount || amount <= 0 || creditor === debtor) {
                alert("é‡‘é¡å¿…é ˆå¤§æ–¼é›¶ï¼Œä¸”å‚µæ¬Šäººèˆ‡å‚µå‹™äººä¸èƒ½ç›¸åŒï¼");
                return;
            }

            const newIOU = { id: id || 'iou' + Date.now(), creditor, debtor, amount, note };

            if (id) {
                const idx = manualDebts.findIndex(i => i.id == id);
                if (idx > -1) manualDebts[idx] = newIOU;
            } else {
                manualDebts.push(newIOU);
            }
            localStorage.setItem('manualDebts_v1', JSON.stringify(manualDebts));
            
            renderExpenses(); // Re-render everything affected by debt change
            closeModal('iou-modal');
        }

        function deleteIOU() {
            const id = document.getElementById('iou-id').value;
            if (id && confirm("ç¢ºå®šåˆªé™¤æ­¤æ‰‹å‹•æ¬ æ¬¾ç´€éŒ„å—ï¼Ÿ")) {
                manualDebts = manualDebts.filter(i => i.id != id);
                localStorage.setItem('manualDebts_v1', JSON.stringify(manualDebts));
                renderExpenses();
                closeModal('iou-modal');
            }
        }


        /* --- MUST EAT LIST (RESTRUCTURED V18) --- */
        function renderMustEatList() {
            const container = document.getElementById('must-eat-list');
            container.innerHTML = '';
            
            // 1. Sort by location (Mandatory for V18 grouping)
            const sortedList = [...mustEatList].sort((a, b) => a.location.localeCompare(b.location, 'zh-TW'));

            let currentGroup = '';
            let groupHtml = '';

            sortedList.forEach(item => {
                const totalItems = item.items ? item.items.length : 0;
                const checkedItems = item.items ? item.items.filter(i => i.done).length : 0;
                const summary = totalItems > 0 ? `<span class="text-xs text-gray-500 mr-2">${checkedItems}/${totalItems} å·²åšé®®</span>` : '<span class="text-xs text-red-400">æœªè¨­å®šèœå–®</span>';

                // Check for new group (Location change)
                if (item.location !== currentGroup) {
                    if (currentGroup !== '') {
                        groupHtml += '</div>'; // Close previous group
                        container.innerHTML += groupHtml;
                    }
                    currentGroup = item.location;
                    // Start new group display
                    groupHtml = `
                    <div class="mb-4 pt-3">
                        <h4 class="text-base font-black handwritten text-matcha bg-matcha/20 p-2 rounded-lg border-l-4 border-matcha">${currentGroup} åœ°å€å¿…åƒ</h4>
                        <div class="mt-2 space-y-3">
                    `;
                }

                // Item HTML
                groupHtml += `
                <div id="eat-item-${item.id}" class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition" onclick="openMustEatModal('${item.id}')">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-gray-700 truncate">${item.name} <span class="text-xs text-gray-400 font-normal">(${item.location})</span></div>
                        <div class="text-xs text-matcha mt-1 italic">${item.note || 'ç„¡å‚™è¨»'}</div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-2">
                        ${summary}
                    </div>
                </div>`;
            });
            
            // Append last group
            if (currentGroup !== '') {
                groupHtml += '</div>';
                container.innerHTML += groupHtml;
            }

            if (mustEatList.length === 0) {
                 container.innerHTML = '<p class="text-sm text-center text-gray-400 p-4">ç›®å‰æ²’æœ‰å¿…åƒæ¸…å–®é …ç›®ã€‚</p>';
            }
        }
        
        function renderFoodItemsInModal() {
            const container = document.getElementById('must-eat-items-container');
            container.innerHTML = '';

            if (currentMustEatItems.length === 0) {
                 container.innerHTML = '<p class="text-xs text-center text-gray-400 p-2">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢å¿…é»èœè‰²/é¤å»³</p>';
                 return;
            }

            currentMustEatItems.forEach(item => {
                const isDone = item.done;
                // V18: Add URL display
                const urlHtml = item.url ? `<a href="${item.url}" target="_blank" onclick="event.stopPropagation()" class="text-blue-500 hover:text-blue-700 ml-2" title="é»æ“Šå‰å¾€é¤å»³é€£çµ"><i class="fa-solid fa-link text-xs"></i></a>` : '';
                
                const html = `
                <div class="flex items-center justify-between p-2 border-b last:border-b-0 ${isDone ? 'opacity-50' : 'bg-gray-50 rounded-sm'}">
                    <div class="flex items-center flex-1 min-w-0 mr-2">
                        <input type="checkbox" onchange="toggleFoodItemDone('${item.id}')" ${isDone ? 'checked' : ''} class="w-4 h-4 accent-matcha flex-shrink-0">
                        <span class="ml-2 text-sm font-medium ${isDone ? 'line-through text-gray-400' : 'text-gray-700'} truncate">${item.foodName}</span>
                        ${urlHtml}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="text-xs font-mono text-clay">Â¥${item.price.toLocaleString()}</span>
                        <button onclick="quickExpenseFromFoodItem('${currentEditingMustEatId}', '${item.id}')" title="è¨˜å¸³" class="text-clay hover:text-red-500 px-1 py-0.5 rounded text-sm disabled:opacity-50" ${isDone ? 'disabled' : ''}>
                           <i class="fa-solid fa-money-bill-transfer"></i>
                        </button>
                        <button onclick="deleteFoodItem('${item.id}')" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-times text-xs"></i></button>
                    </div>
                </div>
                `;
                container.innerHTML += html;
            });
        }

        function openMustEatModal(id = null) {
            // V18: Adjusting fields for the new semantic
            document.getElementById('eat-id').value = '';
            document.getElementById('eat-name').value = ''; // Theme Name
            document.getElementById('eat-location').value = ''; // Location (Primary)
            document.getElementById('eat-note').value = '';
            currentMustEatItems = [];
            currentEditingMustEatId = null;

            if (id) {
                const item = mustEatList.find(i => i.id === id);
                document.getElementById('eat-id').value = item.id;
                document.getElementById('eat-name').value = item.name;
                document.getElementById('eat-location').value = item.location || '';
                document.getElementById('eat-note').value = item.note || '';
                currentMustEatItems = JSON.parse(JSON.stringify(item.items || [])); // Deep clone items
                currentEditingMustEatId = id;
            }
            renderFoodItemsInModal();
            openModal('must-eat-modal');
        }

        function addNewFoodItem() {
            const name = document.getElementById('new-food-name').value.trim();
            const price = parseFloat(document.getElementById('new-food-price').value) || 0;
            const url = document.getElementById('new-food-url').value.trim(); // V18: Added URL

            if (!name) return;

            const newFoodItem = { 
                id: 'f' + Date.now() + Math.random().toString(36).substring(2, 5), 
                foodName: name, 
                price: price, 
                done: false,
                url: url
            };

            currentMustEatItems.push(newFoodItem);
            document.getElementById('new-food-name').value = '';
            document.getElementById('new-food-price').value = '';
            document.getElementById('new-food-url').value = ''; // V18: Reset URL
            renderFoodItemsInModal();
        }

        function toggleFoodItemDone(foodId) {
            const item = currentMustEatItems.find(i => i.id === foodId);
            if (item) {
                item.done = !item.done;
                // If it was checked off, update the main list data too
                if (currentEditingMustEatId) {
                    const mainItem = mustEatList.find(e => e.id === currentEditingMustEatId);
                    const mainFood = mainItem.items.find(f => f.id === foodId);
                    if (mainFood) mainFood.done = item.done;
                }
                renderFoodItemsInModal();
            }
        }
        
        function deleteFoodItem(foodId) {
            if (confirm("ç¢ºå®šåˆªé™¤æ­¤é£Ÿç‰©é …ç›®å—ï¼Ÿ")) {
                currentMustEatItems = currentMustEatItems.filter(i => i.id !== foodId);
                renderFoodItemsInModal();
            }
        }

        function saveMustEatItem() {
            const id = document.getElementById('eat-id').value;
            const name = document.getElementById('eat-name').value; // Theme Name
            const location = document.getElementById('eat-location').value; // Location
            const note = document.getElementById('eat-note').value;

            if (!location) {
                 alert("åœ°é»åç¨±ç‚ºå¿…å¡«é …ç›®ã€‚");
                 return;
            }

            const newItem = { id: id || 'eat' + Date.now(), name, location, note, items: currentMustEatItems };

            if (id) {
                const idx = mustEatList.findIndex(i => i.id === id);
                if (idx > -1) {
                    mustEatList[idx] = { ...mustEatList[idx], ...newItem };
                }
            } else {
                mustEatList.push(newItem);
            }
            localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
            renderMustEatList();
            renderItinerary(); // Important: update itinerary links
            closeModal('must-eat-modal');
        }

        function deleteMustEatItem() {
            const id = document.getElementById('eat-id').value;
            if (id && confirm("ç¢ºå®šåˆªé™¤æ­¤å¿…åƒåœ°é»é …ç›®å—ï¼Ÿ")) {
                mustEatList = mustEatList.filter(i => i.id !== id);
                localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
                renderMustEatList();
                renderItinerary(); // Important: update itinerary links
                closeModal('must-eat-modal');
            }
        }
        
        function quickExpenseFromFoodItem(eatId, foodId) {
             const eatItem = mustEatList.find(e => e.id === eatId);
             if (!eatItem) return;

             const foodItem = eatItem.items.find(f => f.id === foodId);
             if (!foodItem) return;

             // 1. Mark as consumed (Done) in the main list
             foodItem.done = true;
             localStorage.setItem('mustEatList', JSON.stringify(mustEatList));
             renderMustEatList(); // Re-render main list
             
             // 2. Also update temp items in modal if it's open
             const tempFoodItem = currentMustEatItems.find(f => f.id === foodId);
             if(tempFoodItem) tempFoodItem.done = true;
             renderFoodItemsInModal(); // Re-render modal content

             // 3. Open expense modal
             openExpenseModal(null, {
                 cat: 'é£²é£Ÿ',
                 note: `${foodItem.foodName} (${eatItem.location} - ${eatItem.name})`,
                 amt: foodItem.price
             });
             closeModal('must-eat-modal');
        }


        function jumpToMustEat(id) {
            switchTab('lists');
            setTimeout(() => {
                const el = document.getElementById('eat-item-' + id);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('highlight-target');
                    setTimeout(() => el.classList.remove('highlight-target'), 2000);
                }
            }, 100);
        }

        /* --- GUIDE & SORTING --- */
        function renderGuides() {
            const list = document.getElementById('guide-list'); list.innerHTML='';
            
            // Clear previous Sortable instance if exists
            if (guideSortable) {
                guideSortable.destroy();
                guideSortable = null;
            }

            guides.forEach(g => {
                const mapHtml = g.coords ? `<iframe width="100%" height="150" frameborder="0" src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(g.coords.split(',')[1])-0.01},${parseFloat(g.coords.split(',')[0])-0.01},${parseFloat(g.coords.split(',')[1])+0.01},${parseFloat(g.coords.split(',')[0])+0.01}&layer=mapnik&marker=${g.coords}"></iframe>` : '';
                const imgHtml = g.photo ? `<img src="${g.photo}" class="w-full h-40 object-cover border-b border-gray-100" onclick="viewPhoto('${g.photo}')">` : '';
                
                list.innerHTML += `
                <div id="guide-${g.id}" data-id="${g.id}" class="hand-card p-0 overflow-hidden relative group">
                    <!-- NEW DRAG HANDLE on the left -->
                    <div class="drag-handle absolute top-0 left-0 h-full w-6 bg-gray-100/50 flex items-center justify-center text-gray-400 hover:text-pencil z-10">
                        <i class="fa-solid fa-grip-vertical text-xs"></i>
                    </div>
                    
                    <button onclick="openGuideModal(${g.id})" class="absolute top-2 right-2 z-20 bg-white/80 rounded-full w-8 h-8 text-gray-500 shadow flex items-center justify-center"><i class="fa-solid fa-pen"></i></button>
                    ${imgHtml}${mapHtml}
                    <div class="p-4 bg-white guide-card-content">
                        <h3 class="text-lg font-bold text-gray-700 mb-2">${g.title}</h3>
                        <p class="text-sm text-gray-600 whitespace-pre-line leading-6">${g.desc}</p>
                    </div>
                </div>`;
            });
            
            // Initialize SortableJS for guides, targeting the new handle
            const guideListEl = document.getElementById('guide-list');
            guideSortable = new Sortable(guideListEl, {
                animation: 150,
                handle: '.drag-handle', // Use the new handle class
                onEnd: function (evt) {
                    const itemEl = evt.item;
                    const itemId = itemEl.getAttribute('data-id');
                    
                    const movedItem = guides.find(g => g.id == itemId);
                    
                    guides.splice(evt.oldIndex, 1);
                    guides.splice(evt.newIndex, 0, movedItem);

                    localStorage.setItem('guides', JSON.stringify(guides));
                    renderItinerary(); 
                }
            });

            renderItinerary();
        }
        
        function openGuideModal(id=null) {
            currentGuidePhoto=null; document.getElementById('guide-photo-preview').classList.add('hidden'); document.getElementById('guide-photo-text').classList.remove('hidden');
            if(id) {
                const g = guides.find(i=>i.id==id);
                document.getElementById('guide-id').value = g.id;
                document.getElementById('guide-title').value = g.title;
                document.getElementById('guide-desc').value = g.desc;
                document.getElementById('guide-coords').value = g.coords;
                if(g.photo) { currentGuidePhoto=g.photo; document.getElementById('guide-photo-preview').src=g.photo; document.getElementById('guide-photo-preview').classList.remove('hidden'); document.getElementById('guide-photo-text').classList.add('hidden'); }
            } else {
                ['guide-id','guide-title','guide-desc','guide-coords'].forEach(k=>document.getElementById(k).value='');
            }
            openModal('guide-modal');
        }
        
        function saveGuide() {
            const id = document.getElementById('guide-id').value;
            const t = document.getElementById('guide-title').value;
            const d = document.getElementById('guide-desc').value;
            const c = document.getElementById('guide-coords').value;
            if(!t) return;
            
            if(id) {
                const idx = guides.findIndex(i => i.id == id);
                if(idx > -1) { 
                    guides[idx] = {...guides[idx], title:t, desc:d, coords:c, photo: currentGuidePhoto || guides[idx].photo}; 
                }
            } else {
                guides.push({id:Date.now(), title:t, desc:d, coords:c, photo: currentGuidePhoto});
            }
            localStorage.setItem('guides', JSON.stringify(guides));
            renderGuides(); closeModal('guide-modal');
        }

        /* --- ITINERARY & OTHERS --- */
        
        function renderFlights(){
            const c=document.getElementById('flight-list-container');c.innerHTML='';
            flights.forEach(f=>{
                const bgStyle = f.photo ? `background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url(${f.photo}); background-size: cover; background-position: center; color: white; text-shadow: 1px 1px 2px black;` : '';
                const linkAction = f.url ? `onclick="window.open('${f.url}', '_blank')"` : '';
                const cursor = f.url ? 'cursor-pointer hover:shadow-lg' : '';
                
                c.innerHTML+=`
                <div class="hand-card p-4 relative overflow-hidden group ${cursor}" style="${bgStyle}" ${linkAction}>
                    <div class="washi-tape tape-blue h-6 w-32 absolute -top-2 left-1/2 transform -translate-x-1/2 rotate-1"></div>
                    <button onclick="event.stopPropagation(); deleteFlight(${f.id})" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times"></i></button>
                    <button onclick="event.stopPropagation(); editFlight(${f.id})" class="absolute top-2 right-10 text-gray-300 hover:text-fuji opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-pen"></i></button>
                    <div class="mt-4 flex justify-between items-center text-center">
                        <div><div class="text-2xl font-bold font-hand">${f.dep}</div></div>
                        <div class="flex-1 px-2 relative"><i class="fa-solid fa-plane ${f.photo?'text-white':'text-fuji'} text-xl"></i><div class="border-b-2 border-dashed ${f.photo?'border-white':'border-gray-300'} w-full absolute top-1/2 left-0 -z-10"></div></div>
                        <div><div class="text-2xl font-bold font-hand">${f.arr}</div></div>
                    </div>
                    <div class="mt-3 ${f.photo?'bg-black/30 border-white/30 text-white':'bg-blue-50 border-blue-100 text-fuji'} p-2 rounded text-sm text-center border">
                        <span class="font-bold">${f.code}</span> <br> <span class="text-xs opacity-80">${f.date} | ${f.time}</span>
                    </div>
                </div>`;
            });
        }
        
        function openFlightModal(flight = null){
            const previewEl = document.getElementById('flight-photo-preview');
            const textEl = document.getElementById('flight-photo-text');
            
            ['flight-id','flight-dep','flight-arr','flight-code','flight-time','flight-date','flight-url'].forEach(id=>document.getElementById(id).value='');
            currentFlightPhoto = null;
            previewEl.classList.add('hidden');
            textEl.classList.remove('hidden');

            if (flight) {
                document.getElementById('flight-id').value = flight.id;
                document.getElementById('flight-dep').value = flight.dep;
                document.getElementById('flight-arr').value = flight.arr;
                document.getElementById('flight-code').value = flight.code;
                document.getElementById('flight-time').value = flight.time;
                document.getElementById('flight-date').value = flight.date;
                document.getElementById('flight-url').value = flight.url;

                if (flight.photo) {
                    currentFlightPhoto = flight.photo;
                    previewEl.src = flight.photo;
                    previewEl.classList.remove('hidden');
                    textEl.classList.add('hidden');
                }
            }
            openModal('flight-modal');
        }
        
        function editFlight(id) {
            const flight = flights.find(f => f.id === id);
            if (flight) {
                openFlightModal(flight);
            }
        }
        
        function saveFlight(){
            const id = document.getElementById('flight-id').value; 
            const dep=document.getElementById('flight-dep').value,arr=document.getElementById('flight-arr').value,code=document.getElementById('flight-code').value,time=document.getElementById('flight-time').value,date=document.getElementById('flight-date').value,url=document.getElementById('flight-url').value;
            
            if(!dep) return; 

            const newFlightData = {
                id: id ? parseInt(id) : Date.now(), 
                dep, arr, code, time, date, url, photo: currentFlightPhoto
            };

            if (id) {
                const idx = flights.findIndex(f => f.id == id);
                if (idx > -1) {
                    flights[idx] = newFlightData;
                }
            } else {
                flights.push(newFlightData);
            }

            localStorage.setItem('flights',JSON.stringify(flights));
            renderFlights();
            closeModal('flight-modal');
        }
        function deleteFlight(id){if(confirm("åˆªé™¤ï¼Ÿ")){flights=flights.filter(f=>f.id!==id);localStorage.setItem('flights',JSON.stringify(flights));renderFlights();}}

        function renderItinerary() {
            const c=document.getElementById('itinerary-container'); c.innerHTML='';
            itinerary.forEach((day)=>{
                let content=day.content;
                
                // 1. Link Guides (æ™¯é»å°è¦½)
                if(guides.length>0) guides.forEach(g=>{ const rg=new RegExp(`(${g.title})`,'gi'); content=content.replace(rg,`<span class="font-extrabold cursor-pointer hover:text-matcha transition-colors border-b-2 border-transparent hover:border-matcha" onclick="jumpToGuide(${g.id})">$1</span>`); });
                
                // 2. Link Must Eat Items (å¿…åƒæ¸…å–®) - By NAME
                if(mustEatList.length>0) mustEatList.forEach(e=>{
                    const foodNames = e.items.map(i => i.foodName).join('|');
                    if (foodNames.length > 0) {
                        const rgName=new RegExp(`(${foodNames}|${e.name})`,'gi'); 
                        content=content.replace(rgName,`<span class="font-bold text-matcha cursor-pointer hover:text-clay transition-colors" onclick="jumpToMustEat('${e.id}')"><i class="fa-solid fa-utensils text-xs mr-1"></i>$1</span>`); 
                    }
                });
                
                // 3. Link Must Eat Items (å¿…åƒæ¸…å–®) - By LOCATION
                if(mustEatList.length>0) {
                    const locationMap = new Map();
                    mustEatList.forEach(e => {
                        if (e.location && e.location.trim().length > 0 && !locationMap.has(e.location)) {
                            locationMap.set(e.location, e.id);
                        }
                    });

                    locationMap.forEach((id, location) => {
                        const rgLocation = new RegExp(`(${location})`, 'g'); 
                        content = content.replace(rgLocation, (match, p1) => {
                            // Simple heuristic to avoid double-linking/overwriting complex links
                            if (match.includes('<i class="fa-solid fa-utensils')) return match; 
                            return `<span class="font-bold text-matcha cursor-pointer hover:text-clay transition-colors" onclick="jumpToMustEat('${id}')">${p1}<i class="fa-solid fa-utensils text-xs ml-1"></i></span>`;
                        });
                    });
                }


                content=content.split('\\').map(e=>`<li>â€¢ ${e.trim()}</li>`).join('');
                
                const mealHTML = (m) => { if(!m.name) return ''; const n=m.url?`<a href="${m.url}" target="_blank" class="text-blue-600 underline">${m.name}</a>`:m.name; const desc=m.note?`<span class="text-[10px] text-gray-400 ml-1">(${m.note})</span>`:''; return `<div class="flex items-start gap-2"><span>${n}${desc}</span></div>`; };
                const mealsBlock = (day.meals.b.name||day.meals.l.name||day.meals.d.name)?
                    `<div class="mt-2 bg-yellow-50/50 p-2 rounded-lg text-xs text-gray-600 space-y-1">
                        ${day.meals.b.name?`<div class="flex gap-2 items-center"><button onclick="quickExpense('${day.meals.b.name}')" title="è¨˜ä¸€ç­†" class="hover:bg-yellow-200 rounded px-1"><i class="fa-solid fa-mug-hot text-orange-300 w-4"></i></button>${mealHTML(day.meals.b)}</div>`:''}
                        ${day.meals.l.name?`<div class="flex gap-2 items-center"><button onclick="quickExpense('${day.meals.l.name}')" title="è¨˜ä¸€ç­†" class="hover:bg-green-200 rounded px-1"><i class="fa-solid fa-utensils text-green-400 w-4"></i></button>${mealHTML(day.meals.l)}</div>`:''}
                        ${day.meals.d.name?`<div class="flex gap-2 items-center"><button onclick="quickExpense('${day.meals.d.name}')" title="è¨˜ä¸€ç­†" class="hover:bg-purple-200 rounded px-1"><i class="fa-solid fa-wine-glass text-purple-400 w-4"></i></button>${mealHTML(day.meals.d)}</div>`:''}
                    </div>`:'';
                
                const acc = day.accommodation?`<div class="mt-2 pt-2 border-t border-dashed border-gray-100 flex items-start text-sm text-indigo-600">${day.accommodationUrl?`<a href="${day.accommodationUrl}" target="_blank" class="font-bold underline"><i class="fa-solid fa-bed mr-1"></i>ä½å®¿ï¼š${day.accommodation}</a>`:`<span class="text-gray-600"><i class="fa-solid fa-bed mr-1 text-indigo-400"></i>ä½å®¿ï¼š${day.accommodation}</span>`}</div>`:'';
                
                let trans = '';
                if(day.transportation.content) {
                    const t = day.transportation;
                    const photoHtml = t.photo ? `<div onclick="viewPhoto('${t.photo}')" class="w-10 h-10 rounded bg-gray-200 overflow-hidden cursor-pointer border border-gray-300 flex-shrink-0"><img src="${t.photo}" class="w-full h-full object-cover"></div>` : '';
                    trans = `
                    <div class="mt-3 bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm text-gray-600 flex items-center gap-3">
                        ${photoHtml}
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-train-subway text-gray-400"></i>
                                <span class="font-bold text-gray-700">${t.time ? `<span class="bg-gray-200 text-xs px-1 rounded mr-1">${t.time}</span>` : ''}${t.content}</span>
                            </div>
                            ${t.note ? `<div class="text-xs text-gray-400 pl-6">${t.note}</div>` : ''}
                        </div>
                    </div>`;
                }

                const note = day.dayNote?`<div class="mt-3 p-2 bg-yellow-100 text-yellow-800 text-xs rounded rotate-1 shadow-sm font-hand relative"><i class="fa-solid fa-thumbtack absolute -top-2 -right-1 text-red-400"></i>${day.dayNote}</div>`:'';
                
                const links = day.links?.length > 0 ?
                    `<div class="mt-2 flex flex-wrap gap-2 pt-2 border-t border-dashed border-gray-200">
                        ${day.links.map((l) => `
                                <div class="relative group">
                                    <a href="${l.url}" target="_blank" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded shadow-sm hover:text-blue-500 flex items-center pr-6">
                                        <i class="fa-solid fa-link mr-1"></i>${l.name}
                                    </a>
                                    <button onclick="deleteLink('${day.id}', '${l.id}')" class="absolute top-0 right-0 h-full w-6 bg-gray-100/50 hover:bg-red-400 hover:text-white rounded-r text-[8px] flex items-center justify-center transition border-l border-gray-200">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                </div>
                            `).join('')}
                    </div>` : '';

                const photosHtml = day.photos && day.photos.length > 0 ? 
                    `<div class="mt-3 grid grid-cols-3 gap-1 overflow-hidden rounded-lg">
                        ${day.photos.map(p => `<div class="aspect-square bg-gray-100" onclick="viewPhoto('${p}')"><img src="${p}" class="w-full h-full object-cover cursor-pointer"></div>`).join('')}
                    </div>` : '';

                c.innerHTML+=`<div class="relative pl-6 border-l-2 border-dashed ${day.highlight?'border-sakura':'border-gray-300'} pb-6 group"><div class="absolute -left-2 top-0 w-4 h-4 rounded-full ${day.highlight?'bg-sakura':'bg-gray-300'} border-2 border-white shadow"></div><div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg text-pencil handwritten ${day.highlight?'text-red-500':''}">${day.date}</h3><div class="flex gap-2"><button onclick="openLinkModal('${day.id}')" class="text-xs text-gray-300 p-1"><i class="fa-solid fa-link"></i></button><button onclick="openDayEditor('${day.id}')" class="text-xs text-gray-300 p-1"><i class="fa-solid fa-pen"></i></button></div></div><div class="bg-white p-3 rounded-tr-xl rounded-bl-xl shadow-sm border border-gray-100/50"><ul class="text-sm text-gray-600 space-y-2 leading-relaxed">${content}</ul>${photosHtml}${trans}${acc}${mealsBlock}${note}${links}</div></div>`;
            });
        }
        function addNewDay(){itinerary.push({id:'day_'+Date.now(),date:"New Day",highlight:false,content:"...",accommodation:"",accommodationUrl:"",transportation:{content:"",note:"",time:"",photo:""},dayNote:"",links:[],photos:[],meals:{b:{name:'',url:'',note:''},l:{name:'',url:'',note:''},d:{name:'',url:'',note:''}}});localStorage.setItem('itinerary_v2',JSON.stringify(itinerary));renderItinerary();setTimeout(()=>window.scrollTo(0,document.body.scrollHeight),100);}
        function openDayEditor(id){
            const d=itinerary.find(i=>i.id===id);
            if(d){
                document.getElementById('day-id-edit').value=d.id;
                document.getElementById('day-date-edit').value=d.date;
                document.getElementById('day-highlight-edit').checked=d.highlight;
                document.getElementById('day-content-edit').value=d.content;
                document.getElementById('day-accommodation-edit').value=d.accommodation;
                document.getElementById('day-accommodation-url-edit').value=d.accommodationUrl;
                
                const t = d.transportation || {content:'', note:'', time:'', photo:''};
                document.getElementById('day-trans-content').value=t.content;
                document.getElementById('day-trans-note').value=t.note;
                document.getElementById('day-trans-time').value=t.time || '';
                currentTransPhoto = t.photo || null;
                if(t.photo) {
                    document.getElementById('trans-photo-preview').src = t.photo;
                    document.getElementById('trans-photo-preview').classList.remove('hidden');
                    document.getElementById('trans-photo-text').classList.add('hidden');
                } else {
                    clearTransPhoto();
                }

                document.getElementById('day-note-edit').value=d.dayNote;
                
                tempDayPhotos = d.photos ? [...d.photos] : [];
                renderDayPhotosPreview();
                
                const m=d.meals;
                document.getElementById('meal-b-name').value=m.b.name;document.getElementById('meal-b-url').value=m.b.url;document.getElementById('meal-b-note').value=m.b.note;
                document.getElementById('meal-l-name').value=m.l.name;document.getElementById('meal-l-url').value=m.l.url;document.getElementById('meal-l-note').value=m.l.note;
                document.getElementById('meal-d-name').value=m.d.name;document.getElementById('meal-d-url').value=m.d.url;document.getElementById('meal-d-note').value=m.d.note;
                openModal('day-modal');
            }
        }
        function addDayPhoto(input) {
            processImage(input, (base64) => {
                tempDayPhotos.push(base64);
                renderDayPhotosPreview();
            });
        }
        function renderDayPhotosPreview() {
            const c = document.getElementById('day-photos-preview');
            c.innerHTML = tempDayPhotos.map((p, idx) => `
                <div class="relative aspect-square">
                    <img src="${p}" class="w-full h-full object-cover rounded" onclick="viewPhoto('${p}')">
                    <button onclick="removeDayPhoto(${idx})" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-4 h-4 text-[10px] flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
                </div>
            `).join('');
        }
        function removeDayPhoto(idx) {
            tempDayPhotos.splice(idx, 1);
            renderDayPhotosPreview();
        }
        function clearTransPhoto() {
            currentTransPhoto = null;
            document.getElementById('trans-photo-preview').classList.add('hidden');
            document.getElementById('trans-photo-text').classList.remove('hidden');
            document.getElementById('trans-photo-preview').src = '';
        }

        function saveDay(){
            const idx=itinerary.findIndex(i=>i.id===document.getElementById('day-id-edit').value);
            if(idx>-1){
                const i=itinerary[idx];
                i.date=document.getElementById('day-date-edit').value;
                i.highlight=document.getElementById('day-highlight-edit').checked;
                i.content=document.getElementById('day-content-edit').value;
                i.accommodation=document.getElementById('day-accommodation-edit').value;
                i.accommodationUrl=document.getElementById('day-accommodation-url-edit').value;
                i.transportation={
                    content:document.getElementById('day-trans-content').value,
                    note:document.getElementById('day-trans-note').value,
                    time:document.getElementById('day-trans-time').value,
                    photo:currentTransPhoto
                };
                i.dayNote=document.getElementById('day-note-edit').value;
                i.photos = [...tempDayPhotos];
                i.meals={b:{name:document.getElementById('meal-b-name').value,url:document.getElementById('meal-b-url').value,note:document.getElementById('meal-b-note').value},l:{name:document.getElementById('meal-l-name').value,url:document.getElementById('meal-l-url').value,note:document.getElementById('meal-l-note').value},d:{name:document.getElementById('meal-d-name').value,url:document.getElementById('meal-d-url').value,note:document.getElementById('meal-d-note').value}};
                localStorage.setItem('itinerary_v2',JSON.stringify(itinerary));
                renderItinerary();
                closeModal('day-modal');
            }
        }
        function deleteDay(){if(confirm('Del?')){itinerary=itinerary.filter(d=>d.id!==document.getElementById('day-id-edit').value);localStorage.setItem('itinerary_v2',JSON.stringify(itinerary));renderItinerary();closeModal('day-modal');}}
        function jumpToGuide(id){switchTab('guide');setTimeout(()=>{const el=document.getElementById('guide-'+id);if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.classList.add('highlight-target');setTimeout(()=>el.classList.remove('highlight-target'),2000);}},100);}
        function openLinkModal(id){document.getElementById('link-day-id').value=id;openModal('link-modal');}
        
        function saveLink(){
            const idx=itinerary.findIndex(d=>d.id===document.getElementById('link-day-id').value);
            const n=document.getElementById('link-name').value;
            const u=document.getElementById('link-url').value;
            if(idx>-1&&n&&u){
                if(!itinerary[idx].links)itinerary[idx].links=[];
                itinerary[idx].links.push({
                    id: Date.now() + Math.random().toString(36).substring(2, 9), 
                    name:n,
                    url:u
                });
                localStorage.setItem('itinerary_v2',JSON.stringify(itinerary));
                renderItinerary();
                closeModal('link-modal');
            }
        }
        
        function deleteLink(dayId, linkId) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤é€£çµå—ï¼Ÿ")) return;
            
            const dayIndex = itinerary.findIndex(d => d.id === dayId);

            if (dayIndex > -1) {
                itinerary[dayIndex].links = itinerary[dayIndex].links.filter(l => l.id !== linkId);
                localStorage.setItem('itinerary_v2', JSON.stringify(itinerary));
                renderItinerary();
            }
        }
        
        /* --- WALLET & EXPENSES (V17: Integrated Settlement Logic) --- */
        
        function convertToTWD(amount, currency, rate) {
            if (currency === 'JPY') {
                return amount * rate;
            }
            return amount;
        }

        function calculateSettlement() {
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const summaryContainer = document.getElementById('settlement-summary');
            const dashboardContainer = document.getElementById('individual-stats-dashboard');
            
            // 1. Initialize balances and totals
            let totalPaidByEach = new Map(payers.map(p => [p, 0]));
            let totalExpenseTWD_Group = 0; // Total group expenses

            // 2. Process Group Expenses (Calculate TGE and TPP)
            expenses.forEach(ex => {
                const twdAmount = convertToTWD(ex.amt, ex.curr, rate);
                totalExpenseTWD_Group += twdAmount;
                totalPaidByEach.set(ex.payer, totalPaidByEach.get(ex.payer) + twdAmount);
            });
            
            const averageShare = totalExpenseTWD_Group / payers.length;
            
            // 3. Calculate Net Position (Group Split ONLY)
            let netBalances = new Map(payers.map(p => [p, 0]));
            payers.forEach(p => {
                const paid = totalPaidByEach.get(p);
                const groupNet = paid - averageShare;
                netBalances.set(p, groupNet);
            });
            
            // 4. Apply Manual Debts (IOUs) to the Net Position
            manualDebts.forEach(iou => {
                // Debtor owes Creditor (Debtor's net decreases, Creditor's net increases)
                netBalances.set(iou.debtor, netBalances.get(iou.debtor) - iou.amount);
                netBalances.set(iou.creditor, netBalances.get(iou.creditor) + iou.amount);
            });
            
            // 5. Render Individual Stats Dashboard (Based on final Net Position)
            dashboardContainer.innerHTML = '';
            let dashboardHTML = '';
            payers.forEach(p => {
                const totalPaid = totalPaidByEach.get(p) || 0;
                const finalNet = netBalances.get(p);
                const isPositive = finalNet >= 0;
                const netClass = isPositive ? 'positive-balance' : 'negative-balance';
                const netText = isPositive ? `æ‡‰æ”¶ï¼š+NT$ ${Math.round(finalNet).toLocaleString()}` : `æ‡‰ä»˜ï¼š-NT$ ${Math.round(Math.abs(finalNet)).toLocaleString()}`;
                
                dashboardHTML += `
                <div class="p-3 bg-gray-700 rounded-lg">
                    <div class="font-bold text-base text-white mb-1">${p}</div>
                    <div class="text-gray-400">å¯¦éš›æ”¯ä»˜: NT$ ${Math.round(totalPaid).toLocaleString()}</div>
                    <div class="font-bold text-sm mt-1 ${netClass}">${netText}</div>
                </div>`;
            });
            dashboardContainer.innerHTML = dashboardHTML;

            // 6. Simplify Debts (Settlement)
            let finalBalancesArray = Array.from(netBalances.entries()).map(([payer, net]) => ({ payer, net }));
            let creditors = finalBalancesArray.filter(b => b.net > 1).sort((a, b) => b.net - a.net); 
            let debtors = finalBalancesArray.filter(b => b.net < -1).sort((a, b) => a.net - b.net);   

            const settlements = [];
            let c = 0; let d = 0;
            
            while (c < creditors.length && d < debtors.length) {
                let creditor = creditors[c];
                let debtor = debtors[d];
                
                let amountToSettle = Math.min(creditor.net, Math.abs(debtor.net));
                
                settlements.push({
                    from: debtor.payer,
                    to: creditor.payer,
                    amount: amountToSettle
                });

                // Update balances
                creditor.net -= amountToSettle;
                debtor.net += amountToSettle;

                // Move to next creditor/debtor if their balance is settled (close to zero)
                if (creditor.net <= 1) { c++; }
                if (debtor.net >= -1) { d++; }
            }
            
            // 7. Render final simplified settlements
            if (settlements.length === 0 && totalExpenseTWD_Group > 0) {
                summaryContainer.innerHTML = '<div class="text-xs text-center text-green-700 font-bold">å…¨å“¡çµç®—å®Œæˆï¼Œå¸³å‹™å·²å¹³è¡¡ï¼</div>';
            } else if (settlements.length === 0 && totalExpenseTWD_Group === 0) {
                 summaryContainer.innerHTML = '<div class="text-xs text-center text-gray-500">å°šç„¡å…¬è²»ç´€éŒ„ã€‚</div>';
            }
             else {
                summaryContainer.innerHTML = settlements.map(s => 
                    `<div class="text-sm border-b border-gray-200 py-1 flex justify-between items-center">
                        <span><span class="font-bold text-red-600">${s.from}</span> æ¬  <span class="font-bold text-green-700">${s.to}</span></span>
                        <span class="font-mono bg-white px-2 py-0.5 rounded-full text-xs border border-gray-300">NT$ ${Math.round(s.amount).toLocaleString()}</span>
                    </div>`
                ).join('');
            }

            document.getElementById('wallet-total-display').innerText = `NT$ ${Math.round(totalExpenseTWD_Group).toLocaleString()}`;
        }

        function renderPayerOptions() {
            const opts = payers.map(p=>`<option value="${p}">${p}</option>`).join('');
            document.getElementById('ex-payer').innerHTML = opts;
            document.getElementById('wallet-filter').innerHTML = `<option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>` + opts;
            // IOU options are rendered inside openIOUModal
        }
        function openPayerModal() {
            const list = document.getElementById('payer-list'); list.innerHTML='';
            payers.forEach((p,i) => {
                list.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm"><span>${p}</span>${payers.length>1?`<button onclick="removePayer(${i})" class="text-red-400"><i class="fa-solid fa-times"></i></button>`:''}</div>`;
            });
            openModal('payer-modal');
        }
        function addPayer() { const n=document.getElementById('new-payer-name').value; if(n && !payers.includes(n)){ payers.push(n); localStorage.setItem('payers',JSON.stringify(payers)); document.getElementById('new-payer-name').value=''; openPayerModal(); renderPayerOptions(); renderExpenses(); } }
        function removePayer(i) { if(confirm('åˆªé™¤?')){ payers.splice(i,1); localStorage.setItem('payers',JSON.stringify(payers)); openPayerModal(); renderPayerOptions(); renderExpenses(); } }

        function renderExpenses() {
            const list = document.getElementById('expense-list'); list.innerHTML='';
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const filter = document.getElementById('wallet-filter').value;
            
            // Calculate and Render Dashboard/Settlement first (V17 Logic)
            calculateSettlement();

            const filtered = filter === 'ALL' ? expenses : expenses.filter(e => e.payer === filter);

            filtered.forEach(ex => {
                const final = convertToTWD(ex.amt, ex.curr, rate);
                const split = Math.round(final / (ex.ppl || 1));
                list.innerHTML += `
                <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex gap-3 relative" onclick="openExpenseModal(${ex.id})">
                    <!-- Increased size to w-20 h-20 -->
                    <div class="w-20 h-20 bg-gray-100 rounded flex-shrink-0 overflow-hidden border border-gray-200 flex items-center justify-center">
                        ${ex.photo ? `<img src="${ex.photo}" class="w-full h-full object-cover cursor-pointer" onclick="event.stopPropagation(); viewPhoto('${ex.photo}')">` : '<span class="text-xs text-gray-300">ç„¡ç…§ç‰‡</span>'}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] px-2 py-0.5 rounded-full bg-gray-100">${ex.cat}</span>
                            <span class="text-sm font-bold">${ex.note || 'æœªå‘½å'}</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <div class="text-xs text-gray-400">${ex.payer}ä»˜ / ${ex.ppl||1}äºº</div>
                            <div class="text-right">
                                <div class="text-xs text-gray-400 font-mono">${ex.curr} ${ex.amt}</div>
                                <div class="text-sm font-bold text-clay font-mono">NT$ ${split.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
        }
        function openExpenseModal(id=null, prefill=null) {
            currentPhotoBase64=null; document.getElementById('photo-preview').classList.add('hidden'); document.getElementById('photo-placeholder').classList.remove('hidden');
            const delBtn = document.getElementById('btn-delete-expense');
            if(id) {
                const ex = expenses.find(e=>e.id===id);
                document.getElementById('ex-id').value = ex.id;
                document.getElementById('ex-category').value = ex.cat;
                document.getElementById('ex-note').value = ex.note;
                document.getElementById('ex-currency').value = ex.curr;
                document.getElementById('ex-amount').value = ex.amt;
                document.getElementById('ex-payer').value = ex.payer;
                document.getElementById('ex-people').value = ex.ppl;
                if(ex.photo){ currentPhotoBase64=ex.photo; document.getElementById('photo-preview').src=ex.photo; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); }
                delBtn.classList.remove('hidden');
            } else {
                document.getElementById('ex-id').value = '';
                document.getElementById('ex-amount').value = '';
                document.getElementById('ex-note').value = '';
                if(prefill) {
                    document.getElementById('ex-category').value = prefill.cat;
                    document.getElementById('ex-note').value = prefill.note;
                    document.getElementById('ex-amount').value = prefill.amt;
                    if(prefill.photo) { currentPhotoBase64=prefill.photo; document.getElementById('photo-preview').src=prefill.photo; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); }
                }
                delBtn.classList.add('hidden');
            }
            openModal('expense-modal');
        }
        function saveExpense() {
            const id = document.getElementById('ex-id').value;
            const cat = document.getElementById('ex-category').value;
            const note = document.getElementById('ex-note').value;
            const curr = document.getElementById('ex-currency').value;
            const amt = parseFloat(document.getElementById('ex-amount').value);
            const payer = document.getElementById('ex-payer').value;
            const ppl = parseInt(document.getElementById('ex-people').value)||1;
            
            if(!amt) return;

            if(id) {
                const idx = expenses.findIndex(e=>e.id==id);
                if(idx>-1) expenses[idx] = { ...expenses[idx], cat, note, curr, amt, payer, ppl, photo: currentPhotoBase64 || expenses[idx].photo };
            } else {
                expenses.unshift({id:Date.now(), date:new Date().toLocaleDateString(), cat, note, curr, amt, payer, ppl, photo: currentPhotoBase64});
            }
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderExpenses(); closeModal('expense-modal');
        }
        function deleteExpense() {
            const id = document.getElementById('ex-id').value;
            if(id && confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³å—ï¼Ÿ")) {
                expenses = expenses.filter(e => e.id != id);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                renderExpenses();
                closeModal('expense-modal');
            }
        }
        function quickExpense(name) {
            openExpenseModal(null, {
                cat: 'é£²é£Ÿ',
                note: name || 'ç”¨é¤',
                amt: ''
            });
        }
        
        /* --- LISTS & CHECKLISTS --- */
        function renderChecklist(){const ul=document.getElementById('checklist-container');ul.innerHTML='';todos.forEach((t,i)=>{ul.innerHTML+=`<li class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded group"><input type="checkbox" onchange="toggleTodo(${i})" ${t.done?'checked':''} class="w-5 h-5 accent-matcha"><input type="text" value="${t.text}" onchange="updateTodo(${i}, this.value)" class="flex-1 text-sm bg-transparent outline-none ${t.done?'line-through text-gray-300':''}"><button onclick="deleteTodo(${i})" class="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-times"></i></button></li>`;});}
        function addTodo(){const v=document.getElementById('new-todo').value;if(v){todos.push({text:v,done:false});localStorage.setItem('todos',JSON.stringify(todos));renderChecklist();document.getElementById('new-todo').value='';}}
        function toggleTodo(i){todos[i].done=!todos[i].done;localStorage.setItem('todos',JSON.stringify(todos));renderChecklist();}
        function updateTodo(i,v){todos[i].text=v;localStorage.setItem('todos',JSON.stringify(todos));}
        function deleteTodo(i){todos.splice(i,1);localStorage.setItem('todos',JSON.stringify(todos));renderChecklist();}
        
        function renderShoppingList() {
            const pendingDiv = document.getElementById('shopping-list-pending');
            const doneDiv = document.getElementById('shopping-list-done');
            pendingDiv.innerHTML = ''; doneDiv.innerHTML = '';

            shoppingList.forEach((item) => {
                const html = `
                <div class="relative p-2 pb-2 shadow-md border border-gray-100 flex flex-col ${item.done?'bg-gray-100':'bg-white'}" onclick="openShoppingModal(${item.id})">
                    <div class="w-full h-24 bg-gray-50 mb-2 overflow-hidden flex items-center justify-center rounded-sm">
                        ${item.photo ? `<img src="${item.photo}" class="w-full h-full object-cover cursor-pointer" onclick="event.stopPropagation(); viewPhoto('${item.photo}')">` : '<i class="fa-solid fa-bag-shopping text-gray-300 text-2xl"></i>'}
                    </div>
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-bold truncate flex-1 ${item.done?'line-through text-gray-400':''}">${item.name}</span>
                        <input type="checkbox" onclick="event.stopPropagation(); toggleShopping(${item.id})" ${item.done ? 'checked' : ''} class="w-5 h-5 accent-red-400 flex-shrink-0">
                    </div>
                    <div class="text-[10px] text-gray-500 flex justify-between">
                        <span>Qty: ${item.qty}</span>
                        <span>Â¥${item.price||0}</span>
                    </div>
                </div>`;
                if(item.done) doneDiv.innerHTML += html; else pendingDiv.innerHTML += html;
            });
        }
        function openShoppingModal(id=null) {
            currentShopPhoto = null; document.getElementById('shop-photo-preview').classList.add('hidden'); document.getElementById('shop-photo-text').classList.remove('hidden');
            if(id) {
                const s = shoppingList.find(i=>i.id===id);
                document.getElementById('shop-id').value = s.id;
                document.getElementById('shop-name').value = s.name;
                document.getElementById('shop-qty').value = s.qty;
                document.getElementById('shop-price').value = s.price;
                if(s.photo) { currentShopPhoto=s.photo; document.getElementById('shop-photo-preview').src=s.photo; document.getElementById('shop-photo-preview').classList.remove('hidden'); document.getElementById('shop-photo-text').classList.add('hidden'); }
            } else {
                ['shop-id','shop-name','shop-price'].forEach(k=>document.getElementById(k).value='');
                document.getElementById('shop-qty').value=1;
            }
            openModal('shopping-modal');
        }
        function saveShoppingItem() {
            const id = document.getElementById('shop-id').value;
            const name = document.getElementById('shop-name').value;
            const qty = document.getElementById('shop-qty').value;
            const price = document.getElementById('shop-price').value;
            if(!name) return;
            if(id) {
                const idx = shoppingList.findIndex(i=>i.id==id);
                if(idx>-1) { shoppingList[idx] = {...shoppingList[idx], name, qty, price, photo: currentShopPhoto || shoppingList[idx].photo}; }
            } else {
                shoppingList.push({id: Date.now(), name, qty, price, photo: currentShopPhoto, done: false});
            }
            localStorage.setItem('shoppingList_v2', JSON.stringify(shoppingList));
            renderShoppingList(); closeModal('shopping-modal');
        }
        function deleteShoppingItem() {
            const id = document.getElementById('shop-id').value;
            if(id && confirm("åˆªé™¤?")) {
                shoppingList = shoppingList.filter(i=>i.id!=id);
                localStorage.setItem('shoppingList_v2', JSON.stringify(shoppingList));
                renderShoppingList(); closeModal('shopping-modal');
            }
        }
        function toggleShopping(id) {
            const idx = shoppingList.findIndex(i=>i.id===id);
            if(idx>-1) {
                shoppingList[idx].done = !shoppingList[idx].done;
                if(shoppingList[idx].done) {
                    if(confirm("æ˜¯å¦å°‡æ­¤é …ç›®åŠ å…¥è¨˜å¸³ï¼Ÿ")) {
                        const item = shoppingList[idx];
                        openExpenseModal(null, {
                            cat: 'è³¼ç‰©',
                            note: item.name,
                            amt: (item.price || 0) * (item.qty || 1),
                            photo: item.photo
                        });
                    }
                }
                localStorage.setItem('shoppingList_v2', JSON.stringify(shoppingList));
                renderShoppingList();
            }
        }

        /* --- GENERAL UTILS --- */
        document.getElementById('memo-pad').addEventListener('input',(e)=>{localStorage.setItem('memo',e.target.value);const m=e.target.value.match(/(https?:\/\/[^\s]+)/g);document.getElementById('memo-links').innerHTML=m?m.map(u=>`<a href="${u}" target="_blank" class="text-xs bg-white border px-2 py-1 rounded-full text-blue-500 truncate max-w-full">Link</a>`).join(''):'';});document.getElementById('memo-pad').value=memoText;
        function switchTab(t){document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden'));document.getElementById('view-'+t).classList.remove('hidden');document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));document.querySelector(`[data-target="${t}"]`).classList.add('active');window.scrollTo(0,0);}
        
        window.onload = function() { 
            renderFlights(); 
            renderGuides(); 
            renderChecklist(); 
            renderShoppingList(); 
            renderPayerOptions(); 
            renderMustEatList(); // Renders the updated grouped list
            renderExpenses(); // Calculates everything
            switchTab('plan'); 
        }
    </script>
</body>
</html>